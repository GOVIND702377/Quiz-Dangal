import{k as B,a as M,b as O,u as U,r as s,s as u,j as e,L as N,m as c,B as C,T as H}from"./index-3d4d01e5.js";import{C as E}from"./check-circle-e5eeba82.js";import{C as Q}from"./clock-a6d9bc55.js";import{U as J}from"./users-1e8ad57b.js";import{A as V}from"./index-27b376ed.js";const te=()=>{var _;const{id:m}=B(),o=M(),{user:j,userProfile:G}=O(),{toast:i}=U(),[n,T]=s.useState(null),[d,k]=s.useState([]),[x,A]=s.useState(0),[w,L]=s.useState({}),[a,b]=s.useState("loading"),[y,P]=s.useState(0),[h,g]=s.useState(!1),[D,F]=s.useState(0),q=s.useCallback(async()=>{try{const{data:t,error:l}=await u.from("quiz_participants").select("*").eq("user_id",j.id).eq("quiz_id",m).single();if(l||!t){i({title:"Not Joined",description:"You have not joined this quiz.",variant:"destructive"}),o("/");return}if(t.status==="completed"){b("completed");return}const{data:r,error:f}=await u.from("quizzes").select("*").eq("id",m).single();if(f||!r){i({title:"Error",description:"Quiz not found.",variant:"destructive"}),o("/");return}T(r);const{data:v,error:I}=await u.from("questions").select(`
          id,
          question_text,
          options (
            id,
            option_text
          )
        `).eq("quiz_id",m).order("id");if(I||!v||v.length===0){i({title:"Error",description:"Could not load questions.",variant:"destructive"}),o("/");return}k(v);const{count:R}=await u.from("quiz_participants").select("*",{count:"exact",head:!0}).eq("quiz_id",m).eq("status","joined");F(R||0)}catch(t){console.error("Error fetching quiz data:",t),i({title:"Error",description:"Failed to load quiz.",variant:"destructive"}),o("/")}},[m,j.id,o,i]);s.useEffect(()=>{q()},[q]),s.useEffect(()=>{if(!n||a==="loading"||a==="completed")return;const t=setInterval(()=>{new Date(n.start_time),new Date(n.end_time),b("active"),P(600)},1e3);return()=>clearInterval(t)},[n,a]),s.useEffect(()=>{a==="finished"&&Object.keys(w).length>0&&!h&&z()},[a]);const Y=async(t,l)=>{try{const{error:r}=await u.from("user_answers").upsert({user_id:j.id,question_id:t,selected_option_id:l});if(r)throw r;L(f=>({...f,[t]:l})),x<d.length-1&&setTimeout(()=>{A(f=>f+1)},500),i({title:"Answer Saved",description:"Your answer has been recorded."})}catch(r){console.error("Error saving answer:",r),i({title:"Error",description:"Failed to save answer. Please try again.",variant:"destructive"})}},z=async()=>{if(!h){g(!0);try{const{error:t}=await u.from("quiz_participants").update({status:"completed"}).eq("user_id",j.id).eq("quiz_id",m);if(t)throw t;i({title:"Quiz Completed!",description:"Your answers have been submitted. Results will be announced soon!"}),b("completed"),setTimeout(()=>{o("/my-quizzes")},3e3)}catch(t){console.error("Error submitting quiz:",t),i({title:"Submission Failed",description:"Could not submit your answers. Please try again.",variant:"destructive"})}finally{g(!1)}}},S=t=>{const l=Math.floor(t/60),r=t%60;return`${l.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`};if(a==="loading"||!n)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(N,{className:"h-16 w-16 animate-spin text-accent-b mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading quiz..."})]})});if(a==="completed")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(c.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx(E,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:"Quiz Completed!"}),e.jsx("p",{className:"text-slate-300 mb-4",children:"You have already submitted your answers for this quiz."}),e.jsx(C,{onClick:()=>o("/my-quizzes"),variant:"brand",className:"w-full",children:"View My Quizzes"})]})});if(a==="waiting")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(c.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx(Q,{className:"h-16 w-16 text-accent-b mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:n.title}),e.jsx("p",{className:"text-slate-300 mb-4",children:"Quiz starts in:"}),e.jsx("div",{className:"text-4xl font-bold text-indigo-300 mb-4",children:S(y)}),e.jsxs("div",{className:"flex items-center justify-center space-x-4 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(J,{className:"h-4 w-4 mr-1"}),D," joined"]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(H,{className:"h-4 w-4 mr-1"}),"â‚¹",n.prize_pool," prize pool"]})]})]})});if(a==="finished")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(c.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx(Q,{className:"h-16 w-16 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:"Quiz Ended"}),e.jsx("p",{className:"text-slate-300 mb-4",children:"The quiz has ended. Results will be announced soon!"}),h&&e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx(N,{className:"h-6 w-6 animate-spin mr-2"}),e.jsx("span",{children:"Submitting your answers..."})]})]})});if(d.length===0)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-gray-600",children:"No questions available for this quiz."})})});const p=d[x],$=(x+1)/d.length*100;return e.jsx("div",{className:"min-h-screen p-4",children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs(c.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"qd-card rounded-2xl p-4 shadow-lg mb-6 text-slate-100",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold text-white",children:n.title}),e.jsxs("p",{className:"text-sm text-slate-300",children:["Question ",x+1," of ",d.length]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold text-red-400",children:S(y)}),e.jsx("div",{className:"text-xs text-slate-300",children:"Time Left"})]})]}),e.jsx("div",{className:"w-full bg-slate-700/40 rounded-full h-2 mt-4",children:e.jsx(c.div,{className:"bg-accent-b h-2 rounded-full",style:{width:`${$}%`},transition:{duration:.5}})})]}),e.jsx(V,{mode:"wait",children:e.jsxs(c.div,{initial:{opacity:0,x:50},animate:{opacity:1,x:0},exit:{opacity:0,x:-50},transition:{duration:.3},className:"qd-card rounded-2xl p-6 shadow-lg text-slate-100",children:[e.jsx("h2",{className:"text-xl font-bold text-center text-white text-shadow-sm mb-8",children:p.question_text}),e.jsx("div",{className:"space-y-4",children:(_=p.options)==null?void 0:_.map((t,l)=>e.jsxs(c.button,{onClick:()=>Y(p.id,t.id),whileHover:{scale:1.02},whileTap:{scale:.98},className:`w-full p-4 rounded-xl text-left font-medium transition-all duration-200 shadow-md border ${w[p.id]===t.id?"bg-emerald-600 text-white border-emerald-500":"bg-slate-800/70 hover:bg-slate-800 text-slate-100 border-slate-700"}`,children:[e.jsxs("span",{className:"font-bold mr-3 text-accent-b",children:[String.fromCharCode(65+l),"."]}),t.option_text]},t.id))}),x===d.length-1&&Object.keys(w).length===d.length&&e.jsx(c.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.5},className:"mt-8",children:e.jsx(C,{onClick:z,disabled:h,className:"w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 text-lg",children:h?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"mr-2 h-6 w-6 animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"mr-2 h-6 w-6"}),"Submit Quiz"]})})})]},p.id)})]})})};export{te as default};
