import{j as e,o as Ie,u as se,a as Ae,s as x,h as Ee,B as f,A as ue,m as G,L as A,I as P,p as Z}from"./index-4d991a5c.js";import{a as z,r as y}from"./react-8a702e3e.js";import{d as Te,L as Le}from"./router-f2cf3f51.js";import{L as D,Y as te,Z as Qe,m as qe,u as Pe,_ as De,$ as Me}from"./icons-e9c8901f.js";import"./supabase-4c1332f7.js";const ie=z.forwardRef(({className:l,...u},N)=>e.jsx("textarea",{ref:N,className:Ie("flex w-full rounded-md border border-input bg-background px-3 py-2 text-base sm:text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 min-h-[80px] resize-vertical",l),...u}));ie.displayName="Textarea";const ge=[{value:"opinion",label:"Opinion"},{value:"gk",label:"General Knowledge"},{value:"sports",label:"Sports"},{value:"movies",label:"Movies"}],he=l=>{var u;return((u=ge.find(N=>N.value===l))==null?void 0:u.label)||l},F=()=>({text:"",options:["","",""],correctIndex:0});function H(l,u,{fallback:N=0}={}){return u==null&&(u=N),l==="coins"?`${u} coins`:l==="others"?`${u}`:`₹${u}`}function $e(l,{allowZeroCorrect:u=!1}={}){var b,C;const N=String(l||"").trim().split(/\n\s*\n+/),j=[],R=[],E=[];let S=0;for(const T of N){const L=T.split(/\r?\n/).map(a=>a.trim()).filter(Boolean);if(!L.length)continue;S+=1;const _=L[0].replace(/^Q\d*\.?\s*/i,"").replace(/^Question\s*[:-]\s*/i,""),v=[];let w="";for(let a=1;a<L.length;a++){const m=L[a];if(/^ans(wer)?\s*[:-]/i.test(m)){w=m;continue}const g=m.match(/^[-*•]?\s*\[(x|X| )\]\s*(.+)$/);if(g){v.push({option_text:g[2].trim(),is_correct:/x/i.test(g[1])});continue}const r=m.match(/^(?:[-*•]|[A-Da-d]\)|\d+\)|[A-Da-d][.:])\s*(.+)$/),n=r?r[1].trim():m.replace(/^[*]\s*/,"").trim();n&&v.push({option_text:n,is_correct:/^\*/.test(m)})}if(w){const a=w.split(/[:-]/).slice(1).join(":").trim(),m=(C=(b=a.match(/^[A-D]/i))==null?void 0:b[0])==null?void 0:C.toUpperCase(),g=m?{A:0,B:1,C:2,D:3}[m]:NaN,r=parseInt(a,10);if(!Number.isNaN(g)&&v[g])v.forEach((n,k)=>n.is_correct=k===g);else if(!Number.isNaN(r)&&v[r-1])v.forEach((n,k)=>n.is_correct=k===r-1);else{const n=a.toLowerCase(),k=v.findIndex(M=>M.option_text.toLowerCase()===n||M.option_text.toLowerCase().includes(n));k>=0&&v.forEach((M,U)=>M.is_correct=U===k)}}let c=v.filter(a=>a.option_text);if(c.length>4){const a=c.findIndex(m=>m.is_correct);if(a>=0){const m=c[a],g=c.filter((r,n)=>n!==a);c=[m,...g.slice(0,3)]}else c=c.slice(0,4);E.push(`Q${S}: Trimmed to 4 options.`)}if(!_){R.push(`Q${S}: Missing question text.`);continue}if(c.length<2){R.push(`Q${S}: Need at least 2 options.`);continue}if(u)c=c.map(a=>({...a,is_correct:!1}));else{const a=c.filter(m=>m.is_correct).length;if(a===0)c[0].is_correct=!0;else if(a>1){let m=!1;c=c.map(g=>g.is_correct&&!m?(m=!0,g):{...g,is_correct:!1})}}j.push({question_text:_,options:c})}return{items:j,errors:R,warnings:E}}function Xe(){var de;const{toast:l}=se(),{userProfile:u,loading:N,user:j}=Ae(),[R,E]=Te(),S=R.get("tab")||"overview",b=t=>{R.set("tab",t),E(R,{replace:!0})},[C,T]=y.useState([]),[L,_]=y.useState(!1),[v,w]=y.useState(!1),[c,a]=y.useState({title:"",category:"",start_time:"",end_time:"",prizes:["","",""],prize_type:"coins",bulk:""}),[m,g]=y.useState("form"),[r,n]=y.useState([F()]),[k,M]=y.useState(null),[U,K]=y.useState([]),[ae,re]=y.useState(null),[fe,ye]=y.useState(!1),$=c.category==="opinion",je=y.useMemo(()=>{try{const t=String({}.VITE_ADMIN_EMAILS||"").trim();return t?new Set(t.split(/[\s,]+/).map(s=>s.trim().toLowerCase()).filter(Boolean)):new Set}catch(t){return new Set}},[]),ve=String((u==null?void 0:u.role)||"").trim().toLowerCase(),ne=String((j==null?void 0:j.email)||"").trim().toLowerCase(),be=String(((de=j==null?void 0:j.app_metadata)==null?void 0:de.role)||"").trim().toLowerCase(),I=ve==="admin"||be==="admin"||ne&&je.has(ne),J=y.useCallback(async()=>{if(!I){_(!1),T([]);return}if(_(!0),!x){T([]),_(!1);return}const{data:t,error:s}=await x.from("quizzes").select("id,title,category,prizes,prize_pool,prize_type,start_time,end_time").order("start_time",{ascending:!1});s?l({title:"Fetch failed",description:s.message,variant:"destructive"}):T(t||[]),_(!1)},[l,I]),we=y.useCallback(async t=>{if(!I){K([]);return}if(!x){K([]);return}const{data:s,error:o}=await x.from("questions").select("id,question_text,options(id,option_text,is_correct)").eq("quiz_id",t);o?l({title:"Questions failed",description:o.message,variant:"destructive"}):K(s||[])},[l,I]);y.useEffect(()=>{N||J()},[J,N]);const Ne=async t=>{t.preventDefault();try{if(!I){l({title:"Access denied",description:"Only admins can create quizzes.",variant:"destructive"});return}const s=[];c.category||s.push("Select category"),c.title.trim()||s.push("Title required"),(!c.start_time||!c.end_time)&&s.push("Start & End time required");const o=new Date(c.start_time);new Date(c.end_time)<=o&&s.push("End after start");const i=parseInt(c.prizes[0]||"",10);if((Number.isNaN(i)||i<=0)&&s.push("1st prize invalid"),s.length){l({title:"Fix form",description:s[0],variant:"destructive"});return}const p=r.map(q=>{const V=(q.options||[]).map(ee=>ee.trim()).filter(Boolean).slice(0,4);if(!q.text.trim()||V.length<2)return null;const ke=Math.min(Math.max(q.correctIndex||0,0),V.length-1);return{question_text:q.text.trim(),options:V.map((ee,Re)=>({option_text:ee,is_correct:$?!1:Re===ke}))}}).filter(Boolean);if(!p.length){l({title:"Add questions",variant:"destructive"});return}const h=c.prizes.filter(q=>q).map(q=>parseInt(q,10)),Q=h.reduce((q,V)=>q+V,0),Y=c.prize_type==="money"&&Q>0?"coins":c.prize_type,X={title:c.title.trim(),category:c.category,start_time:new Date(c.start_time).toISOString(),end_time:new Date(c.end_time).toISOString(),prizes:h,prize_pool:Q,prize_type:Y};if(!x)throw new Error("Supabase config missing");const{data:me,error:xe}=await x.from("quizzes").insert([X]).select().single();if(xe)throw xe;l({title:"Quiz created",description:me.title});const pe=await _e(me.id,p,"replace");pe.ok?l({title:"Questions added",description:`${p.length} questions`}):l({title:"Question insert fallback",description:pe.message||"Failed",variant:"destructive"}),w(!1),a({title:"",category:"",start_time:"",end_time:"",prizes:["","",""],prize_type:"coins",bulk:""}),n([F()]),J()}catch(s){l({title:"Create failed",description:s.message,variant:"destructive"})}},_e=async(t,s,o="append")=>{var d;if(!I)return{ok:!1,message:"Admin access required"};if(!x)return{ok:!1,message:"No Supabase client"};try{const{data:i}=await x.auth.getSession(),p=(d=i==null?void 0:i.session)==null?void 0:d.access_token,h=await fetch("/functions/v1/admin-upsert-questions",{method:"POST",headers:{"Content-Type":"application/json",...p?{Authorization:`Bearer ${p}`}:{}},body:JSON.stringify({quizId:t,items:s,mode:o})});if(h.ok)return{ok:!0};if(h.status!==404){const Q=await h.json().catch(()=>({}));throw new Error((Q==null?void 0:Q.error)||`HTTP ${h.status}`)}}catch(i){console.warn("Edge bulk insert failed, falling back to direct RPC path",i)}try{const{error:i}=await x.rpc("admin_bulk_upsert_questions",{p_quiz_id:t,p_payload:s,p_mode:o});if(!i)return{ok:!0};console.warn("admin_bulk_upsert_questions RPC returned error, using manual inserts",i==null?void 0:i.message)}catch(i){console.warn("admin_bulk_upsert_questions RPC threw, using manual inserts",i)}o==="replace"&&await x.from("questions").delete().eq("quiz_id",t);for(const i of s){const{data:p,error:h}=await x.from("questions").insert({quiz_id:t,question_text:i.question_text}).select("id").single();if(h)return{ok:!1,message:h.message};const Q=i.options.map(X=>({question_id:p.id,option_text:X.option_text,is_correct:!!X.is_correct})),{error:Y}=await x.from("options").insert(Q);if(Y)return{ok:!1,message:Y.message}}return{ok:!0}},ze=async t=>{if(!window.confirm("Delete this quiz?"))return;if(!I){l({title:"Access denied",description:"Only admins can delete quizzes.",variant:"destructive"});return}if(!x)return;const{error:s}=await x.from("quizzes").delete().eq("id",t);s?l({title:"Delete failed",description:s.message,variant:"destructive"}):(l({title:"Deleted"}),J())},Se=async t=>{if(!I){l({title:"Access denied",description:"Only admins can recompute results.",variant:"destructive"});return}if(x)try{re(t);const{error:s}=await x.rpc("admin_recompute_quiz_results",{p_quiz_id:t});if(s)throw s;try{await x.rpc("compute_results_if_due",{p_quiz_id:t})}catch(o){try{}catch(d){}}l({title:"Recomputed"})}catch(s){l({title:"Recompute failed",description:s.message,variant:"destructive"})}finally{re(null)}},le=y.useMemo(()=>{const t=Date.now(),s=[],o=[];for(const d of C){const i=d.end_time?new Date(d.end_time).getTime():null;i!==null&&t>i?o.push(d):s.push(d)}return{active:s,finished:o}},[C]),[W,O]=y.useState([]),[ce,oe]=y.useState(!1),B=y.useCallback(async()=>{if(!I){O([]);return}if(!x){O([]);return}oe(!0);try{const{data:t,error:s}=await x.from("redemptions").select("id,user_id,reward_value,reward_type,coins_required,payout_identifier,payout_channel,requested_at, profiles!inner(username)").eq("status","pending").order("requested_at",{ascending:!1});if(s)throw s;O(t||[])}catch(t){O([])}finally{oe(!1)}},[I]),Ce=y.useCallback(async t=>{if(I&&x){O(s=>s.filter(o=>o.id!==t));try{const{error:s}=await x.rpc("admin_approve_redemption",{p_redemption_id:t});if(s)throw s;l({title:"Approved",description:"Redemption approved."})}catch(s){l({title:"Approve failed",description:s.message,variant:"destructive"}),B()}}},[I,B,l]);return y.useEffect(()=>{B();const t=setInterval(B,3e4);return()=>clearInterval(t)},[B]),N?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(D,{className:"w-8 h-8 text-indigo-600 animate-spin"})}):I?e.jsxs("div",{className:"container mx-auto p-6 max-w-5xl bg-white text-gray-900 rounded-2xl shadow-sm",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6 text-gray-900",children:"Admin Dashboard"}),!Ee&&e.jsx("div",{className:"mb-6 text-sm text-amber-600",children:"Supabase env keys missing. Read-only UI only."}),e.jsx("div",{className:"flex gap-2 mb-6 flex-wrap",children:["overview","rewards","approvals","notifications"].map(t=>e.jsx("button",{onClick:()=>b(t),className:`px-3 py-1.5 rounded border text-sm transition-colors ${t===S?"bg-indigo-600 text-white border-indigo-600":"bg-gray-100 text-gray-700 border-gray-200 hover:bg-gray-200"}`,children:t},t))}),S==="overview"&&e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{children:e.jsxs(f,{onClick:()=>w(!0),className:"bg-indigo-600 hover:bg-indigo-700 text-white",children:[e.jsx(te,{className:"w-4 h-4 mr-1"}),"New Quiz"]})}),e.jsx(ue,{children:v&&e.jsxs(G.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},className:"bg-gray-50 border border-gray-200 rounded-xl p-5",children:[e.jsx("h2",{className:"font-semibold text-lg mb-4",children:"Create Quiz"}),e.jsxs("form",{onSubmit:Ne,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(A,{className:"mb-1 block",children:"Category"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:ge.map(({value:t,label:s})=>e.jsx("button",{type:"button",onClick:()=>a(o=>({...o,category:t})),className:`px-3 py-1 rounded-full text-xs border ${c.category===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:s},t))})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(A,{children:"Title"}),e.jsx(P,{value:c.title,onChange:t=>a(s=>({...s,title:t.target.value})),placeholder:"Daily Quiz",required:!0})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Prize Type"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["money","coins","others"].map(t=>e.jsx("button",{type:"button",onClick:()=>a(s=>({...s,prize_type:t})),className:`px-2 py-1 rounded text-xs border ${c.prize_type===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:t},t))})]})]}),e.jsx("div",{className:"grid md:grid-cols-3 gap-2",children:c.prizes.map((t,s)=>e.jsx(P,{value:t,placeholder:`${s+1}${["st","nd","rd"][s]||"th"} Prize`,onChange:o=>a(d=>{const i=[...d.prizes];return i[s]=o.target.value,{...d,prizes:i}})},s))}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(A,{children:"Start Time"}),e.jsx(P,{type:"datetime-local",value:c.start_time,onChange:t=>a(s=>({...s,start_time:t.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(A,{children:"End Time"}),e.jsx(P,{type:"datetime-local",value:c.end_time,onChange:t=>a(s=>({...s,end_time:t.target.value})),required:!0})]})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Questions Mode"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["form","paste"].map(t=>e.jsx("button",{type:"button",onClick:()=>g(t),className:`px-3 py-1 rounded text-xs border ${m===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:t},t))})]}),m==="form"?e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-xs text-gray-600",children:$?"Opinion: no correct option stored.":"Mark one correct option with radio."}),r.map((t,s)=>e.jsxs("div",{className:"border border-gray-200 rounded p-3 space-y-2 bg-white",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("span",{className:"text-xs text-gray-500 w-6",children:["Q",s+1]}),e.jsx(P,{value:t.text,onChange:o=>n(d=>{const i=[...d];return i[s]={...i[s],text:o.target.value},i}),placeholder:"Question text",className:"flex-1"}),e.jsx(f,{type:"button",variant:"outline",size:"sm",className:"border-red-300 text-red-500",onClick:()=>n(o=>o.length===1?[F()]:o.filter((d,i)=>i!==s)),children:"Del"})]}),(t.options||[]).slice(0,4).map((o,d)=>e.jsxs("div",{className:"flex items-center gap-2",children:[!$&&e.jsx("input",{type:"radio",name:`q-${s}`,checked:(t.correctIndex||0)===d,onChange:()=>n(i=>{const p=[...i];return p[s]={...p[s],correctIndex:d},p})}),e.jsx(P,{value:o,onChange:i=>n(p=>{const h=[...p],Q=[...h[s].options];return Q[d]=i.target.value,h[s]={...h[s],options:Q},h}),placeholder:`Option ${d+1}`,className:"flex-1"}),(t.options||[]).length>2&&e.jsx(f,{type:"button",size:"sm",variant:"outline",className:"border-red-300 text-red-500",onClick:()=>n(i=>{const p=[...i],h=[...p[s].options];return h.splice(d,1),p[s]={...p[s],options:h},p}),children:"X"})]},d)),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs(f,{type:"button",size:"sm",disabled:(t.options||[]).length>=4,onClick:()=>n(o=>{const d=[...o],i=[...d[s].options];return i.length<4&&i.push(""),d[s]={...d[s],options:i},d}),children:[e.jsx(te,{className:"w-4 h-4 mr-1"}),"Option"]}),e.jsx("span",{className:"text-xs text-gray-500",children:"Max 4 options"})]})]},s)),e.jsxs(f,{type:"button",onClick:()=>n(t=>[...t,F()]),children:[e.jsx(te,{className:"w-4 h-4 mr-1"}),"Question"]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Paste Questions"}),e.jsx(ie,{className:"h-40",value:c.bulk,onChange:t=>a(s=>({...s,bulk:t.target.value})),placeholder:`Q1. Capital of India?
- [ ] Mumbai
- [x] Delhi
- [ ] Kolkata
- [ ] Jaipur

Q2. ...`}),(()=>{const{items:t,errors:s,warnings:o}=$e(c.bulk,{allowZeroCorrect:$});return e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsxs("div",{children:[t.length," parsed"]}),o[0]&&e.jsx("div",{className:"text-amber-500",children:o[0]}),s[0]&&e.jsx("div",{className:"text-red-500",children:s[0]}),e.jsx(f,{type:"button",size:"sm",disabled:!!s.length||!t.length,onClick:()=>{if(s.length||!t.length)return;const d=t.map(i=>({text:i.question_text,options:i.options.map(p=>p.option_text),correctIndex:$?0:i.options.findIndex(p=>p.is_correct)>=0?i.options.findIndex(p=>p.is_correct):0}));n(d.length?d:[F()]),g("form"),l({title:"Loaded",description:`${d.length} questions moved to form.`})},children:"Load into form"})]})})()]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(f,{type:"submit",className:"bg-green-600 hover:bg-green-700",children:"Create"}),e.jsx(f,{type:"button",variant:"outline",onClick:()=>w(!1),children:"Cancel"})]})]})]})}),e.jsxs("section",{children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2 mb-3",children:[e.jsx(Qe,{className:"w-5 h-5"}),"All Quizzes"]}),L?e.jsxs("div",{className:"py-8 text-center text-gray-500",children:[e.jsx(D,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading..."]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Active / Upcoming"}),e.jsx("div",{className:"space-y-4",children:le.active.map(t=>{const s=t.prize_type||"money",o=H(s,t.prize_pool,{fallback:0}),d=Array.isArray(t.prizes)?t.prizes.map(i=>H(s,i,{fallback:0})).join(", "):"";return e.jsxs(G.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"border border-gray-200 rounded-xl p-4 bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between gap-4 flex-wrap",children:[e.jsxs("div",{className:"flex-1 min-w-[240px]",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-xs text-gray-600 flex flex-wrap gap-3 mt-1",children:[e.jsxs("span",{children:["Category: ",he(t.category)||"—"]}),e.jsxs("span",{children:["Type: ",s]}),e.jsxs("span",{children:["Pool: ",o]}),e.jsxs("span",{children:["Prizes: ",d]})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[e.jsxs("span",{children:["Start: ",t.start_time?Z(t.start_time):"—"]}),e.jsxs("span",{className:"ml-4",children:["End: ",t.end_time?Z(t.end_time):"—"]})]})]}),e.jsxs("div",{className:"flex gap-2 items-start",children:[e.jsx(f,{size:"sm",variant:"outline",onClick:()=>Se(t.id),disabled:ae===t.id,children:ae===t.id?e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"w-4 h-4 mr-1 animate-spin"}),"..."]}):e.jsxs(e.Fragment,{children:[e.jsx(qe,{className:"w-4 h-4 mr-1"}),"Recompute"]})}),e.jsxs(Le,{to:`/results/${t.id}`,className:"inline-flex items-center gap-1 px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-100 text-indigo-600",children:[e.jsx(Pe,{className:"w-4 h-4"}),"Results"]}),e.jsxs(f,{size:"sm",variant:"outline",onClick:()=>{M(t),we(t.id),ye(!0)},className:"text-blue-400",children:[e.jsx(De,{className:"w-4 h-4 mr-1"}),"Questions"]}),e.jsx(f,{size:"sm",variant:"outline",onClick:()=>ze(t.id),className:"text-red-500",children:e.jsx(Me,{className:"w-4 h-4"})})]})]}),e.jsx(ue,{children:fe&&(k==null?void 0:k.id)===t.id&&e.jsxs(G.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"mt-4 space-y-2",children:[e.jsxs("h5",{className:"font-medium flex items-center gap-2",children:["Questions for ",t.title]}),U.length===0&&e.jsx("div",{className:"text-xs text-gray-500",children:"No questions."}),U.map((i,p)=>e.jsxs("div",{className:"border border-gray-200 rounded p-3 bg-white",children:[e.jsxs("div",{className:"text-sm font-medium",children:["Q",p+1,": ",i.question_text]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:(i.options||[]).map(h=>e.jsxs("div",{className:`px-2 py-0.5 text-xs rounded-full ${h.is_correct?"bg-green-600 text-white":"bg-gray-200 text-gray-700"}`,children:[h.option_text,h.is_correct&&e.jsx("span",{className:"ml-1",children:"✓"})]},h.id))})]},i.id))]})})]},t.id)})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Finished"}),e.jsx("div",{className:"space-y-4",children:le.finished.map(t=>{const s=t.prize_type||"money",o=H(s,t.prize_pool,{fallback:0}),d=Array.isArray(t.prizes)?t.prizes.map(i=>H(s,i,{fallback:0})).join(", "):"";return e.jsxs(G.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"border border-gray-200 rounded-xl p-4 bg-gray-50",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-xs text-gray-600 flex flex-wrap gap-3 mt-1",children:[e.jsxs("span",{children:["Category: ",he(t.category)||"—"]}),e.jsxs("span",{children:["Type: ",s]}),e.jsxs("span",{children:["Pool: ",o]}),e.jsxs("span",{children:["Prizes: ",d]})]})]},t.id)})})]})]})]})]}),S==="approvals"&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Pending Redemptions"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Approve user reward payouts after verifying their UPI ID / phone number."}),ce&&e.jsxs("div",{className:"py-8 text-center text-gray-500",children:[e.jsx(D,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading pending requests..."]}),!ce&&W.length===0&&e.jsx("div",{className:"py-6 text-center text-gray-500 border border-gray-200 rounded-xl bg-gray-50",children:"No pending redemptions."}),W.length>0&&e.jsx("div",{className:"space-y-4",children:W.map(t=>{var s;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 bg-white shadow-sm flex flex-col md:flex-row md:items-center gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-gradient-to-br from-amber-400 to-yellow-500 flex items-center justify-center text-white font-semibold shadow",children:e.jsx("span",{className:"text-sm",children:"₹"})}),(()=>{var i;const o=t.reward_value,d=o&&String(o).trim().length?o:`${t.reward_type||""}`.trim()||"Reward";return e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900 truncate",children:d}),e.jsxs("div",{className:"text-[11px] text-gray-600",children:["@",((i=t.profiles)==null?void 0:i.username)||"user"]})]})})()]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-600 flex flex-wrap gap-3",children:[e.jsxs("span",{children:["Type: ",t.reward_type||"—"]}),e.jsxs("span",{children:["Coins: ",(s=t.coins_required)!=null?s:0]}),e.jsxs("span",{children:["Requested: ",t.requested_at?Z(t.requested_at):"—"]})]}),e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["Payout: ",t.payout_identifier?`${t.payout_identifier} (${t.payout_channel||"upi"})`:"—"]})]}),e.jsx("div",{className:"flex items-center gap-2 self-start md:self-center",children:e.jsx(f,{size:"sm",onClick:()=>Ce(t.id),className:"bg-green-600 hover:bg-green-700 text-white",children:"Approve"})})]},t.id)})})]}),S==="notifications"&&e.jsx(Be,{}),S==="rewards"&&e.jsx(Oe,{})]}):e.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-2xl p-6 max-w-md w-full text-center shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-500 mb-2",children:"Admin access required"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx("span",{children:"Supabase "}),e.jsx("code",{children:"profiles"}),e.jsx("span",{children:" table mein aapke record ka "}),e.jsx("strong",{children:"role"}),e.jsx("span",{children:" field admin hona chahiye."})]}),e.jsxs("ul",{className:"text-left text-sm text-gray-600 mt-4 space-y-2 list-disc list-inside",children:[e.jsxs("li",{children:[e.jsx("span",{children:"Supabase dashboard"}),e.jsx("span",{"aria-hidden":"true",role:"presentation",className:"mx-1",children:"→"}),e.jsx("span",{children:"Table editor"}),e.jsx("span",{"aria-hidden":"true",role:"presentation",className:"mx-1",children:"→"}),e.jsx("code",{children:"profiles"}),e.jsx("span",{children:" me role update karein."})]}),e.jsx("li",{children:"Update ke baad login session refresh karein."}),e.jsxs("li",{children:["Dev bypass (",e.jsx("code",{children:"VITE_BYPASS_AUTH=1"}),") mein mock admin auto-enable hota hai."]})]})]})})}function Oe(){const{toast:l}=se(),[u,N]=z.useState([]),[j,R]=z.useState(!1),[E,S]=z.useState(!1),[b,C]=z.useState({reward_type:"coins",reward_value:"",coins_required:"",is_active:!0}),[T,L]=z.useState(!1),[_,v]=z.useState(null),w=z.useCallback(async()=>{if(!x)return;R(!0);const{data:r,error:n}=await x.from("reward_catalog").select("id,reward_type,reward_value,coins_required,is_active").order("id",{ascending:!1}).limit(200);n?l({title:"Rewards load failed",description:n.message,variant:"destructive"}):N(r||[]),R(!1)},[l]);z.useEffect(()=>{w()},[w]);const c=()=>C({reward_type:"coins",reward_value:"",coins_required:"",is_active:!0}),a=async r=>{if(r.preventDefault(),!!x){L(!0);try{const n={reward_type:String(b.reward_type||"").trim()||"other",reward_value:String(b.reward_value||"").trim(),coins_required:b.coins_required!==""&&b.coins_required!==null?parseInt(b.coins_required,10):null,is_active:!!b.is_active};if(!n.reward_value)throw new Error("Value required");if(n.coins_required===null||Number.isNaN(n.coins_required))throw new Error("Coins required");let k;if(_?k=await x.from("reward_catalog").update(n).eq("id",_).select().single():k=await x.from("reward_catalog").insert([n]).select().single(),k.error)throw k.error;l({title:_?"Reward updated":"Reward created"}),c(),S(!1),v(null),w()}catch(n){l({title:"Save failed",description:n.message,variant:"destructive"})}finally{L(!1)}}},m=async r=>{if(!x)return;const{error:n}=await x.from("reward_catalog").update({is_active:!r.is_active}).eq("id",r.id);n?l({title:"Toggle failed",description:n.message,variant:"destructive"}):(l({title:r.is_active?"Deactivated":"Activated"}),w())},g=r=>{var n;v(r.id),S(!0),C({reward_type:r.reward_type||"coins",reward_value:r.reward_value||"",coins_required:((n=r.coins_required)!=null?n:"").toString(),is_active:!!r.is_active})};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Redemptions auto-approved hain. Neeche sirf Rewards Catalog manage karna hai."}),e.jsxs("div",{className:"pt-10 border-t border-gray-200 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Rewards Catalog"}),e.jsx(f,{size:"sm",onClick:()=>{S(r=>!r),E||(c(),v(null))},children:E?"Close":"New Reward"}),e.jsx(f,{size:"sm",variant:"outline",onClick:w,disabled:j,children:j?e.jsx(D,{className:"w-4 h-4 animate-spin"}):"Refresh"})]}),E&&e.jsxs("form",{onSubmit:a,className:"space-y-3 bg-gray-50 border border-gray-200 rounded-lg p-4 max-w-3xl",children:[e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(A,{children:"Type"}),e.jsx("div",{className:"flex gap-2 flex-wrap mt-1",children:["coins","cash","voucher","other"].map(r=>e.jsx("button",{type:"button",onClick:()=>C(n=>({...n,reward_type:r})),className:`px-2 py-1 rounded text-xs border ${b.reward_type===r?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:r},r))})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Value"}),e.jsx(P,{value:b.reward_value,onChange:r=>C(n=>({...n,reward_value:r.target.value})),placeholder:"e.g. 100 / AMAZON100 / ₹100"})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Coins Required"}),e.jsx(P,{type:"number",value:b.coins_required,onChange:r=>C(n=>({...n,coins_required:r.target.value})),placeholder:"coins needed"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"is_active",type:"checkbox",checked:!!b.is_active,onChange:r=>C(n=>({...n,is_active:r.target.checked}))}),e.jsx("label",{htmlFor:"is_active",className:"text-sm",children:"Active"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{type:"submit",disabled:T,children:T?e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"w-4 h-4 mr-1 animate-spin"}),"Saving"]}):_?"Update":"Create"}),e.jsx(f,{type:"button",variant:"outline",onClick:()=>{c(),v(null)},children:_?"Cancel Edit":"Reset"})]})]}),e.jsx("div",{className:"overflow-x-auto rounded-lg border border-gray-200",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-100 text-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Type"}),e.jsx("th",{className:"p-2 text-left",children:"Value"}),e.jsx("th",{className:"p-2 text-left",children:"Coins Required"}),e.jsx("th",{className:"p-2 text-left",children:"Active"}),e.jsx("th",{className:"p-2 text-left",children:"Actions"})]})}),e.jsxs("tbody",{children:[u.map(r=>{var n;return e.jsxs("tr",{className:"border-t border-gray-200 hover:bg-gray-100",children:[e.jsx("td",{className:"p-2 capitalize",children:r.reward_type}),e.jsx("td",{className:"p-2 max-w-[260px] truncate",title:r.reward_value,children:r.reward_value}),e.jsx("td",{className:"p-2",children:(n=r.coins_required)!=null?n:"—"}),e.jsx("td",{className:"p-2",children:r.is_active?e.jsx("span",{className:"text-green-500",children:"Yes"}):e.jsx("span",{className:"text-gray-500",children:"No"})}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(f,{size:"sm",variant:"outline",onClick:()=>g(r),children:"Edit"}),e.jsx(f,{size:"sm",variant:"outline",onClick:()=>m(r),children:r.is_active?"Deactivate":"Activate"})]})})]},r.id)}),!u.length&&!j&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"p-4 text-center text-gray-500",children:"No rewards."})}),j&&e.jsx("tr",{children:e.jsxs("td",{colSpan:8,className:"p-6 text-center text-gray-500",children:[e.jsx(D,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading rewards..."]})})]})]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"Catalog: inactive rewards are hidden from users."})]})]})}function Be(){const{toast:l}=se(),[u,N]=z.useState(""),[j,R]=z.useState(""),[E,S]=z.useState("all"),[b,C]=z.useState(!1),[T,L]=z.useState([]),[_,v]=z.useState(!1),w=z.useCallback(async()=>{if(!x)return;v(!0);const{data:a,error:m}=await x.from("notifications").select("id,title,message,type,segment,created_at").order("created_at",{ascending:!1}).limit(100);m?l({title:"Fetch failed",description:m.message,variant:"destructive"}):L(a||[]),v(!1)},[l]);z.useEffect(()=>{w()},[w]);const c=async a=>{if(a.preventDefault(),!u.trim()||!j.trim()){l({title:"Missing fields",variant:"destructive"});return}if(!x){l({title:"No backend client",variant:"destructive"});return}C(!0);try{const{data:{session:m}}=await x.auth.getSession(),g=m==null?void 0:m.access_token,r=await fetch("/functions/v1/send-notifications",{method:"POST",headers:{"Content-Type":"application/json",...g?{Authorization:`Bearer ${g}`}:{}},body:JSON.stringify({title:u.trim(),message:j.trim(),segment:E})});if(!r.ok){const n=await r.text();throw new Error(n||`HTTP ${r.status}`)}l({title:"Sent",description:u.trim()}),N(""),R(""),w()}catch(m){l({title:"Send failed",description:m.message,variant:"destructive"})}finally{C(!1)}};return e.jsxs("div",{className:"space-y-8 max-w-3xl",children:[e.jsxs("form",{onSubmit:c,className:"space-y-4 bg-gray-50 border border-gray-200 rounded-xl p-5",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Send Notification"}),e.jsxs("div",{children:[e.jsx(A,{children:"Title"}),e.jsx(P,{value:u,onChange:a=>N(a.target.value),maxLength:80,placeholder:"Short title"}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Max 80 chars • ",u.length,"/80"]})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Message"}),e.jsx(ie,{value:j,onChange:a=>R(a.target.value),className:"h-28",maxLength:280,placeholder:"Body shown in push notification"}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Max 280 chars • ",j.length,"/280"]})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Segment"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["all"].map(a=>e.jsx("button",{type:"button",onClick:()=>S(a),className:`px-3 py-1 rounded text-xs border ${E===a?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:a},a))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{type:"submit",disabled:b,children:b?e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"w-4 h-4 mr-1 animate-spin"}),"Sending"]}):"Send"}),e.jsx(f,{type:"button",variant:"outline",onClick:()=>{N(""),R("")},children:"Reset"})]})]}),e.jsxs("section",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Recent Notifications"}),e.jsx(f,{size:"sm",variant:"outline",onClick:w,disabled:_,children:_?e.jsx(D,{className:"w-4 h-4 animate-spin"}):"Refresh"})]}),e.jsxs("div",{className:"space-y-3",children:[T.map(a=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-3 bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between gap-4 flex-wrap",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:a.title}),e.jsx("div",{className:"text-xs text-gray-600 whitespace-pre-wrap max-w-xl break-words",children:a.message})]}),e.jsx("div",{className:"text-[10px] text-gray-500",children:Z(a.created_at)})]}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Segment: ",a.segment||"—",a.type?` • ${a.type}`:""]})]},a.id)),!T.length&&!_&&e.jsx("div",{className:"text-xs text-gray-500",children:"No notifications yet."})]})]})]})}export{Xe as default};
