import{a as R,u as B,s as h,j as e,B as E}from"./index-9ff65d13.js";import{r as i}from"./react-8a702e3e.js";import{c as O,a as H}from"./router-bcacfb8d.js";import{L as y,o as Q,d as T,r as J,T as U}from"./icons-c5cbdee3.js";import{m as o,A as V}from"./motion-511bde03.js";import"./supabase-4c1332f7.js";const se=()=>{var C;const{id:u}=O(),d=H(),{user:b,userProfile:G}=R(),{toast:r}=B(),[c,k]=i.useState(null),[m,A]=i.useState([]),[f,D]=i.useState(0),[v,L]=i.useState({}),[n,p]=i.useState("loading"),[g,N]=i.useState(0),[j,q]=i.useState(!1),[M,P]=i.useState(0),z=i.useCallback(async()=>{try{const{data:t,error:a}=await h.from("quiz_participants").select("*").eq("user_id",b.id).eq("quiz_id",u).single();if(a||!t){r({title:"Not Joined",description:"You have not joined this quiz.",variant:"destructive"}),d("/");return}if(t.status==="completed"){p("completed");return}const{data:s,error:l}=await h.from("quizzes").select("*").eq("id",u).single();if(l||!s){r({title:"Error",description:"Quiz not found.",variant:"destructive"}),d("/");return}k(s);const{data:x,error:$}=await h.from("questions").select(`
          id,
          question_text,
          options (
            id,
            option_text
          )
        `).eq("quiz_id",u).order("id");if($||!x||x.length===0){r({title:"Error",description:"Could not load questions.",variant:"destructive"}),d("/");return}A(x);const{count:I}=await h.from("quiz_participants").select("*",{count:"exact",head:!0}).eq("quiz_id",u).eq("status","joined");P(I||0)}catch(t){console.error("Error fetching quiz data:",t),r({title:"Error",description:"Failed to load quiz.",variant:"destructive"}),d("/")}},[u,b.id,d,r]);i.useEffect(()=>{z()},[z]),i.useEffect(()=>{if(!c||n==="loading"||n==="completed")return;const t=()=>{const s=new Date,l=new Date(c.start_time),x=new Date(c.end_time);s<l?(p("waiting"),N(Math.max(0,Math.round((l-s)/1e3)))):s>=l&&s<x?(p("active"),N(Math.max(0,Math.round((x-s)/1e3)))):(p("finished"),N(0))};t();const a=setInterval(t,1e3);return()=>clearInterval(a)},[c,n]),i.useEffect(()=>{n==="finished"&&Object.keys(v).length>0&&!j&&S()},[n]);const F=async(t,a)=>{try{const{error:s}=await h.from("user_answers").upsert({user_id:b.id,question_id:t,selected_option_id:a});if(s)throw s;L(l=>({...l,[t]:a})),f<m.length-1&&setTimeout(()=>{D(l=>l+1)},500),r({title:"Answer Saved",description:"Your answer has been recorded."})}catch(s){console.error("Error saving answer:",s),r({title:"Error",description:"Failed to save answer. Please try again.",variant:"destructive"})}},S=async()=>{if(!j){q(!0);try{const{error:t}=await h.from("quiz_participants").update({status:"completed"}).eq("user_id",b.id).eq("quiz_id",u);if(t)throw t;r({title:"Quiz Completed!",description:"Your answers have been submitted. Results will be announced soon!"}),p("completed"),setTimeout(()=>{d("/my-quizzes")},3e3)}catch(t){console.error("Error submitting quiz:",t),r({title:"Submission Failed",description:"Could not submit your answers. Please try again.",variant:"destructive"})}finally{q(!1)}}},_=t=>{const a=Math.floor(t/60),s=t%60;return`${a.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`};if(n==="loading"||!c)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(y,{className:"h-16 w-16 animate-spin text-accent-b mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading quiz..."})]})});if(n==="completed")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(o.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx(Q,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:"Quiz Completed!"}),e.jsx("p",{className:"text-slate-300 mb-4",children:"You have already submitted your answers for this quiz."}),e.jsx(E,{onClick:()=>d("/my-quizzes"),variant:"brand",className:"w-full",children:"View My Quizzes"})]})});if(n==="waiting")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(o.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx(T,{className:"h-16 w-16 text-accent-b mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:c.title}),e.jsx("p",{className:"text-slate-300 mb-4",children:"Quiz starts in:"}),e.jsx("div",{className:"text-4xl font-bold text-indigo-300 mb-4",children:_(g)}),e.jsxs("div",{className:"flex items-center justify-center space-x-4 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(J,{className:"h-4 w-4 mr-1"}),M," joined"]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(U,{className:"h-4 w-4 mr-1"}),"â‚¹",c.prize_pool," prize pool"]})]})]})});if(n==="finished")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(o.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx(T,{className:"h-16 w-16 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:"Quiz Ended"}),e.jsx("p",{className:"text-slate-300 mb-4",children:"The quiz has ended. Results will be announced soon!"}),j&&e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx(y,{className:"h-6 w-6 animate-spin mr-2"}),e.jsx("span",{children:"Submitting your answers..."})]})]})});if(m.length===0)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-gray-600",children:"No questions available for this quiz."})})});const w=m[f],Y=(f+1)/m.length*100;return e.jsx("div",{className:"min-h-screen p-4",children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs(o.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"qd-card rounded-2xl p-4 shadow-lg mb-6 text-slate-100",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold text-white",children:c.title}),e.jsxs("p",{className:"text-sm text-slate-300",children:["Question ",f+1," of ",m.length]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold text-red-400",children:_(g)}),e.jsx("div",{className:"text-xs text-slate-300",children:"Time Left"})]})]}),e.jsx("div",{className:"w-full bg-slate-700/40 rounded-full h-2 mt-4",children:e.jsx(o.div,{className:"bg-accent-b h-2 rounded-full",style:{width:`${Y}%`},transition:{duration:.5}})})]}),e.jsx(V,{mode:"wait",children:e.jsxs(o.div,{initial:{opacity:0,x:50},animate:{opacity:1,x:0},exit:{opacity:0,x:-50},transition:{duration:.3},className:"qd-card rounded-2xl p-6 shadow-lg text-slate-100",children:[e.jsx("h2",{className:"text-xl font-bold text-center text-white text-shadow-sm mb-8",children:w.question_text}),e.jsx("div",{className:"space-y-4",children:(C=w.options)==null?void 0:C.map((t,a)=>e.jsxs(o.button,{onClick:()=>F(w.id,t.id),whileHover:{scale:1.02},whileTap:{scale:.98},className:`w-full p-4 rounded-xl text-left font-medium transition-all duration-200 shadow-md border ${v[w.id]===t.id?"bg-emerald-600 text-white border-emerald-500":"bg-slate-800/70 hover:bg-slate-800 text-slate-100 border-slate-700"}`,children:[e.jsxs("span",{className:"font-bold mr-3 text-accent-b",children:[String.fromCharCode(65+a),"."]}),t.option_text]},t.id))}),f===m.length-1&&Object.keys(v).length===m.length&&e.jsx(o.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.5},className:"mt-8",children:e.jsx(E,{onClick:S,disabled:j,className:"w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 text-lg",children:j?e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"mr-2 h-6 w-6 animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"mr-2 h-6 w-6"}),"Submit Quiz"]})})})]},w.id)})]})})};export{se as default};
