import{j as e,k as Ae,u as se,a as Ee,s as m,h as Qe,B as y,A as ue,m as J,L as E,I as D,o as W}from"./index-93d743b2.js";import{a as S,r as j}from"./react-8a702e3e.js";import{d as Te,L as qe}from"./router-f2cf3f51.js";import{L as $,Y as te,Z as Ie,m as Le,u as Pe,_ as De,$ as $e}from"./icons-e9c8901f.js";import"./supabase-4c1332f7.js";const ie=S.forwardRef(({className:l,...h},N)=>e.jsx("textarea",{ref:N,className:Ae("flex w-full rounded-md border border-input bg-background px-3 py-2 text-base sm:text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 min-h-[80px] resize-vertical",l),...h}));ie.displayName="Textarea";const ge=[{value:"opinion",label:"Opinion"},{value:"gk",label:"General Knowledge"},{value:"sports",label:"Sports"},{value:"movies",label:"Movies"}],he=l=>{var h;return((h=ge.find(N=>N.value===l))==null?void 0:h.label)||l},V=()=>({text:"",options:["","",""],correctIndex:0});function K(l,h,{fallback:N=0}={}){return h==null&&(h=N),l==="coins"?`${h} coins`:l==="others"?`${h}`:`₹${h}`}function Me(l,{allowZeroCorrect:h=!1}={}){var b,C;const N=String(l||"").trim().split(/\n\s*\n+/),v=[],R=[],Q=[];let k=0;for(const T of N){const q=T.split(/\r?\n/).map(a=>a.trim()).filter(Boolean);if(!q.length)continue;k+=1;const z=q[0].replace(/^Q\d*\.?\s*/i,"").replace(/^Question\s*[:-]\s*/i,""),w=[];let _="";for(let a=1;a<q.length;a++){const x=q[a];if(/^ans(wer)?\s*[:-]/i.test(x)){_=x;continue}const g=x.match(/^[-*•]?\s*\[(x|X| )\]\s*(.+)$/);if(g){w.push({option_text:g[2].trim(),is_correct:/x/i.test(g[1])});continue}const n=x.match(/^(?:[-*•]|[A-Da-d]\)|\d+\)|[A-Da-d][.:])\s*(.+)$/),r=n?n[1].trim():x.replace(/^[*]\s*/,"").trim();r&&w.push({option_text:r,is_correct:/^\*/.test(x)})}if(_){const a=_.split(/[:-]/).slice(1).join(":").trim(),x=(C=(b=a.match(/^[A-D]/i))==null?void 0:b[0])==null?void 0:C.toUpperCase(),g=x?{A:0,B:1,C:2,D:3}[x]:NaN,n=parseInt(a,10);if(!Number.isNaN(g)&&w[g])w.forEach((r,f)=>r.is_correct=f===g);else if(!Number.isNaN(n)&&w[n-1])w.forEach((r,f)=>r.is_correct=f===n-1);else{const r=a.toLowerCase(),f=w.findIndex(L=>L.option_text.toLowerCase()===r||L.option_text.toLowerCase().includes(r));f>=0&&w.forEach((L,M)=>L.is_correct=M===f)}}let c=w.filter(a=>a.option_text);if(c.length>4){const a=c.findIndex(x=>x.is_correct);if(a>=0){const x=c[a],g=c.filter((n,r)=>r!==a);c=[x,...g.slice(0,3)]}else c=c.slice(0,4);Q.push(`Q${k}: Trimmed to 4 options.`)}if(!z){R.push(`Q${k}: Missing question text.`);continue}if(c.length<2){R.push(`Q${k}: Need at least 2 options.`);continue}if(h)c=c.map(a=>({...a,is_correct:!1}));else{const a=c.filter(x=>x.is_correct).length;if(a===0)c[0].is_correct=!0;else if(a>1){let x=!1;c=c.map(g=>g.is_correct&&!x?(x=!0,g):{...g,is_correct:!1})}}v.push({question_text:z,options:c})}return{items:v,errors:R,warnings:Q}}function He(){var de;const{toast:l}=se(),{userProfile:h,loading:N,user:v}=Ee(),[R,Q]=Te(),k=R.get("tab")||"overview",b=t=>{R.set("tab",t),Q(R,{replace:!0})},[C,T]=j.useState([]),[q,z]=j.useState(!1),[w,_]=j.useState(!1),[c,a]=j.useState({title:"",category:"",start_time:"",end_time:"",prizes:["","",""],prize_type:"coins",bulk:""}),[x,g]=j.useState("form"),[n,r]=j.useState([V()]),[f,L]=j.useState(null),[M,X]=j.useState([]),[ae,re]=j.useState(null),[fe,ye]=j.useState(!1),F=c.category==="opinion",je=j.useMemo(()=>{try{const t=String({}.VITE_ADMIN_EMAILS||"").trim();return t?new Set(t.split(/[\s,]+/).map(s=>s.trim().toLowerCase()).filter(Boolean)):new Set}catch(t){return new Set}},[]),ve=String((h==null?void 0:h.role)||"").trim().toLowerCase(),ne=String((v==null?void 0:v.email)||"").trim().toLowerCase(),be=String(((de=v==null?void 0:v.app_metadata)==null?void 0:de.role)||"").trim().toLowerCase(),A=ve==="admin"||be==="admin"||ne&&je.has(ne),Y=j.useCallback(async()=>{if(!A){z(!1),T([]);return}if(z(!0),!m){T([]),z(!1);return}const{data:t,error:s}=await m.from("quizzes").select("id,title,category,prizes,prize_pool,prize_type,start_time,end_time").order("start_time",{ascending:!1});s?l({title:"Fetch failed",description:s.message,variant:"destructive"}):T(t||[]),z(!1)},[l,A]),we=j.useCallback(async t=>{if(!A){X([]);return}if(!m){X([]);return}const{data:s,error:o}=await m.from("questions").select("id,question_text,options(id,option_text,is_correct)").eq("quiz_id",t);o?l({title:"Questions failed",description:o.message,variant:"destructive"}):X(s||[])},[l,A]);j.useEffect(()=>{N||Y()},[Y,N]);const _e=async t=>{t.preventDefault();try{if(!A){l({title:"Access denied",description:"Only admins can create quizzes.",variant:"destructive"});return}const s=[];c.category||s.push("Select category"),c.title.trim()||s.push("Title required"),(!c.start_time||!c.end_time)&&s.push("Start & End time required");const o=new Date(c.start_time);new Date(c.end_time)<=o&&s.push("End after start");const i=parseInt(c.prizes[0]||"",10);if((Number.isNaN(i)||i<=0)&&s.push("1st prize invalid"),s.length){l({title:"Fix form",description:s[0],variant:"destructive"});return}const p=n.map(P=>{const U=(P.options||[]).map(ee=>ee.trim()).filter(Boolean).slice(0,4);if(!P.text.trim()||U.length<2)return null;const Ce=Math.min(Math.max(P.correctIndex||0,0),U.length-1);return{question_text:P.text.trim(),options:U.map((ee,Re)=>({option_text:ee,is_correct:F?!1:Re===Ce}))}}).filter(Boolean);if(!p.length){l({title:"Add questions",variant:"destructive"});return}const u=c.prizes.filter(P=>P).map(P=>parseInt(P,10)),I=u.reduce((P,U)=>P+U,0),Z=c.prize_type==="money"&&I>0?"coins":c.prize_type,H={title:c.title.trim(),category:c.category,start_time:new Date(c.start_time).toISOString(),end_time:new Date(c.end_time).toISOString(),prizes:u,prize_pool:I,prize_type:Z};if(!m)throw new Error("Supabase config missing");const{data:me,error:pe}=await m.from("quizzes").insert([H]).select().single();if(pe)throw pe;l({title:"Quiz created",description:me.title});const xe=await Ne(me.id,p,"replace");xe.ok?l({title:"Questions added",description:`${p.length} questions`}):l({title:"Question insert fallback",description:xe.message||"Failed",variant:"destructive"}),_(!1),a({title:"",category:"",start_time:"",end_time:"",prizes:["","",""],prize_type:"coins",bulk:""}),r([V()]),Y()}catch(s){l({title:"Create failed",description:s.message,variant:"destructive"})}},Ne=async(t,s,o="append")=>{var d;if(!A)return{ok:!1,message:"Admin access required"};if(!m)return{ok:!1,message:"No Supabase client"};try{const{data:i}=await m.auth.getSession(),p=(d=i==null?void 0:i.session)==null?void 0:d.access_token,u=await fetch("/functions/v1/admin-upsert-questions",{method:"POST",headers:{"Content-Type":"application/json",...p?{Authorization:`Bearer ${p}`}:{}},body:JSON.stringify({quizId:t,items:s,mode:o})});if(u.ok)return{ok:!0};if(u.status!==404){const I=await u.json().catch(()=>({}));throw new Error((I==null?void 0:I.error)||`HTTP ${u.status}`)}}catch(i){console.warn("Edge bulk insert failed, falling back to direct RPC path",i)}try{const{error:i}=await m.rpc("admin_bulk_upsert_questions",{p_quiz_id:t,p_payload:s,p_mode:o});if(!i)return{ok:!0};console.warn("admin_bulk_upsert_questions RPC returned error, using manual inserts",i==null?void 0:i.message)}catch(i){console.warn("admin_bulk_upsert_questions RPC threw, using manual inserts",i)}o==="replace"&&await m.from("questions").delete().eq("quiz_id",t);for(const i of s){const{data:p,error:u}=await m.from("questions").insert({quiz_id:t,question_text:i.question_text}).select("id").single();if(u)return{ok:!1,message:u.message};const I=i.options.map(H=>({question_id:p.id,option_text:H.option_text,is_correct:!!H.is_correct})),{error:Z}=await m.from("options").insert(I);if(Z)return{ok:!1,message:Z.message}}return{ok:!0}},ze=async t=>{if(!window.confirm("Delete this quiz?"))return;if(!A){l({title:"Access denied",description:"Only admins can delete quizzes.",variant:"destructive"});return}if(!m)return;const{error:s}=await m.from("quizzes").delete().eq("id",t);s?l({title:"Delete failed",description:s.message,variant:"destructive"}):(l({title:"Deleted"}),Y())},Se=async t=>{if(!A){l({title:"Access denied",description:"Only admins can recompute results.",variant:"destructive"});return}if(m)try{re(t);const{error:s}=await m.rpc("admin_recompute_quiz_results",{p_quiz_id:t});if(s)throw s;try{await m.rpc("compute_results_if_due",{p_quiz_id:t})}catch(o){try{}catch(d){}}l({title:"Recomputed"})}catch(s){l({title:"Recompute failed",description:s.message,variant:"destructive"})}finally{re(null)}},le=j.useMemo(()=>{const t=Date.now(),s=[],o=[];for(const d of C){const i=d.end_time?new Date(d.end_time).getTime():null;i!==null&&t>i?o.push(d):s.push(d)}return{active:s,finished:o}},[C]),[G,O]=j.useState([]),[ce,oe]=j.useState(!1),B=j.useCallback(async()=>{if(!A){O([]);return}if(!m){O([]);return}oe(!0);try{const{data:t,error:s}=await m.from("redemptions").select("id,user_id,reward_value,reward_type,coins_required,payout_identifier,payout_channel,requested_at, profiles(username,full_name)").eq("status","pending").order("requested_at",{ascending:!1});if(s)throw s;O(t||[])}catch(t){O([])}finally{oe(!1)}},[A]),ke=j.useCallback(async t=>{if(A&&m){O(s=>s.filter(o=>o.id!==t));try{const{error:s}=await m.rpc("admin_approve_redemption",{p_redemption_id:t});if(s)throw s;l({title:"Approved",description:"Redemption approved."})}catch(s){l({title:"Approve failed",description:s.message,variant:"destructive"}),B()}}},[A,B,l]);return j.useEffect(()=>{B();const t=setInterval(B,3e4);return()=>clearInterval(t)},[B]),N?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx($,{className:"w-8 h-8 text-indigo-600 animate-spin"})}):A?e.jsxs("div",{className:"container mx-auto p-6 max-w-5xl bg-white text-gray-900 rounded-2xl shadow-sm",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6 text-gray-900",children:"Admin Dashboard"}),!Qe&&e.jsx("div",{className:"mb-6 text-sm text-amber-600",children:"Supabase env keys missing. Read-only UI only."}),e.jsx("div",{className:"flex gap-2 mb-6 flex-wrap",children:["overview","rewards","approvals","notifications"].map(t=>e.jsx("button",{onClick:()=>b(t),className:`px-3 py-1.5 rounded border text-sm transition-colors ${t===k?"bg-indigo-600 text-white border-indigo-600":"bg-gray-100 text-gray-700 border-gray-200 hover:bg-gray-200"}`,children:t},t))}),k==="overview"&&e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{children:e.jsxs(y,{onClick:()=>_(!0),className:"bg-indigo-600 hover:bg-indigo-700 text-white",children:[e.jsx(te,{className:"w-4 h-4 mr-1"}),"New Quiz"]})}),e.jsx(ue,{children:w&&e.jsxs(J.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},className:"bg-gray-50 border border-gray-200 rounded-xl p-5",children:[e.jsx("h2",{className:"font-semibold text-lg mb-4",children:"Create Quiz"}),e.jsxs("form",{onSubmit:_e,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(E,{className:"mb-1 block",children:"Category"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:ge.map(({value:t,label:s})=>e.jsx("button",{type:"button",onClick:()=>a(o=>({...o,category:t})),className:`px-3 py-1 rounded-full text-xs border ${c.category===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:s},t))})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(E,{children:"Title"}),e.jsx(D,{value:c.title,onChange:t=>a(s=>({...s,title:t.target.value})),placeholder:"Daily Quiz",required:!0})]}),e.jsxs("div",{children:[e.jsx(E,{children:"Prize Type"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["money","coins","others"].map(t=>e.jsx("button",{type:"button",onClick:()=>a(s=>({...s,prize_type:t})),className:`px-2 py-1 rounded text-xs border ${c.prize_type===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:t},t))})]})]}),e.jsx("div",{className:"grid md:grid-cols-3 gap-2",children:c.prizes.map((t,s)=>e.jsx(D,{value:t,placeholder:`${s+1}${["st","nd","rd"][s]||"th"} Prize`,onChange:o=>a(d=>{const i=[...d.prizes];return i[s]=o.target.value,{...d,prizes:i}})},s))}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(E,{children:"Start Time"}),e.jsx(D,{type:"datetime-local",value:c.start_time,onChange:t=>a(s=>({...s,start_time:t.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(E,{children:"End Time"}),e.jsx(D,{type:"datetime-local",value:c.end_time,onChange:t=>a(s=>({...s,end_time:t.target.value})),required:!0})]})]}),e.jsxs("div",{children:[e.jsx(E,{children:"Questions Mode"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["form","paste"].map(t=>e.jsx("button",{type:"button",onClick:()=>g(t),className:`px-3 py-1 rounded text-xs border ${x===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:t},t))})]}),x==="form"?e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-xs text-gray-600",children:F?"Opinion: no correct option stored.":"Mark one correct option with radio."}),n.map((t,s)=>e.jsxs("div",{className:"border border-gray-200 rounded p-3 space-y-2 bg-white",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("span",{className:"text-xs text-gray-500 w-6",children:["Q",s+1]}),e.jsx(D,{value:t.text,onChange:o=>r(d=>{const i=[...d];return i[s]={...i[s],text:o.target.value},i}),placeholder:"Question text",className:"flex-1"}),e.jsx(y,{type:"button",variant:"outline",size:"sm",className:"border-red-300 text-red-500",onClick:()=>r(o=>o.length===1?[V()]:o.filter((d,i)=>i!==s)),children:"Del"})]}),(t.options||[]).slice(0,4).map((o,d)=>e.jsxs("div",{className:"flex items-center gap-2",children:[!F&&e.jsx("input",{type:"radio",name:`q-${s}`,checked:(t.correctIndex||0)===d,onChange:()=>r(i=>{const p=[...i];return p[s]={...p[s],correctIndex:d},p})}),e.jsx(D,{value:o,onChange:i=>r(p=>{const u=[...p],I=[...u[s].options];return I[d]=i.target.value,u[s]={...u[s],options:I},u}),placeholder:`Option ${d+1}`,className:"flex-1"}),(t.options||[]).length>2&&e.jsx(y,{type:"button",size:"sm",variant:"outline",className:"border-red-300 text-red-500",onClick:()=>r(i=>{const p=[...i],u=[...p[s].options];return u.splice(d,1),p[s]={...p[s],options:u},p}),children:"X"})]},d)),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs(y,{type:"button",size:"sm",disabled:(t.options||[]).length>=4,onClick:()=>r(o=>{const d=[...o],i=[...d[s].options];return i.length<4&&i.push(""),d[s]={...d[s],options:i},d}),children:[e.jsx(te,{className:"w-4 h-4 mr-1"}),"Option"]}),e.jsx("span",{className:"text-xs text-gray-500",children:"Max 4 options"})]})]},s)),e.jsxs(y,{type:"button",onClick:()=>r(t=>[...t,V()]),children:[e.jsx(te,{className:"w-4 h-4 mr-1"}),"Question"]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{children:"Paste Questions"}),e.jsx(ie,{className:"h-40",value:c.bulk,onChange:t=>a(s=>({...s,bulk:t.target.value})),placeholder:`Q1. Capital of India?
- [ ] Mumbai
- [x] Delhi
- [ ] Kolkata
- [ ] Jaipur

Q2. ...`}),(()=>{const{items:t,errors:s,warnings:o}=Me(c.bulk,{allowZeroCorrect:F});return e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsxs("div",{children:[t.length," parsed"]}),o[0]&&e.jsx("div",{className:"text-amber-500",children:o[0]}),s[0]&&e.jsx("div",{className:"text-red-500",children:s[0]}),e.jsx(y,{type:"button",size:"sm",disabled:!!s.length||!t.length,onClick:()=>{if(s.length||!t.length)return;const d=t.map(i=>({text:i.question_text,options:i.options.map(p=>p.option_text),correctIndex:F?0:i.options.findIndex(p=>p.is_correct)>=0?i.options.findIndex(p=>p.is_correct):0}));r(d.length?d:[V()]),g("form"),l({title:"Loaded",description:`${d.length} questions moved to form.`})},children:"Load into form"})]})})()]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(y,{type:"submit",className:"bg-green-600 hover:bg-green-700",children:"Create"}),e.jsx(y,{type:"button",variant:"outline",onClick:()=>_(!1),children:"Cancel"})]})]})]})}),e.jsxs("section",{children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2 mb-3",children:[e.jsx(Ie,{className:"w-5 h-5"}),"All Quizzes"]}),q?e.jsxs("div",{className:"py-8 text-center text-gray-500",children:[e.jsx($,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading..."]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Active / Upcoming"}),e.jsx("div",{className:"space-y-4",children:le.active.map(t=>{const s=t.prize_type||"money",o=K(s,t.prize_pool,{fallback:0}),d=Array.isArray(t.prizes)?t.prizes.map(i=>K(s,i,{fallback:0})).join(", "):"";return e.jsxs(J.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"border border-gray-200 rounded-xl p-4 bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between gap-4 flex-wrap",children:[e.jsxs("div",{className:"flex-1 min-w-[240px]",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-xs text-gray-600 flex flex-wrap gap-3 mt-1",children:[e.jsxs("span",{children:["Category: ",he(t.category)||"—"]}),e.jsxs("span",{children:["Type: ",s]}),e.jsxs("span",{children:["Pool: ",o]}),e.jsxs("span",{children:["Prizes: ",d]})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[e.jsxs("span",{children:["Start: ",t.start_time?W(t.start_time):"—"]}),e.jsxs("span",{className:"ml-4",children:["End: ",t.end_time?W(t.end_time):"—"]})]})]}),e.jsxs("div",{className:"flex gap-2 items-start",children:[e.jsx(y,{size:"sm",variant:"outline",onClick:()=>Se(t.id),disabled:ae===t.id,children:ae===t.id?e.jsxs(e.Fragment,{children:[e.jsx($,{className:"w-4 h-4 mr-1 animate-spin"}),"..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Le,{className:"w-4 h-4 mr-1"}),"Recompute"]})}),e.jsxs(qe,{to:`/results/${t.id}`,className:"inline-flex items-center gap-1 px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-100 text-indigo-600",children:[e.jsx(Pe,{className:"w-4 h-4"}),"Results"]}),e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>{L(t),we(t.id),ye(!0)},className:"text-blue-400",children:[e.jsx(De,{className:"w-4 h-4 mr-1"}),"Questions"]}),e.jsx(y,{size:"sm",variant:"outline",onClick:()=>ze(t.id),className:"text-red-500",children:e.jsx($e,{className:"w-4 h-4"})})]})]}),e.jsx(ue,{children:fe&&(f==null?void 0:f.id)===t.id&&e.jsxs(J.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"mt-4 space-y-2",children:[e.jsxs("h5",{className:"font-medium flex items-center gap-2",children:["Questions for ",t.title]}),M.length===0&&e.jsx("div",{className:"text-xs text-gray-500",children:"No questions."}),M.map((i,p)=>e.jsxs("div",{className:"border border-gray-200 rounded p-3 bg-white",children:[e.jsxs("div",{className:"text-sm font-medium",children:["Q",p+1,": ",i.question_text]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:(i.options||[]).map(u=>e.jsxs("div",{className:`px-2 py-0.5 text-xs rounded-full ${u.is_correct?"bg-green-600 text-white":"bg-gray-200 text-gray-700"}`,children:[u.option_text,u.is_correct&&e.jsx("span",{className:"ml-1",children:"✓"})]},u.id))})]},i.id))]})})]},t.id)})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Finished"}),e.jsx("div",{className:"space-y-4",children:le.finished.map(t=>{const s=t.prize_type||"money",o=K(s,t.prize_pool,{fallback:0}),d=Array.isArray(t.prizes)?t.prizes.map(i=>K(s,i,{fallback:0})).join(", "):"";return e.jsxs(J.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"border border-gray-200 rounded-xl p-4 bg-gray-50",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-xs text-gray-600 flex flex-wrap gap-3 mt-1",children:[e.jsxs("span",{children:["Category: ",he(t.category)||"—"]}),e.jsxs("span",{children:["Type: ",s]}),e.jsxs("span",{children:["Pool: ",o]}),e.jsxs("span",{children:["Prizes: ",d]})]})]},t.id)})})]})]})]})]}),k==="approvals"&&e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Pending Redemptions"}),e.jsx("div",{className:"text-sm text-gray-600",children:"Approve user reward payouts after verifying their UPI ID / phone number."}),ce&&e.jsxs("div",{className:"py-8 text-center text-gray-500",children:[e.jsx($,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading pending requests..."]}),!ce&&G.length===0&&e.jsx("div",{className:"py-6 text-center text-gray-500 border border-gray-200 rounded-xl bg-gray-50",children:"No pending redemptions."}),G.length>0&&e.jsx("div",{className:"space-y-4",children:G.map(t=>{var s;return e.jsxs("div",{className:"border border-gray-200 rounded-xl p-4 bg-white shadow-sm flex flex-col md:flex-row md:items-center gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-gradient-to-br from-amber-400 to-yellow-500 flex items-center justify-center text-white font-semibold shadow",children:e.jsx("span",{className:"text-sm",children:"₹"})}),(()=>{var p,u;const o=t.reward_value,d=o&&String(o).trim().length?o:`${t.reward_type||""}`.trim()||"Reward",i=((p=t.profiles)==null?void 0:p.username)||((u=t.profiles)==null?void 0:u.full_name)||"Anonymous";return e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900 truncate",children:d}),e.jsxs("div",{className:"text-[11px] text-gray-600",children:["@",i]})]})})()]}),e.jsxs("div",{className:"mt-2 text-xs text-gray-600 flex flex-wrap gap-3",children:[e.jsxs("span",{children:["Type: ",t.reward_type||"—"]}),e.jsxs("span",{children:["Coins: ",(s=t.coins_required)!=null?s:0]}),e.jsxs("span",{children:["Requested: ",t.requested_at?W(t.requested_at):"—"]})]}),e.jsxs("div",{className:"mt-1 text-xs text-gray-500",children:["Payout: ",t.payout_identifier?`${t.payout_identifier} (${t.payout_channel||"upi"})`:"—"]})]}),e.jsx("div",{className:"flex items-center gap-2 self-start md:self-center",children:e.jsx(y,{size:"sm",onClick:()=>ke(t.id),className:"bg-green-600 hover:bg-green-700 text-white",children:"Approve"})})]},t.id)})})]}),k==="notifications"&&e.jsx(Oe,{}),k==="rewards"&&e.jsx(Fe,{})]}):e.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-2xl p-6 max-w-md w-full text-center shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-500 mb-2",children:"Admin access required"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx("span",{children:"Supabase "}),e.jsx("code",{children:"profiles"}),e.jsx("span",{children:" table mein aapke record ka "}),e.jsx("strong",{children:"role"}),e.jsx("span",{children:" field admin hona chahiye."})]}),e.jsxs("ul",{className:"text-left text-sm text-gray-600 mt-4 space-y-2 list-disc list-inside",children:[e.jsxs("li",{children:[e.jsx("span",{children:"Supabase dashboard"}),e.jsx("span",{"aria-hidden":"true",role:"presentation",className:"mx-1",children:"→"}),e.jsx("span",{children:"Table editor"}),e.jsx("span",{"aria-hidden":"true",role:"presentation",className:"mx-1",children:"→"}),e.jsx("code",{children:"profiles"}),e.jsx("span",{children:" me role update karein."})]}),e.jsx("li",{children:"Update ke baad login session refresh karein."}),e.jsxs("li",{children:["Dev bypass (",e.jsx("code",{children:"VITE_BYPASS_AUTH=1"}),") mein mock admin auto-enable hota hai."]})]})]})})}function Fe(){const{toast:l}=se(),[h,N]=S.useState([]),[v,R]=S.useState(!1),[Q,k]=S.useState(!1),[b,C]=S.useState({reward_type:"coins",reward_value:"",coins_required:"",is_active:!0}),[T,q]=S.useState(!1),[z,w]=S.useState(null),_=S.useCallback(async()=>{if(!m)return;R(!0);const{data:n,error:r}=await m.from("reward_catalog").select("id,reward_type,reward_value,coins_required,is_active").order("id",{ascending:!1}).limit(200);r?l({title:"Rewards load failed",description:r.message,variant:"destructive"}):N(n||[]),R(!1)},[l]);S.useEffect(()=>{_()},[_]);const c=()=>C({reward_type:"cash",reward_value:"",coins_required:"",is_active:!0}),a=async n=>{if(n.preventDefault(),!!m){q(!0);try{const r={reward_type:String(b.reward_type||"").trim()||"cash",reward_value:String(b.reward_value||"").trim(),coins_required:b.coins_required!==""&&b.coins_required!==null?parseInt(b.coins_required,10):null,is_active:!!b.is_active};if(!r.reward_value)throw new Error("Value required");if(r.coins_required===null||Number.isNaN(r.coins_required))throw new Error("Coins required");let f;if(z?f=await m.from("reward_catalog").update(r).eq("id",z).select().single():f=await m.from("reward_catalog").insert([r]).select().single(),f.error)throw f.error;l({title:z?"Reward updated":"Reward created"}),c(),k(!1),w(null),_()}catch(r){l({title:"Save failed",description:r.message,variant:"destructive"})}finally{q(!1)}}},x=async n=>{if(!m)return;const{error:r}=await m.from("reward_catalog").update({is_active:!n.is_active}).eq("id",n.id);r?l({title:"Toggle failed",description:r.message,variant:"destructive"}):(l({title:n.is_active?"Deactivated":"Activated"}),_())},g=n=>{var r;w(n.id),k(!0),C({reward_type:n.reward_type||"cash",reward_value:n.reward_value||"",coins_required:((r=n.coins_required)!=null?r:"").toString(),is_active:!!n.is_active})};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Redemptions auto-approved hain. Neeche sirf Rewards Catalog manage karna hai."}),e.jsxs("div",{className:"pt-10 border-t border-gray-200 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Rewards Catalog"}),e.jsx(y,{size:"sm",onClick:()=>{k(n=>!n),Q||(c(),w(null))},children:Q?"Close":"New Reward"}),e.jsx(y,{size:"sm",variant:"outline",onClick:_,disabled:v,children:v?e.jsx($,{className:"w-4 h-4 animate-spin"}):"Refresh"})]}),Q&&e.jsxs("form",{onSubmit:a,className:"space-y-3 bg-gray-50 border border-gray-200 rounded-lg p-4 max-w-3xl",children:[e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(E,{children:"Type"}),e.jsx("div",{className:"flex gap-2 flex-wrap mt-1",children:["cash","voucher"].map(n=>e.jsx("button",{type:"button",onClick:()=>C(r=>({...r,reward_type:n})),className:`px-2 py-1 rounded text-xs border ${b.reward_type===n?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:n==="cash"?"💵 Cash (UPI/Phone)":"🎟️ Voucher (WhatsApp)"},n))}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:b.reward_type==="cash"?"User will provide UPI ID or Phone number":"User will provide WhatsApp number"})]}),e.jsxs("div",{children:[e.jsx(E,{children:"Value"}),e.jsx(D,{value:b.reward_value,onChange:n=>C(r=>({...r,reward_value:n.target.value})),placeholder:"e.g. 100 / AMAZON100 / ₹100"})]}),e.jsxs("div",{children:[e.jsx(E,{children:"Coins Required"}),e.jsx(D,{type:"number",value:b.coins_required,onChange:n=>C(r=>({...r,coins_required:n.target.value})),placeholder:"coins needed"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"is_active",type:"checkbox",checked:!!b.is_active,onChange:n=>C(r=>({...r,is_active:n.target.checked}))}),e.jsx("label",{htmlFor:"is_active",className:"text-sm",children:"Active"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{type:"submit",disabled:T,children:T?e.jsxs(e.Fragment,{children:[e.jsx($,{className:"w-4 h-4 mr-1 animate-spin"}),"Saving"]}):z?"Update":"Create"}),e.jsx(y,{type:"button",variant:"outline",onClick:()=>{c(),w(null)},children:z?"Cancel Edit":"Reset"})]})]}),e.jsx("div",{className:"overflow-x-auto rounded-lg border border-gray-200",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-100 text-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Type"}),e.jsx("th",{className:"p-2 text-left",children:"Value"}),e.jsx("th",{className:"p-2 text-left",children:"Coins Required"}),e.jsx("th",{className:"p-2 text-left",children:"Active"}),e.jsx("th",{className:"p-2 text-left",children:"Actions"})]})}),e.jsxs("tbody",{children:[h.map(n=>{var r;return e.jsxs("tr",{className:"border-t border-gray-200 hover:bg-gray-100",children:[e.jsx("td",{className:"p-2 capitalize",children:n.reward_type}),e.jsx("td",{className:"p-2 max-w-[260px] truncate",title:n.reward_value,children:n.reward_value}),e.jsx("td",{className:"p-2",children:(r=n.coins_required)!=null?r:"—"}),e.jsx("td",{className:"p-2",children:n.is_active?e.jsx("span",{className:"text-green-500",children:"Yes"}):e.jsx("span",{className:"text-gray-500",children:"No"})}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(y,{size:"sm",variant:"outline",onClick:()=>g(n),children:"Edit"}),e.jsx(y,{size:"sm",variant:"outline",onClick:()=>x(n),children:n.is_active?"Deactivate":"Activate"})]})})]},n.id)}),!h.length&&!v&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"p-4 text-center text-gray-500",children:"No rewards."})}),v&&e.jsx("tr",{children:e.jsxs("td",{colSpan:8,className:"p-6 text-center text-gray-500",children:[e.jsx($,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading rewards..."]})})]})]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"Catalog: inactive rewards are hidden from users."})]})]})}function Oe(){const{toast:l}=se(),[h,N]=S.useState(""),[v,R]=S.useState(""),[Q,k]=S.useState("all"),[b,C]=S.useState(!1),[T,q]=S.useState([]),[z,w]=S.useState(!1),_=S.useCallback(async()=>{if(!m)return;w(!0);const{data:a,error:x}=await m.from("notifications").select("id,title,message,type,segment,created_at").order("created_at",{ascending:!1}).limit(100);x?l({title:"Fetch failed",description:x.message,variant:"destructive"}):q(a||[]),w(!1)},[l]);S.useEffect(()=>{_()},[_]);const c=async a=>{var x;if(a.preventDefault(),!h.trim()||!v.trim()){l({title:"Missing fields",variant:"destructive"});return}if(!m){l({title:"No backend client",variant:"destructive"});return}C(!0);try{const g={title:h.trim(),message:v.trim(),segment:Q},{data:n}=await m.auth.getSession(),r=(x=n==null?void 0:n.session)==null?void 0:x.access_token,{data:f,error:L}=await m.functions.invoke("send-notifications",{body:g,headers:r?{Authorization:`Bearer ${r}`}:void 0});if(L)throw new Error(L.message||L.error||"Failed to send notification");const M=typeof f=="object"&&(f!=null&&f.message)?f.message:h.trim();l({title:"Sent",description:M}),N(""),R(""),_()}catch(g){l({title:"Send failed",description:g.message,variant:"destructive"})}finally{C(!1)}};return e.jsxs("div",{className:"space-y-8 max-w-3xl",children:[e.jsxs("form",{onSubmit:c,className:"space-y-4 bg-gray-50 border border-gray-200 rounded-xl p-5",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Send Notification"}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"notification-title",children:"Title"}),e.jsx(D,{id:"notification-title",name:"notificationTitle",value:h,onChange:a=>N(a.target.value),maxLength:80,placeholder:"Short title"}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Max 80 chars • ",h.length,"/80"]})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"notification-message",children:"Message"}),e.jsx(ie,{id:"notification-message",name:"notificationMessage",value:v,onChange:a=>R(a.target.value),className:"h-28",maxLength:280,placeholder:"Body shown in push notification"}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Max 280 chars • ",v.length,"/280"]})]}),e.jsxs("div",{children:[e.jsx(E,{children:"Segment"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["all"].map(a=>e.jsx("button",{type:"button",onClick:()=>k(a),className:`px-3 py-1 rounded text-xs border ${Q===a?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:a},a))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{type:"submit",disabled:b,children:b?e.jsxs(e.Fragment,{children:[e.jsx($,{className:"w-4 h-4 mr-1 animate-spin"}),"Sending"]}):"Send"}),e.jsx(y,{type:"button",variant:"outline",onClick:()=>{N(""),R("")},children:"Reset"})]})]}),e.jsxs("section",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Recent Notifications"}),e.jsx(y,{size:"sm",variant:"outline",onClick:_,disabled:z,children:z?e.jsx($,{className:"w-4 h-4 animate-spin"}):"Refresh"})]}),e.jsxs("div",{className:"space-y-3",children:[T.map(a=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-3 bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between gap-4 flex-wrap",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:a.title}),e.jsx("div",{className:"text-xs text-gray-600 whitespace-pre-wrap max-w-xl break-words",children:a.message})]}),e.jsx("div",{className:"text-[10px] text-gray-500",children:W(a.created_at)})]}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Segment: ",a.segment||"—",a.type?` • ${a.type}`:""]})]},a.id)),!T.length&&!z&&e.jsx("div",{className:"text-xs text-gray-500",children:"No notifications yet."})]})]})]})}export{He as default};
