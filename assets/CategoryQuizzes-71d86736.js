import{u as ne,a as ae,i as oe,s as v,j as t,f as B,d as T,m as de,g as le}from"./index-5033e0b8.js";import{r as u}from"./react-63c462fe.js";import{S as ce}from"./SEO-ded81176.js";import{c as me,a as ue}from"./router-10fed1f4.js";import{e as pe,d as xe,b as U,B as ge,T as fe,c as he}from"./icons-590232b1.js";import"./supabase-07ebd5d8.js";const S=new Map;function be(d,{max:o=5,windowMs:p=8e3}={}){const c=Date.now(),f=S.get(d);return f?c-f.firstTs>p?(S.set(d,{count:1,firstTs:c}),{allowed:!0,remaining:o-1}):f.count>=o?{allowed:!1,remaining:0}:(f.count+=1,{allowed:!0,remaining:o-f.count}):(S.set(d,{count:1,firstTs:c}),{allowed:!0,remaining:o-1})}function we(d){const o="px-2 py-0.5 rounded-full text-xs font-semibold";return d==="active"?o+" bg-green-600/15 text-green-400 border border-green-700/40":d==="upcoming"?o+" bg-blue-600/15 text-blue-300 border border-blue-700/40":o+" bg-slate-600/20 text-slate-300 border border-slate-700/40"}function je(d=""){const o=String(d||"").toLowerCase();return o.includes("opinion")?{title:"Opinion Quizzes",emoji:"ðŸ’¬",Icon:U,from:"from-indigo-600/30",to:"to-fuchsia-600/30",ring:"ring-fuchsia-500/30"}:o.includes("gk")?{title:"GK Quizzes",emoji:"ðŸ§ ",Icon:ge,from:"from-emerald-600/30",to:"to-teal-600/30",ring:"ring-emerald-500/30"}:o.includes("sport")?{title:"Sports Quizzes",emoji:"ðŸ†",Icon:fe,from:"from-orange-600/30",to:"to-red-600/30",ring:"ring-orange-500/30"}:o.includes("movie")?{title:"Movie Quizzes",emoji:"ðŸŽ¬",Icon:he,from:"from-violet-600/30",to:"to-indigo-600/30",ring:"ring-violet-500/30"}:{title:`${d} Quizzes`,emoji:"â­",Icon:U,from:"from-sky-600/30",to:"to-indigo-600/30",ring:"ring-sky-500/30"}}const Te=()=>{const{slug:d}=me(),o=ue(),{toast:p}=ne(),{user:c}=ae(),{isSubscribed:f,subscribeToPush:W}=oe(),[l,G]=u.useState([]),[K,$]=u.useState(!0),[_,M]=u.useState(null),[H,E]=u.useState({}),[R,b]=u.useState({}),[V,F]=u.useState(0),I=u.useCallback(async()=>{try{const{data:e,error:s}=await v.from("quizzes").select("id,title,category,start_time,end_time,status,prize_pool,prizes,prize_type").eq("category",d).order("start_time",{ascending:!0});if(s)throw s;G(e||[])}catch(e){p({title:"Error",description:"Could not load quizzes.",variant:"destructive"})}finally{$(!1)}},[d,p]);u.useEffect(()=>{$(!0),I()},[I]),u.useEffect(()=>{const e=Date.now();if(!(l||[]).some(i=>{const a=i.start_time?new Date(i.start_time).getTime():0,n=i.end_time?new Date(i.end_time).getTime():0;return a&&e<a||a&&n&&e>=a&&e<n}))return;const r=setInterval(()=>F(i=>(i+1)%1e6),1e3);return()=>clearInterval(r)},[l]),u.useEffect(()=>{const e=async()=>{try{const s=(l||[]).map(n=>n.id);if(!s.length){E({});return}const{data:r,error:i}=await v.rpc("get_engagement_counts_many",{p_quiz_ids:s});if(i)throw i;const a={};for(const n of r||[]){const m=n.pre_joined||0,g=n.joined||0;a[n.quiz_id]=m+g}E(a)}catch(s){}};l&&l.length&&e()},[l]),u.useEffect(()=>{(async()=>{if(!c||!(l!=null&&l.length)){b({});return}try{const s=l.map(n=>n.id),{data:r,error:i}=await v.from("quiz_participants").select("quiz_id,status").eq("user_id",c.id).in("quiz_id",s);if(i)throw i;const a={};for(const n of r||[])a[n.quiz_id]=n.status==="pre_joined"?"pre":"joined";b(a)}catch(s){b({})}})()},[c,l]);const X=async e=>{if(!c){p({title:"Login required",description:"Please sign in to join the quiz.",variant:"destructive"}),o("/login");return}try{typeof Notification!="undefined"&&Notification.permission!=="granted"&&!f&&await W()}catch(s){}M(e.id);try{const s=Date.now(),r=e.start_time?new Date(e.start_time).getTime():0,i=e.end_time?new Date(e.end_time).getTime():0,a=r&&i&&s>=r&&s<i,n=r&&s<r,m=n?"pre_join_quiz":a?"join_quiz":"pre_join_quiz",{error:g}=await v.rpc(m,{p_quiz_id:e.id});if(g){const x=String(g.message||"").toLowerCase();if(m==="join_quiz"&&(x.includes("not active")||x.includes("bad request")||x.includes("400"))){const{error:w}=await v.rpc("pre_join_quiz",{p_quiz_id:e.id});if(!w){b(z=>({...z,[e.id]:"pre"})),p({title:"Pre-joined!",description:"We will remind you before start."});return}}throw g}if(b(x=>({...x,[e.id]:a?"joined":"pre"})),n)p({title:"Pre-joined!",description:"We will remind you before start."});else{if(!be(`join_${(c==null?void 0:c.id)||"anon"}`,{max:4,windowMs:8e3}).allowed){p({title:"Slow down",description:"Please wait a moment before trying again.",variant:"destructive"});return}p({title:"Joined!",description:"Taking you to the quiz."}),o(`/quiz/${e.id}`)}}catch(s){p({title:"Error",description:s.message||"Could not join quiz.",variant:"destructive"})}finally{M(null)}},C=l.filter(e=>{const s=Date.now(),r=e.start_time?new Date(e.start_time).getTime():0,i=e.end_time?new Date(e.end_time).getTime():0,a=r&&i&&s>=r&&s<i,n=r&&s<r;return a||n}),h=je(d),y=Date.now(),Y=(l||[]).reduce((e,s)=>{const r=s.start_time?new Date(s.start_time).getTime():0,i=s.end_time?new Date(s.end_time).getTime():0;return e+(r&&i&&y>=r&&y<i?1:0)},0),Z=(l||[]).reduce((e,s)=>{const r=s.start_time?new Date(s.start_time).getTime():0;return e+(r&&y<r?1:0)},0),N=(l||[]).map(e=>e.start_time?new Date(e.start_time).getTime():null).filter(e=>e&&e>y).sort((e,s)=>e-s)[0]||null,q=typeof window!="undefined"?`${window.location.origin}/category/${d}/`:`https://quizdangal.com/category/${d}/`;return t.jsxs("div",{className:"container mx-auto px-4 py-3 text-foreground",children:[t.jsx(ce,{title:`${h.title} â€“ Quiz Dangal`,description:`Active and upcoming quizzes in ${h.title}.`,canonical:q,robots:"index, follow"}),t.jsx("span",{className:"hidden","aria-hidden":!0,children:V}),t.jsxs("div",{className:`relative overflow-hidden rounded-2xl border border-slate-800 bg-gradient-to-r ${h.from} ${h.to} shadow-xl mb-4`,children:[t.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{background:"radial-gradient(700px 180px at -10% -20%, rgba(255,255,255,0.07), transparent), radial-gradient(420px 100px at 110% 10%, rgba(255,255,255,0.05), transparent)"}}),t.jsx("div",{className:"px-4 py-4 sm:px-5 sm:py-5",children:t.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:t.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[t.jsx("div",{className:"shrink-0 grid place-items-center w-10 h-10 sm:w-12 sm:h-12 rounded-xl ring-2 ring-white/20 bg-white/10 text-white text-xl sm:text-2xl shadow","aria-hidden":!0,children:h.emoji}),t.jsxs("div",{className:"min-w-0",children:[t.jsx("h1",{className:"truncate text-base sm:text-xl font-extrabold text-white tracking-tight drop-shadow-sm",children:h.title}),t.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-2 text-[11px] text-white/85",children:[t.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-600/20 text-emerald-200 border border-emerald-500/30",children:[Y," live"]}),t.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-sky-600/20 text-sky-200 border border-sky-500/30",children:[Z," upcoming"]}),N&&t.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/10 text-white/90 border border-white/20",children:[t.jsx(pe,{className:"w-3.5 h-3.5"})," Next: ",B(N)," â€¢ ",T(N)]})]})]})]})})})]}),K?t.jsx("div",{className:"grid gap-3",children:Array.from({length:4}).map((e,s)=>t.jsx("div",{className:"h-24 rounded-xl bg-slate-800/60 border border-slate-700/60 animate-pulse"},s))}):C.length===0?t.jsx("div",{className:"text-center text-muted-foreground py-16",children:"No quizzes in this category yet."}):t.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4",children:C.map((e,s)=>{var Q,A,L;const r=Date.now(),i=e.start_time?new Date(e.start_time).getTime():null,a=e.end_time?new Date(e.end_time).getTime():null,n=i&&a&&r>=i&&r<a,m=i&&r<i,g=n||m,x=m&&i?Math.max(0,Math.floor((i-r)/1e3)):n&&a?Math.max(0,Math.floor((a-r)/1e3)):null,w=Array.isArray(e.prizes)?e.prizes:[],z=e.prize_type||"coins",ee=(Q=w[0])!=null?Q:0,te=(A=w[1])!=null?A:0,se=(L=w[2])!=null?L:0,k=j=>le(z,j,{fallback:0}).formatted,ie=H[e.id]||0,P=R[e.id],D=!!P,re=_===e.id||D||!g,J=i&&a?Math.max(1,a-i):null,O=n&&J?Math.min(100,Math.max(0,Math.round((r-i)/J*100))):null;return t.jsxs(de.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:s*.03},onClick:()=>o(`/quiz/${e.id}`),className:`relative overflow-hidden rounded-2xl border ${n?"border-emerald-700/50":"border-slate-800"} bg-gradient-to-br from-slate-950/90 via-slate-900/85 to-slate-900/60 shadow-xl cursor-pointer group hover:-translate-y-0.5 transition-transform`,role:"button",tabIndex:0,onKeyDown:j=>{j.key==="Enter"&&o(`/quiz/${e.id}`)},children:[t.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{background:"radial-gradient(1200px 300px at -10% -10%, rgba(99,102,241,0.06), transparent), radial-gradient(900px 200px at 110% 20%, rgba(16,185,129,0.05), transparent)"}}),t.jsxs("div",{className:"absolute top-3 right-3 z-10 flex gap-2",children:[n&&t.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-extrabold tracking-widest bg-rose-600 text-white ring-1 ring-rose-300/50 shadow",children:"LIVE"}),m&&t.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-extrabold tracking-widest bg-sky-600 text-white ring-1 ring-sky-300/50 shadow",children:"SOON"})]}),t.jsxs("div",{className:"p-4 sm:p-5",children:[t.jsx("div",{className:"flex items-center justify-between gap-3",children:t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[t.jsx("div",{className:"w-full font-semibold text-slate-100 text-base sm:text-lg whitespace-normal break-words leading-snug pr-12 sm:pr-16",children:e.title}),t.jsx("span",{className:we(n?"active":m?"upcoming":"finished"),children:n?"active":m?"upcoming":"finished"}),P&&t.jsx("span",{className:`px-2 py-0.5 rounded-full text-[10px] font-semibold border ${n?"bg-emerald-500/15 text-emerald-300 border-emerald-700/40":"bg-indigo-500/15 text-indigo-300 border-indigo-700/40"}`,children:"Joined"})]}),t.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs",children:[t.jsxs("span",{className:"px-2.5 py-1.5 rounded-lg bg-gradient-to-r from-amber-500/20 to-amber-400/10 text-amber-200 border border-amber-500/30 shadow-sm",children:["ðŸ¥‡ ",k(ee)]}),t.jsxs("span",{className:"px-2.5 py-1.5 rounded-lg bg-gradient-to-r from-sky-500/20 to-sky-400/10 text-sky-200 border border-sky-500/30 shadow-sm",children:["ðŸ¥ˆ ",k(te)]}),t.jsxs("span",{className:"px-2.5 py-1.5 rounded-lg bg-gradient-to-r from-violet-500/20 to-violet-400/10 text-violet-200 border border-violet-500/30 shadow-sm",children:["ðŸ¥‰ ",k(se)]})]}),t.jsxs("div",{className:"mt-2",children:[t.jsx("div",{className:"text-[11px] text-slate-400",children:e.start_time?B(e.start_time):"â€”"}),t.jsxs("div",{className:"mt-1 grid grid-cols-1 sm:grid-cols-2 gap-2 text-[11px] text-slate-300",children:[t.jsxs("div",{className:"bg-slate-800/50 border border-slate-700 rounded-md px-2 py-1",children:[t.jsx("span",{className:"uppercase text-[9px] text-slate-400",children:"Start"}),t.jsx("div",{children:e.start_time?T(e.start_time):"â€”"})]}),t.jsxs("div",{className:"bg-slate-800/50 border border-slate-700 rounded-md px-2 py-1",children:[t.jsx("span",{className:"uppercase text-[9px] text-slate-400",children:"End"}),t.jsx("div",{children:e.end_time?T(e.end_time):"â€”"})]})]})]}),x!==null&&t.jsxs("div",{className:"mt-2 text-sm font-semibold text-indigo-300",children:[m?"Starts in":"Ends in"," ",Math.floor(x/60).toString().padStart(2,"0"),":",(x%60).toString().padStart(2,"0")]}),t.jsx("div",{className:"mt-1 flex items-center gap-4 text-xs text-slate-400",children:t.jsxs("span",{className:"inline-flex items-center",children:[t.jsx(xe,{className:"w-3.5 h-3.5 mr-1"}),ie," joined"]})}),O!==null&&t.jsx("div",{className:"mt-2 w-full bg-slate-800/50 border border-slate-700/70 rounded-full h-1 overflow-hidden",children:t.jsx("div",{className:"h-1 bg-emerald-500/80",style:{width:`${O}%`}})})]})}),t.jsx("div",{className:"mt-3 flex",children:t.jsx("button",{onClick:j=>{j.stopPropagation(),D?o(`/quiz/${e.id}`):X(e)},disabled:_===e.id||!g,className:`relative w-full px-4 py-2.5 rounded-lg text-sm sm:text-base font-extrabold border text-white transition focus:outline-none focus:ring-2 focus:ring-fuchsia-300 overflow-hidden ${re?"opacity-80 cursor-not-allowed":"hover:scale-[1.015] active:scale-[0.99] hover:shadow-[0_12px_24px_rgba(139,92,246,0.55)]"} shadow-[0_8px_18px_rgba(139,92,246,0.4)] border-violet-500/40 bg-[linear-gradient(90deg,#4f46e5,#7c3aed,#9333ea,#c026d3)]`,children:t.jsx("span",{className:"inline-flex items-center justify-center gap-2",children:D?"JOINED":_===e.id?"JOININGâ€¦":"JOIN"})})})]})]},e.id)})})]})};export{Te as default};
