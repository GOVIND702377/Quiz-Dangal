import{j as e,c as Z,a as ee,u as J,s as d,B as c,L as u,I as o}from"./index-aebac8b0.js";import{a as te,r as n}from"./react-8a702e3e.js";import{d as se}from"./router-bcacfb8d.js";import{m as K}from"./motion-511bde03.js";import{J as V,L as T,K as ie,N as ae,O as $,Q as re}from"./icons-b32a7949.js";import"./supabase-4c1332f7.js";const G=te.forwardRef(({className:m,...r},w)=>e.jsx("textarea",{ref:w,className:Z("flex w-full rounded-md border border-input bg-background px-3 py-2 text-base sm:text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 min-h-[80px] resize-vertical",m),...r}));G.displayName="Textarea";function ne(){const{toast:m}=J(),[r,w]=n.useState(""),[S,b]=n.useState(""),[A,D]=n.useState("announcement"),[C,R]=n.useState(""),[k,L]=n.useState(""),[_,h]=n.useState(!1),[E,M]=n.useState([]),[I,Q]=n.useState(!0),[q,F]=n.useState(""),[z,i]=n.useState(""),[x,j]=n.useState(!1),v=async()=>{Q(!0);const{data:a,error:p}=await d.from("notifications").select("*").order("created_at",{ascending:!1}).limit(20);p?m({title:"Load failed",description:p.message,variant:"destructive"}):M(a||[]),Q(!1)};n.useEffect(()=>{v()},[]);const U=async a=>{if(a.preventDefault(),!q.trim()||!z.trim()){m({title:"Title/Message required",variant:"destructive"});return}j(!0);try{const{error:p}=await d.functions.invoke("send-notifications",{body:{title:q.trim(),message:z.trim()}});if(p)throw p;m({title:"Push sent",description:"Notifications queued to subscribers."}),F(""),i("")}catch(p){m({title:"Push failed",description:p.message||"Try again later",variant:"destructive"})}finally{j(!1)}},B=async a=>{if(a.preventDefault(),!r.trim()||!S.trim()){m({title:"Title/Message required",variant:"destructive"});return}h(!0);try{const p={p_title:r.trim(),p_message:S.trim(),p_type:A,p_quiz_id:C||null,p_scheduled_at:k?new Date(k).toISOString():null},{error:O}=await d.rpc("create_notification",p);if(O)throw O;m({title:"Notification queued",description:"It will be delivered per schedule."}),w(""),b(""),R(""),L(""),D("announcement"),await v()}catch(p){m({title:"Send failed",description:p.message,variant:"destructive"})}finally{h(!1)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent flex items-center",children:[e.jsx(re,{className:"mr-2"})," Admin: Notifications"]}),e.jsx("p",{className:"text-gray-600 text-sm",children:"Announcements aur quiz notifications yahan se bhejein"})]})}),e.jsxs("div",{className:"bg-white/80 backdrop-blur-md border border-gray-200/50 rounded-2xl p-4 shadow-lg mb-6",children:[e.jsx("h3",{className:"text-xl font-bold text-gray-800 mb-4",children:"Send Push Notification"}),e.jsxs("form",{onSubmit:U,className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"pushTitle",children:"Push Notification Title *"}),e.jsx(o,{id:"pushTitle",value:q,onChange:a=>F(a.target.value),placeholder:"e.g., New Quiz Alert!",required:!0})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"pushMessage",children:"Push Notification Message *"}),e.jsx(G,{id:"pushMessage",value:z,onChange:a=>i(a.target.value),placeholder:"Don't miss out on today's quiz!",required:!0})]}),e.jsx(c,{type:"submit",disabled:x,className:"bg-purple-600 hover:bg-purple-700",children:x?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"w-4 h-4 mr-2 animate-spin"}),"Sending Push..."]}):"Send Push Notification"})]})]}),e.jsx("div",{className:"bg-white/80 backdrop-blur-md border border-gray-200/50 rounded-2xl p-4 shadow-lg",children:e.jsxs("form",{onSubmit:B,className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"ntitle",children:"Title *"}),e.jsx(o,{id:"ntitle",value:r,onChange:a=>w(a.target.value),placeholder:"e.g., Quiz Starting Soon",required:!0})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"ntype",children:"Type *"}),e.jsxs("select",{id:"ntype",value:A,onChange:a=>D(a.target.value),className:"w-full border rounded-md px-3 py-2",children:[e.jsx("option",{value:"announcement",children:"Announcement"}),e.jsx("option",{value:"quiz_start",children:"Quiz Start"}),e.jsx("option",{value:"quiz_end",children:"Quiz End"}),e.jsx("option",{value:"quiz_result",children:"Quiz Result"})]})]})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"nmsg",children:"Message *"}),e.jsx(G,{id:"nmsg",value:S,onChange:a=>b(a.target.value),placeholder:"Write your message...",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"nquiz",children:"Quiz ID (optional)"}),e.jsx(o,{id:"nquiz",value:C,onChange:a=>R(a.target.value),placeholder:"UUID of quiz"})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"nsched",children:"Schedule (optional)"}),e.jsx(o,{id:"nsched",type:"datetime-local",value:k,onChange:a=>L(a.target.value)})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{type:"submit",disabled:_,className:"bg-indigo-600 hover:bg-indigo-700",children:_?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"w-4 h-4 mr-2 animate-spin"}),"Sending..."]}):"Send Notification"}),e.jsx(c,{type:"button",variant:"outline",onClick:v,children:"Refresh"})]})]})}),e.jsxs("div",{className:"bg-white/80 backdrop-blur-md border border-gray-200/50 rounded-2xl p-4 shadow-lg",children:[e.jsx("h3",{className:"font-semibold text-gray-800 mb-3",children:"Recent"}),I?e.jsxs("div",{className:"py-8 text-center text-gray-600",children:[e.jsx(T,{className:"inline-block h-6 w-6 animate-spin text-indigo-500 mr-2"})," Loading..."]}):E.length===0?e.jsx("div",{className:"py-8 text-center text-gray-600",children:"No notifications"}):e.jsx("div",{className:"space-y-2",children:E.map(a=>e.jsx("div",{className:"p-3 rounded-xl bg-white/70 border border-gray-200/50 flex items-center justify-between text-sm",children:e.jsxs("div",{children:[e.jsxs("div",{className:"font-semibold text-gray-800",children:[a.title," ",e.jsxs("span",{className:"text-xs text-gray-500",children:["(",a.type,")"]})]}),e.jsx("div",{className:"text-gray-600",children:a.message}),e.jsxs("div",{className:"text-gray-500 text-xs",children:["Quiz: ",a.quiz_id||"—"," • Scheduled: ",a.scheduled_at?new Date(a.scheduled_at).toLocaleString():"now"," • Created: ",new Date(a.created_at).toLocaleString()]})]})},a.id))})]})]})}function he(){const{userProfile:m}=ee(),{toast:r}=J(),[w,S]=se(),b=w.get("tab")||"overview",A=t=>{const s=new URLSearchParams(w);s.set("tab",t),S(s,{replace:!1})};if((m==null?void 0:m.role)!=="admin")return e.jsxs("div",{className:"container mx-auto px-4 py-8 text-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-red-600",children:"Access Denied"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Aapke paas admin adhikaar nahi hain."})]});const[D,C]=n.useState([]),[R,k]=n.useState(!0),[L,_]=n.useState(!1),[h,E]=n.useState(null),[M,I]=n.useState(!1),[Q,q]=n.useState([]),[F,z]=n.useState(null),[i,x]=n.useState({title:"",entry_fee:"",prizes:["","",""],start_time:"",end_time:"",result_time:"",category:""});n.useEffect(()=>{b==="overview"&&j()},[b]);const j=async()=>{try{const{data:t,error:s}=await d.from("quizzes").select("*").order("start_time",{ascending:!1});if(s)throw s;C(t||[])}catch(t){r({title:"Error",description:"Failed to fetch quizzes.",variant:"destructive"})}finally{k(!1)}},v=async t=>{try{const{data:s,error:l}=await d.from("questions").select("id, question_text, options ( id, option_text, is_correct )").eq("quiz_id",t);if(l)throw l;q(s||[])}catch(s){r({title:"Error",description:"Failed to fetch questions.",variant:"destructive"})}},U=async()=>{if(!h)return;const t=window.prompt("Question text daalein");if(!t||!t.trim())return;const{error:s}=await d.from("questions").insert({quiz_id:h.id,question_text:t.trim()});if(s)return r({title:"Add failed",description:s.message,variant:"destructive"});await v(h.id)},B=async(t,s)=>{const l=(s||"").trim();if(!l)return r({title:"Question khaali nahi ho sakta",variant:"destructive"});const{error:g}=await d.from("questions").update({question_text:l}).eq("id",t);if(g)return r({title:"Update failed",description:g.message,variant:"destructive"});await v(h.id)},a=async t=>{if(!confirm("Is question aur iske options ko delete karein?"))return;const{error:s}=await d.from("questions").delete().eq("id",t);if(s)return r({title:"Delete failed",description:s.message,variant:"destructive"});await v(h.id)},p=async t=>{const s=window.prompt("Option text daalein");if(!s||!s.trim())return;const{error:l}=await d.from("options").insert({question_id:t,option_text:s.trim()});if(l)return r({title:"Add failed",description:l.message,variant:"destructive"});await v(h.id)},O=async(t,s)=>{const l=(s||"").trim();if(!l)return r({title:"Option khaali nahi ho sakta",variant:"destructive"});const{error:g}=await d.from("options").update({option_text:l}).eq("id",t);if(g)return r({title:"Update failed",description:g.message,variant:"destructive"});await v(h.id)},W=async t=>{if(!confirm("Is option ko delete karein?"))return;const{error:s}=await d.from("options").delete().eq("id",t);if(s)return r({title:"Delete failed",description:s.message,variant:"destructive"});await v(h.id)},H=async t=>{t.preventDefault();try{const s=i.prizes.filter(N=>N).map(N=>parseInt(N)),l=s.reduce((N,y)=>N+y,0),{data:g,error:P}=await d.from("quizzes").insert([{title:i.title,entry_fee:parseFloat(i.entry_fee),prize_pool:l,prizes:s,start_time:i.start_time,end_time:i.end_time,result_time:i.result_time,status:"upcoming",category:i.category||null}]).select("id").single();if(P)throw P;r({title:"Success",description:"Quiz create ho gaya."}),_(!1),x({title:"",entry_fee:"",prizes:["","",""],start_time:"",end_time:"",result_time:"",category:""}),j()}catch(s){r({title:"Error",description:s.message,variant:"destructive"})}},X=async t=>{if(confirm("Kya aap is quiz ko delete karna chahte hain?"))try{const{error:s}=await d.from("quizzes").delete().eq("id",t);if(s)throw s;r({title:"Success",description:"Quiz delete ho gaya."}),j()}catch(s){r({title:"Error",description:s.message,variant:"destructive"})}},Y=async t=>{try{z(t);const{error:s}=await d.rpc("admin_recompute_quiz_results",{p_quiz_id:t});if(s)throw s;r({title:"Results recomputed",description:"Leaderboard update ho gaya."})}catch(s){r({title:"Recompute failed",description:s.message,variant:"destructive"})}finally{z(null)}};return e.jsxs("div",{className:"container mx-auto px-4 py-8 max-w-6xl",children:[e.jsxs(K.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2",children:"Quiz Dangal Admin"}),e.jsx("p",{className:"text-gray-600",children:"Admin dashboard"})]}),e.jsx("div",{className:"flex gap-2 flex-wrap mb-6",children:[{key:"overview",title:"Overview"},{key:"notifications",title:"Notifications"}].map(t=>e.jsx("button",{onClick:()=>A(t.key),className:`px-3 py-2 rounded-lg border text-sm transition-colors ${t.key===b?"bg-indigo-600 text-white border-indigo-600":"bg-white border-gray-200 hover:bg-gray-50"}`,children:t.title},t.key))}),b==="overview"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-6",children:e.jsxs(c,{onClick:()=>_(!0),className:"bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white",children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),"Create New Quiz"]})}),L&&e.jsxs(K.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"bg-white/80 backdrop-blur-md border border-gray-200/50 rounded-2xl p-6 shadow-lg mb-8",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-1",children:"Create New Quiz"}),e.jsxs("form",{onSubmit:H,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"title",children:"Quiz Title"}),e.jsx(o,{id:"title",value:i.title,onChange:t=>x({...i,title:t.target.value}),placeholder:"Daily Opinion Quiz - Evening",required:!0})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"entry_fee",children:"Entry Fee (₹)"}),e.jsx(o,{id:"entry_fee",type:"number",step:"0.01",value:i.entry_fee,onChange:t=>x({...i,entry_fee:t.target.value}),placeholder:"11.00",required:!0})]})]}),e.jsxs("div",{children:[e.jsx(u,{children:"Prize Distribution (₹)"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(o,{placeholder:"1st Prize (251)",value:i.prizes[0],onChange:t=>{const s=[...i.prizes];s[0]=t.target.value,x({...i,prizes:s})}}),e.jsx(o,{placeholder:"2nd Prize (151)",value:i.prizes[1],onChange:t=>{const s=[...i.prizes];s[1]=t.target.value,x({...i,prizes:s})}}),e.jsx(o,{placeholder:"3rd Prize (51)",value:i.prizes[2],onChange:t=>{const s=[...i.prizes];s[2]=t.target.value,x({...i,prizes:s})}})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx(u,{htmlFor:"start_time",children:"Start Time"}),e.jsx(o,{id:"start_time",type:"datetime-local",value:i.start_time,onChange:t=>x({...i,start_time:t.target.value}),required:!0})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"end_time",children:"End Time"}),e.jsx(o,{id:"end_time",type:"datetime-local",value:i.end_time,onChange:t=>x({...i,end_time:t.target.value}),required:!0})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"result_time",children:"Result Time"}),e.jsx(o,{id:"result_time",type:"datetime-local",value:i.result_time,onChange:t=>x({...i,result_time:t.target.value}),required:!0})]}),e.jsxs("div",{children:[e.jsx(u,{htmlFor:"category",children:"Category"}),e.jsx(o,{id:"category",value:i.category,onChange:t=>x({...i,category:t.target.value}),placeholder:"e.g., GK, Sports, Movies, Opinion"})]})]}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsx(c,{type:"submit",className:"bg-green-600 hover:bg-green-700",children:"Create Quiz"}),e.jsx(c,{type:"button",variant:"outline",onClick:()=>_(!1),children:"Cancel"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"All Quizzes"}),R?e.jsxs("div",{className:"py-8 text-center text-gray-600",children:[e.jsx(T,{className:"inline-block h-6 w-6 animate-spin text-indigo-500 mr-2"})," Loading quizzes..."]}):D.map((t,s)=>{var l,g,P,N;return e.jsx(K.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:s*.1},className:"bg-white/80 backdrop-blur-md border border-gray-200/50 rounded-2xl p-6 shadow-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:t.title}),e.jsxs("div",{className:"flex items-center space-x-4 mt-2 text-sm text-gray-600",children:[e.jsxs("span",{children:["Entry: ₹",t.entry_fee]}),e.jsxs("span",{children:["Prize Pool: ₹",t.prize_pool]}),e.jsxs("span",{children:["Prizes: ₹",(l=t.prizes)==null?void 0:l.join(", ₹")]}),e.jsx("span",{className:`px-2 py-1 rounded-full text-xs ${t.status==="upcoming"?"bg-blue-100 text-blue-800":t.status==="active"?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:t.status})]}),e.jsxs("div",{className:"mt-2 text-sm text-gray-500",children:[e.jsxs("span",{children:["Start: ",new Date(t.start_time).toLocaleString()]}),e.jsxs("span",{className:"ml-4",children:["End: ",new Date(t.end_time).toLocaleString()]})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-4 gap-2",children:[e.jsx(o,{type:"datetime-local",value:((g=t.start_time)==null?void 0:g.slice(0,16))||"",onChange:async y=>{const{error:f}=await d.from("quizzes").update({start_time:y.target.value}).eq("id",t.id);f?r({title:"Update failed",description:f.message,variant:"destructive"}):j()}}),e.jsx(o,{type:"datetime-local",value:((P=t.end_time)==null?void 0:P.slice(0,16))||"",onChange:async y=>{const{error:f}=await d.from("quizzes").update({end_time:y.target.value}).eq("id",t.id);f?r({title:"Update failed",description:f.message,variant:"destructive"}):j()}}),e.jsx(o,{type:"datetime-local",value:((N=t.result_time)==null?void 0:N.slice(0,16))||"",onChange:async y=>{const{error:f}=await d.from("quizzes").update({result_time:y.target.value}).eq("id",t.id);f?r({title:"Update failed",description:f.message,variant:"destructive"}):j()}}),e.jsxs("select",{className:"border rounded-md px-2 py-2",value:t.status,onChange:async y=>{const{error:f}=await d.from("quizzes").update({status:y.target.value}).eq("id",t.id);f?r({title:"Update failed",description:f.message,variant:"destructive"}):j()},children:[e.jsx("option",{value:"upcoming",children:"upcoming"}),e.jsx("option",{value:"active",children:"active"}),e.jsx("option",{value:"finished",children:"finished"})]})]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(c,{size:"sm",variant:"outline",onClick:()=>Y(t.id),disabled:F===t.id,className:"text-indigo-600 hover:text-indigo-700",children:F===t.id?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"h-4 w-4 mr-1 animate-spin"}),"Recomputing"]}):e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),"Recompute"]})}),e.jsxs(c,{size:"sm",variant:"outline",onClick:()=>{E(t),v(t.id),I(!0)},className:"text-blue-600 hover:text-blue-700",children:[e.jsx(ae,{className:"h-4 w-4"}),"Questions"]}),e.jsx(c,{size:"sm",variant:"outline",onClick:()=>X(t.id),className:"text-red-600 hover:text-red-700",children:e.jsx($,{className:"h-4 w-4"})})]})]})},t.id)})]}),M&&h&&e.jsxs("div",{className:"mt-6 bg-white/80 backdrop-blur-md border border-gray-200/50 rounded-2xl p-6 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-800",children:["Questions for: ",h.title]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(c,{onClick:U,className:"bg-indigo-600 hover:bg-indigo-700",size:"sm",children:[e.jsx(V,{className:"w-4 h-4 mr-1"}),"Add Question"]}),e.jsx(c,{variant:"outline",size:"sm",onClick:()=>I(!1),children:"Close"})]})]}),Q.length===0?e.jsx("div",{className:"py-6 text-center text-gray-600",children:"No questions yet"}):e.jsx("div",{className:"space-y-4",children:Q.map(t=>e.jsxs("div",{className:"p-3 rounded-xl bg-white/70 border border-gray-200/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{defaultValue:t.question_text,onBlur:s=>B(t.id,s.target.value),className:"flex-1"}),e.jsx(c,{variant:"outline",size:"sm",className:"text-red-600 border-red-300",onClick:()=>a(t.id),children:e.jsx($,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"mt-2 pl-1",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Options"}),e.jsxs("div",{className:"space-y-2",children:[(t.options||[]).map(s=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(o,{defaultValue:s.option_text,onBlur:l=>O(s.id,l.target.value),className:"flex-1"}),e.jsxs("label",{className:"flex items-center gap-1 text-xs text-gray-700",children:[e.jsx("input",{type:"checkbox",defaultChecked:!!s.is_correct,onChange:async l=>{const{error:g}=await d.from("options").update({is_correct:l.target.checked}).eq("id",s.id);g&&r({title:"Update failed",description:g.message,variant:"destructive"})}}),"Correct"]}),e.jsx(c,{variant:"outline",size:"sm",className:"text-red-600 border-red-300",onClick:()=>W(s.id),children:e.jsx($,{className:"w-4 h-4"})})]},s.id)),e.jsxs(c,{onClick:()=>p(t.id),size:"sm",className:"bg-green-600 hover:bg-green-700",children:[e.jsx(V,{className:"w-4 h-4 mr-1"}),"Add Option"]})]})]})]},t.id))})]})]}),b==="notifications"&&e.jsx(ne,{})]})}export{he as default};
