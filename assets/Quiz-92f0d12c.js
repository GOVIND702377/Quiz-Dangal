import{a as G,u as K,s as u,j as e,B as C,f as X,b as J}from"./index-30cc22b4.js";import{r as l}from"./react-8a702e3e.js";import{c as Z,a as ee}from"./router-bcacfb8d.js";import{L as E,e as Q,d as O,T as I,o as $}from"./icons-5fedd17b.js";import{m as d,A as te}from"./motion-511bde03.js";import"./supabase-4c1332f7.js";const oe=()=>{var F;const{id:m}=Z(),b=ee(),{user:f,userProfile:se}=G(),{toast:c}=K(),[s,R]=l.useState(null),[h,y]=l.useState([]),[w,Y]=l.useState(0),[z,B]=l.useState({}),[o,j]=l.useState("loading"),[_,q]=l.useState(0),[v,T]=l.useState(!1),[D,k]=l.useState(0),[U,N]=l.useState(!1),A=l.useCallback(async()=>{try{const{data:t,error:r}=await u.from("quizzes").select("*").eq("id",m).single();if(r||!t){c({title:"Error",description:"Quiz not found.",variant:"destructive"}),b("/");return}R(t);let i=null;if(f&&f.id){const{data:n,error:p}=await u.from("quiz_participants").select("status").eq("user_id",f.id).eq("quiz_id",m).maybeSingle();!p&&n?(i=n,N(!0),i.status==="completed"&&j("completed")):N(!1)}else N(!1);if(i&&i.status!=="completed"){const{data:n,error:p}=await u.from("questions").select(`
            id,
            question_text,
            options (
              id,
              option_text
            )
          `).eq("quiz_id",m).order("id");!p&&n&&n.length>0?y(n):y([])}const{data:a,error:x}=await u.rpc("get_participant_count",{p_quiz_id:m});x?(console.warn("Participant count fetch failed:",x),k(0)):k(typeof a=="number"?a:0)}catch(t){console.error("Error fetching quiz data:",t),c({title:"Error",description:"Failed to load quiz.",variant:"destructive"}),b("/")}},[m,f.id,b,c]);l.useEffect(()=>{A()},[A]),l.useEffect(()=>{if(!s||o==="completed")return;const t=()=>{const i=new Date,a=s.start_time?new Date(s.start_time):null,x=s.end_time?new Date(s.end_time):null,n=a&&i<a,p=a&&x&&i>=a&&i<x;if(n){j("waiting"),q(Math.max(0,Math.round((a.getTime()-i.getTime())/1e3)));return}if(p){j("active"),q(Math.max(0,Math.round((x.getTime()-i.getTime())/1e3)));return}j("finished"),q(0)};t();const r=setInterval(t,1e3);return()=>clearInterval(r)},[s,o]),l.useEffect(()=>{o==="finished"&&Object.keys(z).length>0&&!v&&P()},[o]);const W=async(t,r)=>{try{const{error:i}=await u.from("user_answers").upsert({user_id:f.id,question_id:t,selected_option_id:r},{onConflict:"user_id,question_id"});if(i)throw i;B(a=>({...a,[t]:r})),w<h.length-1&&setTimeout(()=>{Y(a=>a+1)},500),c({title:"Answer Saved",description:"Your answer has been recorded."})}catch(i){console.error("Error saving answer:",i),c({title:"Error",description:"Failed to save answer. Please try again.",variant:"destructive"})}},H=async()=>{if(!s)return;const t=new Date,r=s.start_time?new Date(s.start_time):null,i=s.end_time?new Date(s.end_time):null,a=s.status==="active"&&r&&i&&t>=r&&t<i,x=a?"join_quiz":"pre_join_quiz";try{const{error:n}=await u.rpc(x,{p_quiz_id:m});if(n)throw n;if(N(!0),c({title:a?"Joined!":"Pre-joined!",description:a?"Starting now.":"We will remind you before start."}),a){const{data:p}=await u.from("questions").select("id, question_text, options ( id, option_text )").eq("quiz_id",m).order("id");y(p||[]),j("active")}}catch(n){c({title:"Error",description:(n==null?void 0:n.message)||"Could not join.",variant:"destructive"})}},P=async()=>{if(!v){T(!0);try{const{error:t}=await u.from("quiz_participants").update({status:"completed"}).eq("user_id",f.id).eq("quiz_id",m);if(t)throw t;c({title:"Quiz Completed!",description:"Your answers have been submitted. Results will be announced soon!"}),j("completed"),setTimeout(()=>{b("/my-quizzes")},3e3)}catch(t){console.error("Error submitting quiz:",t),c({title:"Submission Failed",description:"Could not submit your answers. Please try again.",variant:"destructive"})}finally{T(!1)}}},S=t=>{const r=Math.floor(t/60),i=t%60;return`${r.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`};if(o==="loading"||!s)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(E,{className:"h-16 w-16 animate-spin text-accent-b mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading quiz..."})]})});const L=()=>e.jsxs("div",{className:"mt-3 text-xs text-slate-300",children:[e.jsx("div",{className:"text-[11px] text-slate-400",children:s.start_time?X(s.start_time):"—"}),e.jsxs("div",{className:"mt-1 grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide text-[10px] text-slate-400",children:"Start"}),e.jsx("div",{children:s.start_time?J(s.start_time):"—"})]}),e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide text-[10px] text-slate-400",children:"End"}),e.jsx("div",{children:s.end_time?J(s.end_time):"—"})]})]})]}),M=()=>{const t=Array.isArray(s.prizes)?s.prizes:[],r=t[0]||0,i=t[1]||0,a=t[2]||0;return e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"px-2 py-1 rounded-md bg-amber-500/15 text-amber-300 border border-amber-700/30",children:["1st ₹",r]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-sky-500/15 text-sky-300 border border-sky-700/30",children:["2nd ₹",i]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-violet-500/15 text-violet-300 border border-violet-700/30",children:["3rd ₹",a]})]})};if(!U&&o!=="completed"){const t=new Date,r=s.start_time?new Date(s.start_time):null,i=s.end_time?new Date(s.end_time):null,a=s.status==="active"&&r&&i&&t>=r&&t<i;return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(d.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100 w-full",children:[e.jsx(Q,{className:"h-16 w-16 text-accent-b mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:s.title}),e.jsx("p",{className:"text-slate-300 mb-1",children:a?"Quiz is live!":"Quiz starts in:"}),e.jsx("div",{className:"text-4xl font-bold text-indigo-300 mb-4",children:S(_)}),e.jsxs("div",{className:"flex items-center justify-center space-x-4 text-sm text-gray-400",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(O,{className:"h-4 w-4 mr-1"}),D," joined"]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(I,{className:"h-4 w-4 mr-1"}),"₹",s.prize_pool," prize pool"]})]}),e.jsx(M,{}),e.jsx(L,{}),e.jsx("div",{className:"mt-6",children:e.jsx(C,{onClick:H,className:a?"bg-emerald-600 hover:bg-emerald-700":"bg-indigo-600 hover:bg-indigo-700",children:a?"Join & Start":"Pre-Join"})})]})})}if(o==="completed")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(d.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx($,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:"Quiz Completed!"}),e.jsx("p",{className:"text-slate-300 mb-4",children:"You have already submitted your answers for this quiz."}),e.jsx(C,{onClick:()=>b("/my-quizzes"),variant:"brand",className:"w-full",children:"View My Quizzes"})]})});if(o==="waiting")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(d.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx(Q,{className:"h-16 w-16 text-accent-b mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:s.title}),e.jsx("p",{className:"text-slate-300 mb-1",children:"Quiz starts in:"}),e.jsx("div",{className:"text-4xl font-bold text-indigo-300 mb-4",children:S(_)}),e.jsxs("div",{className:"flex items-center justify-center space-x-4 text-sm text-gray-400",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(O,{className:"h-4 w-4 mr-1"}),D," joined"]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(I,{className:"h-4 w-4 mr-1"}),"₹",s.prize_pool," prize pool"]})]}),e.jsx(M,{}),e.jsx(L,{}),e.jsx("div",{className:"mt-4 text-xs text-slate-400",children:"We’ll auto-start when the timer hits zero."})]})});if(o==="finished")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(d.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx(Q,{className:"h-16 w-16 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:"Quiz Ended"}),e.jsx("p",{className:"text-slate-300 mb-4",children:"The quiz has ended. Results will be announced soon!"}),v&&e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx(E,{className:"h-6 w-6 animate-spin mr-2"}),e.jsx("span",{children:"Submitting your answers..."})]})]})});if(h.length===0)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-gray-600",children:"No questions available for this quiz."})})});const g=h[w],V=(w+1)/h.length*100;return e.jsx("div",{className:"min-h-screen p-4",children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs(d.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"qd-card rounded-2xl p-4 shadow-lg mb-6 text-slate-100",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold text-white",children:s.title}),e.jsxs("p",{className:"text-sm text-slate-300",children:["Question ",w+1," of ",h.length]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold text-red-400",children:S(_)}),e.jsx("div",{className:"text-xs text-slate-300",children:"Time Left"})]})]}),e.jsx("div",{className:"w-full bg-slate-700/40 rounded-full h-2 mt-4",children:e.jsx(d.div,{className:"bg-accent-b h-2 rounded-full",style:{width:`${V}%`},transition:{duration:.5}})})]}),e.jsx(te,{mode:"wait",children:e.jsxs(d.div,{initial:{opacity:0,x:50},animate:{opacity:1,x:0},exit:{opacity:0,x:-50},transition:{duration:.3},className:"qd-card rounded-2xl p-6 shadow-lg text-slate-100",children:[e.jsx("h2",{className:"text-xl font-bold text-center text-white text-shadow-sm mb-8",children:g.question_text}),e.jsx("div",{className:"space-y-4",children:(F=g.options)==null?void 0:F.map((t,r)=>e.jsxs(d.button,{onClick:()=>W(g.id,t.id),whileHover:{scale:1.02},whileTap:{scale:.98},className:`w-full p-4 rounded-xl text-left font-medium transition-all duration-200 shadow-md border ${z[g.id]===t.id?"bg-emerald-600 text-white border-emerald-500":"bg-slate-800/70 hover:bg-slate-800 text-slate-100 border-slate-700"}`,children:[e.jsxs("span",{className:"font-bold mr-3 text-accent-b",children:[String.fromCharCode(65+r),"."]}),t.option_text]},t.id))}),w===h.length-1&&Object.keys(z).length===h.length&&e.jsx(d.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.5},className:"mt-8",children:e.jsx(C,{onClick:P,disabled:v,className:"w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 text-lg",children:v?e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"mr-2 h-6 w-6 animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx($,{className:"mr-2 h-6 w-6"}),"Submit Quiz"]})})})]},g.id)})]})})};export{oe as default};
