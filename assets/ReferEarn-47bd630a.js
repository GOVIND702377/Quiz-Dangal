import{a as de,j as e,I as Z,B as C,s as ee}from"./index-71d9342d.js";import{r as g}from"./react-8a702e3e.js";import{b as me,g as xe}from"./avatar-33f39a6e.js";import{G as fe,C as z,d as te,a1 as B,a2 as H,f as he}from"./icons-3e0b0f01.js";import"./supabase-4c1332f7.js";import"./router-bcacfb8d.js";import"./motion-511bde03.js";const Ne=()=>{const{user:W,userProfile:u}=de(),[O,A]=g.useState({total:0,earnings:0}),[S,Y]=g.useState([]),[R,T]=g.useState(""),[ae,G]=g.useState(!0),[_,M]=g.useState(null),U=(u==null?void 0:u.referral_code)||"",f=`${window.location.origin}?ref=${U}`;g.useEffect(()=>{let a=!0;return(async()=>{if(W){G(!0);try{const{data:n,error:t}=await ee.from("referrals").select("*").eq("referrer_id",W.id).order("created_at",{ascending:!1});if(t&&t.code!=="PGRST116")throw t;if(!a)return;let l=n||[];if(l.length){const m=Array.from(new Set(l.map(c=>c.referred_id).filter(Boolean)));if(m.length){const{data:c,error:o}=await ee.rpc("profiles_public_by_ids",{p_ids:m});o&&console.warn("Referral profile lookup failed:",o);const w=c||[],P=new Map(w.map(d=>[d.id,d])),L=await xe(w.map(d=>d.avatar_url).filter(Boolean));l=l.map(d=>{const h=P.get(d.referred_id);if(!h)return{...d,referred:null};const $=h.avatar_url&&L.get(h.avatar_url)||"";return{...d,referred:{...h,avatar_url:$}}})}}const b=l.length,j=l.reduce((m,c)=>m+(c.coins_awarded||0),0)||0;A({total:b,earnings:j}),Y(l)}catch(n){if(!a)return;A({total:0,earnings:0}),Y([])}finally{a&&G(!1)}}})(),()=>{a=!1}},[W]),g.useEffect(()=>{let a=!1;return(async()=>{try{const r=await q();a||M(r)}catch(r){a||M(null)}})(),()=>{a=!0}},[U]);const E=async(a,r)=>{try{await navigator.clipboard.writeText(a),T(r),setTimeout(()=>T(""),1600)}catch(n){const t=document.createElement("textarea");t.value=a,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),T(r),setTimeout(()=>T(""),1600)}},q=async()=>{const n=document.createElement("canvas");n.width=1080,n.height=1080;const t=n.getContext("2d");t.textBaseline="top";const l=(s,i)=>{t.font=`${s} ${i}px Inter, system-ui, -apple-system, Segoe UI, Roboto`},b=s=>t.measureText(s).width,j=(s,i,v,y,x)=>{t.beginPath(),t.moveTo(s+x,i),t.lineTo(s+v-x,i),t.quadraticCurveTo(s+v,i,s+v,i+x),t.lineTo(s+v,i+y-x),t.quadraticCurveTo(s+v,i+y,s+v-x,i+y),t.lineTo(s+x,i+y),t.quadraticCurveTo(s,i+y,s,i+y-x),t.lineTo(s,i+x),t.quadraticCurveTo(s,i,s+x,i),t.closePath()},m=t.createLinearGradient(0,0,1080,1080);m.addColorStop(0,"#150a36"),m.addColorStop(1,"#0f0926"),t.fillStyle=m,t.fillRect(0,0,1080,1080);const c=64;let o=c;l("900",72),t.fillStyle="#facc15";const w="Refer & Earn",P=b(w);t.fillText(w,(1080-P)/2,o),o+=72+12,l("700",30),t.fillStyle="rgba(226,232,240,0.92)";const L="Invite friends. Earn coins.",d=b(L);t.fillText(L,(1080-d)/2,o),o+=30+24;const h=c,$=1080-c*2,I=560,p=o;j(h,p,$,I,28),t.fillStyle="rgba(12,10,36,0.9)",t.fill(),t.lineWidth=2,t.strokeStyle="rgba(79,70,229,0.45)",t.stroke();const ne=({}.VITE_PUBLIC_SITE_URL||"https://www.quizdangal.com").replace(/\/$/,""),D=(u==null?void 0:u.referral_code)||"",le=`${ne}?ref=${encodeURIComponent(D)}`,N=360,F=N+32,X=N+40,Q=h+$-F-36,V=p+Math.round((I-X)/2);j(Q,V,F,X,20),t.fillStyle="#ffffff",t.fill();try{const s=document.createElement("canvas");await me.toCanvas(s,le,{width:N,margin:1,color:{dark:"#000000",light:"#ffffff"}}),t.drawImage(s,Q+16,V+16,N,N)}catch(s){}const k=h+36;l("900",48),t.fillStyle="rgba(255,255,255,0.96)",t.fillText("🧠 Play & Win",k,p+36),l("800",36),t.fillStyle="rgba(203,213,225,0.98)",t.fillText("🌐 www.quizdangal.com",k,p+36+56),l("900",44),t.fillStyle="rgba(255,255,255,0.96)";const J="🔗 Referral: ",oe=b(J);t.fillText(J,k,p+36+56+64),t.fillStyle="rgba(0,255,198,1)",t.fillText(D,k+oe,p+36+56+64),l("700",28),t.fillStyle="rgba(226,232,240,0.92)",t.fillText("Share this poster or scan the QR to join.",k,p+I-80);const ie=p+I+24;l("700",24),t.fillStyle="rgba(226,232,240,0.9)";const K="Tip: Sharing from your phone attaches this poster.",ce=b(K);return t.fillText(K,(1080-ce)/2,ie),await new Promise(s=>n.toBlob(s,"image/jpeg",.92))},se=async()=>{const a="Earn coins by playing quizzes! Use my referral to get started.";try{const r=_||await q();if(r&&navigator.canShare&&window.File){const n=new File([r],"quizdangal-referral.jpg",{type:"image/jpeg"});if(navigator.canShare({files:[n],text:`${a} ${f}`})){await navigator.share({files:[n],text:`${a} ${f}`});return}}}catch(r){}try{if(_){const c=URL.createObjectURL(_),o=document.createElement("a");o.href=c,o.download="quizdangal-referral.jpg",o.rel="noopener",document.body.appendChild(o),o.click(),document.body.removeChild(o),setTimeout(()=>URL.revokeObjectURL(c),2e3)}const r=encodeURIComponent(`${a}
${f}`),n=navigator.userAgent||"",l=/iPhone|iPad|iPod/i.test(n)?`https://wa.me/?text=${r}`:`whatsapp://send?text=${r}`;if(window.open(l,"_blank"))return;const j=`https://t.me/share/url?url=${encodeURIComponent(f)}&text=${encodeURIComponent(a)}`;if(window.open(j,"_blank"))return}catch(r){}E(f,"link")},re=async()=>{try{const a=_||await q();if(!a)return;const r=URL.createObjectURL(a),n=document.createElement("a");n.href=r,n.download="quizdangal-referral.jpg",n.rel="noopener",document.body.appendChild(n),n.click(),document.body.removeChild(n),setTimeout(()=>URL.revokeObjectURL(r),2e3)}catch(a){}};return e.jsx("div",{className:"min-h-screen",children:e.jsxs("div",{className:"container mx-auto px-4 py-6 max-w-2xl text-slate-100",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(fe,{className:"w-6 h-6 text-emerald-300"}),e.jsx("h1",{className:"text-2xl font-extrabold bg-gradient-to-r from-sky-400 via-cyan-400 to-emerald-400 bg-clip-text text-transparent tracking-tight",children:"Refer & Earn"})]}),e.jsx("div",{className:"rounded-2xl p-4 mb-6 bg-emerald-900/25 border border-emerald-600/30 backdrop-blur-xl",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full overflow-hidden hd-badge-coin relative shrink-0","aria-hidden":!0,children:e.jsxs("div",{className:"hd-badge-coin-front",children:[e.jsx(z,{className:"hd-badge-coin-icon"}),e.jsx("span",{className:"hd-badge-coin-shine"})]})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-lg font-extrabold tracking-wide",children:[e.jsx("span",{className:"text-amber-200",children:"Earn +50 coins"})," per referral"]}),e.jsx("div",{className:"text-sm text-emerald-100/90",children:"Coins are added after your friend signs up and completes their profile."})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"rounded-xl p-4 text-center bg-gradient-to-br from-sky-900/40 via-cyan-900/30 to-emerald-900/20 border border-cyan-600/40",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 mb-1",children:[e.jsx(te,{className:"w-4 h-4 text-cyan-300"}),e.jsx("span",{className:"text-2xl font-extrabold bg-gradient-to-r from-sky-300 via-cyan-300 to-emerald-300 bg-clip-text text-transparent",children:O.total})]}),e.jsx("p",{className:"text-xs sm:text-sm text-cyan-200/90 tracking-wide",children:"Friends Referred"})]}),e.jsxs("div",{className:"rounded-xl p-4 text-center bg-gradient-to-br from-amber-900/30 via-yellow-900/20 to-transparent border border-amber-600/40",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 mb-1",children:[e.jsx("span",{className:"relative inline-flex w-6 h-6 align-middle rounded-full overflow-hidden hd-badge-coin shrink-0",children:e.jsxs("span",{className:"hd-badge-coin-front",children:[e.jsx(z,{className:"hd-badge-coin-icon"}),e.jsx("span",{className:"hd-badge-coin-shine"})]})}),e.jsx("span",{className:"text-2xl font-extrabold bg-gradient-to-r from-amber-200 via-yellow-200 to-orange-200 bg-clip-text text-transparent",children:O.earnings})]}),e.jsx("p",{className:"text-xs sm:text-sm text-amber-200/90 tracking-wide",children:"Coins Earned"})]})]}),e.jsxs("div",{className:"space-y-2 mb-5",children:[e.jsx("h3",{className:"font-semibold text-slate-200",children:"Your Referral Code"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{value:U,readOnly:!0,className:"font-mono text-center text-lg font-bold bg-slate-900/60 border-slate-700/60 text-slate-100"}),e.jsx(C,{onClick:()=>E(U,"code"),variant:"outline",size:"sm",className:"px-3 border-cyan-500/50 text-cyan-200 hover:bg-cyan-900/30",children:R==="code"?e.jsx(B,{className:"w-4 h-4 text-emerald-300"}):e.jsx(H,{className:"w-4 h-4 text-cyan-300"})})]})]}),e.jsxs("div",{className:"space-y-2 mb-6",children:[e.jsx("h3",{className:"font-semibold text-slate-200",children:"Your Referral Link"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{value:f,readOnly:!0,className:"text-sm bg-slate-900/60 border-slate-700/60 text-slate-100"}),e.jsx(C,{onClick:()=>E(f,"link"),variant:"outline",size:"sm",className:"px-3 border-cyan-500/50 text-cyan-200 hover:bg-cyan-900/30",children:R==="link"?e.jsx(B,{className:"w-4 h-4 text-emerald-300"}):e.jsx(H,{className:"w-4 h-4 text-cyan-300"})})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(C,{onClick:se,className:"flex-1 bg-gradient-to-r from-indigo-500 via-violet-500 to-fuchsia-500 hover:opacity-90 border border-indigo-400/40",children:[e.jsx(he,{className:"w-4 h-4 mr-2"})," Share"]}),e.jsxs(C,{onClick:()=>E(f,"link"),variant:"outline",className:"flex-1 border-cyan-500/50 text-cyan-200 hover:bg-cyan-900/30",children:[R==="link"?e.jsx(B,{className:"w-4 h-4 mr-2 text-emerald-300"}):e.jsx(H,{className:"w-4 h-4 mr-2 text-cyan-300"})," ",R==="link"?"Copied!":"Copy Link"]}),e.jsx(C,{onClick:re,variant:"outline",size:"sm",className:"border-emerald-500/50 text-emerald-200 hover:bg-emerald-900/30",children:"Save Poster"})]}),!ae&&(S.length>0?e.jsxs("div",{className:"space-y-3 mt-6",children:[e.jsx("h3",{className:"font-semibold text-slate-200",children:"Recent Referrals"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:S.slice(0,8).map(a=>{var r;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-900/60 rounded-lg border border-slate-700/60",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-100",children:((r=a.referred)==null?void 0:r.username)||"New User"}),e.jsx("div",{className:"text-xs text-slate-400",children:new Date(a.created_at).toLocaleDateString()})]}),e.jsxs("div",{className:"flex items-center gap-1 text-emerald-300",children:[e.jsx("span",{className:"relative inline-flex w-5 h-5 align-middle rounded-full overflow-hidden hd-badge-coin shrink-0",children:e.jsxs("span",{className:"hd-badge-coin-front",children:[e.jsx(z,{className:"hd-badge-coin-icon"}),e.jsx("span",{className:"hd-badge-coin-shine"})]})}),e.jsxs("span",{className:"font-bold",children:["+",a.coins_awarded]})]})]},a.id)})}),S.length>8&&e.jsxs("p",{className:"text-xs text-slate-400",children:["And ",S.length-8," more referrals…"]})]}):e.jsxs("div",{className:"text-center py-8 text-slate-400 mt-6",children:[e.jsx(te,{className:"w-12 h-12 mx-auto mb-2 text-slate-500"}),e.jsx("p",{className:"text-slate-200",children:"No referrals yet"}),e.jsx("p",{className:"text-sm",children:"Start sharing your link to earn coins!"})]}))]})})};export{Ne as default};
