import{a as L,s as y,j as e,B as R,f as A,b as _}from"./index-30cc22b4.js";import{r as p}from"./react-8a702e3e.js";import{a as I}from"./router-bcacfb8d.js";import{L as Q,P as z,d as O,e as k}from"./icons-5fedd17b.js";import{m as b}from"./motion-511bde03.js";import"./supabase-4c1332f7.js";function Y(o){const i="px-2 py-0.5 rounded-full text-xs font-semibold";return o==="active"?i+" bg-green-600/15 text-green-400 border border-green-700/40":o==="upcoming"?i+" bg-blue-600/15 text-blue-300 border border-blue-700/40":i+" bg-slate-600/20 text-slate-300 border border-slate-700/40"}const B=({leaderboard:o,currentUser:i})=>{const x=o.slice(0,10),m=o.find(r=>r.user_id===i.id),u=r=>r===1?"text-amber-300":r===2?"text-slate-200":r===3?"text-orange-300":"text-slate-300";return e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-semibold text-lg text-center text-slate-100",children:"Leaderboard"}),e.jsx("div",{className:"space-y-2",children:x.map(r=>e.jsxs("div",{className:`flex items-center justify-between p-3 rounded-xl border transition ${r.user_id===i.id?"bg-indigo-900/30 border-indigo-600/50 shadow-lg":"bg-slate-900/60 border-slate-700/60"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsxs("span",{className:`font-extrabold tabular-nums w-8 text-center ${u(r.rank)}`,children:[r.rank,"."]}),e.jsx("span",{className:"font-medium text-slate-100 truncate",children:r.display_name})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"font-bold text-indigo-300",children:[r.score," ",e.jsx("span",{className:"text-sm font-normal text-slate-300",children:"pts"})]})})]},r.user_id))}),m&&m.rank>10&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-center text-slate-500",children:"..."}),e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-xl bg-indigo-900/30 border border-indigo-600/50 shadow-lg",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsxs("span",{className:"font-extrabold tabular-nums w-8 text-center text-indigo-200",children:[m.rank,"."]}),e.jsx("span",{className:"font-medium text-slate-100 truncate",children:m.display_name})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"font-bold text-indigo-300",children:[m.score," ",e.jsx("span",{className:"text-sm font-normal text-slate-300",children:"pts"})]})})]})]})]})},F=({size:o=72})=>{const i=typeof o=="number"?`${o}px`:o,[x,m]=p.useState(0),u=["/Trophy.png","/trophy.png","/trophy-question.png","/trophy-question.webp"],r=u[x]||u[0];return e.jsx("div",{className:"relative trophy-float mx-auto mb-4 pointer-events-none",style:{width:i,height:i},children:e.jsx("div",{className:"trophy-sway w-full h-full",children:e.jsx("div",{className:"trophy-pulse w-full h-full",children:x>=0?e.jsx("img",{src:r,alt:"Trophy",className:"w-full h-full object-contain select-none",style:{backgroundColor:"transparent",display:"block"},loading:"eager",decoding:"async",onError:()=>{const N=x+1;N<u.length?m(N):m(-1)}}):e.jsxs("svg",{viewBox:"0 0 128 128",width:"100%",height:"100%",preserveAspectRatio:"xMidYMid meet","aria-hidden":!0,children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"qdTg",x1:"0%",y1:"0%",x2:"0%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#ffe795"}),e.jsx("stop",{offset:"45%",stopColor:"#ffd34d"}),e.jsx("stop",{offset:"75%",stopColor:"#f0a700"}),e.jsx("stop",{offset:"100%",stopColor:"#b86a00"})]}),e.jsxs("linearGradient",{id:"qdQM",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#6d28d9"}),e.jsx("stop",{offset:"100%",stopColor:"#7c3aed"})]})]}),e.jsx("path",{d:"M28 30c-10 0-18 10-16 20 2 10 14 14 24 11",fill:"none",stroke:"#f0b000",strokeWidth:"8",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M100 30c10 0 18 10 16 20-2 10-14 14-24 11",fill:"none",stroke:"#f0b000",strokeWidth:"8",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M28 22h72c0 24-10 36-26 41v9c0 7-6 13-14 13s-14-6-14-13v-9C38 58 28 46 28 22Z",fill:"url(#qdTg)"}),e.jsx("rect",{x:"56",y:"72",width:"16",height:"10",rx:"3",fill:"url(#qdTg)"}),e.jsx("rect",{x:"44",y:"82",width:"40",height:"12",rx:"4",fill:"url(#qdTg)"}),e.jsx("rect",{x:"36",y:"94",width:"56",height:"10",rx:"5",fill:"url(#qdTg)"}),e.jsx("text",{x:"64",y:"46",textAnchor:"middle",dominantBaseline:"middle",fontSize:"32",fontWeight:"900",fill:"url(#qdQM)",stroke:"#2b1a59",strokeWidth:"3",paintOrder:"stroke fill",children:"?"})]})})})})},V=()=>{const o=I(),{user:i}=L(),[x,m]=p.useState([]),[u,r]=p.useState(!0),[N,T]=p.useState(0),[D,w]=p.useState({}),j=p.useCallback(async()=>{if(i)try{const{data:t,error:d}=await y.from("my_quizzes_view").select("*");if(d){console.error("Error fetching my quizzes view:",d),m([]);return}const a=new Date(Date.now()-60*60*1e3),n=(t||[]).map(s=>s.leaderboard&&new Date(s.result_shown_at)<a?{...s,leaderboard:null,resultExpired:!0}:{...s});m(n)}catch(t){console.error(t)}},[i]);if(p.useEffect(()=>{typeof window!="undefined"&&"Notification"in window&&Notification.permission==="default"&&Notification.requestPermission().catch(()=>{});const t=y.channel("quiz-results-channel",{config:{broadcast:{ack:!0}}}).on("postgres_changes",{event:"INSERT",schema:"public",table:"quiz_results"},s=>{if(j(),typeof window!="undefined"&&"Notification"in window&&Notification.permission==="granted")try{new Notification("Quiz Result Ready",{body:"Your quiz results are available. Tap to view."})}catch(c){}}).subscribe(s=>{});(async()=>{r(!0),await j(),r(!1)})();const a=setInterval(j,12e4),n=setInterval(()=>T(s=>(s+1)%1e6),1e3);return()=>{y.removeChannel(t),clearInterval(a),clearInterval(n)}},[i,j]),p.useEffect(()=>{const t=async()=>{try{const d=Date.now(),a=(x||[]).filter(l=>l.end_time&&d<new Date(l.end_time).getTime()).map(l=>l.id);if(!a.length){w({});return}const{data:n,error:s}=await y.rpc("get_engagement_counts_many",{p_quiz_ids:a});if(s)throw s;const c={};for(const l of n||[]){const f=l.pre_joined||0,g=l.joined||0;c[l.quiz_id]=f+g}w(c)}catch(d){w({})}};x&&x.length&&t()},[x]),u)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(Q,{className:"h-12 w-12 animate-spin text-indigo-300"})});if(x.length===0)return e.jsx("div",{className:"min-h-screen",children:e.jsx("div",{className:"container mx-auto px-4 py-6",children:e.jsxs(b.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"text-center text-slate-100",children:[e.jsx("h1",{className:"text-3xl font-bold heading-gradient text-shadow mb-8",children:"My Quizzes"}),e.jsxs(b.div,{initial:{opacity:0,scale:.98},animate:{opacity:1,scale:1},transition:{delay:.15},className:"qd-card rounded-2xl p-8 max-w-md mx-auto shadow-2xl",children:[e.jsx(F,{size:104}),e.jsx("h3",{className:"text-xl font-semibold text-white mb-2",children:"No Quizzes Yet"}),e.jsx("p",{className:"text-slate-300 mb-6",children:"You haven't joined any quizzes. Play one to see your history!"}),e.jsxs(R,{onClick:()=>o("/"),variant:"brand",className:"w-full rounded-xl",children:[e.jsx(z,{className:"w-5 h-5 mr-2"})," Play Now"]})]})]})})});const h=Date.now(),v=x.filter(t=>t.end_time&&h<new Date(t.end_time).getTime()),M=x.filter(t=>t.end_time&&h>=new Date(t.end_time).getTime());return v.sort((t,d)=>{const a=t.start_time?new Date(t.start_time).getTime():0,n=t.end_time?new Date(t.end_time).getTime():0,s=d.start_time?new Date(d.start_time).getTime():0,c=d.end_time?new Date(d.end_time).getTime():0,l=a&&n&&h>=a&&h<n,f=s&&c&&h>=s&&h<c;return l!==f?l?-1:1:a-s}),e.jsx("div",{className:"min-h-screen",children:e.jsx("div",{className:"container mx-auto px-4 py-6",children:e.jsxs(b.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},children:[e.jsx("h1",{className:"text-3xl font-bold heading-gradient text-shadow mb-8 text-center",children:"My Quizzes"}),v.length>0&&e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-semibold text-white mb-3",children:"Live/Upcoming"}),e.jsx("div",{className:"space-y-3",children:v.map((t,d)=>{const a=t.start_time?new Date(t.start_time):null,n=t.end_time?new Date(t.end_time):null,s=a&&n&&h>=a.getTime()&&h<n.getTime(),c=s?Math.max(0,Math.floor((n.getTime()-Date.now())/1e3)):a?Math.max(0,Math.floor((a.getTime()-Date.now())/1e3)):0,l=a&&n?Math.max(1,n.getTime()-a.getTime()):null,f=s&&l?Math.min(100,Math.max(0,Math.round((Date.now()-a.getTime())/l*100))):null,g=Array.isArray(t.prizes)?t.prizes:[],S=g[0]||0,C=g[1]||0,E=g[2]||0,$=D[t.id]||0;return e.jsxs(b.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:d*.05},onClick:()=>o(`/quiz/${t.id}`),className:`relative overflow-hidden rounded-2xl border ${s?"border-emerald-700/50":"border-slate-800"} bg-gradient-to-br from-slate-950/90 via-slate-900/85 to-slate-900/60 shadow-xl cursor-pointer group hover:-translate-y-0.5 transition-transform qd-card p-4`,children:[e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{background:"radial-gradient(1200px 300px at -10% -10%, rgba(99,102,241,0.06), transparent), radial-gradient(900px 200px at 110% 20%, rgba(16,185,129,0.05), transparent)"}}),s&&e.jsx("div",{className:"absolute -left-10 top-3 rotate-[-15deg]",children:e.jsx("span",{className:"bg-rose-600 text-white text-[10px] font-extrabold tracking-widest px-6 py-1 rounded shadow-lg ring-1 ring-rose-300/50",children:"LIVE"})}),!s&&a&&e.jsx("div",{className:"absolute -left-10 top-3 rotate-[-15deg]",children:e.jsx("span",{className:"bg-sky-600 text-white text-[10px] font-extrabold tracking-widest px-6 py-1 rounded shadow-lg ring-1 ring-sky-300/50",children:"SOON"})}),e.jsx("div",{className:"flex items-center justify-between gap-3",children:e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("div",{className:"truncate font-semibold text-slate-100 text-base sm:text-lg",children:t.title}),e.jsx("span",{className:Y(s?"active":"upcoming"),children:s?"active":"upcoming"}),e.jsx("span",{className:`px-2 py-0.5 rounded-full text-[10px] font-semibold border ${s?"bg-emerald-500/15 text-emerald-300 border-emerald-700/40":"bg-indigo-500/15 text-indigo-300 border-indigo-700/40"}`,children:"Joined"})]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"px-2.5 py-1.5 rounded-lg bg-gradient-to-r from-amber-500/20 to-amber-400/10 text-amber-200 border border-amber-500/30 shadow-sm",children:["ðŸ¥‡ â‚¹",S]}),e.jsxs("span",{className:"px-2.5 py-1.5 rounded-lg bg-gradient-to-r from-sky-500/20 to-sky-400/10 text-sky-200 border border-sky-500/30 shadow-sm",children:["ðŸ¥ˆ â‚¹",C]}),e.jsxs("span",{className:"px-2.5 py-1.5 rounded-lg bg-gradient-to-r from-violet-500/20 to-violet-400/10 text-violet-200 border border-violet-500/30 shadow-sm",children:["ðŸ¥‰ â‚¹",E]})]}),e.jsxs("div",{className:"mt-2",children:[e.jsx("div",{className:"text-[11px] text-slate-400",children:t.start_time?A(t.start_time):"â€”"}),e.jsxs("div",{className:"mt-1 grid grid-cols-1 sm:grid-cols-2 gap-2 text-[11px] text-slate-300",children:[e.jsxs("div",{className:"bg-slate-800/50 border border-slate-700 rounded-md px-2 py-1",children:[e.jsx("span",{className:"uppercase text-[9px] text-slate-400",children:"Start"}),e.jsx("div",{children:t.start_time?_(t.start_time):"â€”"})]}),e.jsxs("div",{className:"bg-slate-800/50 border border-slate-700 rounded-md px-2 py-1",children:[e.jsx("span",{className:"uppercase text-[9px] text-slate-400",children:"End"}),e.jsx("div",{children:t.end_time?_(t.end_time):"â€”"})]})]})]}),c!==null&&e.jsxs("div",{className:"mt-2 text-sm font-semibold text-indigo-300",children:[s?"Ends in":"Starts in"," ",String(Math.floor(c/60)).padStart(2,"0"),":",String(c%60).padStart(2,"0")]}),e.jsx("div",{className:"mt-1 flex items-center gap-4 text-xs text-slate-400",children:e.jsxs("span",{className:"inline-flex items-center",children:[e.jsx(O,{className:"w-3.5 h-3.5 mr-1"}),$," joined"]})}),f!==null&&e.jsx("div",{className:"mt-2 w-full bg-slate-800/50 border border-slate-700/70 rounded-full h-1 overflow-hidden",children:e.jsx("div",{className:"h-1 bg-emerald-500/80",style:{width:`${f}%`}})})]})})]},`lu-${t.id}`)})})]}),e.jsx("h2",{className:"text-xl font-semibold text-white mb-3",children:"Finished"}),e.jsx("div",{className:"space-y-4",children:M.map((t,d)=>{const a=new Date,n=new Date(t.end_time),s=a>=n&&t.leaderboard,c=s?t.leaderboard.find(l=>l.user_id===i.id):null;return e.jsxs(b.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:d*.06},onClick:()=>o(`/quiz/${t.id}`),className:"qd-card rounded-2xl p-6 shadow-xl text-slate-100 cursor-pointer group",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-xl font-semibold text-white truncate pr-3",children:t.title}),e.jsx("div",{className:`px-3 py-1 rounded-full text-xs sm:text-sm font-medium border ${s?"bg-emerald-900/25 text-emerald-200 border-emerald-500/30":t.resultExpired?"bg-slate-800/60 text-slate-300 border-slate-700/60":"bg-amber-900/25 text-amber-200 border-amber-500/30"}`,children:s?"Completed":t.resultExpired?"Expired":"Awaiting Results"})]}),s?e.jsxs(e.Fragment,{children:[c&&e.jsxs("div",{className:"bg-slate-900/60 rounded-xl p-4 flex justify-around items-center text-center mb-4 border border-slate-700/60",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-slate-400",children:"Your Rank"}),e.jsxs("p",{className:"text-2xl font-bold bg-gradient-to-r from-violet-300 via-indigo-200 to-fuchsia-300 bg-clip-text text-transparent",children:["#",c.rank]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-slate-400",children:"Your Score"}),e.jsx("p",{className:"text-2xl font-bold text-indigo-300",children:c.score})]})]}),e.jsx(B,{leaderboard:t.leaderboard,currentUser:i})]}):t.resultExpired?e.jsxs("div",{className:"text-center p-4 bg-slate-900/60 rounded-xl border border-slate-700/60",children:[e.jsx(k,{className:"mx-auto h-8 w-8 text-slate-400 mb-2"}),e.jsx("p",{className:"font-semibold text-slate-200",children:"Results for this quiz have expired."})]}):e.jsxs("div",{className:"text-center p-4 bg-slate-900/60 rounded-xl border border-slate-700/60",children:[e.jsx(k,{className:"mx-auto h-8 w-8 text-slate-400 mb-2"}),e.jsx("p",{className:"font-semibold text-slate-200",children:"Results will be declared at"}),e.jsx("p",{className:"text-slate-300",children:n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]},t.id)})})]})})})};export{V as default};
