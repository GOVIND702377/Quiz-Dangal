import{u as re,a as le,i as oe,s as w,Q as ce,k as de,c as X,j as e,m as k,B as I,A as ue,f as me,d as K,g as xe}from"./index-e08e3771.js";import{r as a}from"./react-8a702e3e.js";import{c as he,a as fe}from"./router-f2cf3f51.js";import{L as B,X as ee,e as G,d as te,t as pe}from"./icons-52d1b41a.js";import"./supabase-4c1332f7.js";function se(){return typeof document=="undefined"?!1:document.visibilityState==="hidden"}function be(u,p){const{toast:t}=re(),{user:o}=le(),{isSubscribed:T,subscribeToPush:M}=oe(),[n,L]=a.useState(null),[y,F]=a.useState([]),[P,J]=a.useState(0),[H,U]=a.useState({}),[x,E]=a.useState("loading"),[O,D]=a.useState(0),[v,W]=a.useState(!1),[Q,$]=a.useState({joined:0,pre_joined:0}),[N,q]=a.useState(!1),[b,d]=a.useState(null),c=a.useRef(null),h=a.useRef(!0),m=a.useRef([]),S=a.useRef(null);a.useEffect(()=>()=>{h.current=!1,c.current&&clearTimeout(c.current),S.current&&clearTimeout(S.current)},[]);const _=a.useCallback(()=>{if(S.current||m.current.length===0)return;const i=m.current[0],s=2e3*Math.pow(2,(i.attempt||1)-1),r=Math.min(s,3e4);S.current=setTimeout(()=>{S.current=null,g()},r)},[]),g=a.useCallback(async()=>{if(m.current.length===0)return;const i=[...m.current];m.current=[];for(const s of i)if(!(!o||b==="completed"))try{const{error:r}=await w.from("user_answers").upsert({user_id:o.id,question_id:s.questionId,selected_option_id:s.optionId},{onConflict:"user_id,question_id"});if(r)throw r;U(l=>({...l,[s.questionId]:s.optionId}))}catch(r){const l=(s.attempt||1)+1;l<=6?m.current.push({...s,attempt:l}):t({title:"Answer not saved",description:"One answer failed to sync after multiple retries.",variant:"destructive"})}m.current.length>0&&_()},[b,o,t,_]);a.useEffect(()=>{const i=()=>g(),s=()=>{se()||g()};return window.addEventListener("online",i),document.addEventListener("visibilitychange",s),()=>{window.removeEventListener("online",i),document.removeEventListener("visibilitychange",s)}},[g]);const z=(Q.joined||0)+(Q.pre_joined||0),R=(()=>x==="active"?Q.joined||0:z)(),C=a.useCallback(async()=>{const{data:i,error:s}=await w.from("questions").select("id, question_text, options ( id, option_text )").eq("quiz_id",u).order("id");F(s?[]:i||[])},[u]),A=a.useCallback(async()=>{var i,s;try{const{data:r,error:l}=await w.rpc("get_engagement_counts",{p_quiz_id:u});if(l)console.warn("Engagement counts fetch failed:",l),$({joined:0,pre_joined:0});else{const f=Array.isArray(r)?r[0]:r,j=Number((i=f==null?void 0:f.joined)!=null?i:0),Y=Number((s=f==null?void 0:f.pre_joined)!=null?s:0);$({joined:isNaN(j)?0:j,pre_joined:isNaN(Y)?0:Y})}}catch(r){console.warn("Engagement refresh failed",r)}},[u]),Z=a.useCallback(async()=>{try{const{data:i,error:s}=await w.from("quizzes").select("*").eq("id",u).single();if(s||!i){t({title:"Error",description:"Quiz not found.",variant:"destructive"}),p("/");return}L(i);let r=null;if(o&&o.id){const{data:l,error:f}=await w.from("quiz_participants").select("status").eq("user_id",o.id).eq("quiz_id",u).maybeSingle();!f&&l?(r=l,q(!0),d(l.status||null),r.status==="completed"&&E("completed")):(q(!1),d(null))}else q(!1),d(null);r&&r.status!=="completed"&&await C(),await A()}catch(i){console.error("Error fetching quiz data:",i),t({title:"Error",description:"Failed to load quiz.",variant:"destructive"}),p("/")}},[u,o,p,t,C,A]);a.useEffect(()=>{Z()},[Z]),a.useEffect(()=>{if(!n||x==="completed")return;const i=()=>{const r=new Date,l=n.start_time?new Date(n.start_time):null,f=n.end_time?new Date(n.end_time):null,j=l&&r<l,Y=l&&f&&r>=l&&r<f;if(j){E("waiting"),D(Math.max(0,Math.round((l.getTime()-r.getTime())/1e3)));return}if(Y){E("active"),D(Math.max(0,Math.round((f.getTime()-r.getTime())/1e3)));return}E("finished"),D(0)};i();const s=setInterval(i,1e3);return()=>clearInterval(s)},[n,x]),a.useEffect(()=>{if(!n||!(x==="waiting"||x==="active"))return;const s=setInterval(()=>{se()||A()},ce);return()=>clearInterval(s)},[n,x,A]),a.useEffect(()=>{(async()=>{if(n&&x==="active"&&o)try{if(!N||b==="pre_joined"){const{error:s}=await w.rpc("join_quiz",{p_quiz_id:u});if(s)throw s;q(!0),d("joined")}y.length===0&&await C()}catch(s){t({title:"Unable to start",description:(s==null?void 0:s.message)||"Could not start the quiz.",variant:"destructive"})}})()},[n,x,o,N,b,u,C,y.length,t]),a.useEffect(()=>{x==="finished"&&Object.keys(H).length>0&&!v&&V()},[x]),a.useEffect(()=>{if(c.current&&(clearTimeout(c.current),c.current=null),!(n!=null&&n.end_time)||!(x==="finished"||x==="completed"))return;const i=()=>{(async()=>{try{await X(w,u)}catch(s){}p(`/results/${u}`)})()};return c.current=setTimeout(()=>{c.current=null,i()},de),()=>{c.current&&(clearTimeout(c.current),c.current=null)}},[n==null?void 0:n.end_time,u,x,p]);const ie=a.useCallback(async()=>{if(!n)return;if(!o){t({title:"Login required",description:"Please sign in to join the quiz.",variant:"destructive"}),p("/login");return}if(b==="completed"){t({title:"Already submitted",description:"You have already completed this quiz and cannot join again.",variant:"destructive"});return}try{typeof Notification!="undefined"&&Notification.permission!=="granted"&&!T&&await M()}catch(j){}const i=new Date,s=n.start_time?new Date(n.start_time):null,r=n.end_time?new Date(n.end_time):null,l=n.status==="active"&&s&&r&&i>=s&&i<r,f=l?"join_quiz":"pre_join_quiz";try{const{error:j}=await w.rpc(f,{p_quiz_id:u});if(j)throw j;q(!0),A(),d(l?"joined":"pre_joined"),t({title:l?"Joined!":"Pre-joined!",description:l?"Starting now.":"We will remind you before start."}),l&&(await C(),E("active"))}catch(j){t({title:"Error",description:(j==null?void 0:j.message)||"Could not join.",variant:"destructive"})}},[n,o,b,T,M,u,t,p,A,C]),ne=a.useCallback(async(i,s)=>{if(!(v||x!=="active"||b==="completed"))try{const{error:r}=await w.from("user_answers").upsert({user_id:o.id,question_id:i,selected_option_id:s},{onConflict:"user_id,question_id"});if(r)throw r;U(l=>({...l,[i]:s})),P<y.length-1&&(typeof requestAnimationFrame=="function"?requestAnimationFrame(()=>J(l=>l+1)):setTimeout(()=>J(l=>l+1),250))}catch(r){console.error("Error saving answer:",r),m.current.some(f=>f.questionId===i)||t({title:"Sync delayed",description:"Network issue. Will retry automatically.",variant:"destructive"}),m.current.push({questionId:i,optionId:s,attempt:1}),_()}},[v,x,b,o==null?void 0:o.id,P,y.length,t,_]),V=a.useCallback(async()=>{if(!v){W(!0);try{const{error:i}=await w.from("quiz_participants").update({status:"completed"}).eq("user_id",o.id).eq("quiz_id",u);if(i)throw i;t({title:"Quiz Completed!",description:"Your answers have been submitted. Results will be announced soon!"}),E("completed");try{await X(w,u)}catch(s){}p(`/results/${u}`)}catch(i){console.error("Error submitting quiz:",i),t({title:"Submission Failed",description:"Could not submit your answers. Please try again.",variant:"destructive"})}finally{h.current&&W(!1)}}},[v,o==null?void 0:o.id,u,t,p]),ae=a.useCallback(i=>{const s=Math.floor(i/60),r=i%60;return`${s.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`},[]);return{quiz:n,questions:y,currentQuestionIndex:P,answers:H,quizState:x,timeLeft:O,submitting:v,engagement:Q,joined:N,participantStatus:b,totalJoined:z,displayJoined:R,setCurrentQuestionIndex:J,handleJoinOrPrejoin:ie,handleAnswerSelect:ne,handleSubmit:V,formatTime:ae}}const _e=()=>{var b;const{id:u}=he(),p=fe(),{quiz:t,questions:o,currentQuestionIndex:T,answers:M,quizState:n,timeLeft:L,submitting:y,joined:F,participantStatus:P,totalJoined:J,displayJoined:H,handleJoinOrPrejoin:U,handleAnswerSelect:x,handleSubmit:E,formatTime:O}=be(u,p),[D,v]=a.useState(null);a.useEffect(()=>{if(!(t!=null&&t.end_time)){v(null);return}if(!(n==="completed"||n==="finished")){v(null);return}const d=new Date(t.end_time).getTime(),c=()=>{const m=Math.max(0,d-Date.now());v(m)};c();const h=setInterval(c,1e3);return()=>clearInterval(h)},[t==null?void 0:t.end_time,n]);const W=()=>{if(!(t!=null&&t.end_time))return e.jsx("p",{className:"text-slate-300",children:"Results will be published soon."});const d=D!=null?D:Math.max(0,new Date(t.end_time).getTime()-Date.now()),c=Math.max(0,Math.floor(d/1e3)),h=Math.floor(c/86400),m=Math.floor(c%86400/3600),S=Math.floor(c%3600/60),_=c%60,g=({value:z,label:R})=>e.jsxs("div",{className:"px-3 py-2 rounded-md bg-slate-800/70 border border-slate-700 min-w-[64px]",children:[e.jsx("div",{className:"text-xl font-bold text-white tabular-nums",children:z.toString().padStart(2,"0")}),e.jsx("div",{className:"text-xs text-slate-400",children:R})]});return e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-slate-300",children:"Results will be published soon."}),e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[h>0&&e.jsx(g,{value:h,label:"Days"}),e.jsx(g,{value:m,label:"Hours"}),e.jsx(g,{value:S,label:"Minutes"}),e.jsx(g,{value:_,label:"Seconds"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Expected publish time: ",new Date(t.end_time).toLocaleString()]})]})};if(n==="loading"||!t)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(B,{className:"h-16 w-16 animate-spin text-accent-b mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading quiz..."})]})});const Q=()=>e.jsxs("div",{className:"mt-3 text-xs text-slate-300",children:[e.jsx("div",{className:"text-[11px] text-slate-400",children:t.start_time?me(t.start_time):"—"}),e.jsxs("div",{className:"mt-1 grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide text-[10px] text-slate-400",children:"Start"}),e.jsx("div",{children:t.start_time?K(t.start_time):"—"})]}),e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide text-[10px] text-slate-400",children:"End"}),e.jsx("div",{children:t.end_time?K(t.end_time):"—"})]})]})]}),$=()=>{var g,z,R;const d=Array.isArray(t.prizes)?t.prizes:[],c=t.prize_type||"coins",h=(g=d[0])!=null?g:0,m=(z=d[1])!=null?z:0,S=(R=d[2])!=null?R:0,_=C=>xe(c,C,{fallback:0}).formatted;return e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"px-2 py-1 rounded-md bg-amber-500/15 text-amber-300 border border-amber-700/30",children:["1st ",_(h)]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-sky-500/15 text-sky-300 border border-sky-700/30",children:["2nd ",_(m)]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-violet-500/15 text-violet-300 border border-violet-700/30",children:["3rd ",_(S)]})]})};if(!F&&n!=="completed"){const d=new Date,c=t.start_time?new Date(t.start_time):null,h=t.end_time?new Date(t.end_time):null,m=t.status==="active"&&c&&h&&d>=c&&d<h;return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card relative rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100 w-full",children:[e.jsx("button",{"aria-label":"Close",onClick:()=>window.history.length>1?p(-1):p("/"),className:"absolute top-3 right-3 text-slate-400 hover:text-slate-200 transition",children:e.jsx(ee,{className:"h-5 w-5"})}),e.jsx(G,{className:"h-16 w-16 text-accent-b mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:t.title}),e.jsx("p",{className:"text-slate-300 mb-1",children:m?"Quiz is live!":"Quiz starts in:"}),e.jsx("div",{className:"text-4xl font-bold text-indigo-300 mb-4",children:O(L)}),e.jsx("div",{className:"flex items-center justify-center gap-4 text-sm text-gray-300",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(te,{className:"h-4 w-4 mr-1"}),H," joined"]})}),e.jsx($,{}),e.jsx(Q,{}),e.jsx("div",{className:"mt-6",children:e.jsx(I,{onClick:U,className:m?"bg-emerald-600 hover:bg-emerald-700":"bg-indigo-600 hover:bg-indigo-700",children:m?"Join & Start":"Pre-Join"})})]})})}if(n==="waiting")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card relative rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx("button",{"aria-label":"Close",onClick:()=>window.history.length>1?p(-1):p("/"),className:"absolute top-3 right-3 text-slate-400 hover:text-slate-200 transition",children:e.jsx(ee,{className:"h-5 w-5"})}),e.jsx(G,{className:"h-16 w-16 text-accent-b mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:t.title}),e.jsx("p",{className:"text-slate-300 mb-1",children:"Quiz starts in:"}),e.jsx("div",{className:"text-4xl font-bold text-indigo-300 mb-4",children:O(L)}),e.jsx("div",{className:"flex items-center justify-center gap-4 text-sm text-gray-300",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(te,{className:"h-4 w-4 mr-1"}),J," joined"]})}),e.jsx($,{}),e.jsx(Q,{}),e.jsx("div",{className:"mt-4 text-xs text-slate-400",children:"We’ll auto-start when the timer hits zero."})]})});if(n==="finished")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(k.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx(G,{className:"h-16 w-16 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-3",children:"Quiz Ended"}),W(),y&&e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx(B,{className:"h-6 w-6 animate-spin mr-2"}),e.jsx("span",{children:"Submitting your answers..."})]})]})});if(o.length===0)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-gray-600",children:"No questions available for this quiz."})})});const N=o[T],q=(T+1)/o.length*100;return e.jsx("div",{className:"min-h-screen p-4 bg-[radial-gradient(1000px_600px_at_50%_-100px,rgba(59,130,246,0.25),transparent),radial-gradient(800px_500px_at_120%_0,rgba(168,85,247,0.18),transparent)]",children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs(k.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"rounded-2xl p-4 mb-6 text-slate-100 border border-slate-800/60 bg-slate-900/60 backdrop-blur-md shadow-[0_10px_30px_rgba(0,0,0,0.35)]",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-extrabold text-white tracking-tight",children:t.title}),e.jsxs("p",{className:"text-xs text-slate-400",children:["Question ",T+1," of ",o.length]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-black text-rose-300 tabular-nums",children:O(L)}),e.jsx("div",{className:"text-[10px] text-slate-400 uppercase tracking-wide",children:"Time Left"})]})]}),e.jsx("div",{className:"w-full bg-slate-800/60 rounded-full h-2 mt-4 overflow-hidden",children:e.jsx(k.div,{className:"h-2 rounded-full bg-[linear-gradient(90deg,#22d3ee,#818cf8,#a78bfa,#f472b6)]",style:{width:`${q}%`},transition:{duration:.5}})})]}),e.jsx(ue,{mode:"wait",children:e.jsxs(k.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},exit:{opacity:0,y:-16},transition:{duration:.25},className:"rounded-2xl p-6 text-slate-100 border border-slate-800/60 bg-slate-900/60 backdrop-blur-md shadow-[0_10px_30px_rgba(0,0,0,0.35)]",children:[e.jsx("h2",{className:"text-xl font-bold text-center text-white mb-6 leading-relaxed",children:N.question_text}),e.jsx("div",{className:"space-y-3",children:(b=N.options)==null?void 0:b.map((d,c)=>{const h=M[N.id]===d.id;return e.jsxs(k.button,{onClick:()=>x(N.id,d.id),disabled:y||n!=="active"||P==="completed",whileHover:{scale:1.01},whileTap:{scale:.99},className:`w-full p-4 rounded-xl text-left font-medium transition-all duration-200 border group relative overflow-hidden ${h?"bg-emerald-600/90 text-white border-emerald-400 shadow-[0_10px_24px_rgba(16,185,129,0.25)]":"bg-slate-800/70 hover:bg-slate-800 text-slate-100 border-slate-700/80"}`,children:[e.jsxs("span",{className:`font-bold mr-3 ${h?"text-white":"text-indigo-300"}`,children:[String.fromCharCode(65+c),"."]}),d.option_text,!h&&e.jsx("span",{className:"absolute inset-y-0 right-0 w-0 group-hover:w-1/6 transition-[width] duration-200 bg-gradient-to-l from-indigo-500/20 to-transparent"})]},d.id)})}),T===o.length-1&&Object.keys(M).length===o.length&&e.jsx(k.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},transition:{delay:.25},className:"mt-7",children:e.jsx(I,{onClick:E,disabled:y,className:"w-full text-white font-extrabold py-4 text-lg border border-violet-500/40 shadow-[0_8px_18px_rgba(139,92,246,0.35)] hover:shadow-[0_12px_24px_rgba(139,92,246,0.55)] bg-[linear-gradient(90deg,#4f46e5,#7c3aed,#9333ea,#c026d3)]",children:y?e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"mr-2 h-6 w-6 animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"mr-2 h-6 w-6"}),"Submit Quiz"]})})})]},N.id)})]})})};export{_e as default};
