import{u as q,a as F,s as M,j as e,B as h}from"./index-0a1e05c4.js";import{r as o}from"./react-8a702e3e.js";import{g as G}from"./avatar-94f2865b.js";import{c as V,a as W}from"./router-bcacfb8d.js";import{m as j}from"./motion-511bde03.js";import{T as P,M as Y,V as J,q as K}from"./icons-b32a7949.js";import"./supabase-4c1332f7.js";const le=()=>{var E;const{id:b}=V(),N=W(),{toast:S}=q(),{user:v}=F(),[a,D]=o.useState(null),[g,y]=o.useState([]),[x,B]=o.useState(null),[w,A]=o.useState(!0),[z,_]=o.useState(""),[C,f]=o.useState(null),[L,U]=o.useState(!1);o.useEffect(()=>{k()},[b]);const k=async()=>{try{_("");const{data:s}=await M.from("quizzes").select("*").eq("id",b).single();D(s||null);const{data:t,error:c}=await M.from("quiz_results").select("leaderboard").eq("quiz_id",b).maybeSingle();if(c)throw c;const n=Array.isArray(t==null?void 0:t.leaderboard)?t.leaderboard:[];if(!t||n.length===0){if(y([]),s!=null&&s.result_time){const r=new Date(s.result_time).getTime()-Date.now();f(r>0?r:0)}else f(null);return}const i=n.map((l,r)=>{var m;return{id:`${b}-${l.user_id}`,user_id:l.user_id,score:Number(l.score)||0,rank:Number(l.rank)||r+1,profiles:{username:(m=l.display_name)!=null&&m.startsWith("@")?l.display_name.slice(1):void 0,full_name:l.display_name,avatar_url:void 0}}}).sort((l,r)=>r.score-l.score);y(i);try{const l=i.slice(0,10).map(r=>r.user_id);if(l.length){const{data:r,error:m}=await M.rpc("profiles_public_by_ids",{p_ids:l});if(m&&console.warn("Public profile fetch failed:",m),Array.isArray(r)&&r.length){const Q=new Map(r.map(u=>[u.id,u])),$=await G(r.map(u=>u.avatar_url).filter(Boolean));y(u=>u.map(R=>{const p=Q.get(R.user_id);if(!p)return R;const H=p.avatar_url&&$.get(p.avatar_url)||"";return{...R,profiles:{username:p.username,full_name:p.full_name,avatar_url:H}}}))}}}catch(l){}const d=i.find(l=>l.user_id===(v==null?void 0:v.id));d&&B(d)}catch(s){console.error("Error fetching results:",s),_((s==null?void 0:s.message)||"Failed to load results.")}finally{A(!1)}},T=()=>{A(!0),_(""),k()};o.useEffect(()=>{if(!(a!=null&&a.result_time)||g.length>0){f(null);return}const s=new Date(a.result_time).getTime(),t=()=>{const n=s-Date.now();n>0?f(n):(f(0),L||(U(!0),k()))};t();const c=setInterval(t,1e3);return()=>clearInterval(c)},[a==null?void 0:a.result_time,g.length]);const I=s=>{const t=Math.max(0,Math.floor((s!=null?s:0)/1e3)),c=Math.floor(t/86400),n=Math.floor(t%86400/3600),i=Math.floor(t%3600/60),d=t%60;return{days:c,hours:n,minutes:i,seconds:d}};return w?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-accent-b"})}):!w&&z?e.jsx("div",{className:"min-h-screen p-4 flex items-center justify-center",children:e.jsxs("div",{className:"qd-card rounded-2xl p-6 shadow-lg text-center max-w-md w-full text-slate-100",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2 text-white",children:"Couldn\\'t load results"}),e.jsx("p",{className:"text-slate-300 mb-4",children:z}),e.jsxs("div",{className:"flex justify-center gap-3",children:[e.jsx(h,{variant:"brand",onClick:T,children:"Retry"}),e.jsx(h,{variant:"white",onClick:()=>N("/my-quizzes"),children:"Back"})]})]})}):!w&&g.length===0?e.jsx("div",{className:"min-h-screen p-4 flex items-center justify-center",children:e.jsxs("div",{className:"qd-card rounded-2xl p-6 shadow-lg text-center max-w-md w-full text-slate-100",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2 text-white",children:"Results not published yet"}),a!=null&&a.result_time?e.jsx("div",{className:"mb-4",children:C>0?e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-300 mb-3",children:"Results will be published in"}),(()=>{const{days:s,hours:t,minutes:c,seconds:n}=I(C),i=(d,l)=>e.jsxs("div",{className:"px-3 py-2 rounded-md bg-slate-800/70 border border-slate-700 min-w-[64px]",children:[e.jsx("div",{className:"text-xl font-bold text-white tabular-nums",children:d.toString().padStart(2,"0")}),e.jsx("div",{className:"text-xs text-slate-400",children:l})]});return e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[s>0&&i(s,"Days"),i(t,"Hours"),i(c,"Minutes"),i(n,"Seconds")]})})(),e.jsxs("p",{className:"text-xs text-slate-400 mt-3",children:["Result time: ",new Date(a.result_time).toLocaleString()]})]}):e.jsx("p",{className:"text-slate-300 mb-4",children:"Publishing soonâ€¦ please stay on this page."})}):e.jsx("p",{className:"text-slate-300 mb-4",children:"Please check back after the result time."}),e.jsxs("div",{className:"flex justify-center gap-3",children:[e.jsx(h,{variant:"brand",onClick:T,children:"Refresh"}),e.jsx(h,{variant:"white",onClick:()=>N("/my-quizzes"),children:"Back to My Quizzes"}),e.jsx(h,{variant:"white",onClick:()=>N("/"),children:"Go Home"})]})]})}):e.jsx("div",{className:"min-h-screen p-4",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs(j.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"text-center mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-white text-shadow mb-2",children:"Quiz Results"}),e.jsx("p",{className:"text-slate-300",children:a==null?void 0:a.title})]}),e.jsxs("div",{className:"flex justify-center gap-3 mb-8",children:[e.jsx(h,{variant:"white",onClick:()=>N("/my-quizzes"),children:"Back to My Quizzes"}),e.jsx(h,{variant:"brand",onClick:async()=>{var s;try{const t=window.location.href;(s=navigator.clipboard)!=null&&s.writeText?(await navigator.clipboard.writeText(t),S({title:"Link copied",description:"Result link copied to clipboard"})):window.prompt("Copy result link:",t)}catch(t){S({title:"Copy failed",description:t.message,variant:"destructive"})}},children:"Share Result"})]}),x&&e.jsx(j.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"qd-card rounded-2xl p-6 shadow-lg mb-8 text-slate-100",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:x.rank===1?e.jsx(P,{className:"h-16 w-16 text-yellow-500"}):x.rank===2?e.jsx(Y,{className:"h-16 w-16 text-gray-400"}):x.rank===3?e.jsx(J,{className:"h-16 w-16 text-orange-500"}):e.jsx(K,{className:"h-16 w-16 text-blue-500"})}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:"Your Result"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-3xl font-bold text-accent-b",children:["#",x.rank]}),e.jsx("p",{className:"text-sm text-slate-300",children:"Rank"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-3xl font-bold text-green-400",children:x.score}),e.jsx("p",{className:"text-sm text-slate-300",children:"Score"})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-3xl font-bold text-purple-300",children:["â‚¹",x.rank<=3&&((E=a==null?void 0:a.prizes)==null?void 0:E[x.rank-1])||0]}),e.jsx("p",{className:"text-sm text-slate-300",children:"Prize"})]})]})]})}),e.jsxs(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card rounded-2xl p-6 shadow-lg mb-6 text-slate-100",children:[e.jsx("h2",{className:"text-xl font-bold text-white mb-4",children:"Prize Distribution"}),Array.isArray(a==null?void 0:a.prizes)&&a.prizes.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:a.prizes.map((s,t)=>e.jsxs("div",{className:"p-4 rounded-lg bg-slate-800/70 flex items-center justify-between",children:[e.jsx("div",{className:"font-medium text-slate-100",children:t===0?"1st":t===1?"2nd":t===2?"3rd":`#${t+1}`}),e.jsxs("div",{className:"text-accent-b font-bold",children:["â‚¹",s]})]},t))}):e.jsx("div",{className:"text-sm text-slate-300",children:"No prize data available"})]}),e.jsxs(j.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card rounded-2xl p-6 shadow-lg text-slate-100",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-800 mb-6 flex items-center",children:[e.jsx(P,{className:"mr-2 text-accent-a"}),e.jsx("span",{className:"text-white",children:"Leaderboard"})]}),e.jsx("div",{className:"space-y-4",children:g.map((s,t)=>{var c,n,i,d,l,r,m;return e.jsxs(j.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:t*.1},className:`flex items-center justify-between p-4 rounded-lg ${s.user_id===v.id?"bg-slate-800/70 border border-accent-b/50":"bg-slate-800/60 border border-slate-700"}`,children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 rounded-full bg-accent-b text-white font-bold",children:t+1}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full overflow-hidden bg-gray-200 flex items-center justify-center text-gray-600 font-bold",children:(c=s.profiles)!=null&&c.avatar_url?e.jsx("img",{src:s.profiles.avatar_url,alt:"avatar",className:"w-full h-full object-cover"}):e.jsx("span",{children:(((n=s.profiles)==null?void 0:n.full_name)||((i=s.profiles)==null?void 0:i.username)||"U").charAt(0).toUpperCase()})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-white",children:((d=s.profiles)==null?void 0:d.username)||((l=s.profiles)==null?void 0:l.full_name)||"Anonymous"}),((r=s.profiles)==null?void 0:r.full_name)&&((m=s.profiles)==null?void 0:m.username)&&e.jsx("p",{className:"text-xs text-slate-300",children:s.profiles.full_name})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-lg font-bold text-green-400",children:s.score}),e.jsx("p",{className:"text-xs text-slate-300",children:"Score"})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-lg font-bold text-purple-300",children:["â‚¹",t<3&&Array.isArray(a==null?void 0:a.prizes)&&a.prizes[t]||0]}),e.jsx("p",{className:"text-xs text-slate-300",children:"Prize"})]}),t<3&&e.jsx("div",{className:"text-2xl",children:t===0?"ðŸ¥‡":t===1?"ðŸ¥ˆ":"ðŸ¥‰"})]})]},s.id)})})]})]})})};export{le as default};
