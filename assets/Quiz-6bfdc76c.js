import{a as te,u as se,s as f,j as e,B as D,f as ie,b as U}from"./index-20bb43d4.js";import{r as n}from"./react-8a702e3e.js";import{c as ae,a as re}from"./router-bcacfb8d.js";import{L as A,X as B,e as T,d as W,o as H}from"./icons-3e0b0f01.js";import{m as p,A as ne}from"./motion-511bde03.js";import"./supabase-4c1332f7.js";const he=()=>{var R;const{id:d}=ae(),u=re(),{user:x,userProfile:le}=te(),{toast:c}=se(),[i,V]=n.useState(null),[h,P]=n.useState([]),[b,X]=n.useState(0),[S,G]=n.useState({}),[l,j]=n.useState("loading"),[C,E]=n.useState(0),[g,L]=n.useState(!1),[I,J]=n.useState({joined:0,pre_joined:0}),M=(I.joined||0)+(I.pre_joined||0),[k,w]=n.useState(!1),[v,y]=n.useState(null),N=n.useCallback(async()=>{const{data:t,error:a}=await f.from("questions").select(`
        id,
        question_text,
        options (
          id,
          option_text
        )
      `).eq("quiz_id",d).order("id");P(a?[]:t||[])},[d]),F=n.useCallback(async()=>{try{const{data:t,error:a}=await f.from("quizzes").select("*").eq("id",d).single();if(a||!t){c({title:"Error",description:"Quiz not found.",variant:"destructive"}),u("/");return}V(t);let s=null;if(x&&x.id){const{data:r,error:o}=await f.from("quiz_participants").select("status").eq("user_id",x.id).eq("quiz_id",d).maybeSingle();!o&&r?(s=r,w(!0),y(r.status||null),s.status==="completed"&&j("completed")):(w(!1),y(null))}else w(!1),y(null);s&&s.status!=="completed"&&await N(),await z()}catch(t){console.error("Error fetching quiz data:",t),c({title:"Error",description:"Failed to load quiz.",variant:"destructive"}),u("/")}},[d,x.id,u,c,N]),z=n.useCallback(async()=>{var t,a;try{const{data:s,error:r}=await f.rpc("get_engagement_counts",{p_quiz_id:d});if(r)console.warn("Engagement counts fetch failed:",r),J({joined:0,pre_joined:0});else{const o=Array.isArray(s)?s[0]:s,m=Number((t=o==null?void 0:o.joined)!=null?t:0),q=Number((a=o==null?void 0:o.pre_joined)!=null?a:0);J({joined:isNaN(m)?0:m,pre_joined:isNaN(q)?0:q})}}catch(s){console.warn("Engagement refresh failed",s)}},[d]);n.useEffect(()=>{F()},[F]),n.useEffect(()=>{if(!i||l==="completed")return;const t=()=>{const s=new Date,r=i.start_time?new Date(i.start_time):null,o=i.end_time?new Date(i.end_time):null,m=r&&s<r,q=r&&o&&s>=r&&s<o;if(m){j("waiting"),E(Math.max(0,Math.round((r.getTime()-s.getTime())/1e3)));return}if(q){j("active"),E(Math.max(0,Math.round((o.getTime()-s.getTime())/1e3)));return}j("finished"),E(0)};t();const a=setInterval(t,1e3);return()=>clearInterval(a)},[i,l]),n.useEffect(()=>{if(!i||!(l==="waiting"||l==="active"))return;const t=setInterval(z,15e3);return()=>clearInterval(t)},[i,l,z]),n.useEffect(()=>{(async()=>{if(i&&l==="active"&&x)try{if(!k||v==="pre_joined"){const{error:a}=await f.rpc("join_quiz",{p_quiz_id:d});if(a)throw a;w(!0),y("joined")}h.length===0&&await N()}catch(a){c({title:"Unable to start",description:(a==null?void 0:a.message)||"Could not start the quiz.",variant:"destructive"})}})()},[i,l,x,k,v,d,N,h.length,c]),n.useEffect(()=>{l==="finished"&&Object.keys(S).length>0&&!g&&O()},[l]);const K=async(t,a)=>{if(!(g||l!=="active"||v==="completed"))try{const{error:s}=await f.from("user_answers").upsert({user_id:x.id,question_id:t,selected_option_id:a},{onConflict:"user_id,question_id"});if(s)throw s;G(r=>({...r,[t]:a})),b<h.length-1&&setTimeout(()=>{X(r=>r+1)},500),c({title:"Answer Saved",description:"Your answer has been recorded."})}catch(s){console.error("Error saving answer:",s),c({title:"Error",description:"Failed to save answer. Please try again.",variant:"destructive"})}},Z=async()=>{if(!i)return;if(!x){c({title:"Login required",description:"Please sign in to join the quiz.",variant:"destructive"}),u("/login");return}if(v==="completed"){c({title:"Already submitted",description:"You have already completed this quiz and cannot join again.",variant:"destructive"});return}const t=new Date,a=i.start_time?new Date(i.start_time):null,s=i.end_time?new Date(i.end_time):null,r=i.status==="active"&&a&&s&&t>=a&&t<s,o=r?"join_quiz":"pre_join_quiz";try{const{error:m}=await f.rpc(o,{p_quiz_id:d});if(m)throw m;w(!0),z(),y(r?"joined":"pre_joined"),c({title:r?"Joined!":"Pre-joined!",description:r?"Starting now.":"We will remind you before start."}),r&&(await N(),j("active"))}catch(m){c({title:"Error",description:(m==null?void 0:m.message)||"Could not join.",variant:"destructive"})}},O=async()=>{if(!g){L(!0);try{const{error:t}=await f.from("quiz_participants").update({status:"completed"}).eq("user_id",x.id).eq("quiz_id",d);if(t)throw t;c({title:"Quiz Completed!",description:"Your answers have been submitted. Results will be announced soon!"}),j("completed"),setTimeout(()=>{u("/my-quizzes")},3e3)}catch(t){console.error("Error submitting quiz:",t),c({title:"Submission Failed",description:"Could not submit your answers. Please try again.",variant:"destructive"})}finally{L(!1)}}},Q=t=>{const a=Math.floor(t/60),s=t%60;return`${a.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`};if(l==="loading"||!i)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(A,{className:"h-16 w-16 animate-spin text-accent-b mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading quiz..."})]})});const $=()=>e.jsxs("div",{className:"mt-3 text-xs text-slate-300",children:[e.jsx("div",{className:"text-[11px] text-slate-400",children:i.start_time?ie(i.start_time):"—"}),e.jsxs("div",{className:"mt-1 grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide text-[10px] text-slate-400",children:"Start"}),e.jsx("div",{children:i.start_time?U(i.start_time):"—"})]}),e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide text-[10px] text-slate-400",children:"End"}),e.jsx("div",{children:i.end_time?U(i.end_time):"—"})]})]})]}),Y=()=>{const t=Array.isArray(i.prizes)?i.prizes:[],a=t[0]||0,s=t[1]||0,r=t[2]||0;return e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"px-2 py-1 rounded-md bg-amber-500/15 text-amber-300 border border-amber-700/30",children:["1st ₹",a]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-sky-500/15 text-sky-300 border border-sky-700/30",children:["2nd ₹",s]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-violet-500/15 text-violet-300 border border-violet-700/30",children:["3rd ₹",r]})]})};if(!k&&l!=="completed"){const t=new Date,a=i.start_time?new Date(i.start_time):null,s=i.end_time?new Date(i.end_time):null,r=i.status==="active"&&a&&s&&t>=a&&t<s;return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card relative rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100 w-full",children:[e.jsx("button",{"aria-label":"Close",onClick:()=>window.history.length>1?u(-1):u("/"),className:"absolute top-3 right-3 text-slate-400 hover:text-slate-200 transition",children:e.jsx(B,{className:"h-5 w-5"})}),e.jsx(T,{className:"h-16 w-16 text-accent-b mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:i.title}),e.jsx("p",{className:"text-slate-300 mb-1",children:r?"Quiz is live!":"Quiz starts in:"}),e.jsx("div",{className:"text-4xl font-bold text-indigo-300 mb-4",children:Q(C)}),e.jsx("div",{className:"flex items-center justify-center gap-4 text-sm text-gray-300",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(W,{className:"h-4 w-4 mr-1"}),M," joined"]})}),e.jsx(Y,{}),e.jsx($,{}),e.jsx("div",{className:"mt-6",children:e.jsx(D,{onClick:Z,className:r?"bg-emerald-600 hover:bg-emerald-700":"bg-indigo-600 hover:bg-indigo-700",children:r?"Join & Start":"Pre-Join"})})]})})}if(l==="completed")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(p.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx(H,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:"Quiz Completed!"}),e.jsx("p",{className:"text-slate-300 mb-4",children:"You have already submitted your answers for this quiz."}),e.jsx(D,{onClick:()=>u("/my-quizzes"),variant:"brand",className:"w-full",children:"View My Quizzes"})]})});if(l==="waiting")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(p.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card relative rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx("button",{"aria-label":"Close",onClick:()=>window.history.length>1?u(-1):u("/"),className:"absolute top-3 right-3 text-slate-400 hover:text-slate-200 transition",children:e.jsx(B,{className:"h-5 w-5"})}),e.jsx(T,{className:"h-16 w-16 text-accent-b mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:i.title}),e.jsx("p",{className:"text-slate-300 mb-1",children:"Quiz starts in:"}),e.jsx("div",{className:"text-4xl font-bold text-indigo-300 mb-4",children:Q(C)}),e.jsx("div",{className:"flex items-center justify-center gap-4 text-sm text-gray-300",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(W,{className:"h-4 w-4 mr-1"}),M," joined"]})}),e.jsx(Y,{}),e.jsx($,{}),e.jsx("div",{className:"mt-4 text-xs text-slate-400",children:"We’ll auto-start when the timer hits zero."})]})});if(l==="finished")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(p.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx(T,{className:"h-16 w-16 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:"Quiz Ended"}),e.jsx("p",{className:"text-slate-300 mb-4",children:"The quiz has ended. Results will be announced soon!"}),g&&e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx(A,{className:"h-6 w-6 animate-spin mr-2"}),e.jsx("span",{children:"Submitting your answers..."})]})]})});if(h.length===0)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-gray-600",children:"No questions available for this quiz."})})});const _=h[b],ee=(b+1)/h.length*100;return e.jsx("div",{className:"min-h-screen p-4 bg-[radial-gradient(1000px_600px_at_50%_-100px,rgba(59,130,246,0.25),transparent),radial-gradient(800px_500px_at_120%_0,rgba(168,85,247,0.18),transparent)]",children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs(p.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"rounded-2xl p-4 mb-6 text-slate-100 border border-slate-800/60 bg-slate-900/60 backdrop-blur-md shadow-[0_10px_30px_rgba(0,0,0,0.35)]",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-extrabold text-white tracking-tight",children:i.title}),e.jsxs("p",{className:"text-xs text-slate-400",children:["Question ",b+1," of ",h.length]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-black text-rose-300 tabular-nums",children:Q(C)}),e.jsx("div",{className:"text-[10px] text-slate-400 uppercase tracking-wide",children:"Time Left"})]})]}),e.jsx("div",{className:"w-full bg-slate-800/60 rounded-full h-2 mt-4 overflow-hidden",children:e.jsx(p.div,{className:"h-2 rounded-full bg-[linear-gradient(90deg,#22d3ee,#818cf8,#a78bfa,#f472b6)]",style:{width:`${ee}%`},transition:{duration:.5}})})]}),e.jsx(ne,{mode:"wait",children:e.jsxs(p.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},exit:{opacity:0,y:-16},transition:{duration:.25},className:"rounded-2xl p-6 text-slate-100 border border-slate-800/60 bg-slate-900/60 backdrop-blur-md shadow-[0_10px_30px_rgba(0,0,0,0.35)]",children:[e.jsx("h2",{className:"text-xl font-bold text-center text-white mb-6 leading-relaxed",children:_.question_text}),e.jsx("div",{className:"space-y-3",children:(R=_.options)==null?void 0:R.map((t,a)=>{const s=S[_.id]===t.id;return e.jsxs(p.button,{onClick:()=>K(_.id,t.id),disabled:g||l!=="active"||v==="completed",whileHover:{scale:1.01},whileTap:{scale:.99},className:`w-full p-4 rounded-xl text-left font-medium transition-all duration-200 border group relative overflow-hidden ${s?"bg-emerald-600/90 text-white border-emerald-400 shadow-[0_10px_24px_rgba(16,185,129,0.25)]":"bg-slate-800/70 hover:bg-slate-800 text-slate-100 border-slate-700/80"}`,children:[e.jsxs("span",{className:`font-bold mr-3 ${s?"text-white":"text-indigo-300"}`,children:[String.fromCharCode(65+a),"."]}),t.option_text,!s&&e.jsx("span",{className:"absolute inset-y-0 right-0 w-0 group-hover:w-1/6 transition-[width] duration-200 bg-gradient-to-l from-indigo-500/20 to-transparent"})]},t.id)})}),b===h.length-1&&Object.keys(S).length===h.length&&e.jsx(p.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},transition:{delay:.25},className:"mt-7",children:e.jsx(D,{onClick:O,disabled:g,className:"w-full text-white font-extrabold py-4 text-lg border border-violet-500/40 shadow-[0_8px_18px_rgba(139,92,246,0.35)] hover:shadow-[0_12px_24px_rgba(139,92,246,0.55)] bg-[linear-gradient(90deg,#4f46e5,#7c3aed,#9333ea,#c026d3)]",children:g?e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"mr-2 h-6 w-6 animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(H,{className:"mr-2 h-6 w-6"}),"Submit Quiz"]})})})]},_.id)})]})})};export{he as default};
