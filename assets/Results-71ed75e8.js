import{u as B,a as I,s as _,j as e,B as v}from"./index-9ff65d13.js";import{r as m}from"./react-8a702e3e.js";import{c as Q,a as U}from"./router-bcacfb8d.js";import{m as u}from"./motion-511bde03.js";import{T as z,M as $,g as H,r as G}from"./icons-c5cbdee3.js";import"./supabase-4c1332f7.js";const V=()=>{var M;const{id:f}=Q(),g=U(),{toast:k}=B(),{user:p}=I(),[a,C]=m.useState(null),[j,y]=m.useState([]),[o,T]=m.useState(null),[R,D]=m.useState(!0),[A,h]=m.useState(null),[P,E]=m.useState(!1);m.useEffect(()=>{S()},[f]);const S=async()=>{try{const{data:s}=await _.from("quizzes").select("*").eq("id",f).single();C(s||null);const{data:t,error:c}=await _.from("quiz_results").select("leaderboard").eq("quiz_id",f).maybeSingle();if(c)throw c;const n=Array.isArray(t==null?void 0:t.leaderboard)?t.leaderboard:[];if(!t||n.length===0){if(y([]),s!=null&&s.result_time){const r=new Date(s.result_time).getTime()-Date.now();h(r>0?r:0)}else h(null);return}const i=n.map((l,r)=>{var x;return{id:`${f}-${l.user_id}`,user_id:l.user_id,score:Number(l.score)||0,rank:Number(l.rank)||r+1,profiles:{username:(x=l.display_name)!=null&&x.startsWith("@")?l.display_name.slice(1):void 0,full_name:l.display_name,avatar_url:void 0}}}).sort((l,r)=>r.score-l.score);y(i);try{const l=i.slice(0,10).map(r=>r.user_id);if(l.length){const{data:r}=await _.from("profiles").select("id, username, full_name, avatar_url").in("id",l);if(Array.isArray(r)){const x=new Map(r.map(b=>[b.id,b]));y(b=>b.map(w=>{const N=x.get(w.user_id);return N?{...w,profiles:{username:N.username,full_name:N.full_name,avatar_url:N.avatar_url}}:w}))}}}catch(l){}const d=i.find(l=>l.user_id===(p==null?void 0:p.id));d&&T(d)}catch(s){console.error("Error fetching results:",s)}finally{D(!1)}};m.useEffect(()=>{if(!(a!=null&&a.result_time)||j.length>0){h(null);return}const s=new Date(a.result_time).getTime(),t=()=>{const n=s-Date.now();n>0?h(n):(h(0),P||(E(!0),S()))};t();const c=setInterval(t,1e3);return()=>clearInterval(c)},[a==null?void 0:a.result_time,j.length]);const L=s=>{const t=Math.max(0,Math.floor((s!=null?s:0)/1e3)),c=Math.floor(t/86400),n=Math.floor(t%86400/3600),i=Math.floor(t%3600/60),d=t%60;return{days:c,hours:n,minutes:i,seconds:d}};return R?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-accent-b"})}):!R&&j.length===0?e.jsx("div",{className:"min-h-screen p-4 flex items-center justify-center",children:e.jsxs("div",{className:"qd-card rounded-2xl p-6 shadow-lg text-center max-w-md w-full text-slate-100",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2 text-white",children:"Results not published yet"}),a!=null&&a.result_time?e.jsx("div",{className:"mb-4",children:A>0?e.jsxs("div",{children:[e.jsx("p",{className:"text-slate-300 mb-3",children:"Results will be published in"}),(()=>{const{days:s,hours:t,minutes:c,seconds:n}=L(A),i=(d,l)=>e.jsxs("div",{className:"px-3 py-2 rounded-md bg-slate-800/70 border border-slate-700 min-w-[64px]",children:[e.jsx("div",{className:"text-xl font-bold text-white tabular-nums",children:d.toString().padStart(2,"0")}),e.jsx("div",{className:"text-xs text-slate-400",children:l})]});return e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[s>0&&i(s,"Days"),i(t,"Hours"),i(c,"Minutes"),i(n,"Seconds")]})})(),e.jsxs("p",{className:"text-xs text-slate-400 mt-3",children:["Result time: ",new Date(a.result_time).toLocaleString()]})]}):e.jsx("p",{className:"text-slate-300 mb-4",children:"Publishing soonâ€¦ please stay on this page."})}):e.jsx("p",{className:"text-slate-300 mb-4",children:"Please check back after the result time."}),e.jsxs("div",{className:"flex justify-center gap-3",children:[e.jsx(v,{variant:"white",onClick:()=>g("/my-quizzes"),children:"Back to My Quizzes"}),e.jsx(v,{variant:"brand",onClick:()=>g("/"),children:"Go Home"})]})]})}):e.jsx("div",{className:"min-h-screen p-4",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs(u.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"text-center mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-white text-shadow mb-2",children:"Quiz Results"}),e.jsx("p",{className:"text-slate-300",children:a==null?void 0:a.title})]}),e.jsxs("div",{className:"flex justify-center gap-3 mb-8",children:[e.jsx(v,{variant:"white",onClick:()=>g("/my-quizzes"),children:"Back to My Quizzes"}),e.jsx(v,{variant:"brand",onClick:async()=>{var s;try{const t=window.location.href;(s=navigator.clipboard)!=null&&s.writeText?(await navigator.clipboard.writeText(t),k({title:"Link copied",description:"Result link copied to clipboard"})):window.prompt("Copy result link:",t)}catch(t){k({title:"Copy failed",description:t.message,variant:"destructive"})}},children:"Share Result"})]}),o&&e.jsx(u.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"qd-card rounded-2xl p-6 shadow-lg mb-8 text-slate-100",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:o.rank===1?e.jsx(z,{className:"h-16 w-16 text-yellow-500"}):o.rank===2?e.jsx($,{className:"h-16 w-16 text-gray-400"}):o.rank===3?e.jsx(H,{className:"h-16 w-16 text-orange-500"}):e.jsx(G,{className:"h-16 w-16 text-blue-500"})}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:"Your Result"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-3xl font-bold text-accent-b",children:["#",o.rank]}),e.jsx("p",{className:"text-sm text-slate-300",children:"Rank"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-3xl font-bold text-green-400",children:o.score}),e.jsx("p",{className:"text-sm text-slate-300",children:"Score"})]}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-3xl font-bold text-purple-300",children:["â‚¹",o.rank<=3&&((M=a==null?void 0:a.prizes)==null?void 0:M[o.rank-1])||0]}),e.jsx("p",{className:"text-sm text-slate-300",children:"Prize"})]})]})]})}),e.jsxs(u.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card rounded-2xl p-6 shadow-lg mb-6 text-slate-100",children:[e.jsx("h2",{className:"text-xl font-bold text-white mb-4",children:"Prize Distribution"}),Array.isArray(a==null?void 0:a.prizes)&&a.prizes.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:a.prizes.map((s,t)=>e.jsxs("div",{className:"p-4 rounded-lg bg-slate-800/70 flex items-center justify-between",children:[e.jsx("div",{className:"font-medium text-slate-100",children:t===0?"1st":t===1?"2nd":t===2?"3rd":`#${t+1}`}),e.jsxs("div",{className:"text-accent-b font-bold",children:["â‚¹",s]})]},t))}):e.jsx("div",{className:"text-sm text-slate-300",children:"No prize data available"})]}),e.jsxs(u.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card rounded-2xl p-6 shadow-lg text-slate-100",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-800 mb-6 flex items-center",children:[e.jsx(z,{className:"mr-2 text-accent-a"}),e.jsx("span",{className:"text-white",children:"Leaderboard"})]}),e.jsx("div",{className:"space-y-4",children:j.map((s,t)=>{var c,n,i,d,l,r,x;return e.jsxs(u.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:t*.1},className:`flex items-center justify-between p-4 rounded-lg ${s.user_id===p.id?"bg-slate-800/70 border border-accent-b/50":"bg-slate-800/60 border border-slate-700"}`,children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"flex items-center justify-center w-10 h-10 rounded-full bg-accent-b text-white font-bold",children:t+1}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full overflow-hidden bg-gray-200 flex items-center justify-center text-gray-600 font-bold",children:(c=s.profiles)!=null&&c.avatar_url?e.jsx("img",{src:s.profiles.avatar_url,alt:"avatar",className:"w-full h-full object-cover"}):e.jsx("span",{children:(((n=s.profiles)==null?void 0:n.full_name)||((i=s.profiles)==null?void 0:i.username)||"U").charAt(0).toUpperCase()})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-white",children:((d=s.profiles)==null?void 0:d.username)||((l=s.profiles)==null?void 0:l.full_name)||"Anonymous"}),((r=s.profiles)==null?void 0:r.full_name)&&((x=s.profiles)==null?void 0:x.username)&&e.jsx("p",{className:"text-xs text-slate-300",children:s.profiles.full_name})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-lg font-bold text-green-400",children:s.score}),e.jsx("p",{className:"text-xs text-slate-300",children:"Score"})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-lg font-bold text-purple-300",children:["â‚¹",t<3&&Array.isArray(a==null?void 0:a.prizes)&&a.prizes[t]||0]}),e.jsx("p",{className:"text-xs text-slate-300",children:"Prize"})]}),t<3&&e.jsx("div",{className:"text-2xl",children:t===0?"ðŸ¥‡":t===1?"ðŸ¥ˆ":"ðŸ¥‰"})]})]},s.id)})})]})]})})};export{V as default};
