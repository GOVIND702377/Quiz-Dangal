import{a as G,u as q,j as e,I as L,B as y,s as E}from"./index-1b1aa69a.js";import{r as p}from"./react-8a702e3e.js";import{g as H}from"./avatar-d10e088e.js";import{G as Q,C as R,d as I,a1 as P,a2 as O,f as Y}from"./icons-3e0b0f01.js";import"./supabase-4c1332f7.js";import"./router-bcacfb8d.js";import"./motion-511bde03.js";const ae=()=>{const{user:N,userProfile:C}=G(),{toast:g}=q(),[_,S]=p.useState({total:0,earnings:0}),[u,U]=p.useState([]),[$,b]=p.useState(""),[W,A]=p.useState(!0),[m,T]=p.useState(null),w=(C==null?void 0:C.referral_code)||"",x=`${window.location.origin}?ref=${w}`,j="Earn coins by playing quizzes! Use my referral to get started.";p.useEffect(()=>{let t=!0;return(async()=>{if(N){A(!0);try{const{data:r,error:n}=await E.from("referrals").select("*").eq("referrer_id",N.id).order("created_at",{ascending:!1});if(n&&n.code!=="PGRST116")throw n;if(!t)return;let o=r||[];if(o.length){const c=Array.from(new Set(o.map(i=>i.referred_id).filter(Boolean)));if(c.length){const{data:i,error:s}=await E.rpc("profiles_public_by_ids",{p_ids:c});s&&console.warn("Referral profile lookup failed:",s);const l=i||[],D=new Map(l.map(d=>[d.id,d])),F=await H(l.map(d=>d.avatar_url).filter(Boolean));o=o.map(d=>{const v=D.get(d.referred_id);if(!v)return{...d,referred:null};const M=v.avatar_url&&F.get(v.avatar_url)||"";return{...d,referred:{...v,avatar_url:M}}})}}const h=o.length,f=o.reduce((c,i)=>c+(i.coins_awarded||0),0)||0;S({total:h,earnings:f}),U(o)}catch(r){if(!t)return;S({total:0,earnings:0}),U([])}finally{t&&A(!1)}}})(),()=>{t=!1}},[N]),p.useEffect(()=>{let t=!1;return(async()=>{try{const a=`${window.location.origin}/refer-earn-poster.png`,n=await(await fetch(a,{cache:"force-cache"})).blob();t||T(n)}catch(a){t||T(null)}})(),()=>{t=!0}},[w]);const k=async(t,a)=>{try{await navigator.clipboard.writeText(t),b(a),setTimeout(()=>b(""),1600)}catch(r){const n=document.createElement("textarea");n.value=t,document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n),b(a),setTimeout(()=>b(""),1600)}},z=async()=>{const t=`${j} ${x}`;try{const a=m;try{await navigator.clipboard.writeText(t)}catch(r){}if(a&&navigator.canShare&&window.File){const r=new File([a],"refer-earn-poster.png",{type:"image/png"});if(navigator.canShare({files:[r],text:t})){await navigator.share({files:[r],text:t,title:"Quiz Dangal"}),g({title:"Shared",description:"If the caption is missing in the app, it's copied. Just paste."});return}}}catch(a){}try{const a=encodeURIComponent(`${j}
${x}`),r=navigator.userAgent||"",o=/iPhone|iPad|iPod/i.test(r)?`https://wa.me/?text=${a}`:`whatsapp://send?text=${a}`;if(window.open(o,"_blank")){try{if(m){const i=URL.createObjectURL(m),s=document.createElement("a");s.href=i,s.download="refer-earn-poster.png",s.rel="noopener",document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(()=>URL.revokeObjectURL(i),1500)}}catch(i){}g({title:"Caption ready",description:"Caption copied. Poster saved — attach it in WhatsApp."});return}const f=`https://t.me/share/url?url=${encodeURIComponent(x)}&text=${encodeURIComponent(j)}`;if(window.open(f,"_blank"))return}catch(a){}k(x,"link")},B=async()=>{try{const t=`${j} ${x}`;try{await navigator.clipboard.writeText(t)}catch(s){}if(m&&navigator.canShare&&window.File){const s=new File([m],"refer-earn-poster.png",{type:"image/png"});if(navigator.canShare({files:[s],text:t})){await navigator.share({files:[s],text:t,title:"Quiz Dangal"}),g({title:"Shared",description:"Choose WhatsApp. If caption is missing, paste (copied)."});return}}const a=encodeURIComponent(t),r=navigator.userAgent||"",n=/Android/i.test(r),o=/iPhone|iPad|iPod/i.test(r),h=`whatsapp://send?text=${a}`,f=`intent://send?text=${a}#Intent;scheme=whatsapp;package=com.whatsapp;end`,c=`https://wa.me/?text=${a}`,i=s=>!!window.open(s,"_blank");try{if(m){const s=URL.createObjectURL(m),l=document.createElement("a");l.href=s,l.download="refer-earn-poster.png",l.rel="noopener",document.body.appendChild(l),l.click(),document.body.removeChild(l),setTimeout(()=>URL.revokeObjectURL(s),1500)}}catch(s){}if(g({title:"Caption copied",description:"Poster saved. Attach it in WhatsApp chat."}),n){if(i(h))return;window.location.href=f,setTimeout(()=>{document.hidden||(window.location.href=c)},700);return}if(o){window.location.href=h,setTimeout(()=>{document.hidden||(window.location.href=c)},700);return}i(c)}catch(t){}};return e.jsx("div",{className:"min-h-screen",children:e.jsxs("div",{className:"container mx-auto px-4 py-6 max-w-2xl text-slate-100",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(Q,{className:"w-6 h-6 text-emerald-300"}),e.jsx("h1",{className:"text-2xl font-extrabold bg-gradient-to-r from-sky-400 via-cyan-400 to-emerald-400 bg-clip-text text-transparent tracking-tight",children:"Refer & Earn"})]}),e.jsx("div",{className:"rounded-2xl p-4 mb-6 bg-emerald-900/25 border border-emerald-600/30 backdrop-blur-xl",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full overflow-hidden hd-badge-coin relative shrink-0","aria-hidden":!0,children:e.jsxs("div",{className:"hd-badge-coin-front",children:[e.jsx(R,{className:"hd-badge-coin-icon"}),e.jsx("span",{className:"hd-badge-coin-shine"})]})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-lg font-extrabold tracking-wide",children:[e.jsx("span",{className:"text-amber-200",children:"Earn +50 coins"})," per referral"]}),e.jsx("div",{className:"text-sm text-emerald-100/90",children:"Coins are added after your friend signs up and completes their profile."})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"rounded-xl p-4 text-center bg-gradient-to-br from-sky-900/40 via-cyan-900/30 to-emerald-900/20 border border-cyan-600/40",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 mb-1",children:[e.jsx(I,{className:"w-4 h-4 text-cyan-300"}),e.jsx("span",{className:"text-2xl font-extrabold bg-gradient-to-r from-sky-300 via-cyan-300 to-emerald-300 bg-clip-text text-transparent",children:_.total})]}),e.jsx("p",{className:"text-xs sm:text-sm text-cyan-200/90 tracking-wide",children:"Friends Referred"})]}),e.jsxs("div",{className:"rounded-xl p-4 text-center bg-gradient-to-br from-amber-900/30 via-yellow-900/20 to-transparent border border-amber-600/40",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1 mb-1",children:[e.jsx("span",{className:"relative inline-flex w-6 h-6 align-middle rounded-full overflow-hidden hd-badge-coin shrink-0",children:e.jsxs("span",{className:"hd-badge-coin-front",children:[e.jsx(R,{className:"hd-badge-coin-icon"}),e.jsx("span",{className:"hd-badge-coin-shine"})]})}),e.jsx("span",{className:"text-2xl font-extrabold bg-gradient-to-r from-amber-200 via-yellow-200 to-orange-200 bg-clip-text text-transparent",children:_.earnings})]}),e.jsx("p",{className:"text-xs sm:text-sm text-amber-200/90 tracking-wide",children:"Coins Earned"})]})]}),e.jsxs("div",{className:"space-y-2 mb-5",children:[e.jsx("h3",{className:"font-semibold text-slate-200",children:"Your Referral Code"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{value:w,readOnly:!0,className:"font-mono text-center text-lg font-bold bg-slate-900/60 border-slate-700/60 text-slate-100"}),e.jsx(y,{onClick:()=>k(w,"code"),variant:"outline",size:"sm",className:"px-3 border-cyan-500/50 text-cyan-200 hover:bg-cyan-900/30",children:$==="code"?e.jsx(P,{className:"w-4 h-4 text-emerald-300"}):e.jsx(O,{className:"w-4 h-4 text-cyan-300"})})]})]}),e.jsxs("div",{className:"space-y-2 mb-6",children:[e.jsx("h3",{className:"font-semibold text-slate-200",children:"Your Referral Link"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{value:x,readOnly:!0,className:"text-sm bg-slate-900/60 border-slate-700/60 text-slate-100"}),e.jsx(y,{onClick:()=>k(x,"link"),variant:"outline",size:"sm",className:"px-3 border-cyan-500/50 text-cyan-200 hover:bg-cyan-900/30",children:$==="link"?e.jsx(P,{className:"w-4 h-4 text-emerald-300"}):e.jsx(O,{className:"w-4 h-4 text-cyan-300"})})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 items-center",children:[e.jsxs(y,{onClick:z,className:"col-span-1 inline-flex items-center justify-center gap-2 h-12 px-3 rounded-lg text-sm font-extrabold bg-gradient-to-r from-indigo-500 via-violet-500 to-fuchsia-500 hover:opacity-90 border border-indigo-400/40 w-full",children:[e.jsx(Y,{className:"w-4 h-4"}),e.jsx("span",{className:"truncate",children:"Share"})]}),e.jsxs(y,{onClick:B,className:"col-span-1 inline-flex items-center justify-center gap-2 h-12 px-2.5 rounded-lg text-[13px] sm:text-sm font-extrabold border text-white shadow-[0_8px_18px_rgba(34,197,94,0.35)] hover:shadow-[0_12px_24px_rgba(34,197,94,0.5)] border-emerald-500/50 bg-[linear-gradient(90deg,#16a34a,#22c55e,#10b981)] w-full",children:[e.jsx("svg",{className:"w-4 h-4 sm:w-5 sm:h-5",viewBox:"0 0 24 24","aria-hidden":"true",focusable:"false",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{fill:"currentColor",d:"M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.272-.099-.471-.148-.67.149-.198.297-.768.966-.941 1.164-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.149-.173.198-.297.297-.495.099-.198.05-.372-.025-.521-.074-.149-.669-1.611-.916-2.205-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.521.074-.793.372s-1.042 1.016-1.042 2.479 1.067 2.876 1.219 3.074c.149.198 2.1 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.718 2.007-1.41.248-.694.248-1.289.173-1.41-.074-.123-.272-.198-.57-.347m-5.49 7.485h-.004a9.867 9.867 0 01-5.031-1.378l-.361-.214-3.741.982.999-3.648-.235-.374a9.861 9.861 0 01-1.51-5.241c.001-5.45 4.434-9.884 9.885-9.884 2.641 0 5.122 1.03 6.988 2.897a9.825 9.825 0 012.897 6.994c-.003 5.45-4.436 9.884-9.887 9.884m8.413-18.297A11.815 11.815 0 0012.004 0C5.375 0 .16 5.215.157 11.844a11.82 11.82 0 001.624 5.99L0 24l6.305-1.654a11.86 11.86 0 005.68 1.448h.005c6.628 0 11.843-5.215 11.846-11.844a11.787 11.787 0 00-3.473-8.372z"})}),e.jsx("span",{className:"whitespace-nowrap",children:"WhatsApp"})]})]}),!W&&(u.length>0?e.jsxs("div",{className:"space-y-3 mt-6",children:[e.jsx("h3",{className:"font-semibold text-slate-200",children:"Recent Referrals"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:u.slice(0,8).map(t=>{var a;return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-slate-900/60 rounded-lg border border-slate-700/60",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-slate-100",children:((a=t.referred)==null?void 0:a.username)||"New User"}),e.jsx("div",{className:"text-xs text-slate-400",children:new Date(t.created_at).toLocaleDateString()})]}),e.jsxs("div",{className:"flex items-center gap-1 text-emerald-300",children:[e.jsx("span",{className:"relative inline-flex w-5 h-5 align-middle rounded-full overflow-hidden hd-badge-coin shrink-0",children:e.jsxs("span",{className:"hd-badge-coin-front",children:[e.jsx(R,{className:"hd-badge-coin-icon"}),e.jsx("span",{className:"hd-badge-coin-shine"})]})}),e.jsxs("span",{className:"font-bold",children:["+",t.coins_awarded]})]})]},t.id)})}),u.length>8&&e.jsxs("p",{className:"text-xs text-slate-400",children:["And ",u.length-8," more referrals…"]})]}):e.jsxs("div",{className:"text-center py-8 text-slate-400 mt-6",children:[e.jsx(I,{className:"w-12 h-12 mx-auto mb-2 text-slate-500"}),e.jsx("p",{className:"text-slate-200",children:"No referrals yet"}),e.jsx("p",{className:"text-sm",children:"Start sharing your link to earn coins!"})]}))]})})};export{ae as default};
