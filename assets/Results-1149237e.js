import{u as fe,a as ue,s as R,j as t,B as $}from"./index-20bb43d4.js";import{r as w}from"./react-8a702e3e.js";import{g as he}from"./avatar-1f2a8a85.js";import{c as ge,a as be}from"./router-bcacfb8d.js";import{d as ye,T as ve,Z as je,f as we}from"./icons-3e0b0f01.js";import"./supabase-4c1332f7.js";import"./motion-511bde03.js";const $e=()=>{const{id:N}=ge(),M=be(),{toast:P}=fe(),{user:f,userProfile:x}=ue(),[a,ee]=w.useState(null),[j,W]=w.useState([]),[n,te]=w.useState(null),[Q,B]=w.useState(!0),[F,E]=w.useState(""),[Ne,se]=w.useState(!0),[V,U]=w.useState(null),[ae,re]=w.useState(!1),[le,q]=w.useState(null);w.useEffect(()=>{Y()},[N]);const Y=async()=>{try{E("");const{data:s}=await R.from("quizzes").select("*").eq("id",N).single();if(ee(s||null),(x==null?void 0:x.role)!=="admin")try{const{data:l}=await R.from("quiz_participants").select("status").eq("quiz_id",N).eq("user_id",f==null?void 0:f.id).maybeSingle(),c=!!l;if(se(c),!c){E("You did not participate in this quiz. Results are visible only to participants."),B(!1);return}}catch(l){}const{data:r,error:o}=await R.from("quiz_results").select("leaderboard").eq("quiz_id",N).maybeSingle();if(o)throw o;const e=Array.isArray(r==null?void 0:r.leaderboard)?r.leaderboard:[];if(!r||e.length===0){if(W([]),s!=null&&s.end_time){const c=new Date(s.end_time).getTime()-Date.now();if(U(c>0?c:0),c<=0)try{await R.rpc("compute_results_if_due",{p_quiz_id:N}),await new Promise(p=>setTimeout(p,500));const{data:h}=await R.from("quiz_results").select("leaderboard").eq("quiz_id",N).maybeSingle(),y=Array.isArray(h==null?void 0:h.leaderboard)?h.leaderboard:[];if(y.length>0){const p=y.map((i,v)=>{var b;return{id:`${N}-${i.user_id}`,user_id:i.user_id,score:Number(i.score)||0,rank:Number(i.rank)||v+1,profiles:{username:(b=i.display_name)!=null&&b.startsWith("@")?i.display_name.slice(1):void 0,full_name:i.display_name,avatar_url:void 0}}}).sort((i,v)=>v.score-i.score);W(p),B(!1);return}}catch(h){}}else U(null);return}const d=e.map((l,c)=>{var h;return{id:`${N}-${l.user_id}`,user_id:l.user_id,score:Number(l.score)||0,rank:Number(l.rank)||c+1,profiles:{username:(h=l.display_name)!=null&&h.startsWith("@")?l.display_name.slice(1):void 0,full_name:l.display_name,avatar_url:void 0}}}).sort((l,c)=>c.score-l.score);W(d);try{const l=d.slice(0,10).map(c=>c.user_id);if(l.length){const{data:c,error:h}=await R.rpc("profiles_public_by_ids",{p_ids:l});if(h&&console.warn("Public profile fetch failed:",h),Array.isArray(c)&&c.length){const y=new Map(c.map(i=>[i.id,i])),p=await he(c.map(i=>i.avatar_url).filter(Boolean));W(i=>i.map(v=>{const b=y.get(v.user_id);if(!b)return v;const z=b.avatar_url&&p.get(b.avatar_url)||"";return{...v,profiles:{username:b.username,full_name:b.full_name,avatar_url:z}}}))}}}catch(l){}const u=d.find(l=>l.user_id===(f==null?void 0:f.id));u&&te(u)}catch(s){console.error("Error fetching results:",s),E((s==null?void 0:s.message)||"Failed to load results.")}finally{B(!1)}},Z=()=>{B(!0),E(""),Y()};w.useEffect(()=>{let s=!1;return(async()=>{try{if(j.length===0){q(null);return}const o=await J();s||q(o)}catch(o){s||q(null)}})(),()=>{s=!0}},[j.length,N,n==null?void 0:n.rank,n==null?void 0:n.score]);const J=async()=>{try{const o=document.createElement("canvas");o.width=1080,o.height=1080;const e=o.getContext("2d");e.textBaseline="top";const d=e.createLinearGradient(0,0,1080,1080);d.addColorStop(0,"#130531"),d.addColorStop(1,"#1e0b4b"),e.fillStyle=d,e.fillRect(0,0,1080,1080);const u=e.createRadialGradient(1080/2,1080/2,1080*.2,1080/2,1080/2,1080*.7);u.addColorStop(0,"rgba(0,0,0,0)"),u.addColorStop(1,"rgba(0,0,0,0.35)"),e.fillStyle=u,e.fillRect(0,0,1080,1080);const l=64;e.fillStyle="rgba(255,255,255,0.92)",e.font="800 54px Inter, system-ui, -apple-system, Segoe UI, Roboto";const c=a!=null&&a.title?String(a.title).toUpperCase():"QUIZ DANGAL RESULTS",h=1080-l*2,y=m=>e.measureText(m).width;let p=c;for(;p.length>0&&y(p)>h;)p=p.slice(0,-1);if(p!==c&&(p+="â€¦"),e.fillText(p,l,l),Array.isArray(j)){const m=`${j.length} participants`;e.fillStyle="rgba(203,213,225,0.85)",e.font="600 26px Inter, system-ui, -apple-system, Segoe UI, Roboto";const g=e.measureText(m).width;e.fillText(m,1080-l-g,l)}const i=l,v=l+80,b=1080-l*2,z=380,X=36,A=(m,g,S,I,_)=>{e.beginPath(),e.moveTo(m+_,g),e.lineTo(m+S-_,g),e.quadraticCurveTo(m+S,g,m+S,g+_),e.lineTo(m+S,g+I-_),e.quadraticCurveTo(m+S,g+I,m+S-_,g+I),e.lineTo(m+_,g+I),e.quadraticCurveTo(m,g+I,m,g+I-_),e.lineTo(m,g+_),e.quadraticCurveTo(m,g,m+_,g),e.closePath()};e.save(),e.shadowColor="rgba(236,72,153,0.6)",e.shadowBlur=28,A(i,v,b,z,X),e.fillStyle="rgba(15,23,42,0.72)",e.fill(),e.restore(),e.lineWidth=3,e.strokeStyle="rgba(236,72,153,0.6)",A(i,v,b,z,X),e.stroke();let T=v+36;const L=(m,g,S,I,_,K)=>{e.fillStyle=m,e.font=g;let C=S;if(K){for(;C.length>0&&e.measureText(C).width>K;)C=C.slice(0,-1);C!==S&&(C+="â€¦")}e.fillText(C,I,_);const Se=e.measureText("M");return parseInt(g.match(/\s(\d+)px/)[1]||"32",10)},D=b-100,ce=n!=null&&n.rank?`#${n.rank} Rank!`:"Results Live!";T+=L("#ffffff","900 110px Inter, system-ui, -apple-system, Segoe UI, Roboto",ce,i+48,T,D)+10;const de=n!=null&&n.rank&&Array.isArray(a==null?void 0:a.prizes)&&a.prizes[n.rank-1]?a.prizes[n.rank-1]:0;T+=L("rgba(255,255,255,0.92)","700 38px Inter, system-ui, -apple-system, Segoe UI, Roboto",`Prize: â‚¹${de}`,i+50,T,D)+8,typeof(n==null?void 0:n.score)=="number"&&(T+=L("rgba(168, 255, 230, 0.95)","800 58px Inter, system-ui, -apple-system, Segoe UI, Roboto",`Score: ${n.score}`,i+50,T,D)+8);const me=((x==null?void 0:x.username)||(x==null?void 0:x.full_name)||"You").toString();T+=L("rgba(226,232,240,0.92)","700 32px Inter, system-ui, -apple-system, Segoe UI, Roboto",`Player: ${me}`,i+50,T,D),e.fillStyle="rgba(226,232,240,0.92)",e.font="600 28px Inter, system-ui, -apple-system, Segoe UI, Roboto",e.fillText("Only legends make it this far âœ¨",i+50,v+z-56);const H=v+z+24,G=90;e.save(),e.shadowColor="rgba(59,130,246,0.5)",e.shadowBlur=15,A(i,H,b,G,22),e.fillStyle="rgba(2,6,23,0.75)",e.fill(),e.restore(),e.strokeStyle="rgba(59,130,246,0.5)",e.lineWidth=2,A(i,H,b,G,22),e.stroke(),e.fillStyle="rgba(250,204,21,0.95)",e.font="900 40px Inter, system-ui, -apple-system, Segoe UI, Roboto",e.fillText("âš¡ My Result is Live!",i+36,H+58);const k=H+G+24,O=1080-k-l;A(i,k,b,O,24),e.fillStyle="rgba(2,6,23,0.7)",e.fill(),e.strokeStyle="rgba(147,51,234,0.45)",e.lineWidth=2,A(i,k,b,O,24),e.stroke();const xe=(x==null?void 0:x.referral_code)||((f==null?void 0:f.id)||"").replace(/-/g,"").slice(0,8).toUpperCase(),pe=({}.VITE_PUBLIC_SITE_URL||"https://quizdangal.com").replace(/\/$/,"");return e.fillStyle="rgba(255,255,255,0.95)",e.font="800 42px Inter, system-ui, -apple-system, Segoe UI, Roboto",e.fillText("Play & Win on Quiz Dangal",i+36,k+48),e.fillStyle="rgba(203,213,225,0.98)",e.font="700 34px Inter, system-ui, -apple-system, Segoe UI, Roboto",e.fillText(pe.replace(/^https?:\/\//,""),i+36,k+48+42),e.fillStyle="rgba(190,242,100,1)",e.font="900 40px Inter, system-ui, -apple-system, Segoe UI, Roboto",e.fillText(`Referral: ${xe}`,i+36,k+48+42+48),e.fillStyle="rgba(203,213,225,0.9)",e.font="600 24px Inter, system-ui, -apple-system, Segoe UI, Roboto",e.fillText("#QuizDangal  #ChallengeAccepted  #PlayToWin",i+36,k+O-40),await new Promise(m=>o.toBlob(m,"image/jpeg",.92))}catch(s){try{const r=document.createElement("canvas");r.width=8,r.height=8;const o=r.getContext("2d"),e=o.createLinearGradient(0,0,8,8);return e.addColorStop(0,"#130531"),e.addColorStop(1,"#1e0b4b"),o.fillStyle=e,o.fillRect(0,0,8,8),await new Promise(u=>r.toBlob(u,"image/jpeg",.9))}catch(r){return null}}},ie=async()=>{var s;try{const r=/iPhone|iPad|iPod/i.test(navigator.userAgent),o=(x==null?void 0:x.referral_code)||((f==null?void 0:f.id)||"").replace(/-/g,"").slice(0,8),{shareText:e}=oe(),d=["ðŸ”¥ My result is here! ðŸ”¥","Checked out the poster? Now itâ€™s your turn ðŸ‘€","","ðŸ‘‰ Just head over to www.quizdangal.com",`Use Referral Code: ${o}`,"and unlock your score ðŸš€","","Donâ€™t just scroll, share your vibes ðŸ’¯","#Results #ChallengeAccepted"].join(`
`),u=`My result on Quiz Dangal â€” Use code: ${o} â€” quizdangal.com`,c=le||await J(),h=`quizdangal-result-${N}-${(s=n==null?void 0:n.rank)!=null?s:"NA"}.jpg`,y=c?[new File([c],h,{type:"image/jpeg"})]:[];try{await navigator.clipboard.writeText(r?u:d)}catch(p){}if(typeof navigator.share=="function"){if(y.length>0)try{r?(await navigator.share({text:u,files:y}),P({title:"Caption copied",description:"Agar text nahi gaya ho, paste kar dijiye."})):await navigator.share({text:d,files:y});return}catch(p){}try{await navigator.share({text:e||d});return}catch(p){}}P({title:"Sharing not supported",description:"Caption copied. Use WhatsApp button or paste into your app."})}catch(r){P({title:"Share failed",description:(r==null?void 0:r.message)||"Try again",variant:"destructive"})}};w.useEffect(()=>{if(!(a!=null&&a.end_time)||j.length>0){U(null);return}const s=new Date(a.end_time).getTime(),r=()=>{const e=s-Date.now();e>0?U(e):(U(0),ae||(re(!0),Y()))};r();const o=setInterval(r,1e3);return()=>clearInterval(o)},[a==null?void 0:a.end_time,j.length]);const ne=s=>{const r=Math.max(0,Math.floor((s!=null?s:0)/1e3)),o=Math.floor(r/86400),e=Math.floor(r%86400/3600),d=Math.floor(r%3600/60),u=r%60;return{days:o,hours:e,minutes:d,seconds:u}},oe=()=>{const s=(x==null?void 0:x.referral_code)||((f==null?void 0:f.id)||"").replace(/-/g,"").slice(0,8),o=({}.VITE_PUBLIC_SITE_URL||"https://quizdangal.com").replace(/\/$/,""),e=`${o}/results/${N}?ref=${encodeURIComponent(s)}`,d=n?`I scored ${n.score} and rank #${n.rank} in ${(a==null?void 0:a.title)||"Quiz"} on Quiz Dangal! Play now: ${e}`:`Check out the results of ${(a==null?void 0:a.title)||"Quiz"} on Quiz Dangal! ${e}`;return{refCode:s,site:o,resultUrl:e,shareText:d}};return Q?t.jsx("div",{className:"min-h-screen flex items-center justify-center",children:t.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-accent-b"})}):!Q&&F?t.jsx("div",{className:"min-h-screen p-4 flex items-center justify-center",children:t.jsxs("div",{className:"qd-card rounded-2xl p-6 shadow-lg text-center max-w-md w-full text-slate-100",children:[t.jsx("h2",{className:"text-2xl font-bold mb-2 text-white",children:"Couldn\\'t load results"}),t.jsx("p",{className:"text-slate-300 mb-4",children:F}),t.jsxs("div",{className:"flex justify-center gap-3",children:[t.jsx($,{variant:"brand",onClick:Z,children:"Retry"}),t.jsx($,{variant:"white",onClick:()=>M("/my-quizzes"),children:"Back"})]})]})}):!Q&&j.length===0?t.jsx("div",{className:"min-h-screen p-4 flex items-center justify-center",children:t.jsxs("div",{className:"qd-card rounded-2xl p-6 shadow-lg text-center max-w-md w-full text-slate-100",children:[t.jsx("h2",{className:"text-2xl font-bold mb-2 text-white",children:"Results not published yet"}),a!=null&&a.end_time?t.jsx("div",{className:"mb-4",children:V>0?t.jsxs("div",{children:[t.jsx("p",{className:"text-slate-300 mb-3",children:"Quiz ends in"}),(()=>{const{days:s,hours:r,minutes:o,seconds:e}=ne(V),d=(u,l)=>t.jsxs("div",{className:"px-3 py-2 rounded-md bg-slate-800/70 border border-slate-700 min-w-[64px]",children:[t.jsx("div",{className:"text-xl font-bold text-white tabular-nums",children:u.toString().padStart(2,"0")}),t.jsx("div",{className:"text-xs text-slate-400",children:l})]});return t.jsxs("div",{className:"flex items-center justify-center gap-2",children:[s>0&&d(s,"Days"),d(r,"Hours"),d(o,"Minutes"),d(e,"Seconds")]})})(),t.jsxs("p",{className:"text-xs text-slate-400 mt-3",children:["End time: ",new Date(a.end_time).toLocaleString()]})]}):t.jsx("p",{className:"text-slate-300 mb-4",children:"Finalizing resultsâ€¦ please stay on this page."})}):t.jsx("p",{className:"text-slate-300 mb-4",children:"Please check back after the quiz end time."}),t.jsxs("div",{className:"flex justify-center gap-3",children:[t.jsx($,{variant:"brand",onClick:Z,children:"Refresh"}),t.jsx($,{variant:"white",onClick:()=>M("/my-quizzes"),children:"Back to My Quizzes"}),t.jsx($,{variant:"white",onClick:()=>M("/"),children:"Go Home"})]})]})}):t.jsx("div",{className:"min-h-screen p-4",children:t.jsxs("div",{className:"max-w-4xl mx-auto",children:[t.jsxs("div",{className:"mb-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-slate-300 text-xs mb-1",children:[t.jsx(ye,{className:"w-3.5 h-3.5"}),t.jsxs("span",{children:[(j==null?void 0:j.length)||0," participants"]})]}),t.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-white truncate",children:"Results"}),t.jsx("p",{className:"text-xs text-slate-400 truncate",children:a==null?void 0:a.title})]}),n&&(x==null?void 0:x.role)!=="admin"&&t.jsxs("div",{className:"rounded-xl border border-slate-800 bg-slate-900/60 p-3 mb-4 flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"w-9 h-9 rounded-lg bg-gradient-to-br from-indigo-500 via-violet-500 to-fuchsia-600 text-white font-bold flex items-center justify-center ring-1 ring-indigo-300/40",children:["#",n.rank]}),t.jsxs("div",{className:"text-xs text-slate-300",children:[t.jsx("div",{className:"text-white font-semibold",children:"Your Result"}),t.jsxs("div",{children:["Out of ",j.length," participants"]})]})]}),t.jsxs("div",{className:"flex items-center gap-3 text-center",children:[t.jsx("span",{className:"px-2 py-0.5 rounded-full text-[10px] font-semibold bg-indigo-500/15 text-indigo-200 border border-indigo-600/30",children:"YOU"}),t.jsxs("div",{children:[t.jsx("div",{className:"text-[11px] text-slate-400",children:"Score"}),t.jsx("div",{className:"text-sm font-bold text-emerald-300",children:n.score})]}),t.jsxs("div",{className:"min-w-[68px]",children:[t.jsx("div",{className:"text-[11px] text-slate-400",children:"Prize"}),t.jsxs("div",{className:"text-sm font-bold text-purple-300",children:["â‚¹",n.rank&&Array.isArray(a==null?void 0:a.prizes)&&a.prizes[n.rank-1]?a.prizes[n.rank-1]:0]})]})]})]}),Array.isArray(a==null?void 0:a.prizes)&&a.prizes.length>0&&t.jsx("div",{className:"rounded-xl border border-slate-800 bg-slate-900/60 p-3 mb-4 overflow-x-auto whitespace-nowrap",children:a.prizes.map((s,r)=>t.jsxs("span",{className:`inline-block mr-2 mb-2 px-2.5 py-1 rounded-lg text-xs font-semibold border ${r===0?"bg-amber-500/10 text-amber-200 border-amber-500/30":r===1?"bg-sky-500/10 text-sky-200 border-sky-500/30":r===2?"bg-violet-500/10 text-violet-200 border-violet-500/30":"bg-slate-800/60 text-slate-200 border-slate-700"}`,children:[r===0?"ðŸ¥‡ 1st":r===1?"ðŸ¥ˆ 2nd":r===2?"ðŸ¥‰ 3rd":`#${r+1}`," â€¢ â‚¹",s]},r))}),t.jsxs("div",{className:"rounded-xl border border-slate-800 bg-slate-900/60 p-3",children:[t.jsxs("div",{className:"text-sm font-semibold text-white mb-2 flex items-center gap-2",children:[t.jsx(ve,{className:"w-4 h-4 text-amber-300"}),"Leaderboard"]}),t.jsx("div",{className:"space-y-2",children:j.map((s,r)=>{var d,u,l,c,h,y,p;const o=s.rank&&Array.isArray(a==null?void 0:a.prizes)&&a.prizes[s.rank-1]?a.prizes[s.rank-1]:0,e=s.user_id===(f==null?void 0:f.id);return t.jsxs("div",{className:`flex items-center justify-between p-2.5 rounded-lg border transition-colors ${e?"bg-indigo-950/40 border-indigo-700/40":"bg-slate-950/30 border-slate-800 hover:bg-slate-900/60"}`,children:[t.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[t.jsx("div",{className:`w-8 h-8 rounded-md flex items-center justify-center text-xs font-bold ${r<3?"bg-gradient-to-br from-amber-300 to-yellow-500 text-amber-900 ring-1 ring-amber-200/60":"bg-slate-800 text-slate-100 ring-1 ring-white/10"}`,children:r+1}),t.jsx("div",{className:"w-8 h-8 rounded-full overflow-hidden bg-gray-200 flex items-center justify-center text-gray-600 text-xs font-bold",children:(d=s.profiles)!=null&&d.avatar_url?t.jsx("img",{src:s.profiles.avatar_url,alt:"avatar",className:"w-full h-full object-cover"}):t.jsx("span",{children:(((u=s.profiles)==null?void 0:u.full_name)||((l=s.profiles)==null?void 0:l.username)||"U").charAt(0).toUpperCase()})}),t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"text-sm font-medium text-white truncate",children:((c=s.profiles)==null?void 0:c.username)||((h=s.profiles)==null?void 0:h.full_name)||"Anonymous"}),((y=s.profiles)==null?void 0:y.full_name)&&((p=s.profiles)==null?void 0:p.username)&&t.jsx("p",{className:"text-[10px] text-slate-400 truncate",children:s.profiles.full_name})]})]}),t.jsxs("div",{className:"flex items-center gap-5 shrink-0",children:[t.jsxs("div",{className:"text-right",children:[t.jsx("p",{className:"text-sm font-bold text-emerald-300 leading-none",children:s.score}),t.jsx("p",{className:"text-[10px] text-slate-400 leading-none",children:"Score"})]}),t.jsxs("div",{className:"text-right min-w-[64px]",children:[t.jsxs("p",{className:"text-sm font-bold text-purple-300 leading-none",children:["â‚¹",o]}),t.jsx("p",{className:"text-[10px] text-slate-400 leading-none",children:"Prize"})]})]})]},s.id)})})]}),t.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[t.jsxs("button",{onClick:()=>M("/my-quizzes"),className:"inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-semibold bg-slate-800/70 text-white border border-slate-700 hover:bg-slate-800",children:[t.jsx(je,{className:"w-4 h-4"})," Back"]}),t.jsx("div",{className:"flex items-center gap-2",children:t.jsxs("button",{onClick:ie,className:"inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-extrabold border text-white shadow-[0_8px_18px_rgba(139,92,246,0.4)] hover:shadow-[0_12px_24px_rgba(139,92,246,0.55)] border-violet-500/40 bg-[linear-gradient(90deg,#4f46e5,#7c3aed,#9333ea,#c026d3)]",children:[t.jsx(we,{className:"w-4 h-4"})," Share"]})})]})]})})};export{$e as default};
