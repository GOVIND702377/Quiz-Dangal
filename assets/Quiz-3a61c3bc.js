import{u as le,a as ce,i as oe,s as w,Q as de,k as ue,c as X,j as e,B as W,f as me,d as K,g as xe}from"./index-2525ac80.js";import{r as n}from"./react-8a702e3e.js";import{c as he,a as pe}from"./router-f2cf3f51.js";import{L as B,X as I,e as G,d as ee,t as te}from"./icons-52d1b41a.js";import{m as _,AnimatePresence as fe}from"./motion-f69b6c08.js";import"./supabase-4c1332f7.js";function se(){return typeof document=="undefined"?!1:document.visibilityState==="hidden"}function be(o,m){const{toast:i}=le(),{user:c}=ce(),{isSubscribed:z,subscribeToPush:R}=oe(),[r,L]=n.useState(null),[y,$]=n.useState([]),[P,M]=n.useState(0),[F,U]=n.useState({}),[d,N]=n.useState("loading"),[J,k]=n.useState(0),[v,E]=n.useState(!1),[q,O]=n.useState({joined:0,pre_joined:0}),[h,p]=n.useState(!1),[u,j]=n.useState(null),f=n.useRef(null),Q=n.useRef(!0),b=n.useRef([]),S=n.useRef(null);n.useEffect(()=>()=>{Q.current=!1,f.current&&clearTimeout(f.current),S.current&&clearTimeout(S.current)},[]);const C=n.useCallback(()=>{if(S.current||b.current.length===0)return;const s=b.current[0],t=2e3*Math.pow(2,(s.attempt||1)-1),a=Math.min(t,3e4);S.current=setTimeout(()=>{S.current=null,T()},a)},[]),T=n.useCallback(async()=>{if(b.current.length===0)return;const s=[...b.current];b.current=[];for(const t of s)if(!(!c||u==="completed"))try{const{error:a}=await w.from("user_answers").upsert({user_id:c.id,question_id:t.questionId,selected_option_id:t.optionId},{onConflict:"user_id,question_id"});if(a)throw a;U(l=>({...l,[t.questionId]:t.optionId}))}catch(a){const l=(t.attempt||1)+1;l<=6?b.current.push({...t,attempt:l}):i({title:"Answer not saved",description:"One answer failed to sync after multiple retries.",variant:"destructive"})}b.current.length>0&&C()},[u,c,i,C]);n.useEffect(()=>{const s=()=>T(),t=()=>{se()||T()};return window.addEventListener("online",s),document.addEventListener("visibilitychange",t),()=>{window.removeEventListener("online",s),document.removeEventListener("visibilitychange",t)}},[T]);const Y=(q.joined||0)+(q.pre_joined||0),ie=(()=>d==="active"?q.joined||0:Y)(),A=n.useCallback(async()=>{const{data:s,error:t}=await w.from("questions").select("id, question_text, options ( id, option_text )").eq("quiz_id",o).order("id");$(t?[]:s||[])},[o]),D=n.useCallback(async()=>{var s,t;try{const{data:a,error:l}=await w.rpc("get_engagement_counts",{p_quiz_id:o});if(l)console.warn("Engagement counts fetch failed:",l),O({joined:0,pre_joined:0});else{const x=Array.isArray(a)?a[0]:a,g=Number((s=x==null?void 0:x.joined)!=null?s:0),H=Number((t=x==null?void 0:x.pre_joined)!=null?t:0);O({joined:isNaN(g)?0:g,pre_joined:isNaN(H)?0:H})}}catch(a){console.warn("Engagement refresh failed",a)}},[o]),V=n.useCallback(async()=>{try{const{data:s,error:t}=await w.from("quizzes").select("*").eq("id",o).single();if(t||!s){i({title:"Error",description:"Quiz not found.",variant:"destructive"}),m("/");return}L(s);let a=null;if(c&&c.id){const{data:l,error:x}=await w.from("quiz_participants").select("status").eq("user_id",c.id).eq("quiz_id",o).maybeSingle();!x&&l?(a=l,p(!0),j(l.status||null),a.status==="completed"&&N("completed")):(p(!1),j(null))}else p(!1),j(null);a&&a.status!=="completed"&&await A(),await D()}catch(s){console.error("Error fetching quiz data:",s),i({title:"Error",description:"Failed to load quiz.",variant:"destructive"}),m("/")}},[o,c,m,i,A,D]);n.useEffect(()=>{V()},[V]),n.useEffect(()=>{if(!r||d==="completed")return;const s=()=>{const a=new Date,l=r.start_time?new Date(r.start_time):null,x=r.end_time?new Date(r.end_time):null,g=l&&a<l,H=l&&x&&a>=l&&a<x;if(g){N("waiting"),k(Math.max(0,Math.round((l.getTime()-a.getTime())/1e3)));return}if(H){N("active"),k(Math.max(0,Math.round((x.getTime()-a.getTime())/1e3)));return}N("finished"),k(0)};s();const t=setInterval(s,1e3);return()=>clearInterval(t)},[r,d]),n.useEffect(()=>{if(!r||!(d==="waiting"||d==="active"))return;const t=setInterval(()=>{se()||D()},de);return()=>clearInterval(t)},[r,d,D]),n.useEffect(()=>{(async()=>{if(r&&d==="active"&&c)try{if(!h||u==="pre_joined"){const{error:t}=await w.rpc("join_quiz",{p_quiz_id:o});if(t)throw t;p(!0),j("joined")}y.length===0&&await A()}catch(t){i({title:"Unable to start",description:(t==null?void 0:t.message)||"Could not start the quiz.",variant:"destructive"})}})()},[r,d,c,h,u,o,A,y.length,i]),n.useEffect(()=>{d==="finished"&&Object.keys(F).length>0&&!v&&Z()},[d]),n.useEffect(()=>{if(f.current&&(clearTimeout(f.current),f.current=null),!(r!=null&&r.end_time)||!(d==="finished"||d==="completed"))return;const s=()=>{(async()=>{try{await X(w,o)}catch(t){}m(`/results/${o}`)})()};return f.current=setTimeout(()=>{f.current=null,s()},ue),()=>{f.current&&(clearTimeout(f.current),f.current=null)}},[r==null?void 0:r.end_time,o,d,m]);const ae=n.useCallback(async()=>{if(!r)return;if(!c){i({title:"Login required",description:"Please sign in to join the quiz.",variant:"destructive"}),m("/login");return}if(u==="completed"){i({title:"Already submitted",description:"You have already completed this quiz and cannot join again.",variant:"destructive"});return}try{typeof Notification!="undefined"&&Notification.permission!=="granted"&&!z&&await R()}catch(g){}const s=new Date,t=r.start_time?new Date(r.start_time):null,a=r.end_time?new Date(r.end_time):null,l=r.status==="active"&&t&&a&&s>=t&&s<a,x=l?"join_quiz":"pre_join_quiz";try{const{error:g}=await w.rpc(x,{p_quiz_id:o});if(g)throw g;p(!0),D(),j(l?"joined":"pre_joined"),i({title:l?"Joined!":"Pre-joined!",description:l?"Starting now.":"We will remind you before start."}),l&&(await A(),N("active"))}catch(g){i({title:"Error",description:(g==null?void 0:g.message)||"Could not join.",variant:"destructive"})}},[r,c,u,z,R,o,i,m,D,A]),re=n.useCallback(async(s,t)=>{if(!(v||d!=="active"||u==="completed"))try{const{error:a}=await w.from("user_answers").upsert({user_id:c.id,question_id:s,selected_option_id:t},{onConflict:"user_id,question_id"});if(a)throw a;U(l=>({...l,[s]:t})),P<y.length-1&&(typeof requestAnimationFrame=="function"?requestAnimationFrame(()=>M(l=>l+1)):setTimeout(()=>M(l=>l+1),250))}catch(a){console.error("Error saving answer:",a),b.current.some(x=>x.questionId===s)||i({title:"Sync delayed",description:"Network issue. Will retry automatically.",variant:"destructive"}),b.current.push({questionId:s,optionId:t,attempt:1}),C()}},[v,d,u,c==null?void 0:c.id,P,y.length,i,C]),Z=n.useCallback(async()=>{if(!v){E(!0);try{const{error:s}=await w.from("quiz_participants").update({status:"completed"}).eq("user_id",c.id).eq("quiz_id",o);if(s)throw s;i({title:"Quiz Completed!",description:"Your answers have been submitted. Results will be announced soon!"}),N("completed");try{await X(w,o)}catch(t){}m(`/results/${o}`)}catch(s){console.error("Error submitting quiz:",s),i({title:"Submission Failed",description:"Could not submit your answers. Please try again.",variant:"destructive"})}finally{Q.current&&E(!1)}}},[v,c==null?void 0:c.id,o,i,m]),ne=n.useCallback(s=>{const t=Math.floor(s/60),a=s%60;return`${t.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`},[]);return{quiz:r,questions:y,currentQuestionIndex:P,answers:F,quizState:d,timeLeft:J,submitting:v,engagement:q,joined:h,participantStatus:u,totalJoined:Y,displayJoined:ie,setCurrentQuestionIndex:M,handleJoinOrPrejoin:ae,handleAnswerSelect:re,handleSubmit:Z,formatTime:ne}}const Ne=()=>{var O;const{id:o}=he(),m=pe(),{quiz:i,questions:c,currentQuestionIndex:z,answers:R,quizState:r,timeLeft:L,submitting:y,joined:$,participantStatus:P,totalJoined:M,displayJoined:F,handleJoinOrPrejoin:U,handleAnswerSelect:d,handleSubmit:N,formatTime:J}=be(o,m);if(r==="loading"||!i)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(B,{className:"h-16 w-16 animate-spin text-accent-b mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading quiz..."})]})});const k=()=>e.jsxs("div",{className:"mt-3 text-xs text-slate-300",children:[e.jsx("div",{className:"text-[11px] text-slate-400",children:i.start_time?me(i.start_time):"—"}),e.jsxs("div",{className:"mt-1 grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide text-[10px] text-slate-400",children:"Start"}),e.jsx("div",{children:i.start_time?K(i.start_time):"—"})]}),e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide text-[10px] text-slate-400",children:"End"}),e.jsx("div",{children:i.end_time?K(i.end_time):"—"})]})]})]}),v=()=>{var b,S,C;const h=Array.isArray(i.prizes)?i.prizes:[],p=i.prize_type||"coins",u=(b=h[0])!=null?b:0,j=(S=h[1])!=null?S:0,f=(C=h[2])!=null?C:0,Q=T=>xe(p,T,{fallback:0}).formatted;return e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"px-2 py-1 rounded-md bg-amber-500/15 text-amber-300 border border-amber-700/30",children:["1st ",Q(u)]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-sky-500/15 text-sky-300 border border-sky-700/30",children:["2nd ",Q(j)]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-violet-500/15 text-violet-300 border border-violet-700/30",children:["3rd ",Q(f)]})]})};if(!$&&r!=="completed"){const h=new Date,p=i.start_time?new Date(i.start_time):null,u=i.end_time?new Date(i.end_time):null,j=i.status==="active"&&p&&u&&h>=p&&h<u;return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(_.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card relative rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100 w-full",children:[e.jsx("button",{"aria-label":"Close",onClick:()=>window.history.length>1?m(-1):m("/"),className:"absolute top-3 right-3 text-slate-400 hover:text-slate-200 transition",children:e.jsx(I,{className:"h-5 w-5"})}),e.jsx(G,{className:"h-16 w-16 text-accent-b mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:i.title}),e.jsx("p",{className:"text-slate-300 mb-1",children:j?"Quiz is live!":"Quiz starts in:"}),e.jsx("div",{className:"text-4xl font-bold text-indigo-300 mb-4",children:J(L)}),e.jsx("div",{className:"flex items-center justify-center gap-4 text-sm text-gray-300",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ee,{className:"h-4 w-4 mr-1"}),F," joined"]})}),e.jsx(v,{}),e.jsx(k,{}),e.jsx("div",{className:"mt-6",children:e.jsx(W,{onClick:U,className:j?"bg-emerald-600 hover:bg-emerald-700":"bg-indigo-600 hover:bg-indigo-700",children:j?"Join & Start":"Pre-Join"})})]})})}if(r==="completed")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(_.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx(te,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:"Quiz Completed!"}),e.jsx("p",{className:"text-slate-300 mb-4",children:"You have already submitted your answers for this quiz."}),e.jsx(W,{onClick:()=>m("/my-quizzes"),variant:"brand",className:"w-full",children:"View My Quizzes"})]})});if(r==="waiting")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(_.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card relative rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx("button",{"aria-label":"Close",onClick:()=>window.history.length>1?m(-1):m("/"),className:"absolute top-3 right-3 text-slate-400 hover:text-slate-200 transition",children:e.jsx(I,{className:"h-5 w-5"})}),e.jsx(G,{className:"h-16 w-16 text-accent-b mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:i.title}),e.jsx("p",{className:"text-slate-300 mb-1",children:"Quiz starts in:"}),e.jsx("div",{className:"text-4xl font-bold text-indigo-300 mb-4",children:J(L)}),e.jsx("div",{className:"flex items-center justify-center gap-4 text-sm text-gray-300",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ee,{className:"h-4 w-4 mr-1"}),M," joined"]})}),e.jsx(v,{}),e.jsx(k,{}),e.jsx("div",{className:"mt-4 text-xs text-slate-400",children:"We’ll auto-start when the timer hits zero."})]})});if(r==="finished")return e.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:e.jsxs(_.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx(G,{className:"h-16 w-16 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-2",children:"Quiz Ended"}),e.jsx("p",{className:"text-slate-300 mb-4",children:"The quiz has ended. Results will be announced soon!"}),y&&e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx(B,{className:"h-6 w-6 animate-spin mr-2"}),e.jsx("span",{children:"Submitting your answers..."})]})]})});if(c.length===0)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-gray-600",children:"No questions available for this quiz."})})});const E=c[z],q=(z+1)/c.length*100;return e.jsx("div",{className:"min-h-screen p-4 bg-[radial-gradient(1000px_600px_at_50%_-100px,rgba(59,130,246,0.25),transparent),radial-gradient(800px_500px_at_120%_0,rgba(168,85,247,0.18),transparent)]",children:e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs(_.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"rounded-2xl p-4 mb-6 text-slate-100 border border-slate-800/60 bg-slate-900/60 backdrop-blur-md shadow-[0_10px_30px_rgba(0,0,0,0.35)]",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-extrabold text-white tracking-tight",children:i.title}),e.jsxs("p",{className:"text-xs text-slate-400",children:["Question ",z+1," of ",c.length]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-black text-rose-300 tabular-nums",children:J(L)}),e.jsx("div",{className:"text-[10px] text-slate-400 uppercase tracking-wide",children:"Time Left"})]})]}),e.jsx("div",{className:"w-full bg-slate-800/60 rounded-full h-2 mt-4 overflow-hidden",children:e.jsx(_.div,{className:"h-2 rounded-full bg-[linear-gradient(90deg,#22d3ee,#818cf8,#a78bfa,#f472b6)]",style:{width:`${q}%`},transition:{duration:.5}})})]}),e.jsx(fe,{mode:"wait",children:e.jsxs(_.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},exit:{opacity:0,y:-16},transition:{duration:.25},className:"rounded-2xl p-6 text-slate-100 border border-slate-800/60 bg-slate-900/60 backdrop-blur-md shadow-[0_10px_30px_rgba(0,0,0,0.35)]",children:[e.jsx("h2",{className:"text-xl font-bold text-center text-white mb-6 leading-relaxed",children:E.question_text}),e.jsx("div",{className:"space-y-3",children:(O=E.options)==null?void 0:O.map((h,p)=>{const u=R[E.id]===h.id;return e.jsxs(_.button,{onClick:()=>d(E.id,h.id),disabled:y||r!=="active"||P==="completed",whileHover:{scale:1.01},whileTap:{scale:.99},className:`w-full p-4 rounded-xl text-left font-medium transition-all duration-200 border group relative overflow-hidden ${u?"bg-emerald-600/90 text-white border-emerald-400 shadow-[0_10px_24px_rgba(16,185,129,0.25)]":"bg-slate-800/70 hover:bg-slate-800 text-slate-100 border-slate-700/80"}`,children:[e.jsxs("span",{className:`font-bold mr-3 ${u?"text-white":"text-indigo-300"}`,children:[String.fromCharCode(65+p),"."]}),h.option_text,!u&&e.jsx("span",{className:"absolute inset-y-0 right-0 w-0 group-hover:w-1/6 transition-[width] duration-200 bg-gradient-to-l from-indigo-500/20 to-transparent"})]},h.id)})}),z===c.length-1&&Object.keys(R).length===c.length&&e.jsx(_.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},transition:{delay:.25},className:"mt-7",children:e.jsx(W,{onClick:N,disabled:y,className:"w-full text-white font-extrabold py-4 text-lg border border-violet-500/40 shadow-[0_8px_18px_rgba(139,92,246,0.35)] hover:shadow-[0_12px_24px_rgba(139,92,246,0.55)] bg-[linear-gradient(90deg,#4f46e5,#7c3aed,#9333ea,#c026d3)]",children:y?e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"mr-2 h-6 w-6 animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"mr-2 h-6 w-6"}),"Submit Quiz"]})})})]},E.id)})]})})};export{Ne as default};
