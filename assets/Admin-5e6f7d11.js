import{j as e,o as fe,u as X,a as je,s as p,h as ye,B as j,A as re,m as Y,L as A,I as L,p as K}from"./index-edf9bd8a.js";import{a as N,r as C}from"./react-8a702e3e.js";import{d as ve,L as be}from"./router-f2cf3f51.js";import{L as I,V as J,Y as Ne,k as we,s as _e,Z as ze,_ as ke}from"./icons-52d1b41a.js";import"./supabase-4c1332f7.js";const G=N.forwardRef(({className:n,...u},v)=>e.jsx("textarea",{ref:v,className:fe("flex w-full rounded-md border border-input bg-background px-3 py-2 text-base sm:text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 min-h-[80px] resize-vertical",n),...u}));G.displayName="Textarea";const le=[{value:"opinion",label:"Opinion"},{value:"gk",label:"General Knowledge"},{value:"sports",label:"Sports"},{value:"movies",label:"Movies"}],ne=n=>{var u;return((u=le.find(v=>v.value===n))==null?void 0:u.label)||n},B=()=>({text:"",options:["","",""],correctIndex:0});function Z(n,u,{fallback:v=0}={}){return u==null&&(u=v),n==="coins"?`${u} coins`:n==="others"?`${u}`:`₹${u}`}function Se(n,{allowZeroCorrect:u=!1}={}){var y,_;const v=String(n||"").trim().split(/\n\s*\n+/),w=[],Q=[],z=[];let T=0;for(const $ of v){const k=$.split(/\r?\n/).map(a=>a.trim()).filter(Boolean);if(!k.length)continue;T+=1;const S=k[0].replace(/^Q\d*\.?\s*/i,"").replace(/^Question\s*[:-]\s*/i,""),g=[];let c="";for(let a=1;a<k.length;a++){const d=k[a];if(/^ans(wer)?\s*[:-]/i.test(d)){c=d;continue}const f=d.match(/^[-*•]?\s*\[(x|X| )\]\s*(.+)$/);if(f){g.push({option_text:f[2].trim(),is_correct:/x/i.test(f[1])});continue}const i=d.match(/^(?:[-*•]|[A-Da-d]\)|\d+\)|[A-Da-d][.:])\s*(.+)$/),r=i?i[1].trim():d.replace(/^[*]\s*/,"").trim();r&&g.push({option_text:r,is_correct:/^\*/.test(d)})}if(c){const a=c.split(/[:-]/).slice(1).join(":").trim(),d=(_=(y=a.match(/^[A-D]/i))==null?void 0:y[0])==null?void 0:_.toUpperCase(),f=d?{A:0,B:1,C:2,D:3}[d]:NaN,i=parseInt(a,10);if(!Number.isNaN(f)&&g[f])g.forEach((r,R)=>r.is_correct=R===f);else if(!Number.isNaN(i)&&g[i-1])g.forEach((r,R)=>r.is_correct=R===i-1);else{const r=a.toLowerCase(),R=g.findIndex(q=>q.option_text.toLowerCase()===r||q.option_text.toLowerCase().includes(r));R>=0&&g.forEach((q,M)=>q.is_correct=M===R)}}let x=g.filter(a=>a.option_text);if(x.length>4){const a=x.findIndex(d=>d.is_correct);if(a>=0){const d=x[a],f=x.filter((i,r)=>r!==a);x=[d,...f.slice(0,3)]}else x=x.slice(0,4);z.push(`Q${T}: Trimmed to 4 options.`)}if(!S){Q.push(`Q${T}: Missing question text.`);continue}if(x.length<2){Q.push(`Q${T}: Need at least 2 options.`);continue}if(u)x=x.map(a=>({...a,is_correct:!1}));else{const a=x.filter(d=>d.is_correct).length;if(a===0)x[0].is_correct=!0;else if(a>1){let d=!1;x=x.map(f=>f.is_correct&&!d?(d=!0,f):{...f,is_correct:!1})}}w.push({question_text:S,options:x})}return{items:w,errors:Q,warnings:z}}function Ee(){const{toast:n}=X(),{userProfile:u,loading:v}=je(),[w,Q]=ve(),z=w.get("tab")||"overview",T=t=>{w.set("tab",t),Q(w,{replace:!0})},[y,_]=C.useState([]),[$,k]=C.useState(!1),[S,g]=C.useState(!1),[c,x]=C.useState({title:"",category:"",start_time:"",end_time:"",prizes:["","",""],prize_type:"money",bulk:""}),[a,d]=C.useState("form"),[f,i]=C.useState([B()]),[r,R]=C.useState(null),[q,M]=C.useState([]),[W,ee]=C.useState(null),[ce,oe]=C.useState(!1),F=c.category==="opinion",E=(u==null?void 0:u.role)==="admin",U=C.useCallback(async()=>{if(!E){k(!1),_([]);return}if(k(!0),!p){_([]),k(!1);return}const{data:t,error:s}=await p.from("quizzes").select("id,title,category,prizes,prize_pool,prize_type,start_time,end_time").order("start_time",{ascending:!1});s?n({title:"Fetch failed",description:s.message,variant:"destructive"}):_(t||[]),k(!1)},[n,E]),de=C.useCallback(async t=>{if(!E){M([]);return}if(!p){M([]);return}const{data:s,error:m}=await p.from("questions").select("id,question_text,options(id,option_text,is_correct)").eq("quiz_id",t);m?n({title:"Questions failed",description:m.message,variant:"destructive"}):M(s||[])},[n,E]);C.useEffect(()=>{v||U()},[U,v]);const xe=async t=>{t.preventDefault();try{if(!E){n({title:"Access denied",description:"Only admins can create quizzes.",variant:"destructive"});return}const s=[];c.category||s.push("Select category"),c.title.trim()||s.push("Title required"),(!c.start_time||!c.end_time)&&s.push("Start & End time required");const m=new Date(c.start_time);new Date(c.end_time)<=m&&s.push("End after start");const l=parseInt(c.prizes[0]||"",10);if((Number.isNaN(l)||l<=0)&&s.push("1st prize invalid"),s.length){n({title:"Fix form",description:s[0],variant:"destructive"});return}const h=f.map(D=>{const O=(D.options||[]).map(H=>H.trim()).filter(Boolean).slice(0,4);if(!D.text.trim()||O.length<2)return null;const he=Math.min(Math.max(D.correctIndex||0,0),O.length-1);return{question_text:D.text.trim(),options:O.map((H,ge)=>({option_text:H,is_correct:F?!1:ge===he}))}}).filter(Boolean);if(!h.length){n({title:"Add questions",variant:"destructive"});return}const b=c.prizes.filter(D=>D).map(D=>parseInt(D,10)),P=b.reduce((D,O)=>D+O,0),V={title:c.title.trim(),category:c.category,start_time:new Date(c.start_time).toISOString(),end_time:new Date(c.end_time).toISOString(),prizes:b,prize_pool:P,prize_type:c.prize_type};if(!p)throw new Error("Supabase config missing");const{data:se,error:ie}=await p.from("quizzes").insert([V]).select().single();if(ie)throw ie;n({title:"Quiz created",description:se.title});const ae=await me(se.id,h,"replace");ae.ok?n({title:"Questions added",description:`${h.length} questions`}):n({title:"Question insert fallback",description:ae.message||"Failed",variant:"destructive"}),g(!1),x({title:"",category:"",start_time:"",end_time:"",prizes:["","",""],prize_type:"money",bulk:""}),i([B()]),U()}catch(s){n({title:"Create failed",description:s.message,variant:"destructive"})}},me=async(t,s,m="append")=>{if(!E)return{ok:!1,message:"Admin access required"};try{if(!p)throw new Error("No Supabase client");const{error:o}=await p.rpc("admin_bulk_upsert_questions",{p_quiz_id:t,p_payload:s,p_mode:m});if(!o)return{ok:!0}}catch(o){}if(!p)return{ok:!1,message:"No Supabase client"};m==="replace"&&await p.from("questions").delete().eq("quiz_id",t);for(const o of s){const{data:l,error:h}=await p.from("questions").insert({quiz_id:t,question_text:o.question_text}).select("id").single();if(h)return{ok:!1,message:h.message};const b=o.options.map(V=>({question_id:l.id,option_text:V.option_text,is_correct:!!V.is_correct})),{error:P}=await p.from("options").insert(b);if(P)return{ok:!1,message:P.message}}return{ok:!0}},pe=async t=>{if(!window.confirm("Delete this quiz?"))return;if(!E){n({title:"Access denied",description:"Only admins can delete quizzes.",variant:"destructive"});return}if(!p)return;const{error:s}=await p.from("quizzes").delete().eq("id",t);s?n({title:"Delete failed",description:s.message,variant:"destructive"}):(n({title:"Deleted"}),U())},ue=async t=>{if(!E){n({title:"Access denied",description:"Only admins can recompute results.",variant:"destructive"});return}if(p)try{ee(t);const{error:s}=await p.rpc("admin_recompute_quiz_results",{p_quiz_id:t});if(s)throw s;n({title:"Recomputed"})}catch(s){n({title:"Recompute failed",description:s.message,variant:"destructive"})}finally{ee(null)}},te=C.useMemo(()=>{const t=Date.now(),s=[],m=[];for(const o of y){const l=o.end_time?new Date(o.end_time).getTime():null;l!==null&&t>l?m.push(o):s.push(o)}return{active:s,finished:m}},[y]);return v?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(I,{className:"w-8 h-8 text-indigo-600 animate-spin"})}):E?e.jsxs("div",{className:"container mx-auto p-6 max-w-5xl bg-white text-gray-900 rounded-2xl shadow-sm",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6 text-gray-900",children:"Admin Dashboard"}),!ye&&e.jsx("div",{className:"mb-6 text-sm text-amber-600",children:"Supabase env keys missing. Read-only UI only."}),e.jsx("div",{className:"flex gap-2 mb-6 flex-wrap",children:["overview","notifications","redemptions"].map(t=>e.jsx("button",{onClick:()=>T(t),className:`px-3 py-1.5 rounded border text-sm transition-colors ${t===z?"bg-indigo-600 text-white border-indigo-600":"bg-gray-100 text-gray-700 border-gray-200 hover:bg-gray-200"}`,children:t},t))}),z==="overview"&&e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{children:e.jsxs(j,{onClick:()=>g(!0),className:"bg-indigo-600 hover:bg-indigo-700 text-white",children:[e.jsx(J,{className:"w-4 h-4 mr-1"}),"New Quiz"]})}),e.jsx(re,{children:S&&e.jsxs(Y.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},className:"bg-gray-50 border border-gray-200 rounded-xl p-5",children:[e.jsx("h2",{className:"font-semibold text-lg mb-4",children:"Create Quiz"}),e.jsxs("form",{onSubmit:xe,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(A,{className:"mb-1 block",children:"Category"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:le.map(({value:t,label:s})=>e.jsx("button",{type:"button",onClick:()=>x(m=>({...m,category:t})),className:`px-3 py-1 rounded-full text-xs border ${c.category===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:s},t))})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(A,{children:"Title"}),e.jsx(L,{value:c.title,onChange:t=>x(s=>({...s,title:t.target.value})),placeholder:"Daily Quiz",required:!0})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Prize Type"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["money","coins","others"].map(t=>e.jsx("button",{type:"button",onClick:()=>x(s=>({...s,prize_type:t})),className:`px-2 py-1 rounded text-xs border ${c.prize_type===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:t},t))})]})]}),e.jsx("div",{className:"grid md:grid-cols-3 gap-2",children:c.prizes.map((t,s)=>e.jsx(L,{value:t,placeholder:`${s+1}${["st","nd","rd"][s]||"th"} Prize`,onChange:m=>x(o=>{const l=[...o.prizes];return l[s]=m.target.value,{...o,prizes:l}})},s))}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(A,{children:"Start Time"}),e.jsx(L,{type:"datetime-local",value:c.start_time,onChange:t=>x(s=>({...s,start_time:t.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(A,{children:"End Time"}),e.jsx(L,{type:"datetime-local",value:c.end_time,onChange:t=>x(s=>({...s,end_time:t.target.value})),required:!0})]})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Questions Mode"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["form","paste"].map(t=>e.jsx("button",{type:"button",onClick:()=>d(t),className:`px-3 py-1 rounded text-xs border ${a===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:t},t))})]}),a==="form"?e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-xs text-gray-600",children:F?"Opinion: no correct option stored.":"Mark one correct option with radio."}),f.map((t,s)=>e.jsxs("div",{className:"border border-gray-200 rounded p-3 space-y-2 bg-white",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("span",{className:"text-xs text-gray-500 w-6",children:["Q",s+1]}),e.jsx(L,{value:t.text,onChange:m=>i(o=>{const l=[...o];return l[s]={...l[s],text:m.target.value},l}),placeholder:"Question text",className:"flex-1"}),e.jsx(j,{type:"button",variant:"outline",size:"sm",className:"border-red-300 text-red-500",onClick:()=>i(m=>m.length===1?[B()]:m.filter((o,l)=>l!==s)),children:"Del"})]}),(t.options||[]).slice(0,4).map((m,o)=>e.jsxs("div",{className:"flex items-center gap-2",children:[!F&&e.jsx("input",{type:"radio",name:`q-${s}`,checked:(t.correctIndex||0)===o,onChange:()=>i(l=>{const h=[...l];return h[s]={...h[s],correctIndex:o},h})}),e.jsx(L,{value:m,onChange:l=>i(h=>{const b=[...h],P=[...b[s].options];return P[o]=l.target.value,b[s]={...b[s],options:P},b}),placeholder:`Option ${o+1}`,className:"flex-1"}),(t.options||[]).length>2&&e.jsx(j,{type:"button",size:"sm",variant:"outline",className:"border-red-300 text-red-500",onClick:()=>i(l=>{const h=[...l],b=[...h[s].options];return b.splice(o,1),h[s]={...h[s],options:b},h}),children:"X"})]},o)),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs(j,{type:"button",size:"sm",disabled:(t.options||[]).length>=4,onClick:()=>i(m=>{const o=[...m],l=[...o[s].options];return l.length<4&&l.push(""),o[s]={...o[s],options:l},o}),children:[e.jsx(J,{className:"w-4 h-4 mr-1"}),"Option"]}),e.jsx("span",{className:"text-xs text-gray-500",children:"Max 4 options"})]})]},s)),e.jsxs(j,{type:"button",onClick:()=>i(t=>[...t,B()]),children:[e.jsx(J,{className:"w-4 h-4 mr-1"}),"Question"]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Paste Questions"}),e.jsx(G,{className:"h-40",value:c.bulk,onChange:t=>x(s=>({...s,bulk:t.target.value})),placeholder:`Q1. Capital of India?
- [ ] Mumbai
- [x] Delhi
- [ ] Kolkata
- [ ] Jaipur

Q2. ...`}),(()=>{const{items:t,errors:s,warnings:m}=Se(c.bulk,{allowZeroCorrect:F});return e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsxs("div",{children:[t.length," parsed"]}),m[0]&&e.jsx("div",{className:"text-amber-500",children:m[0]}),s[0]&&e.jsx("div",{className:"text-red-500",children:s[0]}),e.jsx(j,{type:"button",size:"sm",disabled:!!s.length||!t.length,onClick:()=>{if(s.length||!t.length)return;const o=t.map(l=>({text:l.question_text,options:l.options.map(h=>h.option_text),correctIndex:F?0:l.options.findIndex(h=>h.is_correct)>=0?l.options.findIndex(h=>h.is_correct):0}));i(o.length?o:[B()]),d("form"),n({title:"Loaded",description:`${o.length} questions moved to form.`})},children:"Load into form"})]})})()]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(j,{type:"submit",className:"bg-green-600 hover:bg-green-700",children:"Create"}),e.jsx(j,{type:"button",variant:"outline",onClick:()=>g(!1),children:"Cancel"})]})]})]})}),e.jsxs("section",{children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2 mb-3",children:[e.jsx(Ne,{className:"w-5 h-5"}),"All Quizzes"]}),$?e.jsxs("div",{className:"py-8 text-center text-gray-500",children:[e.jsx(I,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading..."]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Active / Upcoming"}),e.jsx("div",{className:"space-y-4",children:te.active.map(t=>{const s=t.prize_type||"money",m=Z(s,t.prize_pool,{fallback:0}),o=Array.isArray(t.prizes)?t.prizes.map(l=>Z(s,l,{fallback:0})).join(", "):"";return e.jsxs(Y.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"border border-gray-200 rounded-xl p-4 bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between gap-4 flex-wrap",children:[e.jsxs("div",{className:"flex-1 min-w-[240px]",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-xs text-gray-600 flex flex-wrap gap-3 mt-1",children:[e.jsxs("span",{children:["Category: ",ne(t.category)||"—"]}),e.jsxs("span",{children:["Type: ",s]}),e.jsxs("span",{children:["Pool: ",m]}),e.jsxs("span",{children:["Prizes: ",o]})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[e.jsxs("span",{children:["Start: ",t.start_time?K(t.start_time):"—"]}),e.jsxs("span",{className:"ml-4",children:["End: ",t.end_time?K(t.end_time):"—"]})]})]}),e.jsxs("div",{className:"flex gap-2 items-start",children:[e.jsx(j,{size:"sm",variant:"outline",onClick:()=>ue(t.id),disabled:W===t.id,children:W===t.id?e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"w-4 h-4 mr-1 animate-spin"}),"..."]}):e.jsxs(e.Fragment,{children:[e.jsx(we,{className:"w-4 h-4 mr-1"}),"Recompute"]})}),e.jsxs(be,{to:`/results/${t.id}`,className:"inline-flex items-center gap-1 px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-100 text-indigo-600",children:[e.jsx(_e,{className:"w-4 h-4"}),"Results"]}),e.jsxs(j,{size:"sm",variant:"outline",onClick:()=>{R(t),de(t.id),oe(!0)},className:"text-blue-400",children:[e.jsx(ze,{className:"w-4 h-4 mr-1"}),"Questions"]}),e.jsx(j,{size:"sm",variant:"outline",onClick:()=>pe(t.id),className:"text-red-500",children:e.jsx(ke,{className:"w-4 h-4"})})]})]}),e.jsx(re,{children:ce&&(r==null?void 0:r.id)===t.id&&e.jsxs(Y.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"mt-4 space-y-2",children:[e.jsxs("h5",{className:"font-medium flex items-center gap-2",children:["Questions for ",t.title]}),q.length===0&&e.jsx("div",{className:"text-xs text-gray-500",children:"No questions."}),q.map((l,h)=>e.jsxs("div",{className:"border border-gray-200 rounded p-3 bg-white",children:[e.jsxs("div",{className:"text-sm font-medium",children:["Q",h+1,": ",l.question_text]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:(l.options||[]).map(b=>e.jsxs("div",{className:`px-2 py-0.5 text-xs rounded-full ${b.is_correct?"bg-green-600 text-white":"bg-gray-200 text-gray-700"}`,children:[b.option_text,b.is_correct&&e.jsx("span",{className:"ml-1",children:"✓"})]},b.id))})]},l.id))]})})]},t.id)})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Finished"}),e.jsx("div",{className:"space-y-4",children:te.finished.map(t=>{const s=t.prize_type||"money",m=Z(s,t.prize_pool,{fallback:0}),o=Array.isArray(t.prizes)?t.prizes.map(l=>Z(s,l,{fallback:0})).join(", "):"";return e.jsxs(Y.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"border border-gray-200 rounded-xl p-4 bg-gray-50",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-xs text-gray-600 flex flex-wrap gap-3 mt-1",children:[e.jsxs("span",{children:["Category: ",ne(t.category)||"—"]}),e.jsxs("span",{children:["Type: ",s]}),e.jsxs("span",{children:["Pool: ",m]}),e.jsxs("span",{children:["Prizes: ",o]})]})]},t.id)})})]})]})]})]}),z==="notifications"&&e.jsx(Re,{}),z==="redemptions"&&e.jsx(Ce,{})]}):e.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-2xl p-6 max-w-md w-full text-center shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-500 mb-2",children:"Admin access required"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx("span",{children:"Supabase "}),e.jsx("code",{children:"profiles"}),e.jsx("span",{children:" table mein aapke record ka "}),e.jsx("strong",{children:"role"}),e.jsx("span",{children:" field admin hona chahiye."})]}),e.jsxs("ul",{className:"text-left text-sm text-gray-600 mt-4 space-y-2 list-disc list-inside",children:[e.jsxs("li",{children:[e.jsx("span",{children:"Supabase dashboard"}),e.jsx("span",{"aria-hidden":"true",role:"presentation",className:"mx-1",children:"→"}),e.jsx("span",{children:"Table editor"}),e.jsx("span",{"aria-hidden":"true",role:"presentation",className:"mx-1",children:"→"}),e.jsx("code",{children:"profiles"}),e.jsx("span",{children:" me role update karein."})]}),e.jsx("li",{children:"Update ke baad login session refresh karein."}),e.jsxs("li",{children:["Dev bypass (",e.jsx("code",{children:"VITE_BYPASS_AUTH=1"}),") mein mock admin auto-enable hota hai."]})]})]})})}function Ce(){const{toast:n}=X(),[u,v]=N.useState([]),[w,Q]=N.useState(!1),[z,T]=N.useState(!1),[y,_]=N.useState({reward_type:"coins",reward_value:"",coins_required:"",is_active:!0}),[$,k]=N.useState(!1),[S,g]=N.useState(null),c=N.useCallback(async()=>{if(!p)return;Q(!0);const{data:i,error:r}=await p.from("reward_catalog").select("id,reward_type,reward_value,coins_required,is_active").order("id",{ascending:!1}).limit(200);r?n({title:"Rewards load failed",description:r.message,variant:"destructive"}):v(i||[]),Q(!1)},[n]);N.useEffect(()=>{c()},[c]);const x=()=>_({reward_type:"coins",reward_value:"",coins_required:"",is_active:!0}),a=async i=>{if(i.preventDefault(),!!p){k(!0);try{const r={reward_type:String(y.reward_type||"").trim()||"other",reward_value:String(y.reward_value||"").trim(),coins_required:y.coins_required!==""&&y.coins_required!==null?parseInt(y.coins_required,10):null,is_active:!!y.is_active};if(!r.reward_value)throw new Error("Value required");if(r.coins_required===null||Number.isNaN(r.coins_required))throw new Error("Coins required");let R;if(S?R=await p.from("reward_catalog").update(r).eq("id",S).select().single():R=await p.from("reward_catalog").insert([r]).select().single(),R.error)throw R.error;n({title:S?"Reward updated":"Reward created"}),x(),T(!1),g(null),c()}catch(r){n({title:"Save failed",description:r.message,variant:"destructive"})}finally{k(!1)}}},d=async i=>{if(!p)return;const{error:r}=await p.from("reward_catalog").update({is_active:!i.is_active}).eq("id",i.id);r?n({title:"Toggle failed",description:r.message,variant:"destructive"}):(n({title:i.is_active?"Deactivated":"Activated"}),c())},f=i=>{var r;g(i.id),T(!0),_({reward_type:i.reward_type||"coins",reward_value:i.reward_value||"",coins_required:((r=i.coins_required)!=null?r:"").toString(),is_active:!!i.is_active})};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Redemptions auto-approved hain. Neeche sirf Rewards Catalog manage karna hai."}),e.jsxs("div",{className:"pt-10 border-t border-gray-200 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Rewards Catalog"}),e.jsx(j,{size:"sm",onClick:()=>{T(i=>!i),z||(x(),g(null))},children:z?"Close":"New Reward"}),e.jsx(j,{size:"sm",variant:"outline",onClick:c,disabled:w,children:w?e.jsx(I,{className:"w-4 h-4 animate-spin"}):"Refresh"})]}),z&&e.jsxs("form",{onSubmit:a,className:"space-y-3 bg-gray-50 border border-gray-200 rounded-lg p-4 max-w-3xl",children:[e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(A,{children:"Type"}),e.jsx("div",{className:"flex gap-2 flex-wrap mt-1",children:["coins","cash","voucher","other"].map(i=>e.jsx("button",{type:"button",onClick:()=>_(r=>({...r,reward_type:i})),className:`px-2 py-1 rounded text-xs border ${y.reward_type===i?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:i},i))})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Value"}),e.jsx(L,{value:y.reward_value,onChange:i=>_(r=>({...r,reward_value:i.target.value})),placeholder:"e.g. 100 / AMAZON100 / ₹100"})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Coins Required"}),e.jsx(L,{type:"number",value:y.coins_required,onChange:i=>_(r=>({...r,coins_required:i.target.value})),placeholder:"coins needed"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"is_active",type:"checkbox",checked:!!y.is_active,onChange:i=>_(r=>({...r,is_active:i.target.checked}))}),e.jsx("label",{htmlFor:"is_active",className:"text-sm",children:"Active"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{type:"submit",disabled:$,children:$?e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"w-4 h-4 mr-1 animate-spin"}),"Saving"]}):S?"Update":"Create"}),e.jsx(j,{type:"button",variant:"outline",onClick:()=>{x(),g(null)},children:S?"Cancel Edit":"Reset"})]})]}),e.jsx("div",{className:"overflow-x-auto rounded-lg border border-gray-200",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-100 text-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Type"}),e.jsx("th",{className:"p-2 text-left",children:"Value"}),e.jsx("th",{className:"p-2 text-left",children:"Coins Required"}),e.jsx("th",{className:"p-2 text-left",children:"Active"}),e.jsx("th",{className:"p-2 text-left",children:"Actions"})]})}),e.jsxs("tbody",{children:[u.map(i=>{var r;return e.jsxs("tr",{className:"border-t border-gray-200 hover:bg-gray-100",children:[e.jsx("td",{className:"p-2 capitalize",children:i.reward_type}),e.jsx("td",{className:"p-2 max-w-[260px] truncate",title:i.reward_value,children:i.reward_value}),e.jsx("td",{className:"p-2",children:(r=i.coins_required)!=null?r:"—"}),e.jsx("td",{className:"p-2",children:i.is_active?e.jsx("span",{className:"text-green-500",children:"Yes"}):e.jsx("span",{className:"text-gray-500",children:"No"})}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(j,{size:"sm",variant:"outline",onClick:()=>f(i),children:"Edit"}),e.jsx(j,{size:"sm",variant:"outline",onClick:()=>d(i),children:i.is_active?"Deactivate":"Activate"})]})})]},i.id)}),!u.length&&!w&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"p-4 text-center text-gray-500",children:"No rewards."})}),w&&e.jsx("tr",{children:e.jsxs("td",{colSpan:8,className:"p-6 text-center text-gray-500",children:[e.jsx(I,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading rewards..."]})})]})]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"Catalog: inactive rewards are hidden from users."})]})]})}function Re(){const{toast:n}=X(),[u,v]=N.useState(""),[w,Q]=N.useState(""),[z,T]=N.useState("all"),[y,_]=N.useState(!1),[$,k]=N.useState([]),[S,g]=N.useState(!1),c=N.useCallback(async()=>{if(!p)return;g(!0);const{data:a,error:d}=await p.from("notifications").select("id,title,message,type,segment,created_at").order("created_at",{ascending:!1}).limit(100);d?n({title:"Fetch failed",description:d.message,variant:"destructive"}):k(a||[]),g(!1)},[n]);N.useEffect(()=>{c()},[c]);const x=async a=>{if(a.preventDefault(),!u.trim()||!w.trim()){n({title:"Missing fields",variant:"destructive"});return}if(!p){n({title:"No backend client",variant:"destructive"});return}_(!0);try{const{data:{session:d}}=await p.auth.getSession(),f=d==null?void 0:d.access_token,i=await fetch("/functions/v1/send-notifications",{method:"POST",headers:{"Content-Type":"application/json",...f?{Authorization:`Bearer ${f}`}:{}},body:JSON.stringify({title:u.trim(),message:w.trim(),segment:z})});if(!i.ok){const r=await i.text();throw new Error(r||`HTTP ${i.status}`)}n({title:"Sent",description:u.trim()}),v(""),Q(""),c()}catch(d){n({title:"Send failed",description:d.message,variant:"destructive"})}finally{_(!1)}};return e.jsxs("div",{className:"space-y-8 max-w-3xl",children:[e.jsxs("form",{onSubmit:x,className:"space-y-4 bg-gray-50 border border-gray-200 rounded-xl p-5",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Send Notification"}),e.jsxs("div",{children:[e.jsx(A,{children:"Title"}),e.jsx(L,{value:u,onChange:a=>v(a.target.value),maxLength:80,placeholder:"Short title"}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Max 80 chars • ",u.length,"/80"]})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Message"}),e.jsx(G,{value:w,onChange:a=>Q(a.target.value),className:"h-28",maxLength:280,placeholder:"Body shown in push notification"}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Max 280 chars • ",w.length,"/280"]})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Segment"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["all"].map(a=>e.jsx("button",{type:"button",onClick:()=>T(a),className:`px-3 py-1 rounded text-xs border ${z===a?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:a},a))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{type:"submit",disabled:y,children:y?e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"w-4 h-4 mr-1 animate-spin"}),"Sending"]}):"Send"}),e.jsx(j,{type:"button",variant:"outline",onClick:()=>{v(""),Q("")},children:"Reset"})]})]}),e.jsxs("section",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Recent Notifications"}),e.jsx(j,{size:"sm",variant:"outline",onClick:c,disabled:S,children:S?e.jsx(I,{className:"w-4 h-4 animate-spin"}):"Refresh"})]}),e.jsxs("div",{className:"space-y-3",children:[$.map(a=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-3 bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between gap-4 flex-wrap",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:a.title}),e.jsx("div",{className:"text-xs text-gray-600 whitespace-pre-wrap max-w-xl break-words",children:a.message})]}),e.jsx("div",{className:"text-[10px] text-gray-500",children:K(a.created_at)})]}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Segment: ",a.segment||"—",a.type?` • ${a.type}`:""]})]},a.id)),!$.length&&!S&&e.jsx("div",{className:"text-xs text-gray-500",children:"No notifications yet."})]})]})]})}export{Ee as default};
