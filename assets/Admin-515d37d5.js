import{j as e,o as _e,u as W,a as ze,s as x,h as Se,B as f,A as oe,m as J,L as A,I,p as G}from"./index-0aae9fde.js";import{a as _,r as C}from"./react-8a702e3e.js";import{d as ke,L as Ce}from"./router-f2cf3f51.js";import{L as P,Y as X,Z as Re,m as Ae,u as Ee,_ as Te,$ as Qe}from"./icons-e9c8901f.js";import"./supabase-4c1332f7.js";const ee=_.forwardRef(({className:c,...u},w)=>e.jsx("textarea",{ref:w,className:_e("flex w-full rounded-md border border-input bg-background px-3 py-2 text-base sm:text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 min-h-[80px] resize-vertical",c),...u}));ee.displayName="Textarea";const me=[{value:"opinion",label:"Opinion"},{value:"gk",label:"General Knowledge"},{value:"sports",label:"Sports"},{value:"movies",label:"Movies"}],de=c=>{var u;return((u=me.find(w=>w.value===c))==null?void 0:u.label)||c},B=()=>({text:"",options:["","",""],correctIndex:0});function Y(c,u,{fallback:w=0}={}){return u==null&&(u=w),c==="coins"?`${u} coins`:c==="others"?`${u}`:`₹${u}`}function De(c,{allowZeroCorrect:u=!1}={}){var v,S;const w=String(c||"").trim().split(/\n\s*\n+/),j=[],R=[],E=[];let z=0;for(const T of w){const Q=T.split(/\r?\n/).map(a=>a.trim()).filter(Boolean);if(!Q.length)continue;z+=1;const N=Q[0].replace(/^Q\d*\.?\s*/i,"").replace(/^Question\s*[:-]\s*/i,""),y=[];let b="";for(let a=1;a<Q.length;a++){const d=Q[a];if(/^ans(wer)?\s*[:-]/i.test(d)){b=d;continue}const g=d.match(/^[-*•]?\s*\[(x|X| )\]\s*(.+)$/);if(g){y.push({option_text:g[2].trim(),is_correct:/x/i.test(g[1])});continue}const r=d.match(/^(?:[-*•]|[A-Da-d]\)|\d+\)|[A-Da-d][.:])\s*(.+)$/),n=r?r[1].trim():d.replace(/^[*]\s*/,"").trim();n&&y.push({option_text:n,is_correct:/^\*/.test(d)})}if(b){const a=b.split(/[:-]/).slice(1).join(":").trim(),d=(S=(v=a.match(/^[A-D]/i))==null?void 0:v[0])==null?void 0:S.toUpperCase(),g=d?{A:0,B:1,C:2,D:3}[d]:NaN,r=parseInt(a,10);if(!Number.isNaN(g)&&y[g])y.forEach((n,k)=>n.is_correct=k===g);else if(!Number.isNaN(r)&&y[r-1])y.forEach((n,k)=>n.is_correct=k===r-1);else{const n=a.toLowerCase(),k=y.findIndex(q=>q.option_text.toLowerCase()===n||q.option_text.toLowerCase().includes(n));k>=0&&y.forEach((q,F)=>q.is_correct=F===k)}}let l=y.filter(a=>a.option_text);if(l.length>4){const a=l.findIndex(d=>d.is_correct);if(a>=0){const d=l[a],g=l.filter((r,n)=>n!==a);l=[d,...g.slice(0,3)]}else l=l.slice(0,4);E.push(`Q${z}: Trimmed to 4 options.`)}if(!N){R.push(`Q${z}: Missing question text.`);continue}if(l.length<2){R.push(`Q${z}: Need at least 2 options.`);continue}if(u)l=l.map(a=>({...a,is_correct:!1}));else{const a=l.filter(d=>d.is_correct).length;if(a===0)l[0].is_correct=!0;else if(a>1){let d=!1;l=l.map(g=>g.is_correct&&!d?(d=!0,g):{...g,is_correct:!1})}}j.push({question_text:N,options:l})}return{items:j,errors:R,warnings:E}}function Be(){var re;const{toast:c}=W(),{userProfile:u,loading:w,user:j}=ze(),[R,E]=ke(),z=R.get("tab")||"overview",v=t=>{R.set("tab",t),E(R,{replace:!0})},[S,T]=C.useState([]),[Q,N]=C.useState(!1),[y,b]=C.useState(!1),[l,a]=C.useState({title:"",category:"",start_time:"",end_time:"",prizes:["","",""],prize_type:"coins",bulk:""}),[d,g]=C.useState("form"),[r,n]=C.useState([B()]),[k,q]=C.useState(null),[F,Z]=C.useState([]),[te,se]=C.useState(null),[xe,pe]=C.useState(!1),M=l.category==="opinion",ue=C.useMemo(()=>{try{const t=String({}.VITE_ADMIN_EMAILS||"").trim();return t?new Set(t.split(/[\s,]+/).map(s=>s.trim().toLowerCase()).filter(Boolean)):new Set}catch(t){return new Set}},[]),he=String((u==null?void 0:u.role)||"").trim().toLowerCase(),ie=String((j==null?void 0:j.email)||"").trim().toLowerCase(),ge=String(((re=j==null?void 0:j.app_metadata)==null?void 0:re.role)||"").trim().toLowerCase(),$=he==="admin"||ge==="admin"||ie&&ue.has(ie),U=C.useCallback(async()=>{if(!$){N(!1),T([]);return}if(N(!0),!x){T([]),N(!1);return}const{data:t,error:s}=await x.from("quizzes").select("id,title,category,prizes,prize_pool,prize_type,start_time,end_time").order("start_time",{ascending:!1});s?c({title:"Fetch failed",description:s.message,variant:"destructive"}):T(t||[]),N(!1)},[c,$]),fe=C.useCallback(async t=>{if(!$){Z([]);return}if(!x){Z([]);return}const{data:s,error:m}=await x.from("questions").select("id,question_text,options(id,option_text,is_correct)").eq("quiz_id",t);m?c({title:"Questions failed",description:m.message,variant:"destructive"}):Z(s||[])},[c,$]);C.useEffect(()=>{w||U()},[U,w]);const je=async t=>{t.preventDefault();try{if(!$){c({title:"Access denied",description:"Only admins can create quizzes.",variant:"destructive"});return}const s=[];l.category||s.push("Select category"),l.title.trim()||s.push("Title required"),(!l.start_time||!l.end_time)&&s.push("Start & End time required");const m=new Date(l.start_time);new Date(l.end_time)<=m&&s.push("End after start");const i=parseInt(l.prizes[0]||"",10);if((Number.isNaN(i)||i<=0)&&s.push("1st prize invalid"),s.length){c({title:"Fix form",description:s[0],variant:"destructive"});return}const p=r.map(L=>{const O=(L.options||[]).map(K=>K.trim()).filter(Boolean).slice(0,4);if(!L.text.trim()||O.length<2)return null;const we=Math.min(Math.max(L.correctIndex||0,0),O.length-1);return{question_text:L.text.trim(),options:O.map((K,Ne)=>({option_text:K,is_correct:M?!1:Ne===we}))}}).filter(Boolean);if(!p.length){c({title:"Add questions",variant:"destructive"});return}const h=l.prizes.filter(L=>L).map(L=>parseInt(L,10)),D=h.reduce((L,O)=>L+O,0),V=l.prize_type==="money"&&D>0?"coins":l.prize_type,H={title:l.title.trim(),category:l.category,start_time:new Date(l.start_time).toISOString(),end_time:new Date(l.end_time).toISOString(),prizes:h,prize_pool:D,prize_type:V};if(!x)throw new Error("Supabase config missing");const{data:ne,error:le}=await x.from("quizzes").insert([H]).select().single();if(le)throw le;c({title:"Quiz created",description:ne.title});const ce=await ye(ne.id,p,"replace");ce.ok?c({title:"Questions added",description:`${p.length} questions`}):c({title:"Question insert fallback",description:ce.message||"Failed",variant:"destructive"}),b(!1),a({title:"",category:"",start_time:"",end_time:"",prizes:["","",""],prize_type:"coins",bulk:""}),n([B()]),U()}catch(s){c({title:"Create failed",description:s.message,variant:"destructive"})}},ye=async(t,s,m="append")=>{var o;if(!$)return{ok:!1,message:"Admin access required"};if(!x)return{ok:!1,message:"No Supabase client"};try{const{data:i}=await x.auth.getSession(),p=(o=i==null?void 0:i.session)==null?void 0:o.access_token,h=await fetch("/functions/v1/admin-upsert-questions",{method:"POST",headers:{"Content-Type":"application/json",...p?{Authorization:`Bearer ${p}`}:{}},body:JSON.stringify({quizId:t,items:s,mode:m})});if(h.ok)return{ok:!0};if(h.status!==404){const D=await h.json().catch(()=>({}));throw new Error((D==null?void 0:D.error)||`HTTP ${h.status}`)}}catch(i){console.warn("Edge bulk insert failed, falling back to direct RPC path",i)}try{const{error:i}=await x.rpc("admin_bulk_upsert_questions",{p_quiz_id:t,p_payload:s,p_mode:m});if(!i)return{ok:!0};console.warn("admin_bulk_upsert_questions RPC returned error, using manual inserts",i==null?void 0:i.message)}catch(i){console.warn("admin_bulk_upsert_questions RPC threw, using manual inserts",i)}m==="replace"&&await x.from("questions").delete().eq("quiz_id",t);for(const i of s){const{data:p,error:h}=await x.from("questions").insert({quiz_id:t,question_text:i.question_text}).select("id").single();if(h)return{ok:!1,message:h.message};const D=i.options.map(H=>({question_id:p.id,option_text:H.option_text,is_correct:!!H.is_correct})),{error:V}=await x.from("options").insert(D);if(V)return{ok:!1,message:V.message}}return{ok:!0}},ve=async t=>{if(!window.confirm("Delete this quiz?"))return;if(!$){c({title:"Access denied",description:"Only admins can delete quizzes.",variant:"destructive"});return}if(!x)return;const{error:s}=await x.from("quizzes").delete().eq("id",t);s?c({title:"Delete failed",description:s.message,variant:"destructive"}):(c({title:"Deleted"}),U())},be=async t=>{if(!$){c({title:"Access denied",description:"Only admins can recompute results.",variant:"destructive"});return}if(x)try{se(t);const{error:s}=await x.rpc("admin_recompute_quiz_results",{p_quiz_id:t});if(s)throw s;try{await x.rpc("compute_results_if_due",{p_quiz_id:t})}catch(m){try{}catch(o){}}c({title:"Recomputed"})}catch(s){c({title:"Recompute failed",description:s.message,variant:"destructive"})}finally{se(null)}},ae=C.useMemo(()=>{const t=Date.now(),s=[],m=[];for(const o of S){const i=o.end_time?new Date(o.end_time).getTime():null;i!==null&&t>i?m.push(o):s.push(o)}return{active:s,finished:m}},[S]);return w?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(P,{className:"w-8 h-8 text-indigo-600 animate-spin"})}):$?e.jsxs("div",{className:"container mx-auto p-6 max-w-5xl bg-white text-gray-900 rounded-2xl shadow-sm",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6 text-gray-900",children:"Admin Dashboard"}),!Se&&e.jsx("div",{className:"mb-6 text-sm text-amber-600",children:"Supabase env keys missing. Read-only UI only."}),e.jsx("div",{className:"flex gap-2 mb-6 flex-wrap",children:["overview","notifications","redemptions"].map(t=>e.jsx("button",{onClick:()=>v(t),className:`px-3 py-1.5 rounded border text-sm transition-colors ${t===z?"bg-indigo-600 text-white border-indigo-600":"bg-gray-100 text-gray-700 border-gray-200 hover:bg-gray-200"}`,children:t},t))}),z==="overview"&&e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{children:e.jsxs(f,{onClick:()=>b(!0),className:"bg-indigo-600 hover:bg-indigo-700 text-white",children:[e.jsx(X,{className:"w-4 h-4 mr-1"}),"New Quiz"]})}),e.jsx(oe,{children:y&&e.jsxs(J.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},className:"bg-gray-50 border border-gray-200 rounded-xl p-5",children:[e.jsx("h2",{className:"font-semibold text-lg mb-4",children:"Create Quiz"}),e.jsxs("form",{onSubmit:je,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(A,{className:"mb-1 block",children:"Category"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:me.map(({value:t,label:s})=>e.jsx("button",{type:"button",onClick:()=>a(m=>({...m,category:t})),className:`px-3 py-1 rounded-full text-xs border ${l.category===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:s},t))})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(A,{children:"Title"}),e.jsx(I,{value:l.title,onChange:t=>a(s=>({...s,title:t.target.value})),placeholder:"Daily Quiz",required:!0})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Prize Type"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["money","coins","others"].map(t=>e.jsx("button",{type:"button",onClick:()=>a(s=>({...s,prize_type:t})),className:`px-2 py-1 rounded text-xs border ${l.prize_type===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:t},t))})]})]}),e.jsx("div",{className:"grid md:grid-cols-3 gap-2",children:l.prizes.map((t,s)=>e.jsx(I,{value:t,placeholder:`${s+1}${["st","nd","rd"][s]||"th"} Prize`,onChange:m=>a(o=>{const i=[...o.prizes];return i[s]=m.target.value,{...o,prizes:i}})},s))}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(A,{children:"Start Time"}),e.jsx(I,{type:"datetime-local",value:l.start_time,onChange:t=>a(s=>({...s,start_time:t.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(A,{children:"End Time"}),e.jsx(I,{type:"datetime-local",value:l.end_time,onChange:t=>a(s=>({...s,end_time:t.target.value})),required:!0})]})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Questions Mode"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["form","paste"].map(t=>e.jsx("button",{type:"button",onClick:()=>g(t),className:`px-3 py-1 rounded text-xs border ${d===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:t},t))})]}),d==="form"?e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-xs text-gray-600",children:M?"Opinion: no correct option stored.":"Mark one correct option with radio."}),r.map((t,s)=>e.jsxs("div",{className:"border border-gray-200 rounded p-3 space-y-2 bg-white",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("span",{className:"text-xs text-gray-500 w-6",children:["Q",s+1]}),e.jsx(I,{value:t.text,onChange:m=>n(o=>{const i=[...o];return i[s]={...i[s],text:m.target.value},i}),placeholder:"Question text",className:"flex-1"}),e.jsx(f,{type:"button",variant:"outline",size:"sm",className:"border-red-300 text-red-500",onClick:()=>n(m=>m.length===1?[B()]:m.filter((o,i)=>i!==s)),children:"Del"})]}),(t.options||[]).slice(0,4).map((m,o)=>e.jsxs("div",{className:"flex items-center gap-2",children:[!M&&e.jsx("input",{type:"radio",name:`q-${s}`,checked:(t.correctIndex||0)===o,onChange:()=>n(i=>{const p=[...i];return p[s]={...p[s],correctIndex:o},p})}),e.jsx(I,{value:m,onChange:i=>n(p=>{const h=[...p],D=[...h[s].options];return D[o]=i.target.value,h[s]={...h[s],options:D},h}),placeholder:`Option ${o+1}`,className:"flex-1"}),(t.options||[]).length>2&&e.jsx(f,{type:"button",size:"sm",variant:"outline",className:"border-red-300 text-red-500",onClick:()=>n(i=>{const p=[...i],h=[...p[s].options];return h.splice(o,1),p[s]={...p[s],options:h},p}),children:"X"})]},o)),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs(f,{type:"button",size:"sm",disabled:(t.options||[]).length>=4,onClick:()=>n(m=>{const o=[...m],i=[...o[s].options];return i.length<4&&i.push(""),o[s]={...o[s],options:i},o}),children:[e.jsx(X,{className:"w-4 h-4 mr-1"}),"Option"]}),e.jsx("span",{className:"text-xs text-gray-500",children:"Max 4 options"})]})]},s)),e.jsxs(f,{type:"button",onClick:()=>n(t=>[...t,B()]),children:[e.jsx(X,{className:"w-4 h-4 mr-1"}),"Question"]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Paste Questions"}),e.jsx(ee,{className:"h-40",value:l.bulk,onChange:t=>a(s=>({...s,bulk:t.target.value})),placeholder:`Q1. Capital of India?
- [ ] Mumbai
- [x] Delhi
- [ ] Kolkata
- [ ] Jaipur

Q2. ...`}),(()=>{const{items:t,errors:s,warnings:m}=De(l.bulk,{allowZeroCorrect:M});return e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsxs("div",{children:[t.length," parsed"]}),m[0]&&e.jsx("div",{className:"text-amber-500",children:m[0]}),s[0]&&e.jsx("div",{className:"text-red-500",children:s[0]}),e.jsx(f,{type:"button",size:"sm",disabled:!!s.length||!t.length,onClick:()=>{if(s.length||!t.length)return;const o=t.map(i=>({text:i.question_text,options:i.options.map(p=>p.option_text),correctIndex:M?0:i.options.findIndex(p=>p.is_correct)>=0?i.options.findIndex(p=>p.is_correct):0}));n(o.length?o:[B()]),g("form"),c({title:"Loaded",description:`${o.length} questions moved to form.`})},children:"Load into form"})]})})()]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(f,{type:"submit",className:"bg-green-600 hover:bg-green-700",children:"Create"}),e.jsx(f,{type:"button",variant:"outline",onClick:()=>b(!1),children:"Cancel"})]})]})]})}),e.jsxs("section",{children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2 mb-3",children:[e.jsx(Re,{className:"w-5 h-5"}),"All Quizzes"]}),Q?e.jsxs("div",{className:"py-8 text-center text-gray-500",children:[e.jsx(P,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading..."]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Active / Upcoming"}),e.jsx("div",{className:"space-y-4",children:ae.active.map(t=>{const s=t.prize_type||"money",m=Y(s,t.prize_pool,{fallback:0}),o=Array.isArray(t.prizes)?t.prizes.map(i=>Y(s,i,{fallback:0})).join(", "):"";return e.jsxs(J.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"border border-gray-200 rounded-xl p-4 bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between gap-4 flex-wrap",children:[e.jsxs("div",{className:"flex-1 min-w-[240px]",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-xs text-gray-600 flex flex-wrap gap-3 mt-1",children:[e.jsxs("span",{children:["Category: ",de(t.category)||"—"]}),e.jsxs("span",{children:["Type: ",s]}),e.jsxs("span",{children:["Pool: ",m]}),e.jsxs("span",{children:["Prizes: ",o]})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[e.jsxs("span",{children:["Start: ",t.start_time?G(t.start_time):"—"]}),e.jsxs("span",{className:"ml-4",children:["End: ",t.end_time?G(t.end_time):"—"]})]})]}),e.jsxs("div",{className:"flex gap-2 items-start",children:[e.jsx(f,{size:"sm",variant:"outline",onClick:()=>be(t.id),disabled:te===t.id,children:te===t.id?e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"w-4 h-4 mr-1 animate-spin"}),"..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ae,{className:"w-4 h-4 mr-1"}),"Recompute"]})}),e.jsxs(Ce,{to:`/results/${t.id}`,className:"inline-flex items-center gap-1 px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-100 text-indigo-600",children:[e.jsx(Ee,{className:"w-4 h-4"}),"Results"]}),e.jsxs(f,{size:"sm",variant:"outline",onClick:()=>{q(t),fe(t.id),pe(!0)},className:"text-blue-400",children:[e.jsx(Te,{className:"w-4 h-4 mr-1"}),"Questions"]}),e.jsx(f,{size:"sm",variant:"outline",onClick:()=>ve(t.id),className:"text-red-500",children:e.jsx(Qe,{className:"w-4 h-4"})})]})]}),e.jsx(oe,{children:xe&&(k==null?void 0:k.id)===t.id&&e.jsxs(J.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"mt-4 space-y-2",children:[e.jsxs("h5",{className:"font-medium flex items-center gap-2",children:["Questions for ",t.title]}),F.length===0&&e.jsx("div",{className:"text-xs text-gray-500",children:"No questions."}),F.map((i,p)=>e.jsxs("div",{className:"border border-gray-200 rounded p-3 bg-white",children:[e.jsxs("div",{className:"text-sm font-medium",children:["Q",p+1,": ",i.question_text]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:(i.options||[]).map(h=>e.jsxs("div",{className:`px-2 py-0.5 text-xs rounded-full ${h.is_correct?"bg-green-600 text-white":"bg-gray-200 text-gray-700"}`,children:[h.option_text,h.is_correct&&e.jsx("span",{className:"ml-1",children:"✓"})]},h.id))})]},i.id))]})})]},t.id)})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Finished"}),e.jsx("div",{className:"space-y-4",children:ae.finished.map(t=>{const s=t.prize_type||"money",m=Y(s,t.prize_pool,{fallback:0}),o=Array.isArray(t.prizes)?t.prizes.map(i=>Y(s,i,{fallback:0})).join(", "):"";return e.jsxs(J.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"border border-gray-200 rounded-xl p-4 bg-gray-50",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-xs text-gray-600 flex flex-wrap gap-3 mt-1",children:[e.jsxs("span",{children:["Category: ",de(t.category)||"—"]}),e.jsxs("span",{children:["Type: ",s]}),e.jsxs("span",{children:["Pool: ",m]}),e.jsxs("span",{children:["Prizes: ",o]})]})]},t.id)})})]})]})]})]}),z==="notifications"&&e.jsx($e,{}),z==="redemptions"&&e.jsx(Le,{})]}):e.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-2xl p-6 max-w-md w-full text-center shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-500 mb-2",children:"Admin access required"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx("span",{children:"Supabase "}),e.jsx("code",{children:"profiles"}),e.jsx("span",{children:" table mein aapke record ka "}),e.jsx("strong",{children:"role"}),e.jsx("span",{children:" field admin hona chahiye."})]}),e.jsxs("ul",{className:"text-left text-sm text-gray-600 mt-4 space-y-2 list-disc list-inside",children:[e.jsxs("li",{children:[e.jsx("span",{children:"Supabase dashboard"}),e.jsx("span",{"aria-hidden":"true",role:"presentation",className:"mx-1",children:"→"}),e.jsx("span",{children:"Table editor"}),e.jsx("span",{"aria-hidden":"true",role:"presentation",className:"mx-1",children:"→"}),e.jsx("code",{children:"profiles"}),e.jsx("span",{children:" me role update karein."})]}),e.jsx("li",{children:"Update ke baad login session refresh karein."}),e.jsxs("li",{children:["Dev bypass (",e.jsx("code",{children:"VITE_BYPASS_AUTH=1"}),") mein mock admin auto-enable hota hai."]})]})]})})}function Le(){const{toast:c}=W(),[u,w]=_.useState([]),[j,R]=_.useState(!1),[E,z]=_.useState(!1),[v,S]=_.useState({reward_type:"coins",reward_value:"",coins_required:"",is_active:!0}),[T,Q]=_.useState(!1),[N,y]=_.useState(null),b=_.useCallback(async()=>{if(!x)return;R(!0);const{data:r,error:n}=await x.from("reward_catalog").select("id,reward_type,reward_value,coins_required,is_active").order("id",{ascending:!1}).limit(200);n?c({title:"Rewards load failed",description:n.message,variant:"destructive"}):w(r||[]),R(!1)},[c]);_.useEffect(()=>{b()},[b]);const l=()=>S({reward_type:"coins",reward_value:"",coins_required:"",is_active:!0}),a=async r=>{if(r.preventDefault(),!!x){Q(!0);try{const n={reward_type:String(v.reward_type||"").trim()||"other",reward_value:String(v.reward_value||"").trim(),coins_required:v.coins_required!==""&&v.coins_required!==null?parseInt(v.coins_required,10):null,is_active:!!v.is_active};if(!n.reward_value)throw new Error("Value required");if(n.coins_required===null||Number.isNaN(n.coins_required))throw new Error("Coins required");let k;if(N?k=await x.from("reward_catalog").update(n).eq("id",N).select().single():k=await x.from("reward_catalog").insert([n]).select().single(),k.error)throw k.error;c({title:N?"Reward updated":"Reward created"}),l(),z(!1),y(null),b()}catch(n){c({title:"Save failed",description:n.message,variant:"destructive"})}finally{Q(!1)}}},d=async r=>{if(!x)return;const{error:n}=await x.from("reward_catalog").update({is_active:!r.is_active}).eq("id",r.id);n?c({title:"Toggle failed",description:n.message,variant:"destructive"}):(c({title:r.is_active?"Deactivated":"Activated"}),b())},g=r=>{var n;y(r.id),z(!0),S({reward_type:r.reward_type||"coins",reward_value:r.reward_value||"",coins_required:((n=r.coins_required)!=null?n:"").toString(),is_active:!!r.is_active})};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Redemptions auto-approved hain. Neeche sirf Rewards Catalog manage karna hai."}),e.jsxs("div",{className:"pt-10 border-t border-gray-200 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Rewards Catalog"}),e.jsx(f,{size:"sm",onClick:()=>{z(r=>!r),E||(l(),y(null))},children:E?"Close":"New Reward"}),e.jsx(f,{size:"sm",variant:"outline",onClick:b,disabled:j,children:j?e.jsx(P,{className:"w-4 h-4 animate-spin"}):"Refresh"})]}),E&&e.jsxs("form",{onSubmit:a,className:"space-y-3 bg-gray-50 border border-gray-200 rounded-lg p-4 max-w-3xl",children:[e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(A,{children:"Type"}),e.jsx("div",{className:"flex gap-2 flex-wrap mt-1",children:["coins","cash","voucher","other"].map(r=>e.jsx("button",{type:"button",onClick:()=>S(n=>({...n,reward_type:r})),className:`px-2 py-1 rounded text-xs border ${v.reward_type===r?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:r},r))})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Value"}),e.jsx(I,{value:v.reward_value,onChange:r=>S(n=>({...n,reward_value:r.target.value})),placeholder:"e.g. 100 / AMAZON100 / ₹100"})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Coins Required"}),e.jsx(I,{type:"number",value:v.coins_required,onChange:r=>S(n=>({...n,coins_required:r.target.value})),placeholder:"coins needed"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"is_active",type:"checkbox",checked:!!v.is_active,onChange:r=>S(n=>({...n,is_active:r.target.checked}))}),e.jsx("label",{htmlFor:"is_active",className:"text-sm",children:"Active"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{type:"submit",disabled:T,children:T?e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"w-4 h-4 mr-1 animate-spin"}),"Saving"]}):N?"Update":"Create"}),e.jsx(f,{type:"button",variant:"outline",onClick:()=>{l(),y(null)},children:N?"Cancel Edit":"Reset"})]})]}),e.jsx("div",{className:"overflow-x-auto rounded-lg border border-gray-200",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-100 text-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Type"}),e.jsx("th",{className:"p-2 text-left",children:"Value"}),e.jsx("th",{className:"p-2 text-left",children:"Coins Required"}),e.jsx("th",{className:"p-2 text-left",children:"Active"}),e.jsx("th",{className:"p-2 text-left",children:"Actions"})]})}),e.jsxs("tbody",{children:[u.map(r=>{var n;return e.jsxs("tr",{className:"border-t border-gray-200 hover:bg-gray-100",children:[e.jsx("td",{className:"p-2 capitalize",children:r.reward_type}),e.jsx("td",{className:"p-2 max-w-[260px] truncate",title:r.reward_value,children:r.reward_value}),e.jsx("td",{className:"p-2",children:(n=r.coins_required)!=null?n:"—"}),e.jsx("td",{className:"p-2",children:r.is_active?e.jsx("span",{className:"text-green-500",children:"Yes"}):e.jsx("span",{className:"text-gray-500",children:"No"})}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(f,{size:"sm",variant:"outline",onClick:()=>g(r),children:"Edit"}),e.jsx(f,{size:"sm",variant:"outline",onClick:()=>d(r),children:r.is_active?"Deactivate":"Activate"})]})})]},r.id)}),!u.length&&!j&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"p-4 text-center text-gray-500",children:"No rewards."})}),j&&e.jsx("tr",{children:e.jsxs("td",{colSpan:8,className:"p-6 text-center text-gray-500",children:[e.jsx(P,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading rewards..."]})})]})]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"Catalog: inactive rewards are hidden from users."})]})]})}function $e(){const{toast:c}=W(),[u,w]=_.useState(""),[j,R]=_.useState(""),[E,z]=_.useState("all"),[v,S]=_.useState(!1),[T,Q]=_.useState([]),[N,y]=_.useState(!1),b=_.useCallback(async()=>{if(!x)return;y(!0);const{data:a,error:d}=await x.from("notifications").select("id,title,message,type,segment,created_at").order("created_at",{ascending:!1}).limit(100);d?c({title:"Fetch failed",description:d.message,variant:"destructive"}):Q(a||[]),y(!1)},[c]);_.useEffect(()=>{b()},[b]);const l=async a=>{if(a.preventDefault(),!u.trim()||!j.trim()){c({title:"Missing fields",variant:"destructive"});return}if(!x){c({title:"No backend client",variant:"destructive"});return}S(!0);try{const{data:{session:d}}=await x.auth.getSession(),g=d==null?void 0:d.access_token,r=await fetch("/functions/v1/send-notifications",{method:"POST",headers:{"Content-Type":"application/json",...g?{Authorization:`Bearer ${g}`}:{}},body:JSON.stringify({title:u.trim(),message:j.trim(),segment:E})});if(!r.ok){const n=await r.text();throw new Error(n||`HTTP ${r.status}`)}c({title:"Sent",description:u.trim()}),w(""),R(""),b()}catch(d){c({title:"Send failed",description:d.message,variant:"destructive"})}finally{S(!1)}};return e.jsxs("div",{className:"space-y-8 max-w-3xl",children:[e.jsxs("form",{onSubmit:l,className:"space-y-4 bg-gray-50 border border-gray-200 rounded-xl p-5",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Send Notification"}),e.jsxs("div",{children:[e.jsx(A,{children:"Title"}),e.jsx(I,{value:u,onChange:a=>w(a.target.value),maxLength:80,placeholder:"Short title"}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Max 80 chars • ",u.length,"/80"]})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Message"}),e.jsx(ee,{value:j,onChange:a=>R(a.target.value),className:"h-28",maxLength:280,placeholder:"Body shown in push notification"}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Max 280 chars • ",j.length,"/280"]})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Segment"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["all"].map(a=>e.jsx("button",{type:"button",onClick:()=>z(a),className:`px-3 py-1 rounded text-xs border ${E===a?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:a},a))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{type:"submit",disabled:v,children:v?e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"w-4 h-4 mr-1 animate-spin"}),"Sending"]}):"Send"}),e.jsx(f,{type:"button",variant:"outline",onClick:()=>{w(""),R("")},children:"Reset"})]})]}),e.jsxs("section",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Recent Notifications"}),e.jsx(f,{size:"sm",variant:"outline",onClick:b,disabled:N,children:N?e.jsx(P,{className:"w-4 h-4 animate-spin"}):"Refresh"})]}),e.jsxs("div",{className:"space-y-3",children:[T.map(a=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-3 bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between gap-4 flex-wrap",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:a.title}),e.jsx("div",{className:"text-xs text-gray-600 whitespace-pre-wrap max-w-xl break-words",children:a.message})]}),e.jsx("div",{className:"text-[10px] text-gray-500",children:G(a.created_at)})]}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Segment: ",a.segment||"—",a.type?` • ${a.type}`:""]})]},a.id)),!T.length&&!N&&e.jsx("div",{className:"text-xs text-gray-500",children:"No notifications yet."})]})]})]})}export{Be as default};
