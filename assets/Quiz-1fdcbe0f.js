import{u as ue,a as me,i as xe,s as w,Q as pe,c as ee,j as e,m as C,B as Z,A as fe,f as he,d as te,g as ge}from"./index-0aba9d84.js";import{r as o}from"./react-63c462fe.js";import{S as W}from"./SEO-c2c15188.js";import{c as be,a as we}from"./router-10fed1f4.js";import{L as se,X as ie,e as ne,d as ae,v as re}from"./icons-590232b1.js";import"./supabase-07ebd5d8.js";function oe(){return typeof document=="undefined"?!1:document.visibilityState==="hidden"}function je(c,f){const{toast:t}=ue(),{user:l}=me(),{isSubscribed:T,subscribeToPush:M}=xe(),[r,J]=o.useState(null),[q,B]=o.useState([]),[O,F]=o.useState(0),[G,V]=o.useState({}),[m,_]=o.useState("loading"),[H,D]=o.useState(0),[N,X]=o.useState(!1),[$,U]=o.useState({joined:0,pre_joined:0}),[S,E]=o.useState(!1),[g,u]=o.useState(null),d=o.useRef(null),h=o.useRef(!0),p=o.useRef([]),k=o.useRef(null);o.useEffect(()=>()=>{h.current=!1,d.current&&clearTimeout(d.current),k.current&&clearTimeout(k.current)},[]),o.useEffect(()=>()=>{try{r&&m==="active"&&g!=="completed"&&(l!=null&&l.id)&&w.from("quiz_participants").update({status:"completed"}).eq("user_id",l.id).eq("quiz_id",c).then(()=>{}).catch(()=>{})}catch(i){}},[r,c,m,g,l==null?void 0:l.id]);const z=o.useCallback(()=>{if(k.current||p.current.length===0)return;const i=p.current[0],n=2e3*Math.pow(2,(i.attempt||1)-1),a=Math.min(n,3e4);k.current=setTimeout(()=>{k.current=null,j()},a)},[]),j=o.useCallback(async()=>{if(p.current.length===0)return;const i=[...p.current];p.current=[];for(const n of i)if(!(!l||g==="completed"))try{const{error:a}=await w.from("user_answers").upsert({user_id:l.id,question_id:n.questionId,selected_option_id:n.optionId},{onConflict:"user_id,question_id"});if(a)throw a;V(s=>({...s,[n.questionId]:n.optionId}))}catch(a){const s=(n.attempt||1)+1;s<=6?p.current.push({...n,attempt:s}):t({title:"Answer not saved",description:"One answer failed to sync after multiple retries.",variant:"destructive"})}p.current.length>0&&z()},[g,l,t,z]);o.useEffect(()=>{const i=()=>j(),n=()=>{oe()||j()};return window.addEventListener("online",i),document.addEventListener("visibilitychange",n),()=>{window.removeEventListener("online",i),document.removeEventListener("visibilitychange",n)}},[j]);const A=($.joined||0)+($.pre_joined||0),R=m==="active"?$.joined||0:A,Q=o.useCallback(async()=>{const{data:i,error:n}=await w.from("questions").select("id, question_text, options ( id, option_text )").eq("quiz_id",c).order("id");B(n?[]:i||[])},[c]),L=o.useCallback(async()=>{var i,n;try{const{data:a,error:s}=await w.rpc("get_engagement_counts",{p_quiz_id:c});if(s)console.warn("Engagement counts fetch failed:",s),U({joined:0,pre_joined:0});else{const x=Array.isArray(a)?a[0]:a,y=Number((i=x==null?void 0:x.joined)!=null?i:0),v=Number((n=x==null?void 0:x.pre_joined)!=null?n:0);U({joined:isNaN(y)?0:y,pre_joined:isNaN(v)?0:v})}}catch(a){console.warn("Engagement refresh failed",a)}},[c]),K=o.useCallback(async()=>{try{const{data:i,error:n}=await w.from("quizzes").select("*").eq("id",c).single();if(n||!i){t({title:"Error",description:"Quiz not found.",variant:"destructive"}),f("/");return}J(i);let a=null;if(l&&l.id){const{data:s,error:x}=await w.from("quiz_participants").select("status").eq("user_id",l.id).eq("quiz_id",c).maybeSingle();!x&&s?(a=s,E(!0),u(s.status||null),a.status==="completed"&&_("completed")):(E(!1),u(null))}else E(!1),u(null);a&&a.status!=="completed"&&await Q(),await L()}catch(i){console.error("Error fetching quiz data:",i),t({title:"Error",description:"Failed to load quiz.",variant:"destructive"}),f("/")}},[c,l,f,t,Q,L]);o.useEffect(()=>{K()},[K]),o.useEffect(()=>{if(!r||m==="completed")return;const i=()=>{const a=new Date,s=r.start_time?new Date(r.start_time):null,x=r.end_time?new Date(r.end_time):null,y=s&&a<s,v=s&&x&&a>=s&&a<x;if(y){_("waiting"),D(Math.max(0,Math.round((s.getTime()-a.getTime())/1e3)));return}if(v){_("active"),D(Math.max(0,Math.round((x.getTime()-a.getTime())/1e3)));return}_("finished"),D(0)};i();const n=setInterval(i,1e3);return()=>clearInterval(n)},[r,m]),o.useEffect(()=>{if(!r||!(m==="waiting"||m==="active"))return;const n=setInterval(()=>{oe()||L()},pe);return()=>clearInterval(n)},[r,m,L]),o.useEffect(()=>{(async()=>{var n,a;if(r&&m==="active"&&l)try{if(!S||g==="pre_joined"){let s=!1,x=null;for(let y=0;y<2&&!s;y++){const{error:v}=await w.rpc("join_quiz",{p_quiz_id:c});if(!v){s=!0;break}x=v;const P=String(v.message||"").toLowerCase();if(P.includes("not active")){await new Promise(Y=>setTimeout(Y,1500));continue}if(P.includes("already")||P.includes("completed")){s=!0;break}break}if(s)E(!0),u("joined");else if(x){const{error:y}=await w.rpc("pre_join_quiz",{p_quiz_id:c});if(!y)E(!0),u("pre_joined");else throw x}}q.length===0&&await Q()}catch(s){!((n=s==null?void 0:s.message)!=null&&n.includes("already"))&&!((a=s==null?void 0:s.message)!=null&&a.includes("completed"))&&console.error("Quiz join error:",s)}})()},[r,m,l,S,g,c,Q,q.length,t]),o.useEffect(()=>{m==="finished"&&Object.keys(G).length>0&&!N&&I()},[m]),o.useEffect(()=>{if(d.current&&(clearTimeout(d.current),d.current=null),!r||!r.end_time||!(m==="finished"||m==="completed"))return;const i=()=>{(async()=>{try{await ee(w,c)}catch(n){}f(`/results/${c}`)})()};try{const n=new Date(r.end_time).getTime(),a=Date.now(),s=Math.max(0,n-a);s===0?i():d.current=setTimeout(()=>{d.current=null,i()},s)}catch(n){console.error("Error calculating redirect time:",n),d.current=setTimeout(()=>{d.current=null,i()},5e3)}return()=>{d.current&&(clearTimeout(d.current),d.current=null)}},[r,c,m,f]);const le=o.useCallback(async()=>{var y,v,P,Y;if(!r)return;if(!l){t({title:"Login required",description:"Please sign in to join the quiz.",variant:"destructive"}),f("/login");return}if(g==="completed"){console.log("User already completed this quiz");return}try{typeof Notification!="undefined"&&Notification.permission!=="granted"&&!T&&await M()}catch(b){}const i=new Date,n=r.start_time?new Date(r.start_time):null,a=r.end_time?new Date(r.end_time):null,s=r.status==="active"&&n&&a&&i>=n&&i<a,x=s?"join_quiz":"pre_join_quiz";try{const{error:b}=await w.rpc(x,{p_quiz_id:c});if(b){if((y=b.message)!=null&&y.includes("already")||(v=b.message)!=null&&v.includes("completed")){console.log("User already joined this quiz"),E(!0),u(s?"joined":"pre_joined"),s&&(await Q(),_("active"));return}throw b}E(!0),L(),u(s?"joined":"pre_joined"),t({title:s?"Joined!":"Pre-joined!",description:s?"Starting now.":"We will remind you before start."}),s&&(await Q(),_("active"))}catch(b){!((P=b==null?void 0:b.message)!=null&&P.includes("already"))&&!((Y=b==null?void 0:b.message)!=null&&Y.includes("completed"))&&(console.error("Join quiz error:",b),t({title:"Error",description:"Could not join quiz. Please try again.",variant:"destructive"}))}},[r,l,g,T,M,c,t,f,L,Q,_]),ce=o.useCallback(async(i,n)=>{if(!(N||m!=="active"||g==="completed"))try{const{error:a}=await w.from("user_answers").upsert({user_id:l.id,question_id:i,selected_option_id:n},{onConflict:"user_id,question_id"});if(a)throw a;V(s=>({...s,[i]:n})),O<q.length-1&&(typeof requestAnimationFrame=="function"?requestAnimationFrame(()=>F(s=>s+1)):setTimeout(()=>F(s=>s+1),250))}catch(a){console.error("Error saving answer:",a),p.current.some(x=>x.questionId===i)||t({title:"Sync delayed",description:"Network issue. Will retry automatically.",variant:"destructive"}),p.current.push({questionId:i,optionId:n,attempt:1}),z()}},[N,m,g,l==null?void 0:l.id,O,q.length,t,z]),I=o.useCallback(async()=>{if(!N){X(!0);try{const{error:i}=await w.from("quiz_participants").update({status:"completed"}).eq("user_id",l.id).eq("quiz_id",c);if(i)throw i;t({title:"Quiz Completed!",description:"Your answers have been submitted. Results will be announced soon!"}),_("completed");try{await ee(w,c)}catch(n){}f(`/results/${c}`)}catch(i){console.error("Error submitting quiz:",i),t({title:"Submission Failed",description:"Could not submit your answers. Please try again.",variant:"destructive"})}finally{h.current&&X(!1)}}},[N,l==null?void 0:l.id,c,t,f]),de=o.useCallback(i=>{const n=Math.floor(i/60),a=i%60;return`${n.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`},[]);return{quiz:r,questions:q,currentQuestionIndex:O,answers:G,quizState:m,timeLeft:H,submitting:N,engagement:$,joined:S,participantStatus:g,totalJoined:A,displayJoined:R,setCurrentQuestionIndex:F,handleJoinOrPrejoin:le,handleAnswerSelect:ce,handleSubmit:I,formatTime:de}}const Se=()=>{var g;const{id:c}=be(),f=we(),{quiz:t,questions:l,currentQuestionIndex:T,answers:M,quizState:r,timeLeft:J,submitting:q,joined:B,participantStatus:O,totalJoined:F,displayJoined:G,handleJoinOrPrejoin:V,handleAnswerSelect:m,handleSubmit:_,formatTime:H}=je(c,f),[D,N]=o.useState(null);o.useEffect(()=>{if(!(t!=null&&t.end_time)){N(null);return}if(!(r==="completed"||r==="finished")){N(null);return}const u=new Date(t.end_time).getTime(),d=()=>{const p=Math.max(0,u-Date.now());N(p)};d();const h=setInterval(d,1e3);return()=>clearInterval(h)},[t==null?void 0:t.end_time,r]);const X=()=>{if(!(t!=null&&t.end_time))return e.jsx("p",{className:"text-slate-300",children:"Results will be published soon."});const u=D!=null?D:Math.max(0,new Date(t.end_time).getTime()-Date.now()),d=Math.max(0,Math.floor(u/1e3)),h=Math.floor(d/86400),p=Math.floor(d%86400/3600),k=Math.floor(d%3600/60),z=d%60,j=({value:A,label:R})=>e.jsxs("div",{className:"px-3 py-2 rounded-md bg-slate-800/70 border border-slate-700 min-w-[64px]",children:[e.jsx("div",{className:"text-xl font-bold text-white tabular-nums",children:A.toString().padStart(2,"0")}),e.jsx("div",{className:"text-xs text-slate-400",children:R})]});return e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-slate-300",children:"Results will be published soon."}),e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[h>0&&e.jsx(j,{value:h,label:"Days"}),e.jsx(j,{value:p,label:"Hours"}),e.jsx(j,{value:k,label:"Minutes"}),e.jsx(j,{value:z,label:"Seconds"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Expected publish time: ",new Date(t.end_time).toLocaleString()]})]})};if(r==="loading"||!t)return e.jsxs("div",{className:"min-h-screen flex items-center justify-center",children:[e.jsx(W,{title:"Quiz – Loading | Quiz Dangal",description:"Loading quiz details.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${c}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs("div",{className:"text-center",children:[e.jsx(se,{className:"h-16 w-16 animate-spin text-accent-b mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading quiz..."})]})]});const $=()=>e.jsxs("div",{className:"mt-3 text-xs text-slate-300",children:[e.jsx("div",{className:"text-[11px] text-slate-400",children:t.start_time?he(t.start_time):"—"}),e.jsxs("div",{className:"mt-1 grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide text-[10px] text-slate-400",children:"Start"}),e.jsx("div",{children:t.start_time?te(t.start_time):"—"})]}),e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide text-[10px] text-slate-400",children:"End"}),e.jsx("div",{children:t.end_time?te(t.end_time):"—"})]})]})]}),U=()=>{var j,A,R;const u=Array.isArray(t.prizes)?t.prizes:[],d=t.prize_type||"coins",h=(j=u[0])!=null?j:0,p=(A=u[1])!=null?A:0,k=(R=u[2])!=null?R:0,z=Q=>ge(d,Q,{fallback:0}).formatted;return e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"px-2 py-1 rounded-md bg-amber-500/15 text-amber-300 border border-amber-700/30",children:["1st ",z(h)]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-sky-500/15 text-sky-300 border border-sky-700/30",children:["2nd ",z(p)]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-violet-500/15 text-violet-300 border border-violet-700/30",children:["3rd ",z(k)]})]})};if(!B&&r!=="completed"){const u=new Date,d=t.start_time?new Date(t.start_time):null,h=t.end_time?new Date(t.end_time):null,p=t.status==="active"&&d&&h&&u>=d&&u<h;return e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4",children:[e.jsx(W,{title:`${t.title||"Quiz"} – Lobby | Quiz Dangal`,description:"Join the quiz lobby.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${c}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs(C.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card relative rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100 w-full",children:[e.jsx("button",{"aria-label":"Close",onClick:()=>window.history.length>1?f(-1):f("/"),className:"absolute top-3 right-3 text-slate-400 hover:text-slate-200 transition",children:e.jsx(ie,{className:"h-5 w-5"})}),e.jsx(ne,{className:"h-16 w-16 text-accent-b mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:t.title}),e.jsx("p",{className:"text-slate-300 mb-1",children:p?"Quiz is live!":"Quiz starts in:"}),e.jsx("div",{className:"text-4xl font-bold text-indigo-300 mb-4",children:H(J)}),e.jsx("div",{className:"flex items-center justify-center gap-4 text-sm text-gray-300",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ae,{className:"h-4 w-4 mr-1"}),G," joined"]})}),e.jsx(U,{}),e.jsx($,{}),e.jsx("div",{className:"mt-6",children:e.jsx(Z,{onClick:V,className:p?"bg-emerald-600 hover:bg-emerald-700":"bg-indigo-600 hover:bg-indigo-700",children:p?"Join & Start":"Pre-Join"})})]})]})}if(r==="waiting")return e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4",children:[e.jsx(W,{title:`${t.title||"Quiz"} – Waiting | Quiz Dangal`,description:"Waiting for the quiz to start.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${c}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs(C.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card relative rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx("button",{"aria-label":"Close",onClick:()=>window.history.length>1?f(-1):f("/"),className:"absolute top-3 right-3 text-slate-400 hover:text-slate-200 transition",children:e.jsx(ie,{className:"h-5 w-5"})}),e.jsx(ne,{className:"h-16 w-16 text-accent-b mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:t.title}),e.jsx("p",{className:"text-slate-300 mb-1",children:"Quiz starts in:"}),e.jsx("div",{className:"text-4xl font-bold text-indigo-300 mb-4",children:H(J)}),e.jsx("div",{className:"flex items-center justify-center gap-4 text-sm text-gray-300",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ae,{className:"h-4 w-4 mr-1"}),F," joined"]})}),e.jsx(U,{}),e.jsx($,{}),e.jsx("div",{className:"mt-4 text-xs text-slate-400",children:"We’ll auto-start when the timer hits zero."})]})]});if(r==="completed"||r==="finished")return e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4",children:[e.jsx(W,{title:`${t.title||"Quiz"} – Completed | Quiz Dangal`,description:"Quiz completed. Results will be published soon.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${c}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs(C.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx(re,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-3",children:"Quiz Submitted Successfully!"}),e.jsx("p",{className:"text-slate-300 mb-4",children:"Thank you for participating!"}),X(),e.jsx("div",{className:"mt-6",children:e.jsx(Z,{onClick:()=>f("/"),className:"bg-indigo-600 hover:bg-indigo-700",children:"Back to Home"})})]})]});if(l.length===0)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-gray-600",children:"No questions available for this quiz."})})});const S=l[T],E=(T+1)/l.length*100;return e.jsxs("div",{className:"min-h-screen p-4 bg-[radial-gradient(1000px_600px_at_50%_-100px,rgba(59,130,246,0.25),transparent),radial-gradient(800px_500px_at_120%_0,rgba(168,85,247,0.18),transparent)]",children:[e.jsx(W,{title:`${t.title||"Quiz"} – Play | Quiz Dangal`,description:"Answer questions and compete to win.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${c}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs(C.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"rounded-2xl p-4 mb-6 text-slate-100 border border-slate-800/60 bg-slate-900/60 backdrop-blur-md shadow-[0_10px_30px_rgba(0,0,0,0.35)]",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-extrabold text-white tracking-tight",children:t.title}),e.jsxs("p",{className:"text-xs text-slate-400",children:["Question ",T+1," of ",l.length]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-black text-rose-300 tabular-nums",children:H(J)}),e.jsx("div",{className:"text-[10px] text-slate-400 uppercase tracking-wide",children:"Time Left"})]})]}),e.jsx("div",{className:"w-full bg-slate-800/60 rounded-full h-2 mt-4 overflow-hidden",children:e.jsx(C.div,{className:"h-2 rounded-full bg-[linear-gradient(90deg,#22d3ee,#818cf8,#a78bfa,#f472b6)]",style:{width:`${E}%`},transition:{duration:.5}})})]}),e.jsx(fe,{mode:"wait",children:e.jsxs(C.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},exit:{opacity:0,y:-16},transition:{duration:.25},className:"rounded-2xl p-6 text-slate-100 border border-slate-800/60 bg-slate-900/60 backdrop-blur-md shadow-[0_10px_30px_rgba(0,0,0,0.35)]",children:[e.jsx("h2",{className:"text-xl font-bold text-center text-white mb-6 leading-relaxed",children:S.question_text}),e.jsx("div",{className:"space-y-3",children:(g=S.options)==null?void 0:g.map((u,d)=>{const h=M[S.id]===u.id;return e.jsxs(C.button,{onClick:()=>m(S.id,u.id),disabled:q||r!=="active"||O==="completed",whileHover:{scale:1.01},whileTap:{scale:.99},className:`w-full p-4 rounded-xl text-left font-medium transition-all duration-200 border group relative overflow-hidden ${h?"bg-emerald-600/90 text-white border-emerald-400 shadow-[0_10px_24px_rgba(16,185,129,0.25)]":"bg-slate-800/70 hover:bg-slate-800 text-slate-100 border-slate-700/80"}`,children:[e.jsxs("span",{className:`font-bold mr-3 ${h?"text-white":"text-indigo-300"}`,children:[String.fromCharCode(65+d),"."]}),u.option_text,!h&&e.jsx("span",{className:"absolute inset-y-0 right-0 w-0 group-hover:w-1/6 transition-[width] duration-200 bg-gradient-to-l from-indigo-500/20 to-transparent"})]},u.id)})}),T===l.length-1&&Object.keys(M).length===l.length&&e.jsx(C.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},transition:{delay:.25},className:"mt-7",children:e.jsx(Z,{onClick:_,disabled:q,className:"w-full text-white font-extrabold py-4 text-lg border border-violet-500/40 shadow-[0_8px_18px_rgba(139,92,246,0.35)] hover:shadow-[0_12px_24px_rgba(139,92,246,0.55)] bg-[linear-gradient(90deg,#4f46e5,#7c3aed,#9333ea,#c026d3)]",children:q?e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"mr-2 h-6 w-6 animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"mr-2 h-6 w-6"}),"Submit Quiz"]})})})]},S.id)})]})]})};export{Se as default};
