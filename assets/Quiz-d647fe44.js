import{u as ue,a as me,i as xe,s as y,Q as he,c as ee,j as e,m as k,B as X,A as pe,f as fe,d as te,g as ge}from"./index-8a5a9ed8.js";import{r}from"./react-63c462fe.js";import{S as H}from"./SEO-00f1c37e.js";import{c as be,a as we}from"./router-10fed1f4.js";import{L as se,X as ie,e as ne,d as ae,v as re}from"./icons-218c8792.js";import"./supabase-07ebd5d8.js";function oe(){return typeof document=="undefined"?!1:document.visibilityState==="hidden"}function je(d,f){const{toast:t}=ue(),{user:c}=me(),{isSubscribed:C,subscribeToPush:M}=xe(),[o,P]=r.useState(null),[z,W]=r.useState([]),[J,O]=r.useState(0),[B,G]=r.useState({}),[p,v]=r.useState("loading"),[U,D]=r.useState(0),[_,V]=r.useState(!1),[T,F]=r.useState({joined:0,pre_joined:0}),[q,S]=r.useState(!1),[w,u]=r.useState(null),l=r.useRef(null),g=r.useRef(!0),x=r.useRef([]),E=r.useRef(null);r.useEffect(()=>()=>{g.current=!1,l.current&&clearTimeout(l.current),E.current&&clearTimeout(E.current)},[]);const N=r.useCallback(()=>{if(E.current||x.current.length===0)return;const s=x.current[0],i=2e3*Math.pow(2,(s.attempt||1)-1),a=Math.min(i,3e4);E.current=setTimeout(()=>{E.current=null,j()},a)},[]),j=r.useCallback(async()=>{if(x.current.length===0)return;const s=[...x.current];x.current=[];for(const i of s)if(!(!c||w==="completed"))try{const{error:a}=await y.from("user_answers").upsert({user_id:c.id,question_id:i.questionId,selected_option_id:i.optionId},{onConflict:"user_id,question_id"});if(a)throw a;G(n=>({...n,[i.questionId]:i.optionId}))}catch(a){const n=(i.attempt||1)+1;n<=6?x.current.push({...i,attempt:n}):t({title:"Answer not saved",description:"One answer failed to sync after multiple retries.",variant:"destructive"})}x.current.length>0&&N()},[w,c,t,N]);r.useEffect(()=>{const s=()=>j(),i=()=>{oe()||j()};return window.addEventListener("online",s),document.addEventListener("visibilitychange",i),()=>{window.removeEventListener("online",s),document.removeEventListener("visibilitychange",i)}},[j]);const $=(T.joined||0)+(T.pre_joined||0),L=p==="active"?T.joined||0:$,Q=r.useCallback(async()=>{const{data:s,error:i}=await y.from("questions").select("id, question_text, options ( id, option_text )").eq("quiz_id",d).order("id");W(i?[]:s||[])},[d]),A=r.useCallback(async()=>{var s,i;try{const{data:a,error:n}=await y.rpc("get_engagement_counts",{p_quiz_id:d});if(n)console.warn("Engagement counts fetch failed:",n),F({joined:0,pre_joined:0});else{const h=Array.isArray(a)?a[0]:a,m=Number((s=h==null?void 0:h.joined)!=null?s:0),R=Number((i=h==null?void 0:h.pre_joined)!=null?i:0);F({joined:isNaN(m)?0:m,pre_joined:isNaN(R)?0:R})}}catch(a){console.warn("Engagement refresh failed",a)}},[d]),Y=r.useCallback(async()=>{try{const{data:s,error:i}=await y.from("quizzes").select("*").eq("id",d).single();if(i||!s){t({title:"Error",description:"Quiz not found.",variant:"destructive"}),f("/");return}P(s);let a=null;if(c&&c.id){const{data:n,error:h}=await y.from("quiz_participants").select("status").eq("user_id",c.id).eq("quiz_id",d).maybeSingle();!h&&n?(a=n,S(!0),u(n.status||null),a.status==="completed"&&v("completed")):(S(!1),u(null))}else S(!1),u(null);a&&a.status!=="completed"&&await Q(),await A()}catch(s){console.error("Error fetching quiz data:",s),t({title:"Error",description:"Failed to load quiz.",variant:"destructive"}),f("/")}},[d,c,f,t,Q,A]);r.useEffect(()=>{Y()},[Y]),r.useEffect(()=>{if(!o||p==="completed")return;const s=()=>{const a=new Date,n=o.start_time?new Date(o.start_time):null,h=o.end_time?new Date(o.end_time):null,m=n&&a<n,R=n&&h&&a>=n&&a<h;if(m){v("waiting"),D(Math.max(0,Math.round((n.getTime()-a.getTime())/1e3)));return}if(R){v("active"),D(Math.max(0,Math.round((h.getTime()-a.getTime())/1e3)));return}v("finished"),D(0)};s();const i=setInterval(s,1e3);return()=>clearInterval(i)},[o,p]),r.useEffect(()=>{if(!o||!(p==="waiting"||p==="active"))return;const i=setInterval(()=>{oe()||A()},he);return()=>clearInterval(i)},[o,p,A]),r.useEffect(()=>{(async()=>{var i,a,n,h;if(o&&p==="active"&&c)try{if(!q||w==="pre_joined"){const{error:m}=await y.rpc("join_quiz",{p_quiz_id:d});if(m)if((i=m.message)!=null&&i.includes("already")||(a=m.message)!=null&&a.includes("completed"))console.log("User already joined or completed quiz"),S(!0),u("joined");else throw m;else S(!0),u("joined")}z.length===0&&await Q()}catch(m){!((n=m==null?void 0:m.message)!=null&&n.includes("already"))&&!((h=m==null?void 0:m.message)!=null&&h.includes("completed"))&&console.error("Quiz join error:",m)}})()},[o,p,c,q,w,d,Q,z.length,t]),r.useEffect(()=>{p==="finished"&&Object.keys(B).length>0&&!_&&Z()},[p]),r.useEffect(()=>{if(l.current&&(clearTimeout(l.current),l.current=null),!o||!o.end_time||!(p==="finished"||p==="completed"))return;const s=()=>{(async()=>{try{await ee(y,d)}catch(i){}f(`/results/${d}`)})()};try{const i=new Date(o.end_time).getTime(),a=Date.now(),n=Math.max(0,i-a);n===0?s():l.current=setTimeout(()=>{l.current=null,s()},n)}catch(i){console.error("Error calculating redirect time:",i),l.current=setTimeout(()=>{l.current=null,s()},5e3)}return()=>{l.current&&(clearTimeout(l.current),l.current=null)}},[o,d,p,f]);const le=r.useCallback(async()=>{var m,R,K,I;if(!o)return;if(!c){t({title:"Login required",description:"Please sign in to join the quiz.",variant:"destructive"}),f("/login");return}if(w==="completed"){console.log("User already completed this quiz");return}try{typeof Notification!="undefined"&&Notification.permission!=="granted"&&!C&&await M()}catch(b){}const s=new Date,i=o.start_time?new Date(o.start_time):null,a=o.end_time?new Date(o.end_time):null,n=o.status==="active"&&i&&a&&s>=i&&s<a,h=n?"join_quiz":"pre_join_quiz";try{const{error:b}=await y.rpc(h,{p_quiz_id:d});if(b){if((m=b.message)!=null&&m.includes("already")||(R=b.message)!=null&&R.includes("completed")){console.log("User already joined this quiz"),S(!0),u(n?"joined":"pre_joined"),n&&(await Q(),v("active"));return}throw b}S(!0),A(),u(n?"joined":"pre_joined"),t({title:n?"Joined!":"Pre-joined!",description:n?"Starting now.":"We will remind you before start."}),n&&(await Q(),v("active"))}catch(b){!((K=b==null?void 0:b.message)!=null&&K.includes("already"))&&!((I=b==null?void 0:b.message)!=null&&I.includes("completed"))&&(console.error("Join quiz error:",b),t({title:"Error",description:"Could not join quiz. Please try again.",variant:"destructive"}))}},[o,c,w,C,M,d,t,f,A,Q,v]),ce=r.useCallback(async(s,i)=>{if(!(_||p!=="active"||w==="completed"))try{const{error:a}=await y.from("user_answers").upsert({user_id:c.id,question_id:s,selected_option_id:i},{onConflict:"user_id,question_id"});if(a)throw a;G(n=>({...n,[s]:i})),J<z.length-1&&(typeof requestAnimationFrame=="function"?requestAnimationFrame(()=>O(n=>n+1)):setTimeout(()=>O(n=>n+1),250))}catch(a){console.error("Error saving answer:",a),x.current.some(h=>h.questionId===s)||t({title:"Sync delayed",description:"Network issue. Will retry automatically.",variant:"destructive"}),x.current.push({questionId:s,optionId:i,attempt:1}),N()}},[_,p,w,c==null?void 0:c.id,J,z.length,t,N]),Z=r.useCallback(async()=>{if(!_){V(!0);try{const{error:s}=await y.from("quiz_participants").update({status:"completed"}).eq("user_id",c.id).eq("quiz_id",d);if(s)throw s;t({title:"Quiz Completed!",description:"Your answers have been submitted. Results will be announced soon!"}),v("completed");try{await ee(y,d)}catch(i){}f(`/results/${d}`)}catch(s){console.error("Error submitting quiz:",s),t({title:"Submission Failed",description:"Could not submit your answers. Please try again.",variant:"destructive"})}finally{g.current&&V(!1)}}},[_,c==null?void 0:c.id,d,t,f]),de=r.useCallback(s=>{const i=Math.floor(s/60),a=s%60;return`${i.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`},[]);return{quiz:o,questions:z,currentQuestionIndex:J,answers:B,quizState:p,timeLeft:U,submitting:_,engagement:T,joined:q,participantStatus:w,totalJoined:$,displayJoined:L,setCurrentQuestionIndex:O,handleJoinOrPrejoin:le,handleAnswerSelect:ce,handleSubmit:Z,formatTime:de}}const Se=()=>{var w;const{id:d}=be(),f=we(),{quiz:t,questions:c,currentQuestionIndex:C,answers:M,quizState:o,timeLeft:P,submitting:z,joined:W,participantStatus:J,totalJoined:O,displayJoined:B,handleJoinOrPrejoin:G,handleAnswerSelect:p,handleSubmit:v,formatTime:U}=je(d,f),[D,_]=r.useState(null);r.useEffect(()=>{if(!(t!=null&&t.end_time)){_(null);return}if(!(o==="completed"||o==="finished")){_(null);return}const u=new Date(t.end_time).getTime(),l=()=>{const x=Math.max(0,u-Date.now());_(x)};l();const g=setInterval(l,1e3);return()=>clearInterval(g)},[t==null?void 0:t.end_time,o]);const V=()=>{if(!(t!=null&&t.end_time))return e.jsx("p",{className:"text-slate-300",children:"Results will be published soon."});const u=D!=null?D:Math.max(0,new Date(t.end_time).getTime()-Date.now()),l=Math.max(0,Math.floor(u/1e3)),g=Math.floor(l/86400),x=Math.floor(l%86400/3600),E=Math.floor(l%3600/60),N=l%60,j=({value:$,label:L})=>e.jsxs("div",{className:"px-3 py-2 rounded-md bg-slate-800/70 border border-slate-700 min-w-[64px]",children:[e.jsx("div",{className:"text-xl font-bold text-white tabular-nums",children:$.toString().padStart(2,"0")}),e.jsx("div",{className:"text-xs text-slate-400",children:L})]});return e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-slate-300",children:"Results will be published soon."}),e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[g>0&&e.jsx(j,{value:g,label:"Days"}),e.jsx(j,{value:x,label:"Hours"}),e.jsx(j,{value:E,label:"Minutes"}),e.jsx(j,{value:N,label:"Seconds"})]}),e.jsxs("div",{className:"text-xs text-slate-400",children:["Expected publish time: ",new Date(t.end_time).toLocaleString()]})]})};if(o==="loading"||!t)return e.jsxs("div",{className:"min-h-screen flex items-center justify-center",children:[e.jsx(H,{title:"Quiz â€“ Loading | Quiz Dangal",description:"Loading quiz details.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${d}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs("div",{className:"text-center",children:[e.jsx(se,{className:"h-16 w-16 animate-spin text-accent-b mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading quiz..."})]})]});const T=()=>e.jsxs("div",{className:"mt-3 text-xs text-slate-300",children:[e.jsx("div",{className:"text-[11px] text-slate-400",children:t.start_time?fe(t.start_time):"â€”"}),e.jsxs("div",{className:"mt-1 grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide text-[10px] text-slate-400",children:"Start"}),e.jsx("div",{children:t.start_time?te(t.start_time):"â€”"})]}),e.jsxs("div",{className:"bg-slate-800/60 border border-slate-700 rounded-lg px-3 py-2",children:[e.jsx("div",{className:"uppercase tracking-wide text-[10px] text-slate-400",children:"End"}),e.jsx("div",{children:t.end_time?te(t.end_time):"â€”"})]})]})]}),F=()=>{var j,$,L;const u=Array.isArray(t.prizes)?t.prizes:[],l=t.prize_type||"coins",g=(j=u[0])!=null?j:0,x=($=u[1])!=null?$:0,E=(L=u[2])!=null?L:0,N=Q=>ge(l,Q,{fallback:0}).formatted;return e.jsxs("div",{className:"mt-2 flex items-center gap-2 text-xs",children:[e.jsxs("span",{className:"px-2 py-1 rounded-md bg-amber-500/15 text-amber-300 border border-amber-700/30",children:["1st ",N(g)]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-sky-500/15 text-sky-300 border border-sky-700/30",children:["2nd ",N(x)]}),e.jsxs("span",{className:"px-2 py-1 rounded-md bg-violet-500/15 text-violet-300 border border-violet-700/30",children:["3rd ",N(E)]})]})};if(!W&&o!=="completed"){const u=new Date,l=t.start_time?new Date(t.start_time):null,g=t.end_time?new Date(t.end_time):null,x=t.status==="active"&&l&&g&&u>=l&&u<g;return e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4",children:[e.jsx(H,{title:`${t.title||"Quiz"} â€“ Lobby | Quiz Dangal`,description:"Join the quiz lobby.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${d}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card relative rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100 w-full",children:[e.jsx("button",{"aria-label":"Close",onClick:()=>window.history.length>1?f(-1):f("/"),className:"absolute top-3 right-3 text-slate-400 hover:text-slate-200 transition",children:e.jsx(ie,{className:"h-5 w-5"})}),e.jsx(ne,{className:"h-16 w-16 text-accent-b mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:t.title}),e.jsx("p",{className:"text-slate-300 mb-1",children:x?"Quiz is live!":"Quiz starts in:"}),e.jsx("div",{className:"text-4xl font-bold text-indigo-300 mb-4",children:U(P)}),e.jsx("div",{className:"flex items-center justify-center gap-4 text-sm text-gray-300",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ae,{className:"h-4 w-4 mr-1"}),B," joined"]})}),e.jsx(F,{}),e.jsx(T,{}),e.jsx("div",{className:"mt-6",children:e.jsx(X,{onClick:G,className:x?"bg-emerald-600 hover:bg-emerald-700":"bg-indigo-600 hover:bg-indigo-700",children:x?"Join & Start":"Pre-Join"})})]})]})}if(o==="waiting")return e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4",children:[e.jsx(H,{title:`${t.title||"Quiz"} â€“ Waiting | Quiz Dangal`,description:"Waiting for the quiz to start.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${d}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"qd-card relative rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx("button",{"aria-label":"Close",onClick:()=>window.history.length>1?f(-1):f("/"),className:"absolute top-3 right-3 text-slate-400 hover:text-slate-200 transition",children:e.jsx(ie,{className:"h-5 w-5"})}),e.jsx(ne,{className:"h-16 w-16 text-accent-b mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white text-shadow-sm mb-2",children:t.title}),e.jsx("p",{className:"text-slate-300 mb-1",children:"Quiz starts in:"}),e.jsx("div",{className:"text-4xl font-bold text-indigo-300 mb-4",children:U(P)}),e.jsx("div",{className:"flex items-center justify-center gap-4 text-sm text-gray-300",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ae,{className:"h-4 w-4 mr-1"}),O," joined"]})}),e.jsx(F,{}),e.jsx(T,{}),e.jsx("div",{className:"mt-4 text-xs text-slate-400",children:"Weâ€™ll auto-start when the timer hits zero."})]})]});if(o==="completed"||o==="finished")return e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4",children:[e.jsx(H,{title:`${t.title||"Quiz"} â€“ Completed | Quiz Dangal`,description:"Quiz completed. Results will be published soon.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${d}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs(k.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"qd-card rounded-2xl p-8 shadow-xl text-center max-w-md text-slate-100",children:[e.jsx(re,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-white mb-3",children:"Quiz Submitted Successfully!"}),e.jsx("p",{className:"text-slate-300 mb-4",children:"Thank you for participating!"}),V(),e.jsx("div",{className:"mt-6",children:e.jsx(X,{onClick:()=>f("/"),className:"bg-indigo-600 hover:bg-indigo-700",children:"Back to Home"})})]})]});if(c.length===0)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-gray-600",children:"No questions available for this quiz."})})});const q=c[C],S=(C+1)/c.length*100;return e.jsxs("div",{className:"min-h-screen p-4 bg-[radial-gradient(1000px_600px_at_50%_-100px,rgba(59,130,246,0.25),transparent),radial-gradient(800px_500px_at_120%_0,rgba(168,85,247,0.18),transparent)]",children:[e.jsx(H,{title:`${t.title||"Quiz"} â€“ Play | Quiz Dangal`,description:"Answer questions and compete to win.",canonical:typeof window!="undefined"?`${window.location.origin}/quiz/${d}`:"https://quizdangal.com/quiz",robots:"noindex, nofollow"}),e.jsxs("div",{className:"max-w-2xl mx-auto",children:[e.jsxs(k.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"rounded-2xl p-4 mb-6 text-slate-100 border border-slate-800/60 bg-slate-900/60 backdrop-blur-md shadow-[0_10px_30px_rgba(0,0,0,0.35)]",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-extrabold text-white tracking-tight",children:t.title}),e.jsxs("p",{className:"text-xs text-slate-400",children:["Question ",C+1," of ",c.length]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-black text-rose-300 tabular-nums",children:U(P)}),e.jsx("div",{className:"text-[10px] text-slate-400 uppercase tracking-wide",children:"Time Left"})]})]}),e.jsx("div",{className:"w-full bg-slate-800/60 rounded-full h-2 mt-4 overflow-hidden",children:e.jsx(k.div,{className:"h-2 rounded-full bg-[linear-gradient(90deg,#22d3ee,#818cf8,#a78bfa,#f472b6)]",style:{width:`${S}%`},transition:{duration:.5}})})]}),e.jsx(pe,{mode:"wait",children:e.jsxs(k.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},exit:{opacity:0,y:-16},transition:{duration:.25},className:"rounded-2xl p-6 text-slate-100 border border-slate-800/60 bg-slate-900/60 backdrop-blur-md shadow-[0_10px_30px_rgba(0,0,0,0.35)]",children:[e.jsx("h2",{className:"text-xl font-bold text-center text-white mb-6 leading-relaxed",children:q.question_text}),e.jsx("div",{className:"space-y-3",children:(w=q.options)==null?void 0:w.map((u,l)=>{const g=M[q.id]===u.id;return e.jsxs(k.button,{onClick:()=>p(q.id,u.id),disabled:z||o!=="active"||J==="completed",whileHover:{scale:1.01},whileTap:{scale:.99},className:`w-full p-4 rounded-xl text-left font-medium transition-all duration-200 border group relative overflow-hidden ${g?"bg-emerald-600/90 text-white border-emerald-400 shadow-[0_10px_24px_rgba(16,185,129,0.25)]":"bg-slate-800/70 hover:bg-slate-800 text-slate-100 border-slate-700/80"}`,children:[e.jsxs("span",{className:`font-bold mr-3 ${g?"text-white":"text-indigo-300"}`,children:[String.fromCharCode(65+l),"."]}),u.option_text,!g&&e.jsx("span",{className:"absolute inset-y-0 right-0 w-0 group-hover:w-1/6 transition-[width] duration-200 bg-gradient-to-l from-indigo-500/20 to-transparent"})]},u.id)})}),C===c.length-1&&Object.keys(M).length===c.length&&e.jsx(k.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},transition:{delay:.25},className:"mt-7",children:e.jsx(X,{onClick:v,disabled:z,className:"w-full text-white font-extrabold py-4 text-lg border border-violet-500/40 shadow-[0_8px_18px_rgba(139,92,246,0.35)] hover:shadow-[0_12px_24px_rgba(139,92,246,0.55)] bg-[linear-gradient(90deg,#4f46e5,#7c3aed,#9333ea,#c026d3)]",children:z?e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"mr-2 h-6 w-6 animate-spin"}),"Submitting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{className:"mr-2 h-6 w-6"}),"Submit Quiz"]})})})]},q.id)})]})]})};export{Se as default};
