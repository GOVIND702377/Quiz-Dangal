import{j as e,i as me,u as H,s as m,h as pe,B as j,p as Y}from"./index-3223cf34.js";import{a as y,r as C}from"./react-8a702e3e.js";import{I as E}from"./input-1b549f88.js";import{L as Q}from"./label-cc46d542.js";import{d as ue,L as he}from"./router-f2cf3f51.js";import{V as X,Y as fe,L as P,j as ge,s as je,Z as ve,_ as be}from"./icons-6fbf3e44.js";import{AnimatePresence as se,m as V}from"./motion-f69b6c08.js";import"./supabase-4c1332f7.js";const K=y.forwardRef(({className:o,...f},S)=>e.jsx("textarea",{ref:S,className:me("flex w-full rounded-md border border-input bg-background px-3 py-2 text-base sm:text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 min-h-[80px] resize-vertical",o),...f}));K.displayName="Textarea";const we=["opinion","general","sports","movies"],F=()=>({text:"",options:["","",""],correctIndex:0});function Z(o,f,{fallback:S=0}={}){return f==null&&(f=S),o==="coins"?`${f} coins`:o==="others"?`${f}`:`₹${f}`}function Ne(o,{allowZeroCorrect:f=!1}={}){var v,_;const S=String(o||"").trim().split(/\n\s*\n+/),b=[],T=[],D=[];let k=0;for(const A of S){const R=A.split(/\r?\n/).map(a=>a.trim()).filter(Boolean);if(!R.length)continue;k+=1;const d=R[0].replace(/^Q\d*\.?\s*/i,"").replace(/^Question\s*[:-]\s*/i,""),p=[];let w="";for(let a=1;a<R.length;a++){const n=R[a];if(/^ans(wer)?\s*[:-]/i.test(n)){w=n;continue}const g=n.match(/^[-*•]?\s*\[(x|X| )\]\s*(.+)$/);if(g){p.push({option_text:g[2].trim(),is_correct:/x/i.test(g[1])});continue}const i=n.match(/^(?:[-*•]|[A-Da-d]\)|\d+\)|[A-Da-d][.:])\s*(.+)$/),r=i?i[1].trim():n.replace(/^[*]\s*/,"").trim();r&&p.push({option_text:r,is_correct:/^\*/.test(n)})}if(w){const a=w.split(/[:-]/).slice(1).join(":").trim(),n=(_=(v=a.match(/^[A-D]/i))==null?void 0:v[0])==null?void 0:_.toUpperCase(),g=n?{A:0,B:1,C:2,D:3}[n]:NaN,i=parseInt(a,10);if(!Number.isNaN(g)&&p[g])p.forEach((r,z)=>r.is_correct=z===g);else if(!Number.isNaN(i)&&p[i-1])p.forEach((r,z)=>r.is_correct=z===i-1);else{const r=a.toLowerCase(),z=p.findIndex(I=>I.option_text.toLowerCase()===r||I.option_text.toLowerCase().includes(r));z>=0&&p.forEach((I,B)=>I.is_correct=B===z)}}let h=p.filter(a=>a.option_text);if(h.length>4){const a=h.findIndex(n=>n.is_correct);if(a>=0){const n=h[a],g=h.filter((i,r)=>r!==a);h=[n,...g.slice(0,3)]}else h=h.slice(0,4);D.push(`Q${k}: Trimmed to 4 options.`)}if(!d){T.push(`Q${k}: Missing question text.`);continue}if(h.length<2){T.push(`Q${k}: Need at least 2 options.`);continue}if(f)h=h.map(a=>({...a,is_correct:!1}));else{const a=h.filter(n=>n.is_correct).length;if(a===0)h[0].is_correct=!0;else if(a>1){let n=!1;h=h.map(g=>g.is_correct&&!n?(n=!0,g):{...g,is_correct:!1})}}b.push({question_text:d,options:h})}return{items:b,errors:T,warnings:D}}function $e(){const{toast:o}=H(),[f,S]=ue(),b=f.get("tab")||"overview",T=t=>{f.set("tab",t),S(f,{replace:!0})},[D,k]=C.useState([]),[v,_]=C.useState(!1),[A,R]=C.useState(!1),[d,p]=C.useState({title:"",category:"",start_time:"",end_time:"",prizes:["","",""],prize_type:"money",bulk:""}),[w,h]=C.useState("form"),[a,n]=C.useState([F()]),[g,i]=C.useState(null),[r,z]=C.useState([]),[I,B]=C.useState(null),[ie,ae]=C.useState(!1),q=d.category==="opinion",O=C.useCallback(async()=>{if(_(!0),!m){k([]);return}const{data:t,error:s}=await m.from("quizzes").select("id,title,category,prizes,prize_pool,prize_type,start_time,end_time").order("start_time",{ascending:!1});s?o({title:"Fetch failed",description:s.message,variant:"destructive"}):k(t||[]),_(!1)},[o]),re=C.useCallback(async t=>{if(!m){z([]);return}const{data:s,error:x}=await m.from("questions").select("id,question_text,options(id,option_text,is_correct)").eq("quiz_id",t);x?o({title:"Questions failed",description:x.message,variant:"destructive"}):z(s||[])},[o]);C.useEffect(()=>{O()},[O]);const ne=async t=>{t.preventDefault();try{const s=[];d.category||s.push("Select category"),d.title.trim()||s.push("Title required"),(!d.start_time||!d.end_time)&&s.push("Start & End time required");const x=new Date(d.start_time);new Date(d.end_time)<=x&&s.push("End after start");const l=parseInt(d.prizes[0]||"",10);if((Number.isNaN(l)||l<=0)&&s.push("1st prize invalid"),s.length){o({title:"Fix form",description:s[0],variant:"destructive"});return}const u=a.map($=>{const M=($.options||[]).map(J=>J.trim()).filter(Boolean).slice(0,4);if(!$.text.trim()||M.length<2)return null;const de=Math.min(Math.max($.correctIndex||0,0),M.length-1);return{question_text:$.text.trim(),options:M.map((J,xe)=>({option_text:J,is_correct:q?!1:xe===de}))}}).filter(Boolean);if(!u.length){o({title:"Add questions",variant:"destructive"});return}const N=d.prizes.filter($=>$).map($=>parseInt($,10)),L=N.reduce(($,M)=>$+M,0),U={title:d.title.trim(),category:d.category,start_time:new Date(d.start_time).toISOString(),end_time:new Date(d.end_time).toISOString(),prizes:N,prize_pool:L,prize_type:d.prize_type};if(!m)throw new Error("Supabase config missing");const{data:W,error:ee}=await m.from("quizzes").insert([U]).select().single();if(ee)throw ee;o({title:"Quiz created",description:W.title});const te=await le(W.id,u,"replace");te.ok?o({title:"Questions added",description:`${u.length} questions`}):o({title:"Question insert fallback",description:te.message||"Failed",variant:"destructive"}),R(!1),p({title:"",category:"",start_time:"",end_time:"",prizes:["","",""],prize_type:"money",bulk:""}),n([F()]),O()}catch(s){o({title:"Create failed",description:s.message,variant:"destructive"})}},le=async(t,s,x="append")=>{try{if(!m)throw new Error("No Supabase client");const{error:c}=await m.rpc("admin_bulk_upsert_questions",{p_quiz_id:t,p_payload:s,p_mode:x});if(!c)return{ok:!0}}catch(c){}if(!m)return{ok:!1,message:"No Supabase client"};x==="replace"&&await m.from("questions").delete().eq("quiz_id",t);for(const c of s){const{data:l,error:u}=await m.from("questions").insert({quiz_id:t,question_text:c.question_text}).select("id").single();if(u)return{ok:!1,message:u.message};const N=c.options.map(U=>({question_id:l.id,option_text:U.option_text,is_correct:!!U.is_correct})),{error:L}=await m.from("options").insert(N);if(L)return{ok:!1,message:L.message}}return{ok:!0}},ce=async t=>{if(!window.confirm("Delete this quiz?")||!m)return;const{error:s}=await m.from("quizzes").delete().eq("id",t);s?o({title:"Delete failed",description:s.message,variant:"destructive"}):(o({title:"Deleted"}),O())},oe=async t=>{if(m)try{B(t);const{error:s}=await m.rpc("admin_recompute_quiz_results",{p_quiz_id:t});if(s)throw s;o({title:"Recomputed"})}catch(s){o({title:"Recompute failed",description:s.message,variant:"destructive"})}finally{B(null)}},G=C.useMemo(()=>{const t=Date.now(),s=[],x=[];for(const c of D){const l=c.end_time?new Date(c.end_time).getTime():null;l!==null&&t>l?x.push(c):s.push(c)}return{active:s,finished:x}},[D]);return e.jsxs("div",{className:"container mx-auto p-6 max-w-5xl text-slate-200",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6 text-slate-100",children:"Admin Dashboard"}),!pe&&e.jsx("div",{className:"mb-6 text-sm text-amber-400",children:"Supabase env keys missing. Read-only UI only."}),e.jsx("div",{className:"flex gap-2 mb-6 flex-wrap",children:["overview","notifications","redemptions"].map(t=>e.jsx("button",{onClick:()=>T(t),className:`px-3 py-1.5 rounded border text-sm ${t===b?"bg-indigo-600 text-white border-indigo-600":"bg-slate-800/40 text-slate-300 border-slate-700 hover:text-white"}`,children:t},t))}),b==="overview"&&e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{children:e.jsxs(j,{onClick:()=>R(!0),className:"bg-indigo-600 hover:bg-indigo-700 text-white",children:[e.jsx(X,{className:"w-4 h-4 mr-1"}),"New Quiz"]})}),e.jsx(se,{children:A&&e.jsxs(V.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},className:"bg-slate-800/40 border border-slate-700 rounded-xl p-5",children:[e.jsx("h2",{className:"font-semibold text-lg mb-4",children:"Create Quiz"}),e.jsxs("form",{onSubmit:ne,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Q,{className:"mb-1 block",children:"Category"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:we.map(t=>e.jsx("button",{type:"button",onClick:()=>p(s=>({...s,category:t})),className:`px-3 py-1 rounded-full text-xs border ${d.category===t?"bg-indigo-600 text-white border-indigo-600":"border-slate-600 text-slate-300 hover:text-white"}`,children:t},t))})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(Q,{children:"Title"}),e.jsx(E,{value:d.title,onChange:t=>p(s=>({...s,title:t.target.value})),placeholder:"Daily Quiz",required:!0})]}),e.jsxs("div",{children:[e.jsx(Q,{children:"Prize Type"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["money","coins","others"].map(t=>e.jsx("button",{type:"button",onClick:()=>p(s=>({...s,prize_type:t})),className:`px-2 py-1 rounded text-xs border ${d.prize_type===t?"bg-indigo-600 text-white border-indigo-600":"border-slate-600 text-slate-300 hover:text-white"}`,children:t},t))})]})]}),e.jsx("div",{className:"grid md:grid-cols-3 gap-2",children:d.prizes.map((t,s)=>e.jsx(E,{value:t,placeholder:`${s+1}${["st","nd","rd"][s]||"th"} Prize`,onChange:x=>p(c=>{const l=[...c.prizes];return l[s]=x.target.value,{...c,prizes:l}})},s))}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(Q,{children:"Start Time"}),e.jsx(E,{type:"datetime-local",value:d.start_time,onChange:t=>p(s=>({...s,start_time:t.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(Q,{children:"End Time"}),e.jsx(E,{type:"datetime-local",value:d.end_time,onChange:t=>p(s=>({...s,end_time:t.target.value})),required:!0})]})]}),e.jsxs("div",{children:[e.jsx(Q,{children:"Questions Mode"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["form","paste"].map(t=>e.jsx("button",{type:"button",onClick:()=>h(t),className:`px-3 py-1 rounded text-xs border ${w===t?"bg-indigo-600 text-white border-indigo-600":"border-slate-600 text-slate-300 hover:text-white"}`,children:t},t))})]}),w==="form"?e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-xs text-slate-400",children:q?"Opinion: no correct option stored.":"Mark one correct option with radio."}),a.map((t,s)=>e.jsxs("div",{className:"border border-slate-600 rounded p-3 space-y-2",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("span",{className:"text-xs text-slate-400 w-6",children:["Q",s+1]}),e.jsx(E,{value:t.text,onChange:x=>n(c=>{const l=[...c];return l[s]={...l[s],text:x.target.value},l}),placeholder:"Question text",className:"flex-1"}),e.jsx(j,{type:"button",variant:"outline",size:"sm",className:"border-red-300 text-red-500",onClick:()=>n(x=>x.length===1?[F()]:x.filter((c,l)=>l!==s)),children:"Del"})]}),(t.options||[]).slice(0,4).map((x,c)=>e.jsxs("div",{className:"flex items-center gap-2",children:[!q&&e.jsx("input",{type:"radio",name:`q-${s}`,checked:(t.correctIndex||0)===c,onChange:()=>n(l=>{const u=[...l];return u[s]={...u[s],correctIndex:c},u})}),e.jsx(E,{value:x,onChange:l=>n(u=>{const N=[...u],L=[...N[s].options];return L[c]=l.target.value,N[s]={...N[s],options:L},N}),placeholder:`Option ${c+1}`,className:"flex-1"}),(t.options||[]).length>2&&e.jsx(j,{type:"button",size:"sm",variant:"outline",className:"border-red-300 text-red-500",onClick:()=>n(l=>{const u=[...l],N=[...u[s].options];return N.splice(c,1),u[s]={...u[s],options:N},u}),children:"X"})]},c)),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs(j,{type:"button",size:"sm",disabled:(t.options||[]).length>=4,onClick:()=>n(x=>{const c=[...x],l=[...c[s].options];return l.length<4&&l.push(""),c[s]={...c[s],options:l},c}),children:[e.jsx(X,{className:"w-4 h-4 mr-1"}),"Option"]}),e.jsx("span",{className:"text-xs text-slate-500",children:"Max 4 options"})]})]},s)),e.jsxs(j,{type:"button",onClick:()=>n(t=>[...t,F()]),children:[e.jsx(X,{className:"w-4 h-4 mr-1"}),"Question"]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Paste Questions"}),e.jsx(K,{className:"h-40",value:d.bulk,onChange:t=>p(s=>({...s,bulk:t.target.value})),placeholder:`Q1. Capital of India?
- [ ] Mumbai
- [x] Delhi
- [ ] Kolkata
- [ ] Jaipur

Q2. ...`}),(()=>{const{items:t,errors:s,warnings:x}=Ne(d.bulk,{allowZeroCorrect:q});return e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsxs("div",{children:[t.length," parsed"]}),x[0]&&e.jsx("div",{className:"text-amber-500",children:x[0]}),s[0]&&e.jsx("div",{className:"text-red-500",children:s[0]}),e.jsx(j,{type:"button",size:"sm",disabled:!!s.length||!t.length,onClick:()=>{if(s.length||!t.length)return;const c=t.map(l=>({text:l.question_text,options:l.options.map(u=>u.option_text),correctIndex:q?0:l.options.findIndex(u=>u.is_correct)>=0?l.options.findIndex(u=>u.is_correct):0}));n(c.length?c:[F()]),h("form"),o({title:"Loaded",description:`${c.length} questions moved to form.`})},children:"Load into form"})]})})()]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(j,{type:"submit",className:"bg-green-600 hover:bg-green-700",children:"Create"}),e.jsx(j,{type:"button",variant:"outline",onClick:()=>R(!1),children:"Cancel"})]})]})]})}),e.jsxs("section",{children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2 mb-3",children:[e.jsx(fe,{className:"w-5 h-5"}),"All Quizzes"]}),v?e.jsxs("div",{className:"py-8 text-center text-slate-400",children:[e.jsx(P,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading..."]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Active / Upcoming"}),e.jsx("div",{className:"space-y-4",children:G.active.map(t=>{const s=t.prize_type||"money",x=Z(s,t.prize_pool,{fallback:0}),c=Array.isArray(t.prizes)?t.prizes.map(l=>Z(s,l,{fallback:0})).join(", "):"";return e.jsxs(V.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"border border-slate-700 rounded-xl p-4 bg-slate-800/30",children:[e.jsxs("div",{className:"flex justify-between gap-4 flex-wrap",children:[e.jsxs("div",{className:"flex-1 min-w-[240px]",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-xs text-slate-400 flex flex-wrap gap-3 mt-1",children:[e.jsxs("span",{children:["Category: ",t.category||"—"]}),e.jsxs("span",{children:["Type: ",s]}),e.jsxs("span",{children:["Pool: ",x]}),e.jsxs("span",{children:["Prizes: ",c]})]}),e.jsxs("div",{className:"text-xs text-slate-500 mt-1",children:[e.jsxs("span",{children:["Start: ",t.start_time?Y(t.start_time):"—"]}),e.jsxs("span",{className:"ml-4",children:["End: ",t.end_time?Y(t.end_time):"—"]})]})]}),e.jsxs("div",{className:"flex gap-2 items-start",children:[e.jsx(j,{size:"sm",variant:"outline",onClick:()=>oe(t.id),disabled:I===t.id,children:I===t.id?e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"w-4 h-4 mr-1 animate-spin"}),"..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ge,{className:"w-4 h-4 mr-1"}),"Recompute"]})}),e.jsxs(he,{to:`/results/${t.id}`,className:"inline-flex items-center gap-1 px-3 py-1.5 text-sm rounded-md border border-slate-600 hover:bg-slate-700 text-blue-400",children:[e.jsx(je,{className:"w-4 h-4"}),"Results"]}),e.jsxs(j,{size:"sm",variant:"outline",onClick:()=>{i(t),re(t.id),ae(!0)},className:"text-blue-400",children:[e.jsx(ve,{className:"w-4 h-4 mr-1"}),"Questions"]}),e.jsx(j,{size:"sm",variant:"outline",onClick:()=>ce(t.id),className:"text-red-500",children:e.jsx(be,{className:"w-4 h-4"})})]})]}),e.jsx(se,{children:ie&&(g==null?void 0:g.id)===t.id&&e.jsxs(V.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"mt-4 space-y-2",children:[e.jsxs("h5",{className:"font-medium flex items-center gap-2",children:["Questions for ",t.title]}),r.length===0&&e.jsx("div",{className:"text-xs text-slate-400",children:"No questions."}),r.map((l,u)=>e.jsxs("div",{className:"border border-slate-600 rounded p-3",children:[e.jsxs("div",{className:"text-sm font-medium",children:["Q",u+1,": ",l.question_text]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:(l.options||[]).map(N=>e.jsxs("div",{className:`px-2 py-0.5 text-xs rounded-full ${N.is_correct?"bg-green-600 text-white":"bg-slate-700 text-slate-300"}`,children:[N.option_text,N.is_correct&&e.jsx("span",{className:"ml-1",children:"✓"})]},N.id))})]},l.id))]})})]},t.id)})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Finished"}),e.jsx("div",{className:"space-y-4",children:G.finished.map(t=>{const s=t.prize_type||"money",x=Z(s,t.prize_pool,{fallback:0}),c=Array.isArray(t.prizes)?t.prizes.map(l=>Z(s,l,{fallback:0})).join(", "):"";return e.jsxs(V.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"border border-slate-700 rounded-xl p-4 bg-slate-800/30",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-xs text-slate-400 flex flex-wrap gap-3 mt-1",children:[e.jsxs("span",{children:["Category: ",t.category||"—"]}),e.jsxs("span",{children:["Type: ",s]}),e.jsxs("span",{children:["Pool: ",x]}),e.jsxs("span",{children:["Prizes: ",c]})]})]},t.id)})})]})]})]})]}),b==="notifications"&&e.jsx(_e,{}),b==="redemptions"&&e.jsx(ye,{})]})}function ye(){const{toast:o}=H(),[f,S]=y.useState([]),[b,T]=y.useState(!1),[D,k]=y.useState(!1),[v,_]=y.useState({reward_type:"coins",reward_value:"",coins_required:"",is_active:!0}),[A,R]=y.useState(!1),[d,p]=y.useState(null),w=y.useCallback(async()=>{if(!m)return;T(!0);const{data:i,error:r}=await m.from("reward_catalog").select("id,reward_type,reward_value,coins_required,is_active").order("id",{ascending:!1}).limit(200);r?o({title:"Rewards load failed",description:r.message,variant:"destructive"}):S(i||[]),T(!1)},[o]);y.useEffect(()=>{w()},[w]);const h=()=>_({reward_type:"coins",reward_value:"",coins_required:"",is_active:!0}),a=async i=>{if(i.preventDefault(),!!m){R(!0);try{const r={reward_type:String(v.reward_type||"").trim()||"other",reward_value:String(v.reward_value||"").trim(),coins_required:v.coins_required!==""&&v.coins_required!==null?parseInt(v.coins_required,10):null,is_active:!!v.is_active};if(!r.reward_value)throw new Error("Value required");if(r.coins_required===null||Number.isNaN(r.coins_required))throw new Error("Coins required");let z;if(d?z=await m.from("reward_catalog").update(r).eq("id",d).select().single():z=await m.from("reward_catalog").insert([r]).select().single(),z.error)throw z.error;o({title:d?"Reward updated":"Reward created"}),h(),k(!1),p(null),w()}catch(r){o({title:"Save failed",description:r.message,variant:"destructive"})}finally{R(!1)}}},n=async i=>{if(!m)return;const{error:r}=await m.from("reward_catalog").update({is_active:!i.is_active}).eq("id",i.id);r?o({title:"Toggle failed",description:r.message,variant:"destructive"}):(o({title:i.is_active?"Deactivated":"Activated"}),w())},g=i=>{var r;p(i.id),k(!0),_({reward_type:i.reward_type||"coins",reward_value:i.reward_value||"",coins_required:((r=i.coins_required)!=null?r:"").toString(),is_active:!!i.is_active})};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-xs text-slate-500",children:"Redemptions auto-approved hain. Neeche sirf Rewards Catalog manage karna hai."}),e.jsxs("div",{className:"pt-10 border-t border-slate-700 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Rewards Catalog"}),e.jsx(j,{size:"sm",onClick:()=>{k(i=>!i),D||(h(),p(null))},children:D?"Close":"New Reward"}),e.jsx(j,{size:"sm",variant:"outline",onClick:w,disabled:b,children:b?e.jsx(P,{className:"w-4 h-4 animate-spin"}):"Refresh"})]}),D&&e.jsxs("form",{onSubmit:a,className:"space-y-3 bg-slate-800/40 border border-slate-700 rounded-lg p-4 max-w-3xl",children:[e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(Q,{children:"Type"}),e.jsx("div",{className:"flex gap-2 flex-wrap mt-1",children:["coins","cash","voucher","other"].map(i=>e.jsx("button",{type:"button",onClick:()=>_(r=>({...r,reward_type:i})),className:`px-2 py-1 rounded text-xs border ${v.reward_type===i?"bg-indigo-600 text-white border-indigo-600":"border-slate-600 text-slate-300 hover:text-white"}`,children:i},i))})]}),e.jsxs("div",{children:[e.jsx(Q,{children:"Value"}),e.jsx(E,{value:v.reward_value,onChange:i=>_(r=>({...r,reward_value:i.target.value})),placeholder:"e.g. 100 / AMAZON100 / ₹100"})]}),e.jsxs("div",{children:[e.jsx(Q,{children:"Coins Required"}),e.jsx(E,{type:"number",value:v.coins_required,onChange:i=>_(r=>({...r,coins_required:i.target.value})),placeholder:"coins needed"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"is_active",type:"checkbox",checked:!!v.is_active,onChange:i=>_(r=>({...r,is_active:i.target.checked}))}),e.jsx("label",{htmlFor:"is_active",className:"text-sm",children:"Active"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{type:"submit",disabled:A,children:A?e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"w-4 h-4 mr-1 animate-spin"}),"Saving"]}):d?"Update":"Create"}),e.jsx(j,{type:"button",variant:"outline",onClick:()=>{h(),p(null)},children:d?"Cancel Edit":"Reset"})]})]}),e.jsx("div",{className:"overflow-x-auto rounded-lg border border-slate-700",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-slate-800/60 text-slate-300",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Type"}),e.jsx("th",{className:"p-2 text-left",children:"Value"}),e.jsx("th",{className:"p-2 text-left",children:"Coins Required"}),e.jsx("th",{className:"p-2 text-left",children:"Active"}),e.jsx("th",{className:"p-2 text-left",children:"Actions"})]})}),e.jsxs("tbody",{children:[f.map(i=>{var r;return e.jsxs("tr",{className:"border-t border-slate-700 hover:bg-slate-800/40",children:[e.jsx("td",{className:"p-2 capitalize",children:i.reward_type}),e.jsx("td",{className:"p-2 max-w-[260px] truncate",title:i.reward_value,children:i.reward_value}),e.jsx("td",{className:"p-2",children:(r=i.coins_required)!=null?r:"—"}),e.jsx("td",{className:"p-2",children:i.is_active?e.jsx("span",{className:"text-green-500",children:"Yes"}):e.jsx("span",{className:"text-slate-500",children:"No"})}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(j,{size:"sm",variant:"outline",onClick:()=>g(i),children:"Edit"}),e.jsx(j,{size:"sm",variant:"outline",onClick:()=>n(i),children:i.is_active?"Deactivate":"Activate"})]})})]},i.id)}),!f.length&&!b&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"p-4 text-center text-slate-500",children:"No rewards."})}),b&&e.jsx("tr",{children:e.jsxs("td",{colSpan:8,className:"p-6 text-center text-slate-500",children:[e.jsx(P,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading rewards..."]})})]})]})}),e.jsx("p",{className:"text-xs text-slate-500",children:"Catalog: inactive rewards are hidden from users."})]})]})}function _e(){const{toast:o}=H(),[f,S]=y.useState(""),[b,T]=y.useState(""),[D,k]=y.useState("all"),[v,_]=y.useState(!1),[A,R]=y.useState([]),[d,p]=y.useState(!1),w=y.useCallback(async()=>{if(!m)return;p(!0);const{data:a,error:n}=await m.from("notifications").select("id,title,message,type,segment,created_at").order("created_at",{ascending:!1}).limit(100);n?o({title:"Fetch failed",description:n.message,variant:"destructive"}):R(a||[]),p(!1)},[o]);y.useEffect(()=>{w()},[w]);const h=async a=>{if(a.preventDefault(),!f.trim()||!b.trim()){o({title:"Missing fields",variant:"destructive"});return}if(!m){o({title:"No backend client",variant:"destructive"});return}_(!0);try{const{data:{session:n}}=await m.auth.getSession(),g=n==null?void 0:n.access_token,i=await fetch("/functions/v1/send-notifications",{method:"POST",headers:{"Content-Type":"application/json",...g?{Authorization:`Bearer ${g}`}:{}},body:JSON.stringify({title:f.trim(),message:b.trim(),segment:D})});if(!i.ok){const r=await i.text();throw new Error(r||`HTTP ${i.status}`)}o({title:"Sent",description:f.trim()}),S(""),T(""),w()}catch(n){o({title:"Send failed",description:n.message,variant:"destructive"})}finally{_(!1)}};return e.jsxs("div",{className:"space-y-8 max-w-3xl",children:[e.jsxs("form",{onSubmit:h,className:"space-y-4 bg-slate-800/40 border border-slate-700 rounded-xl p-5",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Send Notification"}),e.jsxs("div",{children:[e.jsx(Q,{children:"Title"}),e.jsx(E,{value:f,onChange:a=>S(a.target.value),maxLength:80,placeholder:"Short title"}),e.jsxs("div",{className:"text-[10px] text-slate-500 mt-1",children:["Max 80 chars • ",f.length,"/80"]})]}),e.jsxs("div",{children:[e.jsx(Q,{children:"Message"}),e.jsx(K,{value:b,onChange:a=>T(a.target.value),className:"h-28",maxLength:280,placeholder:"Body shown in push notification"}),e.jsxs("div",{className:"text-[10px] text-slate-500 mt-1",children:["Max 280 chars • ",b.length,"/280"]})]}),e.jsxs("div",{children:[e.jsx(Q,{children:"Segment"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["all"].map(a=>e.jsx("button",{type:"button",onClick:()=>k(a),className:`px-3 py-1 rounded text-xs border ${D===a?"bg-indigo-600 text-white border-indigo-600":"border-slate-600 text-slate-300 hover:text-white"}`,children:a},a))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{type:"submit",disabled:v,children:v?e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"w-4 h-4 mr-1 animate-spin"}),"Sending"]}):"Send"}),e.jsx(j,{type:"button",variant:"outline",onClick:()=>{S(""),T("")},children:"Reset"})]})]}),e.jsxs("section",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Recent Notifications"}),e.jsx(j,{size:"sm",variant:"outline",onClick:w,disabled:d,children:d?e.jsx(P,{className:"w-4 h-4 animate-spin"}):"Refresh"})]}),e.jsxs("div",{className:"space-y-3",children:[A.map(a=>e.jsxs("div",{className:"border border-slate-700 rounded-lg p-3 bg-slate-800/30",children:[e.jsxs("div",{className:"flex justify-between gap-4 flex-wrap",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:a.title}),e.jsx("div",{className:"text-xs text-slate-400 whitespace-pre-wrap max-w-xl break-words",children:a.message})]}),e.jsx("div",{className:"text-[10px] text-slate-500",children:Y(a.created_at)})]}),e.jsxs("div",{className:"text-[10px] text-slate-500 mt-1",children:["Segment: ",a.segment||"—",a.type?` • ${a.type}`:""]})]},a.id)),!A.length&&!d&&e.jsx("div",{className:"text-xs text-slate-500",children:"No notifications yet."})]})]})]})}export{$e as default};
