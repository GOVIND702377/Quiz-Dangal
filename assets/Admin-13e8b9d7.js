import{j as e,o as _e,u as K,a as ze,s as x,h as Se,B as g,A as ce,m as Y,L as A,I as D,p as H}from"./index-3385a59c.js";import{a as _,r as k}from"./react-8a702e3e.js";import{d as Ce,L as ke}from"./router-f2cf3f51.js";import{L as O,V as Z,Y as Ie,k as Ae,s as Ee,Z as Re,_ as Te}from"./icons-52d1b41a.js";import"./supabase-4c1332f7.js";const W=_.forwardRef(({className:l,...p},b)=>e.jsx("textarea",{ref:b,className:_e("flex w-full rounded-md border border-input bg-background px-3 py-2 text-base sm:text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 min-h-[80px] resize-vertical",l),...p}));W.displayName="Textarea";const de=[{value:"opinion",label:"Opinion"},{value:"gk",label:"General Knowledge"},{value:"sports",label:"Sports"},{value:"movies",label:"Movies"}],oe=l=>{var p;return((p=de.find(b=>b.value===l))==null?void 0:p.label)||l},B=()=>({text:"",options:["","",""],correctIndex:0});function J(l,p,{fallback:b=0}={}){return p==null&&(p=b),l==="coins"?`${p} coins`:l==="others"?`${p}`:`₹${p}`}function Le(l,{allowZeroCorrect:p=!1}={}){var y,S;const b=String(l||"").trim().split(/\n\s*\n+/),f=[],I=[],E=[];let z=0;for(const R of b){const T=R.split(/\r?\n/).map(i=>i.trim()).filter(Boolean);if(!T.length)continue;z+=1;const w=T[0].replace(/^Q\d*\.?\s*/i,"").replace(/^Question\s*[:-]\s*/i,""),j=[];let v="";for(let i=1;i<T.length;i++){const d=T[i];if(/^ans(wer)?\s*[:-]/i.test(d)){v=d;continue}const h=d.match(/^[-*•]?\s*\[(x|X| )\]\s*(.+)$/);if(h){j.push({option_text:h[2].trim(),is_correct:/x/i.test(h[1])});continue}const a=d.match(/^(?:[-*•]|[A-Da-d]\)|\d+\)|[A-Da-d][.:])\s*(.+)$/),r=a?a[1].trim():d.replace(/^[*]\s*/,"").trim();r&&j.push({option_text:r,is_correct:/^\*/.test(d)})}if(v){const i=v.split(/[:-]/).slice(1).join(":").trim(),d=(S=(y=i.match(/^[A-D]/i))==null?void 0:y[0])==null?void 0:S.toUpperCase(),h=d?{A:0,B:1,C:2,D:3}[d]:NaN,a=parseInt(i,10);if(!Number.isNaN(h)&&j[h])j.forEach((r,C)=>r.is_correct=C===h);else if(!Number.isNaN(a)&&j[a-1])j.forEach((r,C)=>r.is_correct=C===a-1);else{const r=i.toLowerCase(),C=j.findIndex(P=>P.option_text.toLowerCase()===r||P.option_text.toLowerCase().includes(r));C>=0&&j.forEach((P,V)=>P.is_correct=V===C)}}let n=j.filter(i=>i.option_text);if(n.length>4){const i=n.findIndex(d=>d.is_correct);if(i>=0){const d=n[i],h=n.filter((a,r)=>r!==i);n=[d,...h.slice(0,3)]}else n=n.slice(0,4);E.push(`Q${z}: Trimmed to 4 options.`)}if(!w){I.push(`Q${z}: Missing question text.`);continue}if(n.length<2){I.push(`Q${z}: Need at least 2 options.`);continue}if(p)n=n.map(i=>({...i,is_correct:!1}));else{const i=n.filter(d=>d.is_correct).length;if(i===0)n[0].is_correct=!0;else if(i>1){let d=!1;n=n.map(h=>h.is_correct&&!d?(d=!0,h):{...h,is_correct:!1})}}f.push({question_text:w,options:n})}return{items:f,errors:I,warnings:E}}function Be(){var ae;const{toast:l}=K(),{userProfile:p,loading:b,user:f}=ze(),[I,E]=Ce(),z=I.get("tab")||"overview",y=t=>{I.set("tab",t),E(I,{replace:!0})},[S,R]=k.useState([]),[T,w]=k.useState(!1),[j,v]=k.useState(!1),[n,i]=k.useState({title:"",category:"",start_time:"",end_time:"",prizes:["","",""],prize_type:"coins",bulk:""}),[d,h]=k.useState("form"),[a,r]=k.useState([B()]),[C,P]=k.useState(null),[V,X]=k.useState([]),[ee,te]=k.useState(null),[me,xe]=k.useState(!1),$=n.category==="opinion",pe=k.useMemo(()=>{try{const t=String({}.VITE_ADMIN_EMAILS||"").trim();return t?new Set(t.split(/[\s,]+/).map(s=>s.trim().toLowerCase()).filter(Boolean)):new Set}catch(t){return new Set}},[]),ue=String((p==null?void 0:p.role)||"").trim().toLowerCase(),se=String((f==null?void 0:f.email)||"").trim().toLowerCase(),he=String(((ae=f==null?void 0:f.app_metadata)==null?void 0:ae.role)||"").trim().toLowerCase(),Q=ue==="admin"||he==="admin"||se&&pe.has(se),F=k.useCallback(async()=>{if(!Q){w(!1),R([]);return}if(w(!0),!x){R([]),w(!1);return}const{data:t,error:s}=await x.from("quizzes").select("id,title,category,prizes,prize_pool,prize_type,start_time,end_time").order("start_time",{ascending:!1});s?l({title:"Fetch failed",description:s.message,variant:"destructive"}):R(t||[]),w(!1)},[l,Q]),ge=k.useCallback(async t=>{if(!Q){X([]);return}if(!x){X([]);return}const{data:s,error:m}=await x.from("questions").select("id,question_text,options(id,option_text,is_correct)").eq("quiz_id",t);m?l({title:"Questions failed",description:m.message,variant:"destructive"}):X(s||[])},[l,Q]);k.useEffect(()=>{b||F()},[F,b]);const fe=async t=>{t.preventDefault();try{if(!Q){l({title:"Access denied",description:"Only admins can create quizzes.",variant:"destructive"});return}const s=[];n.category||s.push("Select category"),n.title.trim()||s.push("Title required"),(!n.start_time||!n.end_time)&&s.push("Start & End time required");const m=new Date(n.start_time);new Date(n.end_time)<=m&&s.push("End after start");const c=parseInt(n.prizes[0]||"",10);if((Number.isNaN(c)||c<=0)&&s.push("1st prize invalid"),s.length){l({title:"Fix form",description:s[0],variant:"destructive"});return}const u=a.map(L=>{const q=(L.options||[]).map(G=>G.trim()).filter(Boolean).slice(0,4);if(!L.text.trim()||q.length<2)return null;const we=Math.min(Math.max(L.correctIndex||0,0),q.length-1);return{question_text:L.text.trim(),options:q.map((G,Ne)=>({option_text:G,is_correct:$?!1:Ne===we}))}}).filter(Boolean);if(!u.length){l({title:"Add questions",variant:"destructive"});return}const N=n.prizes.filter(L=>L).map(L=>parseInt(L,10)),M=N.reduce((L,q)=>L+q,0),U=n.prize_type==="money"&&M>0?"coins":n.prize_type,be={title:n.title.trim(),category:n.category,start_time:new Date(n.start_time).toISOString(),end_time:new Date(n.end_time).toISOString(),prizes:N,prize_pool:M,prize_type:U};if(!x)throw new Error("Supabase config missing");const{data:re,error:ne}=await x.from("quizzes").insert([be]).select().single();if(ne)throw ne;l({title:"Quiz created",description:re.title});const le=await je(re.id,u,"replace");le.ok?l({title:"Questions added",description:`${u.length} questions`}):l({title:"Question insert fallback",description:le.message||"Failed",variant:"destructive"}),v(!1),i({title:"",category:"",start_time:"",end_time:"",prizes:["","",""],prize_type:"coins",bulk:""}),r([B()]),F()}catch(s){l({title:"Create failed",description:s.message,variant:"destructive"})}},je=async(t,s,m="append")=>{if(!Q)return{ok:!1,message:"Admin access required"};try{if(!x)throw new Error("No Supabase client");const{error:o}=await x.rpc("admin_bulk_upsert_questions",{p_quiz_id:t,p_payload:s,p_mode:m});if(!o)return{ok:!0}}catch(o){}if(!x)return{ok:!1,message:"No Supabase client"};m==="replace"&&await x.from("questions").delete().eq("quiz_id",t);for(const o of s){const{data:c,error:u}=await x.from("questions").insert({quiz_id:t,question_text:o.question_text}).select("id").single();if(u)return{ok:!1,message:u.message};const N=o.options.map(U=>({question_id:c.id,option_text:U.option_text,is_correct:!!U.is_correct})),{error:M}=await x.from("options").insert(N);if(M)return{ok:!1,message:M.message}}return{ok:!0}},ye=async t=>{if(!window.confirm("Delete this quiz?"))return;if(!Q){l({title:"Access denied",description:"Only admins can delete quizzes.",variant:"destructive"});return}if(!x)return;const{error:s}=await x.from("quizzes").delete().eq("id",t);s?l({title:"Delete failed",description:s.message,variant:"destructive"}):(l({title:"Deleted"}),F())},ve=async t=>{if(!Q){l({title:"Access denied",description:"Only admins can recompute results.",variant:"destructive"});return}if(x)try{te(t);const{error:s}=await x.rpc("admin_recompute_quiz_results",{p_quiz_id:t});if(s)throw s;try{await x.rpc("compute_results_if_due",{p_quiz_id:t})}catch(m){try{}catch(o){}}l({title:"Recomputed"})}catch(s){l({title:"Recompute failed",description:s.message,variant:"destructive"})}finally{te(null)}},ie=k.useMemo(()=>{const t=Date.now(),s=[],m=[];for(const o of S){const c=o.end_time?new Date(o.end_time).getTime():null;c!==null&&t>c?m.push(o):s.push(o)}return{active:s,finished:m}},[S]);return b?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(O,{className:"w-8 h-8 text-indigo-600 animate-spin"})}):Q?e.jsxs("div",{className:"container mx-auto p-6 max-w-5xl bg-white text-gray-900 rounded-2xl shadow-sm",children:[e.jsx("h1",{className:"text-2xl font-bold mb-6 text-gray-900",children:"Admin Dashboard"}),!Se&&e.jsx("div",{className:"mb-6 text-sm text-amber-600",children:"Supabase env keys missing. Read-only UI only."}),e.jsx("div",{className:"flex gap-2 mb-6 flex-wrap",children:["overview","notifications","redemptions"].map(t=>e.jsx("button",{onClick:()=>y(t),className:`px-3 py-1.5 rounded border text-sm transition-colors ${t===z?"bg-indigo-600 text-white border-indigo-600":"bg-gray-100 text-gray-700 border-gray-200 hover:bg-gray-200"}`,children:t},t))}),z==="overview"&&e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{children:e.jsxs(g,{onClick:()=>v(!0),className:"bg-indigo-600 hover:bg-indigo-700 text-white",children:[e.jsx(Z,{className:"w-4 h-4 mr-1"}),"New Quiz"]})}),e.jsx(ce,{children:j&&e.jsxs(Y.div,{initial:{opacity:0,y:16},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},className:"bg-gray-50 border border-gray-200 rounded-xl p-5",children:[e.jsx("h2",{className:"font-semibold text-lg mb-4",children:"Create Quiz"}),e.jsxs("form",{onSubmit:fe,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(A,{className:"mb-1 block",children:"Category"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:de.map(({value:t,label:s})=>e.jsx("button",{type:"button",onClick:()=>i(m=>({...m,category:t})),className:`px-3 py-1 rounded-full text-xs border ${n.category===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:s},t))})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(A,{children:"Title"}),e.jsx(D,{value:n.title,onChange:t=>i(s=>({...s,title:t.target.value})),placeholder:"Daily Quiz",required:!0})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Prize Type"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["money","coins","others"].map(t=>e.jsx("button",{type:"button",onClick:()=>i(s=>({...s,prize_type:t})),className:`px-2 py-1 rounded text-xs border ${n.prize_type===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:t},t))})]})]}),e.jsx("div",{className:"grid md:grid-cols-3 gap-2",children:n.prizes.map((t,s)=>e.jsx(D,{value:t,placeholder:`${s+1}${["st","nd","rd"][s]||"th"} Prize`,onChange:m=>i(o=>{const c=[...o.prizes];return c[s]=m.target.value,{...o,prizes:c}})},s))}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(A,{children:"Start Time"}),e.jsx(D,{type:"datetime-local",value:n.start_time,onChange:t=>i(s=>({...s,start_time:t.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(A,{children:"End Time"}),e.jsx(D,{type:"datetime-local",value:n.end_time,onChange:t=>i(s=>({...s,end_time:t.target.value})),required:!0})]})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Questions Mode"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["form","paste"].map(t=>e.jsx("button",{type:"button",onClick:()=>h(t),className:`px-3 py-1 rounded text-xs border ${d===t?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:t},t))})]}),d==="form"?e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-xs text-gray-600",children:$?"Opinion: no correct option stored.":"Mark one correct option with radio."}),a.map((t,s)=>e.jsxs("div",{className:"border border-gray-200 rounded p-3 space-y-2 bg-white",children:[e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs("span",{className:"text-xs text-gray-500 w-6",children:["Q",s+1]}),e.jsx(D,{value:t.text,onChange:m=>r(o=>{const c=[...o];return c[s]={...c[s],text:m.target.value},c}),placeholder:"Question text",className:"flex-1"}),e.jsx(g,{type:"button",variant:"outline",size:"sm",className:"border-red-300 text-red-500",onClick:()=>r(m=>m.length===1?[B()]:m.filter((o,c)=>c!==s)),children:"Del"})]}),(t.options||[]).slice(0,4).map((m,o)=>e.jsxs("div",{className:"flex items-center gap-2",children:[!$&&e.jsx("input",{type:"radio",name:`q-${s}`,checked:(t.correctIndex||0)===o,onChange:()=>r(c=>{const u=[...c];return u[s]={...u[s],correctIndex:o},u})}),e.jsx(D,{value:m,onChange:c=>r(u=>{const N=[...u],M=[...N[s].options];return M[o]=c.target.value,N[s]={...N[s],options:M},N}),placeholder:`Option ${o+1}`,className:"flex-1"}),(t.options||[]).length>2&&e.jsx(g,{type:"button",size:"sm",variant:"outline",className:"border-red-300 text-red-500",onClick:()=>r(c=>{const u=[...c],N=[...u[s].options];return N.splice(o,1),u[s]={...u[s],options:N},u}),children:"X"})]},o)),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsxs(g,{type:"button",size:"sm",disabled:(t.options||[]).length>=4,onClick:()=>r(m=>{const o=[...m],c=[...o[s].options];return c.length<4&&c.push(""),o[s]={...o[s],options:c},o}),children:[e.jsx(Z,{className:"w-4 h-4 mr-1"}),"Option"]}),e.jsx("span",{className:"text-xs text-gray-500",children:"Max 4 options"})]})]},s)),e.jsxs(g,{type:"button",onClick:()=>r(t=>[...t,B()]),children:[e.jsx(Z,{className:"w-4 h-4 mr-1"}),"Question"]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(A,{children:"Paste Questions"}),e.jsx(W,{className:"h-40",value:n.bulk,onChange:t=>i(s=>({...s,bulk:t.target.value})),placeholder:`Q1. Capital of India?
- [ ] Mumbai
- [x] Delhi
- [ ] Kolkata
- [ ] Jaipur

Q2. ...`}),(()=>{const{items:t,errors:s,warnings:m}=Le(n.bulk,{allowZeroCorrect:$});return e.jsxs("div",{className:"text-xs space-y-1",children:[e.jsxs("div",{children:[t.length," parsed"]}),m[0]&&e.jsx("div",{className:"text-amber-500",children:m[0]}),s[0]&&e.jsx("div",{className:"text-red-500",children:s[0]}),e.jsx(g,{type:"button",size:"sm",disabled:!!s.length||!t.length,onClick:()=>{if(s.length||!t.length)return;const o=t.map(c=>({text:c.question_text,options:c.options.map(u=>u.option_text),correctIndex:$?0:c.options.findIndex(u=>u.is_correct)>=0?c.options.findIndex(u=>u.is_correct):0}));r(o.length?o:[B()]),h("form"),l({title:"Loaded",description:`${o.length} questions moved to form.`})},children:"Load into form"})]})})()]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(g,{type:"submit",className:"bg-green-600 hover:bg-green-700",children:"Create"}),e.jsx(g,{type:"button",variant:"outline",onClick:()=>v(!1),children:"Cancel"})]})]})]})}),e.jsxs("section",{children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center gap-2 mb-3",children:[e.jsx(Ie,{className:"w-5 h-5"}),"All Quizzes"]}),T?e.jsxs("div",{className:"py-8 text-center text-gray-500",children:[e.jsx(O,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading..."]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Active / Upcoming"}),e.jsx("div",{className:"space-y-4",children:ie.active.map(t=>{const s=t.prize_type||"money",m=J(s,t.prize_pool,{fallback:0}),o=Array.isArray(t.prizes)?t.prizes.map(c=>J(s,c,{fallback:0})).join(", "):"";return e.jsxs(Y.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"border border-gray-200 rounded-xl p-4 bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between gap-4 flex-wrap",children:[e.jsxs("div",{className:"flex-1 min-w-[240px]",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-xs text-gray-600 flex flex-wrap gap-3 mt-1",children:[e.jsxs("span",{children:["Category: ",oe(t.category)||"—"]}),e.jsxs("span",{children:["Type: ",s]}),e.jsxs("span",{children:["Pool: ",m]}),e.jsxs("span",{children:["Prizes: ",o]})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[e.jsxs("span",{children:["Start: ",t.start_time?H(t.start_time):"—"]}),e.jsxs("span",{className:"ml-4",children:["End: ",t.end_time?H(t.end_time):"—"]})]})]}),e.jsxs("div",{className:"flex gap-2 items-start",children:[e.jsx(g,{size:"sm",variant:"outline",onClick:()=>ve(t.id),disabled:ee===t.id,children:ee===t.id?e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"w-4 h-4 mr-1 animate-spin"}),"..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ae,{className:"w-4 h-4 mr-1"}),"Recompute"]})}),e.jsxs(ke,{to:`/results/${t.id}`,className:"inline-flex items-center gap-1 px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-100 text-indigo-600",children:[e.jsx(Ee,{className:"w-4 h-4"}),"Results"]}),e.jsxs(g,{size:"sm",variant:"outline",onClick:()=>{P(t),ge(t.id),xe(!0)},className:"text-blue-400",children:[e.jsx(Re,{className:"w-4 h-4 mr-1"}),"Questions"]}),e.jsx(g,{size:"sm",variant:"outline",onClick:()=>ye(t.id),className:"text-red-500",children:e.jsx(Te,{className:"w-4 h-4"})})]})]}),e.jsx(ce,{children:me&&(C==null?void 0:C.id)===t.id&&e.jsxs(Y.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"mt-4 space-y-2",children:[e.jsxs("h5",{className:"font-medium flex items-center gap-2",children:["Questions for ",t.title]}),V.length===0&&e.jsx("div",{className:"text-xs text-gray-500",children:"No questions."}),V.map((c,u)=>e.jsxs("div",{className:"border border-gray-200 rounded p-3 bg-white",children:[e.jsxs("div",{className:"text-sm font-medium",children:["Q",u+1,": ",c.question_text]}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:(c.options||[]).map(N=>e.jsxs("div",{className:`px-2 py-0.5 text-xs rounded-full ${N.is_correct?"bg-green-600 text-white":"bg-gray-200 text-gray-700"}`,children:[N.option_text,N.is_correct&&e.jsx("span",{className:"ml-1",children:"✓"})]},N.id))})]},c.id))]})})]},t.id)})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Finished"}),e.jsx("div",{className:"space-y-4",children:ie.finished.map(t=>{const s=t.prize_type||"money",m=J(s,t.prize_pool,{fallback:0}),o=Array.isArray(t.prizes)?t.prizes.map(c=>J(s,c,{fallback:0})).join(", "):"";return e.jsxs(Y.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},className:"border border-gray-200 rounded-xl p-4 bg-gray-50",children:[e.jsx("h4",{className:"font-semibold",children:t.title}),e.jsxs("div",{className:"text-xs text-gray-600 flex flex-wrap gap-3 mt-1",children:[e.jsxs("span",{children:["Category: ",oe(t.category)||"—"]}),e.jsxs("span",{children:["Type: ",s]}),e.jsxs("span",{children:["Pool: ",m]}),e.jsxs("span",{children:["Prizes: ",o]})]})]},t.id)})})]})]})]})]}),z==="notifications"&&e.jsx(De,{}),z==="redemptions"&&e.jsx(Qe,{})]}):e.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",children:e.jsxs("div",{className:"bg-white border border-gray-200 rounded-2xl p-6 max-w-md w-full text-center shadow-sm",children:[e.jsx("h2",{className:"text-xl font-semibold text-red-500 mb-2",children:"Admin access required"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx("span",{children:"Supabase "}),e.jsx("code",{children:"profiles"}),e.jsx("span",{children:" table mein aapke record ka "}),e.jsx("strong",{children:"role"}),e.jsx("span",{children:" field admin hona chahiye."})]}),e.jsxs("ul",{className:"text-left text-sm text-gray-600 mt-4 space-y-2 list-disc list-inside",children:[e.jsxs("li",{children:[e.jsx("span",{children:"Supabase dashboard"}),e.jsx("span",{"aria-hidden":"true",role:"presentation",className:"mx-1",children:"→"}),e.jsx("span",{children:"Table editor"}),e.jsx("span",{"aria-hidden":"true",role:"presentation",className:"mx-1",children:"→"}),e.jsx("code",{children:"profiles"}),e.jsx("span",{children:" me role update karein."})]}),e.jsx("li",{children:"Update ke baad login session refresh karein."}),e.jsxs("li",{children:["Dev bypass (",e.jsx("code",{children:"VITE_BYPASS_AUTH=1"}),") mein mock admin auto-enable hota hai."]})]})]})})}function Qe(){const{toast:l}=K(),[p,b]=_.useState([]),[f,I]=_.useState(!1),[E,z]=_.useState(!1),[y,S]=_.useState({reward_type:"coins",reward_value:"",coins_required:"",is_active:!0}),[R,T]=_.useState(!1),[w,j]=_.useState(null),v=_.useCallback(async()=>{if(!x)return;I(!0);const{data:a,error:r}=await x.from("reward_catalog").select("id,reward_type,reward_value,coins_required,is_active").order("id",{ascending:!1}).limit(200);r?l({title:"Rewards load failed",description:r.message,variant:"destructive"}):b(a||[]),I(!1)},[l]);_.useEffect(()=>{v()},[v]);const n=()=>S({reward_type:"coins",reward_value:"",coins_required:"",is_active:!0}),i=async a=>{if(a.preventDefault(),!!x){T(!0);try{const r={reward_type:String(y.reward_type||"").trim()||"other",reward_value:String(y.reward_value||"").trim(),coins_required:y.coins_required!==""&&y.coins_required!==null?parseInt(y.coins_required,10):null,is_active:!!y.is_active};if(!r.reward_value)throw new Error("Value required");if(r.coins_required===null||Number.isNaN(r.coins_required))throw new Error("Coins required");let C;if(w?C=await x.from("reward_catalog").update(r).eq("id",w).select().single():C=await x.from("reward_catalog").insert([r]).select().single(),C.error)throw C.error;l({title:w?"Reward updated":"Reward created"}),n(),z(!1),j(null),v()}catch(r){l({title:"Save failed",description:r.message,variant:"destructive"})}finally{T(!1)}}},d=async a=>{if(!x)return;const{error:r}=await x.from("reward_catalog").update({is_active:!a.is_active}).eq("id",a.id);r?l({title:"Toggle failed",description:r.message,variant:"destructive"}):(l({title:a.is_active?"Deactivated":"Activated"}),v())},h=a=>{var r;j(a.id),z(!0),S({reward_type:a.reward_type||"coins",reward_value:a.reward_value||"",coins_required:((r=a.coins_required)!=null?r:"").toString(),is_active:!!a.is_active})};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Redemptions auto-approved hain. Neeche sirf Rewards Catalog manage karna hai."}),e.jsxs("div",{className:"pt-10 border-t border-gray-200 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Rewards Catalog"}),e.jsx(g,{size:"sm",onClick:()=>{z(a=>!a),E||(n(),j(null))},children:E?"Close":"New Reward"}),e.jsx(g,{size:"sm",variant:"outline",onClick:v,disabled:f,children:f?e.jsx(O,{className:"w-4 h-4 animate-spin"}):"Refresh"})]}),E&&e.jsxs("form",{onSubmit:i,className:"space-y-3 bg-gray-50 border border-gray-200 rounded-lg p-4 max-w-3xl",children:[e.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(A,{children:"Type"}),e.jsx("div",{className:"flex gap-2 flex-wrap mt-1",children:["coins","cash","voucher","other"].map(a=>e.jsx("button",{type:"button",onClick:()=>S(r=>({...r,reward_type:a})),className:`px-2 py-1 rounded text-xs border ${y.reward_type===a?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:a},a))})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Value"}),e.jsx(D,{value:y.reward_value,onChange:a=>S(r=>({...r,reward_value:a.target.value})),placeholder:"e.g. 100 / AMAZON100 / ₹100"})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Coins Required"}),e.jsx(D,{type:"number",value:y.coins_required,onChange:a=>S(r=>({...r,coins_required:a.target.value})),placeholder:"coins needed"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"is_active",type:"checkbox",checked:!!y.is_active,onChange:a=>S(r=>({...r,is_active:a.target.checked}))}),e.jsx("label",{htmlFor:"is_active",className:"text-sm",children:"Active"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{type:"submit",disabled:R,children:R?e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"w-4 h-4 mr-1 animate-spin"}),"Saving"]}):w?"Update":"Create"}),e.jsx(g,{type:"button",variant:"outline",onClick:()=>{n(),j(null)},children:w?"Cancel Edit":"Reset"})]})]}),e.jsx("div",{className:"overflow-x-auto rounded-lg border border-gray-200",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-100 text-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-left",children:"Type"}),e.jsx("th",{className:"p-2 text-left",children:"Value"}),e.jsx("th",{className:"p-2 text-left",children:"Coins Required"}),e.jsx("th",{className:"p-2 text-left",children:"Active"}),e.jsx("th",{className:"p-2 text-left",children:"Actions"})]})}),e.jsxs("tbody",{children:[p.map(a=>{var r;return e.jsxs("tr",{className:"border-t border-gray-200 hover:bg-gray-100",children:[e.jsx("td",{className:"p-2 capitalize",children:a.reward_type}),e.jsx("td",{className:"p-2 max-w-[260px] truncate",title:a.reward_value,children:a.reward_value}),e.jsx("td",{className:"p-2",children:(r=a.coins_required)!=null?r:"—"}),e.jsx("td",{className:"p-2",children:a.is_active?e.jsx("span",{className:"text-green-500",children:"Yes"}):e.jsx("span",{className:"text-gray-500",children:"No"})}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsx(g,{size:"sm",variant:"outline",onClick:()=>h(a),children:"Edit"}),e.jsx(g,{size:"sm",variant:"outline",onClick:()=>d(a),children:a.is_active?"Deactivate":"Activate"})]})})]},a.id)}),!p.length&&!f&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"p-4 text-center text-gray-500",children:"No rewards."})}),f&&e.jsx("tr",{children:e.jsxs("td",{colSpan:8,className:"p-6 text-center text-gray-500",children:[e.jsx(O,{className:"w-5 h-5 animate-spin inline mr-2"}),"Loading rewards..."]})})]})]})}),e.jsx("p",{className:"text-xs text-gray-500",children:"Catalog: inactive rewards are hidden from users."})]})]})}function De(){const{toast:l}=K(),[p,b]=_.useState(""),[f,I]=_.useState(""),[E,z]=_.useState("all"),[y,S]=_.useState(!1),[R,T]=_.useState([]),[w,j]=_.useState(!1),v=_.useCallback(async()=>{if(!x)return;j(!0);const{data:i,error:d}=await x.from("notifications").select("id,title,message,type,segment,created_at").order("created_at",{ascending:!1}).limit(100);d?l({title:"Fetch failed",description:d.message,variant:"destructive"}):T(i||[]),j(!1)},[l]);_.useEffect(()=>{v()},[v]);const n=async i=>{if(i.preventDefault(),!p.trim()||!f.trim()){l({title:"Missing fields",variant:"destructive"});return}if(!x){l({title:"No backend client",variant:"destructive"});return}S(!0);try{const{data:{session:d}}=await x.auth.getSession(),h=d==null?void 0:d.access_token,a=await fetch("/functions/v1/send-notifications",{method:"POST",headers:{"Content-Type":"application/json",...h?{Authorization:`Bearer ${h}`}:{}},body:JSON.stringify({title:p.trim(),message:f.trim(),segment:E})});if(!a.ok){const r=await a.text();throw new Error(r||`HTTP ${a.status}`)}l({title:"Sent",description:p.trim()}),b(""),I(""),v()}catch(d){l({title:"Send failed",description:d.message,variant:"destructive"})}finally{S(!1)}};return e.jsxs("div",{className:"space-y-8 max-w-3xl",children:[e.jsxs("form",{onSubmit:n,className:"space-y-4 bg-gray-50 border border-gray-200 rounded-xl p-5",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Send Notification"}),e.jsxs("div",{children:[e.jsx(A,{children:"Title"}),e.jsx(D,{value:p,onChange:i=>b(i.target.value),maxLength:80,placeholder:"Short title"}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Max 80 chars • ",p.length,"/80"]})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Message"}),e.jsx(W,{value:f,onChange:i=>I(i.target.value),className:"h-28",maxLength:280,placeholder:"Body shown in push notification"}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Max 280 chars • ",f.length,"/280"]})]}),e.jsxs("div",{children:[e.jsx(A,{children:"Segment"}),e.jsx("div",{className:"flex gap-2 mt-1",children:["all"].map(i=>e.jsx("button",{type:"button",onClick:()=>z(i),className:`px-3 py-1 rounded text-xs border ${E===i?"bg-indigo-600 text-white border-indigo-600":"border-gray-300 text-gray-600 hover:bg-gray-100"}`,children:i},i))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{type:"submit",disabled:y,children:y?e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"w-4 h-4 mr-1 animate-spin"}),"Sending"]}):"Send"}),e.jsx(g,{type:"button",variant:"outline",onClick:()=>{b(""),I("")},children:"Reset"})]})]}),e.jsxs("section",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("h2",{className:"font-semibold text-lg",children:"Recent Notifications"}),e.jsx(g,{size:"sm",variant:"outline",onClick:v,disabled:w,children:w?e.jsx(O,{className:"w-4 h-4 animate-spin"}):"Refresh"})]}),e.jsxs("div",{className:"space-y-3",children:[R.map(i=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-3 bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between gap-4 flex-wrap",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:i.title}),e.jsx("div",{className:"text-xs text-gray-600 whitespace-pre-wrap max-w-xl break-words",children:i.message})]}),e.jsx("div",{className:"text-[10px] text-gray-500",children:H(i.created_at)})]}),e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["Segment: ",i.segment||"—",i.type?` • ${i.type}`:""]})]},i.id)),!R.length&&!w&&e.jsx("div",{className:"text-xs text-gray-500",children:"No notifications yet."})]})]})]})}export{Be as default};
