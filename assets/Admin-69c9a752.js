import{j as e,g as He,a as Ge,u as le,s as x,B as g,o as he,t as Ie,D as Ke,p as Ye,i as Xe,k as Je,l as et,q as tt,r as st,v as rt,h as it}from"./index-3e151fbe.js";import{a as je,r as m}from"./react-8a702e3e.js";import{I as z}from"./input-6ef6a0a9.js";import{L as O}from"./label-f15ff951.js";import{d as at,L as be}from"./router-f2cf3f51.js";import{m as ge}from"./motion-f69b6c08.js";import{V as nt,Y as ye,G as ot,Z as ee,_ as Qe,L as te,j as dt,s as Te,$ as lt,a0 as oe,a1 as ct}from"./icons-71504e08.js";import"./supabase-4c1332f7.js";const de=je.forwardRef(({className:j,...n},T)=>e.jsx("textarea",{ref:T,className:He("flex w-full rounded-md border border-input bg-background px-3 py-2 text-base sm:text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 min-h-[80px] resize-vertical",j),...n}));de.displayName="Textarea";function mt(){const{toast:j}=le(),[n,T]=m.useState(""),[$,q]=m.useState(""),[S,L]=m.useState(!1),f=async v=>{if(v.preventDefault(),!n.trim()||!$.trim()){j({title:"Title/Message required",variant:"destructive"});return}L(!0);try{const{error:y}=await x.functions.invoke("send-notifications",{body:{title:n.trim(),message:$.trim()}});if(y)throw y;j({title:"Push sent",description:"Notifications queued to subscribers."}),T(""),q("")}catch(y){j({title:"Push failed",description:y.message||"Try again later",variant:"destructive"})}finally{L(!1)}},[A,d]=m.useState("broadcast");return e.jsxs("div",{className:"space-y-4 text-foreground",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent flex items-center",children:[e.jsx(ct,{className:"mr-2"})," Admin: Notifications"]}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Announcements aur quiz notifications yahan se bhejein"})]})}),e.jsxs("div",{className:"bg-card border border-border rounded-2xl p-4 shadow-lg",children:[e.jsxs("h3",{className:"text-xl font-bold text-foreground mb-4 flex items-center",children:[e.jsx(ye,{className:"w-5 h-5 mr-2"}),"Send Push Notification"]}),e.jsxs("form",{onSubmit:f,className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx(O,{htmlFor:"pushTitle",children:"Push Notification Title *"}),e.jsx(z,{id:"pushTitle",value:n,onChange:v=>T(v.target.value),placeholder:"e.g., New Quiz Alert!",required:!0})]}),e.jsxs("div",{children:[e.jsx(O,{htmlFor:"pushMessage",children:"Push Notification Message *"}),e.jsx(de,{id:"pushMessage",value:$,onChange:v=>q(v.target.value),placeholder:"Don't miss out on today's quiz!",required:!0})]}),e.jsx(g,{type:"submit",disabled:S,className:"bg-purple-600 hover:bg-purple-700",children:S?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"w-4 h-4 mr-2 animate-spin"}),"Sending Push..."]}):"Send Push Notification"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{variant:A==="broadcast"?"default":"outline",onClick:()=>d("broadcast"),children:"Admin ki bheji hui"}),e.jsx(g,{variant:A==="auto"?"default":"outline",onClick:()=>d("auto"),children:"Automatic wali"})]}),A==="broadcast"?e.jsx(pt,{}):e.jsx(ut,{})]})}function ut(){const{toast:j}=le(),[n,T]=m.useState([]),[$,q]=m.useState(!0),[S,L]=m.useState("all"),f=m.useCallback(async()=>{try{const{data:d,error:v}=await x.from("quiz_notification_log").select("id, quiz_id, type, sent_at").order("sent_at",{ascending:!1}).limit(50);if(v)throw v;const y=d||[],Z=Array.from(new Set(y.map(N=>N.quiz_id).filter(Boolean)));let a={};if(Z.length>0){const{data:N,error:V}=await x.from("quizzes").select("id, title").in("id",Z);if(V)throw V;a=Object.fromEntries((N||[]).map(H=>[H.id,H.title]))}const C=y.map(N=>({...N,quiz_title:a[N.quiz_id]||"Quiz"}));T(C)}catch(d){j({title:"Load failed",description:d.message,variant:"destructive"})}finally{q(!1)}},[j]);m.useEffect(()=>{f()},[f]);const A=je.useMemo(()=>{if(!Array.isArray(n))return[];const d=Date.now();let v=0;if(S==="today"){const y=new Date;y.setHours(0,0,0,0),v=y.getTime()}else S==="7d"?v=d-7*24*60*60*1e3:S==="30d"&&(v=d-30*24*60*60*1e3);return v?n.filter(y=>new Date(y.sent_at).getTime()>=v):n},[n,S]);return e.jsxs("div",{className:"bg-card border border-border rounded-2xl p-4 shadow-lg mb-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-3 flex items-center",children:[e.jsx(Qe,{className:"w-5 h-5 mr-2"}),"Activity: Automatic Quiz Notifications"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3 text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Range:"}),["all","today","7d","30d"].map(d=>e.jsx("button",{onClick:()=>L(d),className:`px-2 py-1 rounded border ${S===d?"bg-primary text-primary-foreground":"border-border text-foreground"}`,children:d.toUpperCase()},d))]}),$?e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading..."}):A.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"No automatic notifications yet."}):e.jsx("div",{className:"space-y-2",children:A.map(d=>e.jsxs("div",{className:"flex items-center justify-between text-sm border border-border rounded-lg px-3 py-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:d.quiz_title}),e.jsxs("div",{className:"text-muted-foreground",children:["Type: ",d.type," â€¢ ",new Date(d.sent_at).toLocaleString()]})]}),e.jsx(be,{to:d.type==="result"?`/#/results/${d.quiz_id}`:`/#/quiz/${d.quiz_id}`,className:"text-primary hover:underline",children:"Open"})]},d.id))})]})}function pt(){const{toast:j}=le(),[n,T]=m.useState([]),[$,q]=m.useState(!0),[S,L]=m.useState("all"),f=m.useCallback(async()=>{try{const{data:d,error:v}=await x.from("notifications").select("id, title, message, created_at, created_by, type").order("created_at",{ascending:!1}).limit(50);if(v)throw v;T(d||[])}catch(d){j({title:"Load failed",description:d.message,variant:"destructive"})}finally{q(!1)}},[j]);m.useEffect(()=>{f()},[f]);const A=je.useMemo(()=>{if(!Array.isArray(n))return[];const d=Date.now();let v=0;if(S==="today"){const y=new Date;y.setHours(0,0,0,0),v=y.getTime()}else S==="7d"?v=d-7*24*60*60*1e3:S==="30d"&&(v=d-30*24*60*60*1e3);return v?n.filter(y=>new Date(y.created_at).getTime()>=v):n},[n,S]);return e.jsxs("div",{className:"bg-card border border-border rounded-2xl p-4 shadow-lg mb-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-3 flex items-center",children:[e.jsx(ye,{className:"w-5 h-5 mr-2"}),"Activity: Admin Broadcast Pushes"]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3 text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Range:"}),["all","today","7d","30d"].map(d=>e.jsx("button",{onClick:()=>L(d),className:`px-2 py-1 rounded border ${S===d?"bg-primary text-primary-foreground":"border-border text-foreground"}`,children:d.toUpperCase()},d))]}),$?e.jsx("div",{className:"text-sm text-muted-foreground",children:"Loading..."}):A.length===0?e.jsx("div",{className:"text-sm text-muted-foreground",children:"No broadcast pushes yet."}):e.jsx("div",{className:"space-y-2",children:A.map(d=>e.jsxs("div",{className:"text-sm border border-border rounded-lg px-3 py-2",children:[e.jsx("div",{className:"font-medium",children:d.title}),e.jsx("div",{className:"text-muted-foreground whitespace-pre-wrap",children:d.message}),e.jsxs("div",{className:"text-muted-foreground mt-1 flex items-center gap-2",children:[e.jsx("span",{children:new Date(d.created_at).toLocaleString()}),d.type?e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-muted border border-border",children:d.type}):null]})]},d.id))})]})}function wt(){const{userProfile:j}=Ge(),{toast:n}=le(),[T,$]=at(),q=T.get("tab")||"overview",S=t=>{const s=new URLSearchParams(T);s.set("tab",t),$(s,{replace:!1})},L=it&&!!x,[f,A]=m.useState([]),[d,v]=m.useState(!0),[y,Z]=m.useState(!1),[a,C]=m.useState(null),[N,V]=m.useState(!1),[H,ce]=m.useState([]),[Ne,fe]=m.useState(!1),[R,K]=m.useState({text:"",options:["","","",""],correctIndex:0}),[Le,we]=m.useState(!1),[me,_e]=m.useState(""),[ke,Pe]=m.useState("append"),[Ce,ue]=m.useState(!1),[ze,Se]=m.useState(null),Ae=["opinion","gk","movies","sports"],[se,pe]=m.useState("form"),re=()=>({text:"",options:["",""],correctIndex:0}),[M,W]=m.useState([re()]),[o,F]=m.useState({title:"",prizes:["","",""],start_time:"",end_time:"",category:"",bulk_text:"",prize_type:"money"}),Y=m.useCallback(async()=>{try{const{data:t,error:s}=await x.from("quizzes").select("*").order("start_time",{ascending:!1});if(s)throw s;A(t||[])}catch(t){n({title:"Error",description:"Failed to fetch quizzes.",variant:"destructive"})}finally{v(!1)}},[n]);if(m.useEffect(()=>{L&&q==="overview"&&Y()},[q,Y,L]),(j==null?void 0:j.role)!=="admin")return e.jsxs("div",{className:"container mx-auto px-4 py-8 text-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-red-600",children:"Access Denied"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Aapke paas admin adhikaar nahi hain."})]});if(!L)return e.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",children:e.jsxs("div",{className:"qd-card rounded-2xl max-w-lg w-full p-6 text-center",children:[e.jsx("h2",{className:"text-xl font-semibold text-yellow-300 mb-3",children:"Supabase config missing"}),e.jsxs("p",{className:"text-sm text-white/70",children:["Admin tools ko local ya staging par chalane ke liye ",e.jsx("code",{children:".env"})," me ",e.jsx("code",{children:"VITE_SUPABASE_URL"})," aur ",e.jsx("code",{children:"VITE_SUPABASE_ANON_KEY"})," bharein."]}),e.jsxs("p",{className:"text-sm text-white/65 mt-3",children:["Agar sirf UI preview karna hai to ",e.jsx("code",{children:"VITE_BYPASS_AUTH=1"})," se login mock ho jayega, lekin Supabase ke bina data actions (quizzes create/update, notifications) disable rahenge."]})]})});const U=async t=>{try{const{data:s,error:i}=await x.from("questions").select("id, question_text, options ( id, option_text, is_correct )").eq("quiz_id",t);if(i)throw i;ce(s||[])}catch(s){n({title:"Error",description:"Failed to fetch questions.",variant:"destructive"})}},ie=(t,{strict:s=!1,allowZeroCorrect:i=!1}={})=>{var D,E;const r=String(t||"").trim().split(/\n\s*\n+/),c=[],l=[],u=[];let w=0;for(const X of r){const G=X.split(/\r?\n/).map(b=>b.trim()),xe=G.filter(Boolean);if(!xe.length)continue;w+=1;const ae=xe[0].replace(/^Q\d*\.?\s*/i,"").replace(/^Question\s*[:-]\s*/i,""),B=[];let J="";for(let b=1;b<G.length;b++){const k=G[b];if(!k)continue;if(/^ans(wer)?\s*[:-]/i.test(k)){J=k;continue}const p=k.match(/^[-*â€¢]?\s*\[(x|X| )\]\s*(.+)$/);if(p){const ne=/x/i.test(p[1]);B.push({option_text:p[2].trim(),is_correct:ne});continue}const h=k.match(/^(?:[-*â€¢]|[A-Da-d]\)|\d+\)|[A-Da-d][.:])\s*(.+)$/);let I=h?h[1].trim():k.replace(/^[*]\s*/,"").trim();const Q=/^\*/.test(k);I&&B.push({option_text:I,is_correct:Q})}if(J){const b=J.split(/[:-]/).slice(1).join(":").trim(),k=(E=(D=b.match(/^[A-Da-d]/))==null?void 0:D[0])==null?void 0:E.toUpperCase(),p=parseInt(b,10);if(k){const h={A:0,B:1,C:2,D:3}[k];Number.isInteger(h)&&B[h]&&B.forEach((I,Q)=>I.is_correct=Q===h)}else if(!isNaN(p)&&p>=1&&B[p-1])B.forEach((h,I)=>h.is_correct=I===p-1);else{const h=b.toLowerCase(),I=B.findIndex(Q=>Q.option_text.toLowerCase()===h||Q.option_text.toLowerCase().includes(h));I>=0&&B.forEach((Q,ne)=>Q.is_correct=ne===I)}}let _=B.filter(b=>b.option_text);if(_.length>4){const b=_.findIndex(k=>k.is_correct);if(b>=0){const k=_[b],p=_.filter((h,I)=>I!==b);_=[k,...p.slice(0,3)]}else _=_.slice(0,4);u.push(`Q${w}: More than 4 options found; trimmed to 4 (kept the marked correct).`)}if(!ae){l.push(`Q${w}: Question text missing.`);continue}if(_.length<2){l.push(`Q${w}: At least 2 options required.`);continue}let P=_.filter(b=>b.is_correct).length;if(i)P>0&&u.push(`Q${w}: Correct marks ignored for opinion category.`),_=_.map(b=>({...b,is_correct:!1}));else if(s)P===0?l.push(`Q${w}: Mark exactly one correct option with [x] or provide an Answer: line.`):P>1&&l.push(`Q${w}: Multiple correct marks detected; keep only one [x] or use a single Answer: line.`);else if(P===0)_[0].is_correct=!0;else if(P>1){let b=!1;_=_.map(k=>k.is_correct&&!b?(b=!0,k):{...k,is_correct:!1})}c.push({question_text:ae,options:_})}return{items:c,errors:l,warnings:u}},De=async(t,s,i="append")=>{try{const{error:r}=await x.rpc("admin_bulk_upsert_questions",{p_quiz_id:t,p_payload:s,p_mode:i});if(!r)return{ok:!0}}catch(r){}i==="replace"&&await x.from("questions").delete().eq("quiz_id",t);for(const r of s){const{data:c,error:l}=await x.from("questions").insert({quiz_id:t,question_text:r.question_text}).select("id").single();if(l)return{ok:!1,message:l.message};const u=c.id,w=r.options.map(E=>({question_id:u,option_text:E.option_text,is_correct:!!E.is_correct})),{error:D}=await x.from("options").insert(w);if(D)return{ok:!1,message:D.message}}return{ok:!0}},Oe=async()=>{if(!a)return;if(a!=null&&a.start_time?new Date(a.start_time).getTime()<=Date.now():!1){n({title:"Locked",description:"Cannot add after quiz start",variant:"destructive"});return}const s=(R.text||"").trim(),i=(R.options||[]).map(l=>(l||"").trim()).filter(Boolean).slice(0,4);if(!s){n({title:"Question required",variant:"destructive"});return}if(i.length<2){n({title:"At least 2 options required",variant:"destructive"});return}const r=(a==null?void 0:a.category)==="opinion",c=Math.min(Math.max(R.correctIndex||0,0),i.length-1);try{const{data:l,error:u}=await x.from("questions").insert({quiz_id:a.id,question_text:s}).select("id").single();if(u)throw u;const w=l.id,D=i.map((X,G)=>({question_id:w,option_text:X,is_correct:r?!1:G===c})),{error:E}=await x.from("options").insert(D);if(E)throw E;n({title:"Added",description:"Question created"}),fe(!1),K({text:"",options:["","","",""],correctIndex:0}),await U(a.id)}catch(l){n({title:"Add failed",description:l.message,variant:"destructive"})}},$e=async(t,s)=>{const i=(s||"").trim();if(!i)return n({title:"Question khaali nahi ho sakta",variant:"destructive"});const{error:r}=await x.from("questions").update({question_text:i}).eq("id",t);if(r)return n({title:"Update failed",description:r.message,variant:"destructive"});await U(a.id)},Ee=async t=>{if(!confirm("Is question aur iske options ko delete karein?"))return;const{error:s}=await x.from("questions").delete().eq("id",t);if(s)return n({title:"Delete failed",description:s.message,variant:"destructive"});await U(a.id)},Be=async t=>{const s=window.prompt("Option text daalein");if(!s||!s.trim())return;const{error:i}=await x.from("options").insert({question_id:t,option_text:s.trim()});if(i)return n({title:"Add failed",description:i.message,variant:"destructive"});await U(a.id)},Re=async(t,s)=>{const i=(s||"").trim();if(!i)return n({title:"Option khaali nahi ho sakta",variant:"destructive"});const{error:r}=await x.from("options").update({option_text:i}).eq("id",t);if(r)return n({title:"Update failed",description:r.message,variant:"destructive"});await U(a.id)},Me=async t=>{if(!confirm("Is option ko delete karein?"))return;const{error:s}=await x.from("options").delete().eq("id",t);if(s)return n({title:"Delete failed",description:s.message,variant:"destructive"});await U(a.id)},Fe=async t=>{t.preventDefault();try{const s=[],i=(o.title||"").trim();o.category||s.push("Please choose a category"),(!i||i.length<3)&&s.push("Title is too short"),o.start_time||s.push("Start time is required"),o.end_time||s.push("End time is required");let r={items:[],errors:[],warnings:[]};const c=[];M.length||s.push("Add at least one question"),M.forEach((p,h)=>{var qe;const I=(p.text||"").trim(),Q=(p.options||[]).map(ve=>(ve||"").trim()).filter(Boolean).slice(0,4);I||r.errors.push(`Q${h+1}: Question text is required`),Q.length<2&&r.errors.push(`Q${h+1}: At least 2 options required`),Q.length>4&&r.warnings.push(`Q${h+1}: Max 4 options; extra ignored`);const ne=Math.max(0,Math.min((qe=p.correctIndex)!=null?qe:0,Q.length-1)),We=Q.map((ve,Ze)=>({option_text:ve,is_correct:Ze===ne}));I&&Q.length>=2&&c.push({question_text:I,options:We})}),r.items=c,r.errors.length&&s.push(r.errors[0]),r.items.length||s.push("No valid questions detected"),se==="paste"&&s.push("Load pasted questions into Form and review before creating");const l=p=>{try{const h=new Date(p);return isNaN(h.getTime())?null:h}catch(h){return null}},u=l(o.start_time),w=l(o.end_time);(!u||!w)&&s.push("Invalid start/end time"),u&&w&&w<=u&&s.push("End time must be after start time"),u&&u.getTime()<Date.now()-6e4&&s.push("Start time must be in the future");const D=parseInt(o.prizes[0]||"",10),E=o.prizes[1]?parseInt(o.prizes[1],10):0,X=o.prizes[2]?parseInt(o.prizes[2],10):0;if((isNaN(D)||D<=0)&&s.push("1st prize must be a positive number"),o.prizes[1]&&(isNaN(E)||E<0)&&s.push("2nd prize must be 0 or more"),o.prizes[2]&&(isNaN(X)||X<0)&&s.push("3rd prize must be 0 or more"),s.length){n({title:"Please fix the form",description:s[0],variant:"destructive"});return}const G=o.prizes.filter(p=>p).map(p=>parseInt(p)),xe=G.reduce((p,h)=>p+h,0),ae=p=>{if(!p)return null;const h=new Date(p);return isNaN(h.getTime())?null:h.toISOString()},B=(p=!0)=>{const h={title:o.title,prize_pool:xe,prizes:G,start_time:ae(o.start_time),end_time:ae(o.end_time),status:"upcoming",category:o.category||null};return p&&(h.prize_type=o.prize_type||"money"),h},J=async(p=!0)=>x.from("quizzes").insert([B(p)]).select("id, title, category, prizes, prize_pool, start_time, end_time").single();let _,P;const b=await J(!0);if(_=b.data,P=b.error,P&&/prize_type/.test(P.message||"")){const p=await J(!1);_=p.data,P=p.error,!P&&_&&(n({title:"Migration pending",description:"Quiz ban gaya, lekin Supabase schema me prize_type column missing hai. Please run latest migrations.",variant:"warning"}),_.prize_type=o.prize_type||"money")}if(P)throw P;n({title:"Quiz created",description:"Questions will be saved now."});const k=r.items;if(Z(!1),F({title:"",prizes:["","",""],start_time:"",end_time:"",category:"",bulk_text:"",prize_type:"money"}),pe("form"),W([re()]),C(_),k.length>0){ue(!0);const p=await De(_.id,k,"replace");ue(!1),p.ok?n({title:"Questions added",description:`${k.length} questions created.`}):n({title:"Bulk add failed",description:p.message||"Please try again",variant:"destructive"})}await U(_.id),V(!0),Y()}catch(s){n({title:"Error",description:s.message,variant:"destructive"})}},Ue=async t=>{if(confirm("Kya aap is quiz ko delete karna chahte hain?"))try{const{error:s}=await x.from("quizzes").delete().eq("id",t);if(s)throw s;n({title:"Success",description:"Quiz delete ho gaya."}),Y()}catch(s){n({title:"Error",description:s.message,variant:"destructive"})}},Ve=async t=>{try{Se(t);const{error:s}=await x.rpc("admin_recompute_quiz_results",{p_quiz_id:t});if(s)throw s;n({title:"Results recomputed",description:"Leaderboard update ho gaya."})}catch(s){n({title:"Recompute failed",description:s.message,variant:"destructive"})}finally{Se(null)}};return e.jsxs("div",{className:"container mx-auto px-4 py-8 max-w-6xl text-foreground",children:[e.jsxs(ge.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-2",children:"Quiz Dangal Admin"}),e.jsx("p",{className:"text-muted-foreground",children:"Admin dashboard"})]}),e.jsx("div",{className:"flex gap-2 flex-wrap mb-6",children:[{key:"overview",title:"Overview",icon:e.jsx(nt,{className:"w-4 h-4"})},{key:"notifications",title:"Notifications",icon:e.jsx(ye,{className:"w-4 h-4"})},{key:"redemptions",title:"Redemptions",icon:e.jsx(ot,{className:"w-4 h-4"})}].map(t=>e.jsxs("button",{onClick:()=>S(t.key),className:`px-3 py-2 rounded-lg border text-sm transition-colors inline-flex items-center gap-2 ${t.key===q?"bg-primary text-primary-foreground border-transparent shadow":"bg-muted text-muted-foreground border-border hover:text-foreground"} `,children:[t.icon,t.title]},t.key))}),q==="overview"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-6",children:e.jsxs(g,{onClick:()=>Z(!0),className:"bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white",children:[e.jsx(ee,{className:"h-4 w-4 mr-2"}),"Create New Quiz"]})}),y&&e.jsxs(ge.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"bg-card text-card-foreground border border-border rounded-2xl p-6 shadow-lg mb-8",children:[e.jsx("h2",{className:"text-xl font-bold text-foreground mb-1",children:"Create New Quiz"}),e.jsxs("form",{onSubmit:Fe,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(O,{children:"Category (Section)"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:Ae.map(t=>e.jsx("button",{type:"button",onClick:()=>F({...o,category:t}),className:`px-3 py-1 rounded-full border text-sm capitalize ${o.category===t?"bg-primary text-primary-foreground border-transparent":"bg-muted text-muted-foreground border-border hover:text-foreground"}`,children:t},t))}),!o.category&&e.jsx("p",{className:"text-xs text-destructive mt-1",children:"Please choose a category"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsxs("div",{children:[e.jsx(O,{htmlFor:"title",children:"Quiz Title"}),e.jsx(z,{id:"title",value:o.title,onChange:t=>F({...o,title:t.target.value}),placeholder:"Daily Opinion Quiz - Evening",required:!0})]})}),e.jsxs("div",{children:[e.jsx(O,{children:"Prize Distribution"}),e.jsxs("div",{className:"flex items-center gap-3 mt-1 text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Type:"}),e.jsx("div",{className:"flex gap-2",children:["money","coins","others"].map(t=>e.jsx("button",{type:"button",onClick:()=>F({...o,prize_type:t}),className:`px-2 py-1 rounded border text-xs capitalize ${o.prize_type===t?"bg-primary text-primary-foreground border-transparent":"bg-muted text-muted-foreground border-border"}`,children:t},t))})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsx(z,{placeholder:o.prize_type==="coins"?"1st Prize (coins)":"1st Prize (amount)",value:o.prizes[0],onChange:t=>{const s=[...o.prizes];s[0]=t.target.value,F({...o,prizes:s})}}),e.jsx(z,{placeholder:o.prize_type==="coins"?"2nd Prize (coins)":"2nd Prize (amount)",value:o.prizes[1],onChange:t=>{const s=[...o.prizes];s[1]=t.target.value,F({...o,prizes:s})}}),e.jsx(z,{placeholder:o.prize_type==="coins"?"3rd Prize (coins)":"3rd Prize (amount)",value:o.prizes[2],onChange:t=>{const s=[...o.prizes];s[2]=t.target.value,F({...o,prizes:s})}})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(O,{children:"Start Time"}),e.jsx(z,{type:"datetime-local",value:o.start_time,onChange:t=>F({...o,start_time:t.target.value}),required:!0})]}),e.jsxs("div",{children:[e.jsx(O,{children:"End Time"}),e.jsx(z,{type:"datetime-local",value:o.end_time,onChange:t=>F({...o,end_time:t.target.value}),required:!0})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(O,{children:"Questions entry mode:"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{type:"button",className:`px-3 py-1 rounded-md text-sm border ${se==="form"?"bg-primary text-primary-foreground border-transparent":"bg-muted text-muted-foreground border-border"}`,onClick:()=>pe("form"),children:"Form"}),e.jsx("button",{type:"button",className:`px-3 py-1 rounded-md text-sm border ${se==="paste"?"bg-primary text-primary-foreground border-transparent":"bg-muted text-muted-foreground border-border"}`,onClick:()=>pe("paste"),children:"Paste"})]})]}),se==="form"?e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:o.category==="opinion"?"Add questions with 2â€“4 options. No correct option in Opinion category.":"Add questions with 2â€“4 options. Select exactly one correct."}),M.map((t,s)=>e.jsxs("div",{className:"p-3 rounded-xl border border-border",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-muted-foreground w-10",children:["Q",s+1,"."]}),e.jsx(z,{value:t.text,onChange:i=>{const r=[...M];r[s]={...r[s],text:i.target.value},W(r)},placeholder:"Question text",className:"flex-1"}),e.jsx(g,{type:"button",variant:"outline",size:"sm",className:"border-red-300 text-red-600",onClick:()=>{const i=[...M];i.splice(s,1),W(i.length?i:[re()])},children:"Remove"})]}),e.jsxs("div",{className:"mt-2 space-y-2",children:[(t.options||[]).slice(0,4).map((i,r)=>{var c;return e.jsxs("div",{className:"flex items-center gap-2",children:[o.category!=="opinion"&&e.jsx("input",{type:"radio",name:`qdraft-${s}`,checked:((c=t.correctIndex)!=null?c:0)===r,onChange:()=>{const l=[...M];l[s]={...l[s],correctIndex:r},W(l)}}),e.jsx(z,{value:i,onChange:l=>{const u=[...M],w=[...u[s].options||[]];w[r]=l.target.value,u[s]={...u[s],options:w},W(u)},placeholder:`Option ${r+1}`,className:"flex-1"}),(t.options||[]).length>2&&e.jsx(g,{type:"button",variant:"outline",size:"sm",className:"border-red-300 text-red-600",onClick:()=>{var D;const l=[...M],u=[...l[s].options||[]];u.splice(r,1);const w=Math.min((D=l[s].correctIndex)!=null?D:0,u.length-1);l[s]={...l[s],options:u,correctIndex:w},W(l)},children:"Delete"})]},r)}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(g,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 disabled:opacity-60",disabled:(t.options||[]).length>=4,onClick:()=>{const i=[...M],r=[...i[s].options||[]].slice(0,4).concat("");i[s]={...i[s],options:r},W(i)},children:[e.jsx(ee,{className:"w-4 h-4 mr-1"}),"Add Option"]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Max 4 options."})]})]})]},s)),e.jsx("div",{children:e.jsxs(g,{type:"button",onClick:()=>W(t=>[...t,re()]),children:[e.jsx(ee,{className:"w-4 h-4 mr-1"}),"Add Question"]})})]}):e.jsxs("div",{children:[e.jsx(O,{children:"Paste Questions (RAW format) *"}),e.jsx(de,{placeholder:`Use RAW format with [x]/[ ] tick and max 4 options. Example:
Q1. Capital of India?
- [ ] Mumbai
- [x] Delhi
- [ ] Kolkata
- [ ] Jaipur

Q2. Best color?
- [x] Blue
- [ ] Red
- [ ] Green
(Alternatively, provide Answer: B or Answer: 2 line)`,value:o.bulk_text,onChange:t=>F({...o,bulk_text:t.target.value}),className:"mt-1 h-40"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[o.category==="opinion"?"No correct option required for Opinion category.":"Mark exactly one correct option per question with [x] or Answer: A/B/1."," Max 4 options per question."]}),(()=>{const{items:t,errors:s,warnings:i}=ie(o.bulk_text,{strict:!0,allowZeroCorrect:o.category==="opinion"});return e.jsxs("div",{className:"mt-2 space-y-1 text-sm",children:[e.jsxs("div",{className:"text-foreground/80",children:["Preview: ",t.length," questions"]}),i.length>0&&e.jsxs("div",{className:"text-xs text-amber-600",children:[i[0],i.length>1?` (+${i.length-1} more)`:""]}),s.length>0&&e.jsxs("div",{className:"text-xs text-destructive",children:[s[0],s.length>1?` (+${s.length-1} more)`:""]}),e.jsx("div",{className:"pt-2",children:e.jsx(g,{type:"button",onClick:()=>{const r=ie(o.bulk_text,{strict:!0,allowZeroCorrect:o.category==="opinion"});if(r.errors.length){n({title:"Fix pasted input",description:r.errors[0],variant:"destructive"});return}if(!r.items.length){n({title:"No valid questions",variant:"destructive"});return}const c=r.items.map(l=>{const u=(l.options||[]).slice(0,4),w=o.category==="opinion"?0:Math.max(0,u.findIndex(D=>D.is_correct));return{text:l.question_text,options:u.map(D=>D.option_text),correctIndex:w<0?0:w}});W(c.length?c:[re()]),pe("form"),n({title:"Loaded into form",description:`${c.length} questions ready to review & edit.`})},className:"bg-indigo-600 hover:bg-indigo-700",children:"Load into Form (Preview & Edit)"})})]})})()]}),e.jsxs("div",{className:"flex space-x-4",children:[(()=>{let t=!1;return se==="paste"?t=!0:t=!M.some(i=>(i.text||"").trim()&&(i.options||[]).filter(r=>(r||"").trim()).length>=2),e.jsx(g,{type:"submit",disabled:t,className:"bg-green-600 hover:bg-green-700 disabled:opacity-60",children:"Create Quiz"})})(),e.jsx(g,{type:"button",variant:"outline",onClick:()=>Z(!1),children:"Cancel"})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h2",{className:"text-xl font-bold text-foreground flex items-center",children:[e.jsx(Qe,{className:"w-5 h-5 mr-2"}),"All Quizzes"]}),d?e.jsxs("div",{className:"py-8 text-center text-muted-foreground",children:[e.jsx(te,{className:"inline-block h-6 w-6 animate-spin text-indigo-500 mr-2"})," Loading quizzes..."]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"Active / Upcoming"}),e.jsx("div",{className:"space-y-4 mt-2",children:f.filter(t=>{const s=Date.now(),i=t.end_time?new Date(t.end_time).getTime():null;return i===null||s<=i}).map((t,s)=>e.jsx(ge.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:s*.05},className:"bg-card text-card-foreground border border-border rounded-2xl p-6 shadow-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:t.title}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 mt-2 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Category: ",t.category||"â€”"]}),e.jsxs("span",{children:["Prize Type: ",t.prize_type||"money"]}),e.jsxs("span",{children:["Prize Pool: ",t.prize_type==="coins"?"ðŸª™":"","â‚¹",t.prize_pool]}),e.jsxs("span",{children:["Prizes: ",t.prize_type==="coins"?"ðŸª™ ":"",Array.isArray(t.prizes)?t.prizes.join(", "):""]})]}),e.jsxs("div",{className:"mt-2 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Start: ",t.start_time?he(t.start_time):"â€”"]}),e.jsxs("span",{className:"ml-4",children:["End: ",t.end_time?he(t.end_time):"â€”"]})]}),(()=>{const i=t.start_time?new Date(t.start_time).getTime()<=Date.now():!1;return e.jsxs("div",{className:"mt-3 grid grid-cols-1 md:grid-cols-3 gap-2",children:[e.jsxs("select",{disabled:i,title:i?"Locked after start time":void 0,className:`border border-border bg-background text-foreground rounded-md px-2 py-2 capitalize ${i?"opacity-60 cursor-not-allowed":""}`,value:t.category||"",onChange:async r=>{if(i){n({title:"Locked",description:"Cannot change after start",variant:"destructive"});return}const{error:c}=await x.from("quizzes").update({category:r.target.value}).eq("id",t.id);c?n({title:"Update failed",description:c.message,variant:"destructive"}):Y()},children:[e.jsx("option",{value:"",children:"Select category"}),Ae.map(r=>e.jsx("option",{value:r,children:r},r))]}),e.jsx(z,{type:"datetime-local",disabled:i,title:i?"Locked after start time":void 0,value:Ie(t.start_time),onChange:async r=>{if(i){n({title:"Locked",description:"Cannot change after start",variant:"destructive"});return}const c=r.target.value,l=c?new Date(c).toISOString():null;f[s].start_time=l,A([...f]);const{error:u}=await x.from("quizzes").update({start_time:l}).eq("id",t.id);u&&(n({title:"Update failed",description:u.message,variant:"destructive"}),Y())}}),e.jsx(z,{type:"datetime-local",disabled:i,title:i?"Locked after start time":void 0,value:Ie(t.end_time),onChange:async r=>{if(i){n({title:"Locked",description:"Cannot change after start",variant:"destructive"});return}const c=r.target.value,l=c?new Date(c).toISOString():null;f[s].end_time=l,A([...f]);const{error:u}=await x.from("quizzes").update({end_time:l}).eq("id",t.id);u&&(n({title:"Update failed",description:u.message,variant:"destructive"}),Y())}})]})})()]}),(()=>{const i=Date.now(),r=t.start_time?new Date(t.start_time).getTime():null,c=!r||i<r;return e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(g,{size:"sm",variant:"outline",onClick:()=>Ve(t.id),disabled:ze===t.id,className:"text-indigo-600 hover:text-indigo-700",children:ze===t.id?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"h-4 w-4 mr-1 animate-spin"}),"Recomputing"]}):e.jsxs(e.Fragment,{children:[e.jsx(dt,{className:"h-4 w-4 mr-1"}),"Recompute"]})}),e.jsxs(be,{to:`/results/${t.id}`,className:"inline-flex items-center gap-1 px-3 py-1.5 text-sm rounded-md border border-border hover:bg-muted text-blue-600",children:[e.jsx(Te,{className:"h-4 w-4"})," Results"]}),e.jsxs(g,{size:"sm",variant:"outline",onClick:()=>{C(t),U(t.id),V(!0)},className:"text-blue-600 hover:text-blue-700",children:[e.jsx(lt,{className:"h-4 w-4"}),"Questions"]}),e.jsxs("div",{className:"relative group",children:[e.jsx(g,{size:"sm",variant:"outline",onClick:()=>Ue(t.id),disabled:!c,className:`${c?"text-red-600 hover:text-red-700":"text-muted-foreground opacity-60 cursor-not-allowed"}`,children:e.jsx(oe,{className:"h-4 w-4"})}),!c&&e.jsx("div",{className:"absolute -top-8 left-1/2 -translate-x-1/2 whitespace-nowrap text-xs bg-popover text-popover-foreground border border-border px-2 py-1 rounded shadow hidden group-hover:block",children:"Cannot delete after start time"})]})]})})()]})},t.id))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:"Finished"}),e.jsx("div",{className:"space-y-4 mt-2",children:f.filter(t=>{const s=Date.now(),i=t.end_time?new Date(t.end_time).getTime():null;return i!==null&&s>i}).map((t,s)=>e.jsx(ge.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:s*.05},className:"bg-card text-card-foreground border border-border rounded-2xl p-6 shadow-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-semibold text-foreground",children:t.title}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 mt-2 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Category: ",t.category||"â€”"]}),e.jsxs("span",{children:["Prize Type: ",t.prize_type||"money"]}),e.jsxs("span",{children:["Prize Pool: ",t.prize_type==="coins"?"ðŸª™":"","â‚¹",t.prize_pool]}),e.jsxs("span",{children:["Prizes: ",t.prize_type==="coins"?"ðŸª™ ":"",Array.isArray(t.prizes)?t.prizes.join(", "):""]})]}),e.jsxs("div",{className:"mt-2 text-sm text-muted-foreground",children:[e.jsxs("span",{children:["Start: ",t.start_time?he(t.start_time):"â€”"]}),e.jsxs("span",{className:"ml-4",children:["End: ",t.end_time?he(t.end_time):"â€”"]})]})]}),e.jsx("div",{className:"flex space-x-2",children:e.jsxs(be,{to:`/results/${t.id}`,className:"inline-flex items-center gap-1 px-3 py-1.5 text-sm rounded-md border border-border hover:bg-muted text-blue-600",children:[e.jsx(Te,{className:"h-4 w-4"})," Results"]})})]})},t.id))})]})]})]}),N&&a&&e.jsxs("div",{className:"mt-6 bg-card text-card-foreground border border-border rounded-2xl p-6 shadow-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-lg font-semibold text-foreground",children:["Questions for: ",a.title]}),e.jsx("div",{className:"flex gap-2",children:(()=>{const t=a!=null&&a.start_time?new Date(a.start_time).getTime()<=Date.now():!1;return e.jsxs(e.Fragment,{children:[e.jsxs(g,{onClick:()=>{if(t){n({title:"Locked",description:"Cannot add after quiz start",variant:"destructive"});return}fe(!0)},disabled:t,className:"bg-indigo-600 hover:bg-indigo-700 disabled:opacity-60",size:"sm",children:[e.jsx(ee,{className:"w-4 h-4 mr-1"}),Ne?"Composer Open":"Add Question"]}),e.jsxs(Ke,{open:Le,onOpenChange:we,children:[e.jsx(Ye,{asChild:!0,children:e.jsx(g,{variant:"outline",size:"sm",disabled:t,children:"Bulk Add/Replace"})}),e.jsxs(Xe,{className:"max-w-2xl",children:[e.jsxs(Je,{children:[e.jsx(et,{children:"Bulk add questions"}),e.jsx(tt,{children:"Paste multiple questions with options. Supported formats shown below."})]}),e.jsxs("div",{children:[e.jsx(de,{value:me,onChange:s=>_e(s.target.value),className:"h-56",disabled:t,placeholder:`RAW format with [x]/[ ] and max 4 options. Example:
Q. Sample?
- [x] Option 1
- [ ] Option 2
- [ ] Option 3
- [ ] Option 4

Alternatively: use Answer: B or Answer: 2`}),(()=>{const{items:s,errors:i,warnings:r}=ie(me,{strict:!0,allowZeroCorrect:(a==null?void 0:a.category)==="opinion"});return e.jsxs("div",{className:"mt-2 space-y-1 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-foreground/80",children:["Preview: ",s.length," questions"]}),e.jsxs("label",{className:"text-sm text-foreground/80 flex items-center gap-2",children:[e.jsx("span",{children:"Mode:"}),e.jsxs("select",{value:ke,onChange:c=>Pe(c.target.value),className:"border border-border bg-background text-foreground rounded-md px-2 py-1 text-sm",disabled:t,children:[e.jsx("option",{value:"append",children:"Append"}),e.jsx("option",{value:"replace",children:"Replace existing"})]})]})]}),r.length>0&&e.jsxs("div",{className:"text-xs text-amber-600",children:[r[0],r.length>1?` (+${r.length-1} more)`:""]}),i.length>0&&e.jsxs("div",{className:"text-xs text-destructive",children:[i[0],i.length>1?` (+${i.length-1} more)`:""]})]})})()]}),e.jsxs(st,{children:[e.jsx(rt,{asChild:!0,children:e.jsx(g,{variant:"outline",children:"Cancel"})}),e.jsx(g,{disabled:Ce||t||ie(me,{strict:!0,allowZeroCorrect:(a==null?void 0:a.category)==="opinion"}).errors.length>0,onClick:async()=>{const i=ie(me,{strict:!0,allowZeroCorrect:(a==null?void 0:a.category)==="opinion"}).items;if(!i.length){n({title:"No valid questions detected",variant:"destructive"});return}ue(!0);const r=await De(a.id,i,ke);if(ue(!1),!r.ok){n({title:"Bulk add failed",description:r.message||"Try again",variant:"destructive"});return}n({title:"Questions added",description:`${i.length} questions processed.`}),we(!1),_e(""),await U(a.id)},children:Ce?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"w-4 h-4 mr-1 animate-spin"}),"Workingâ€¦"]}):"Apply"})]})]})]}),e.jsx(g,{variant:"outline",size:"sm",onClick:()=>V(!1),children:"Close"})]})})()})]}),H.length===0?e.jsx("div",{className:"py-6 text-center text-muted-foreground",children:"No questions yet"}):e.jsxs("div",{className:"space-y-4",children:[(()=>{const t=a!=null&&a.start_time?new Date(a.start_time).getTime()<=Date.now():!1;if(!Ne)return null;const s=(a==null?void 0:a.category)==="opinion";return e.jsxs("div",{className:"p-3 rounded-xl bg-card/80 border border-border",children:[e.jsx("div",{className:"mb-2 text-sm font-semibold text-foreground",children:"New Question"}),e.jsx(z,{placeholder:"Type your question",value:R.text,disabled:t,onChange:i=>K(r=>({...r,text:i.target.value})),className:"mb-3"}),e.jsxs("div",{className:"space-y-2",children:[(R.options||[]).slice(0,4).map((i,r)=>e.jsxs("div",{className:"flex items-center gap-2",children:[!s&&e.jsx("input",{type:"radio",name:"newq-correct",checked:R.correctIndex===r,disabled:t,onChange:()=>K(c=>({...c,correctIndex:r}))}),e.jsx(z,{placeholder:`Option ${r+1}`,value:i,disabled:t,onChange:c=>{const l=[...R.options];l[r]=c.target.value,K(u=>({...u,options:l}))},className:"flex-1"}),R.options.length>2&&e.jsx(g,{type:"button",variant:"outline",size:"sm",className:`border-red-300 ${t?"text-muted-foreground opacity-60 cursor-not-allowed":"text-red-600"}`,disabled:t,onClick:()=>{const c=[...R.options];c.splice(r,1),K(l=>({...l,options:c,correctIndex:Math.min(l.correctIndex,c.length-1)}))},children:e.jsx(oe,{className:"w-4 h-4"})})]},r)),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(g,{type:"button",size:"sm",className:"bg-green-600 hover:bg-green-700 disabled:opacity-60",disabled:t||(R.options||[]).length>=4,onClick:()=>K(i=>({...i,options:[...i.options].slice(0,4).concat("")})),children:[e.jsx(ee,{className:"w-4 h-4 mr-1"})," Add Option"]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s?"Opinion: no correct option needed.":"Select the correct option. Max 4 options."})]})]}),e.jsxs("div",{className:"mt-3 flex gap-2",children:[e.jsx(g,{type:"button",onClick:Oe,className:"bg-indigo-600 hover:bg-indigo-700 disabled:opacity-60",disabled:t,children:"Save Question"}),e.jsx(g,{type:"button",variant:"outline",onClick:()=>{fe(!1),K({text:"",options:["","","",""],correctIndex:0})},children:"Cancel"})]})]})})(),H.map(t=>{const s=a!=null&&a.start_time?new Date(a.start_time).getTime()<=Date.now():!1,i=(a==null?void 0:a.category)==="opinion";return e.jsxs("div",{className:"p-3 rounded-xl bg-card/80 border border-border",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{defaultValue:t.question_text,onBlur:r=>{if(s){n({title:"Locked",description:"Cannot edit after quiz start",variant:"destructive"});return}$e(t.id,r.target.value)},className:"flex-1",disabled:s}),e.jsx(g,{variant:"outline",size:"sm",className:`border-red-300 ${s?"text-muted-foreground opacity-60 cursor-not-allowed":"text-red-600"}`,onClick:()=>{if(s){n({title:"Locked",description:"Cannot delete after quiz start",variant:"destructive"});return}Ee(t.id)},disabled:s,children:e.jsx(oe,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"mt-2 pl-1",children:[e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:"Options"}),e.jsxs("div",{className:"space-y-2",children:[(t.options||[]).map(r=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{defaultValue:r.option_text,onBlur:c=>{if(s){n({title:"Locked",description:"Cannot edit after quiz start",variant:"destructive"});return}Re(r.id,c.target.value)},className:"flex-1",disabled:s}),!i&&e.jsxs("label",{className:"flex items-center gap-1 text-xs text-foreground/80",children:[e.jsx("input",{type:"radio",name:`correct-${t.id}`,defaultChecked:!!r.is_correct,disabled:s,onChange:async c=>{if(s){c.preventDefault();return}if(!c.target.checked)return;const{error:l}=await x.from("options").update({is_correct:!1}).eq("question_id",t.id);if(l){n({title:"Update failed",description:l.message,variant:"destructive"});return}const{error:u}=await x.from("options").update({is_correct:!0}).eq("id",r.id);u&&n({title:"Update failed",description:u.message,variant:"destructive"}),await U(a.id)}}),"Correct"]}),e.jsx(g,{variant:"outline",size:"sm",className:`border-red-300 ${s?"text-muted-foreground opacity-60 cursor-not-allowed":"text-red-600"}`,onClick:()=>{if(s){n({title:"Locked",description:"Cannot delete after quiz start",variant:"destructive"});return}Me(r.id)},disabled:s,children:e.jsx(oe,{className:"w-4 h-4"})})]},r.id)),e.jsxs(g,{onClick:()=>{if(s){n({title:"Locked",description:"Cannot add after quiz start",variant:"destructive"});return}if((t.options||[]).length>=4){n({title:"Limit reached",description:"Max 4 options per question",variant:"destructive"});return}Be(t.id)},size:"sm",className:"bg-green-600 hover:bg-green-700 disabled:opacity-60",disabled:s,children:[e.jsx(ee,{className:"w-4 h-4 mr-1"}),"Add Option"]})]})]})]},t.id)})]})]})]}),q==="notifications"&&e.jsx(mt,{}),q==="redemptions"&&e.jsx(xt,{})]})}function xt(){const{toast:j}=le(),[n,T]=m.useState([]),[$,q]=m.useState(!0),[S,L]=m.useState(!1),[f,A]=m.useState({title:"",coins_required:"",description:"",image_url:""}),d=m.useCallback(async()=>{q(!0);const{data:a,error:C}=await x.from("reward_catalog").select("*").order("coins_required",{ascending:!1});C?(j({title:"Load failed",description:C.message,variant:"destructive"}),T([])):T(a||[]),q(!1)},[j]);m.useEffect(()=>{d()},[d]);const v=async a=>{var H,ce;a.preventDefault();const C=f.title.trim(),N=parseInt(f.coins_required,10);if(!C||isNaN(N)||N<0){j({title:"Invalid input",description:"Title required and coins must be a non-negative number",variant:"destructive"});return}L(!0);const{error:V}=await x.from("reward_catalog").insert({title:C,coins_required:N,description:((H=f.description)==null?void 0:H.trim())||null,image_url:((ce=f.image_url)==null?void 0:ce.trim())||null,is_active:!0});V?j({title:"Add failed",description:V.message,variant:"destructive"}):(j({title:"Added",description:"Catalog item created"}),A({title:"",coins_required:"",description:"",image_url:""}),d()),L(!1)},y=async(a,C)=>{const{error:N}=await x.from("reward_catalog").update(C).eq("id",a);N?j({title:"Update failed",description:N.message,variant:"destructive"}):d()},Z=async a=>{if(!confirm("Delete this item?"))return;const{error:C}=await x.from("reward_catalog").delete().eq("id",a);C?j({title:"Delete failed",description:C.message,variant:"destructive"}):(j({title:"Deleted"}),d())};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent",children:"Admin: Redemptions Catalog"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Items jinko users coins se redeem kar sakte hain"})]}),e.jsx("div",{className:"bg-card text-card-foreground border border-border rounded-2xl p-4 shadow-lg",children:e.jsxs("form",{onSubmit:v,className:"grid grid-cols-1 md:grid-cols-4 gap-3 items-end",children:[e.jsxs("div",{children:[e.jsx(O,{htmlFor:"rc_title",children:"Title *"}),e.jsx(z,{id:"rc_title",value:f.title,onChange:a=>A({...f,title:a.target.value}),placeholder:"e.g., â‚¹100 Paytm",required:!0})]}),e.jsxs("div",{children:[e.jsx(O,{htmlFor:"rc_coins",children:"Coins *"}),e.jsx(z,{id:"rc_coins",type:"number",min:"0",value:f.coins_required,onChange:a=>A({...f,coins_required:a.target.value}),placeholder:"e.g., 1000",required:!0})]}),e.jsxs("div",{children:[e.jsx(O,{htmlFor:"rc_img",children:"Image URL (optional)"}),e.jsx(z,{id:"rc_img",value:f.image_url,onChange:a=>A({...f,image_url:a.target.value}),placeholder:"https://..."})]}),e.jsxs("div",{className:"md:col-span-4",children:[e.jsx(O,{htmlFor:"rc_desc",children:"Description (optional)"}),e.jsx(de,{id:"rc_desc",value:f.description,onChange:a=>A({...f,description:a.target.value}),placeholder:"Short details"})]}),e.jsx("div",{children:e.jsx(g,{type:"submit",disabled:S,className:"bg-green-600 hover:bg-green-700",children:S?e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"w-4 h-4 mr-2 animate-spin"}),"Adding..."]}):"Add Item"})})]})}),e.jsxs("div",{className:"bg-card text-card-foreground border border-border rounded-2xl p-4 shadow-lg",children:[e.jsx("h3",{className:"font-semibold text-foreground mb-3",children:"Catalog Items"}),$?e.jsxs("div",{className:"py-8 text-center text-muted-foreground",children:[e.jsx(te,{className:"inline-block h-6 w-6 animate-spin text-indigo-500 mr-2"})," Loading..."]}):n.length===0?e.jsx("div",{className:"py-8 text-center text-muted-foreground",children:"No items"}):e.jsx("div",{className:"space-y-2",children:n.map(a=>e.jsxs("div",{className:"p-3 rounded-xl bg-card/80 border border-border flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{defaultValue:a.title,onBlur:C=>{const N=C.target.value.trim();N&&N!==a.title&&y(a.id,{title:N})},className:"flex-1"}),e.jsx(z,{type:"number",min:"0",defaultValue:a.coins_required,onBlur:C=>{const N=parseInt(C.target.value,10);!isNaN(N)&&N!==a.coins_required&&y(a.id,{coins_required:N})},className:"w-32"})]}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1 truncate",children:a.description})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("label",{className:"text-xs text-foreground/80 flex items-center gap-1",children:[e.jsx("input",{type:"checkbox",defaultChecked:!!a.is_active,onChange:C=>y(a.id,{is_active:C.target.checked})})," Active"]}),e.jsx(g,{size:"sm",variant:"outline",className:"text-red-600 border-red-300",onClick:()=>Z(a.id),children:e.jsx(oe,{className:"w-4 h-4"})})]})]},a.id))})]})]})}export{wt as default};
